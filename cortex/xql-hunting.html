<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XQL Threat Hunting | Cortex XDR</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Cortex XDR Platform</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="fundamentals.html" class="nav-link"><i class="fas fa-book"></i> Fundamentals</a>
                    <a href="agent-deployment.html" class="nav-link"><i class="fas fa-download"></i> Agent Deployment</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection</div>
                    <a href="analytics.html" class="nav-link"><i class="fas fa-chart-line"></i> Analytics Engine</a>
                    <a href="bioc-rules.html" class="nav-link"><i class="fas fa-code"></i> BIOC Rules</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Investigation</div>
                    <a href="xql-hunting.html" class="nav-link active"><i class="fas fa-crosshairs"></i> XQL Hunting</a>
                    <a href="xql-reference.html" class="nav-link"><i class="fas fa-book-open"></i> XQL Reference</a>
                    <a href="incident-management.html" class="nav-link"><i class="fas fa-clipboard-list"></i> Incident Management</a>
                    <a href="causality.html" class="nav-link"><i class="fas fa-project-diagram"></i> Causality Analysis</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Response</div>
                    <a href="response-actions.html" class="nav-link"><i class="fas fa-bolt"></i> Response Actions</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">Cortex XDR</a><span class="separator">/</span>
                    <span class="current">XQL Threat Hunting</span>
                </div>
            </header>
            <main class="main-content">
                <h1><i class="fas fa-crosshairs"></i> XQL Threat Hunting</h1>
                <p class="lead">Use XQL (Extended Query Language) to hunt for threats across Cortex XDR endpoint telemetry. Access process, network, file, and registry events for proactive threat detection.</p>

                <!-- Accessing Query Center -->
                <h2><i class="fas fa-terminal"></i> Accessing Query Center</h2>
                <div class="config-section">
                    <p><span class="console-path">Cortex XDR → Investigation → Query Center</span></p>
                    
                    <h4>Key Datasets</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Dataset</th><th>Description</th><th>Key Fields</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>xdr_data</td>
                                <td>All XDR endpoint events</td>
                                <td>event_type, host_name, user_name, _time</td>
                            </tr>
                            <tr>
                                <td>endpoints</td>
                                <td>Endpoint inventory</td>
                                <td>endpoint_name, os_type, agent_version</td>
                            </tr>
                            <tr>
                                <td>xdr_alerts</td>
                                <td>XDR alerts</td>
                                <td>alert_name, severity, host_name</td>
                            </tr>
                            <tr>
                                <td>xdr_incidents</td>
                                <td>XDR incidents</td>
                                <td>incident_id, status, severity</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Event Types in xdr_data</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>event_type</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>process_execution</td><td>Process creation events</td></tr>
                            <tr><td>network_connection</td><td>Network connections</td></tr>
                            <tr><td>file_event</td><td>File creation/modification/deletion</td></tr>
                            <tr><td>registry_event</td><td>Registry operations</td></tr>
                            <tr><td>dns_query</td><td>DNS lookups</td></tr>
                            <tr><td>module_load</td><td>DLL/module loading</td></tr>
                            <tr><td>authentication</td><td>Logon events</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- XQL Syntax Basics -->
                <h2><i class="fas fa-code"></i> XQL Syntax Basics</h2>
                <div class="config-section">
                    <h4>Basic Query Structure</h4>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name = "powershell.exe"
| fields _time, host_name, user_name, process_command_line
| sort desc _time
| limit 100</div>

                    <h4>Filter Operators</h4>
                    <div class="code-block">// Exact match
| filter process_name = "cmd.exe"

// Not equal
| filter process_name != "explorer.exe"

// Contains (case-insensitive)
| filter process_command_line contains "-enc"

// Regex match
| filter process_command_line ~= "(?i)-enc"

// In list
| filter process_name in ("cmd.exe", "powershell.exe", "wscript.exe")

// Not in list
| filter process_name not in ("explorer.exe", "svchost.exe")

// Null check
| filter user_name != null

// Wildcard
| filter process_name = "power*"</div>

                    <h4>Aggregation</h4>
                    <div class="code-block">// Count
| comp count() as event_count by host_name

// Multiple aggregations
| comp 
    count() as total,
    count_distinct(host_name) as unique_hosts,
    min(_time) as first_seen,
    max(_time) as last_seen
    by process_name

// With time window
| comp count() by host_name over 1h</div>

                    <h4>Time Filtering</h4>
                    <div class="code-block">// Last 24 hours
| filter _time > ago("24h")

// Last 7 days
| filter _time > ago("7d")

// Specific range
| filter _time between "2024-01-15T00:00:00Z" and "2024-01-16T00:00:00Z"

// Using preset (in Query Center UI)</div>
                </div>

                <!-- Execution Hunting -->
                <h2><i class="fas fa-play"></i> Execution Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1059.001</span> PowerShell Encoded Commands</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name in ("powershell.exe", "pwsh.exe")
| filter process_command_line ~= "(?i)-e(nc|ncodedcommand)"
| fields _time, host_name, user_name, process_command_line, parent_process_name
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1059.001</span> PowerShell Download Activity</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name in ("powershell.exe", "pwsh.exe")
| filter process_command_line ~= "(?i)(downloadstring|downloadfile|invoke-webrequest|net\.webclient|start-bitstransfer|iwr |wget |curl )"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1218</span> LOLBin Execution with Network Activity</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name in ("certutil.exe", "mshta.exe", "regsvr32.exe", "rundll32.exe", "msiexec.exe", "cmstp.exe", "wmic.exe")
| filter process_command_line ~= "(?i)(http|https|ftp|\\\\\\\\)"
| fields _time, host_name, user_name, process_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1059</span> Office Application Spawning Shell</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter parent_process_name in ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", "OUTLOOK.EXE")
| filter process_name in ("cmd.exe", "powershell.exe", "wscript.exe", "cscript.exe", "mshta.exe")
| fields _time, host_name, user_name, parent_process_name, process_name, process_command_line
| sort desc _time</div>
                </div>

                <!-- Persistence Hunting -->
                <h2><i class="fas fa-anchor"></i> Persistence Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1547.001</span> Registry Run Key Modification</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "registry_event"
| filter registry_key ~= "(?i)\\\\CurrentVersion\\\\Run"
| filter registry_value_data ~= "(?i)\\.(exe|dll|bat|ps1|vbs|cmd)"
| fields _time, host_name, user_name, registry_key, registry_value_name, registry_value_data
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1053.005</span> Scheduled Task Creation</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name = "schtasks.exe"
| filter process_command_line contains "/create"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1543.003</span> Service Creation</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name = "sc.exe"
| filter process_command_line contains "create"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <!-- Credential Access Hunting -->
                <h2><i class="fas fa-key"></i> Credential Access Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1003.001</span> LSASS Access Indicators</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_command_line ~= "(?i)(mimikatz|sekurlsa|lsass|procdump.*lsass|minidump)"
| fields _time, host_name, user_name, process_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1003.002</span> SAM/SYSTEM File Access</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_command_line ~= "(?i)(\\\\SAM|\\\\SYSTEM|\\\\SECURITY|reg.*save.*sam|reg.*save.*system)"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1003.003</span> NTDS.dit Access</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_command_line ~= "(?i)(ntds\\.dit|ntdsutil|vssadmin.*shadow)"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <!-- Lateral Movement Hunting -->
                <h2><i class="fas fa-arrows-alt"></i> Lateral Movement Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1021.002</span> SMB Connection Spread</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_port = 445
| filter dst_ip_is_private = true
| comp count_distinct(dst_ip) as unique_targets by host_name, user_name over 30m
| filter unique_targets >= 5
| sort desc unique_targets</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1021.001</span> RDP Connections</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_port = 3389
| fields _time, host_name, user_name, dst_ip, process_name
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1047</span> WMI Remote Execution</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name = "wmic.exe"
| filter process_command_line contains "/node:"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1570</span> PsExec Usage</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name in ("psexec.exe", "psexec64.exe", "PSEXESVC.exe")
| fields _time, host_name, user_name, process_name, process_command_line
| sort desc _time</div>
                </div>

                <!-- Defense Evasion Hunting -->
                <h2><i class="fas fa-eye-slash"></i> Defense Evasion Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1070.001</span> Event Log Clearing</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter (process_name = "wevtutil.exe" and process_command_line ~= "(?i)(cl|clear)")
    or (process_name in ("powershell.exe", "pwsh.exe") and process_command_line contains "Clear-EventLog")
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1562.001</span> Security Tool Tampering</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter process_command_line ~= "(?i)(set-mppreference.*disable|sc.*stop.*windefend|net.*stop.*windefend|disable.*realtimemonitoring)"
| fields _time, host_name, user_name, process_command_line
| sort desc _time</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1036</span> Process Masquerading</h3>
                    <div class="code-block">// System binaries running from wrong paths
dataset = xdr_data
| filter event_type = "process_execution"
| filter process_name in ("cmd.exe", "powershell.exe", "svchost.exe", "lsass.exe", "csrss.exe")
| filter process_path not contains "C:\\Windows"
| fields _time, host_name, process_name, process_path, process_command_line
| sort desc _time</div>
                </div>

                <!-- Network Hunting -->
                <h2><i class="fas fa-network-wired"></i> Network Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1071</span> Connections to Rare Destinations</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_ip_is_private = false
| comp 
    count() as connection_count,
    count_distinct(host_name) as unique_hosts
    by dst_ip
| filter connection_count < 5 and unique_hosts < 3
| sort asc connection_count</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1571</span> Non-Standard Ports</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_ip_is_private = false
| filter dst_port not in (80, 443, 8080, 8443, 53, 21, 22, 25, 110, 143)
| filter dst_port < 49152
| comp count() by dst_ip, dst_port, process_name
| filter count() > 10
| sort desc count()</div>
                </div>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1048</span> Large Outbound Transfers</h3>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_ip_is_private = false
| comp sum(bytes_sent) as total_bytes by host_name, dst_ip, process_name over 1h
| filter total_bytes > 104857600  // > 100 MB
| alter MB_sent = round(total_bytes / 1048576, 2)
| sort desc MB_sent</div>
                </div>

                <!-- DNS Hunting -->
                <h2><i class="fas fa-globe"></i> DNS Hunting</h2>

                <div class="hunt-card">
                    <h3><span class="mitre-tag">T1071.004</span> Suspicious DNS Queries</h3>
                    <div class="code-block">// High-entropy domain names (potential DGA)
dataset = xdr_data
| filter event_type = "dns_query"
| filter dns_query_name ~= "^[a-z0-9]{15,}\\."
| fields _time, host_name, dns_query_name, process_name
| sort desc _time

// Queries to suspicious TLDs
dataset = xdr_data
| filter event_type = "dns_query"
| filter dns_query_name ~= "\\.(tk|ml|ga|cf|gq|top|xyz|pw)$"
| fields _time, host_name, dns_query_name, process_name
| sort desc _time</div>
                </div>

                <!-- Investigation Workflow -->
                <h2><i class="fas fa-search-plus"></i> Investigation Workflow</h2>
                <div class="config-section">
                    <h4>Full Host Timeline</h4>
                    <div class="code-block">dataset = xdr_data
| filter host_name = "SUSPECT-HOST"
| filter _time > ago("24h")
| fields _time, event_type, process_name, process_command_line, dst_ip, dst_port, file_path
| sort asc _time</div>

                    <h4>Process Tree Investigation</h4>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "process_execution"
| filter host_name = "SUSPECT-HOST"
| filter _time > ago("24h")
| fields _time, process_name, process_command_line, parent_process_name, user_name, process_pid
| sort asc _time</div>

                    <h4>Network Activity for Specific Process</h4>
                    <div class="code-block">dataset = xdr_data
| filter event_type = "network_connection"
| filter host_name = "SUSPECT-HOST"
| filter process_name = "suspicious.exe"
| fields _time, dst_ip, dst_port, bytes_sent, bytes_received
| sort asc _time</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How does XQL compare to SPL and KQL?</button>
                        <div class="qa-answer">
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Aspect</th><th>XQL (Cortex)</th><th>SPL (Splunk)</th><th>KQL (Microsoft)</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Pipe character</td><td>|</td><td>|</td><td>|</td></tr>
                                    <tr><td>Filter keyword</td><td>filter</td><td>where/search</td><td>where</td></tr>
                                    <tr><td>Aggregation</td><td>comp</td><td>stats</td><td>summarize</td></tr>
                                    <tr><td>Regex match</td><td>~=</td><td>match()</td><td>matches regex</td></tr>
                                    <tr><td>Select fields</td><td>fields</td><td>table/fields</td><td>project</td></tr>
                                    <tr><td>Data source</td><td>dataset =</td><td>index=</td><td>TableName</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you hunt for lateral movement in Cortex XDR?</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Network connections:</strong> Look for connections on SMB (445), RDP (3389), WinRM (5985/5986)</li>
                                <li><strong>Remote execution:</strong> Search for PsExec, WMI /node:, PowerShell remoting</li>
                                <li><strong>Authentication:</strong> Check authentication events from multiple sources</li>
                                <li><strong>Process patterns:</strong> wmiprvse.exe or services.exe spawning processes remotely</li>
                            </ol>
                            <div class="code-block">// Quick lateral movement hunt
dataset = xdr_data
| filter event_type = "network_connection"
| filter dst_port in (445, 3389, 5985)
| comp count_distinct(dst_ip) as targets by host_name
| filter targets > 5</div>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between xdr_data and xdr_alerts?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>xdr_data:</strong> Raw endpoint telemetry (process, network, file, registry events). This is the data you hunt in.</li>
                                <li><strong>xdr_alerts:</strong> Alerts generated by XDR detection engine (BIOC rules, Analytics BIOC, etc.). These are already-detected suspicious activities.</li>
                            </ul>
                            <p>For hunting, primarily use <code>xdr_data</code>. Use <code>xdr_alerts</code> for alert investigation and metrics.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>