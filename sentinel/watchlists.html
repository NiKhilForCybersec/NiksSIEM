<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watchlists | Microsoft Sentinel</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Watchlists</span>
                </div>

                <h1><i class="fas fa-list-check"></i> Watchlists</h1>
                <p class="lead">Master Sentinel Watchlists for enrichment, allowlisting, and correlation. Learn to create, manage, and operationalize watchlists for enterprise security operations.</p>

                <!-- Watchlist Overview -->
                <h2><i class="fas fa-info-circle"></i> Watchlist Overview</h2>
                <div class="config-section">
                    <div class="arch-diagram">WATCHLIST FUNDAMENTALS
═══════════════════════════════════════════════════════════════════

WHAT IS A WATCHLIST?
├── Curated list of data (IPs, users, hosts, domains, etc.)
├── Stored in Sentinel workspace as a table
├── Queryable via _GetWatchlist('WatchlistName')
├── Supports up to 10 million rows
└── Updates without redeploying analytics rules

COMMON USE CASES:
┌─────────────────────────────────────────────────────────────────┐
│  ENRICHMENT          │  ALLOWLISTING        │  CORRELATION      │
│  ─────────────       │  ─────────────       │  ─────────────    │
│  • VIP users         │  • Known scanners    │  • Threat IOCs    │
│  • Critical assets   │  • Authorized IPs    │  • Campaign IDs   │
│  • Executive list    │  • Service accounts  │  • Actor TTPs     │
│  • High-value hosts  │  • Approved software │  • Related users  │
│  • Geo locations     │  • Partner domains   │  • Attack chains  │
└─────────────────────────────────────────────────────────────────┘

DATA SOURCES:
├── CSV file upload (manual)
├── Azure Storage Account (automated sync)
├── Azure Data Explorer (large datasets)
├── Logic App / API (programmatic updates)
└── Fusion with external threat intel

WATCHLIST vs OTHER OPTIONS:
┌──────────────────┬─────────────────────┬───────────────────────┐
│     Feature      │     Watchlist       │   KQL let statement   │
├──────────────────┼─────────────────────┼───────────────────────┤
│ Size limit       │ 10 million rows     │ ~1 million records    │
│ Update method    │ Portal/API/Storage  │ Edit rule query       │
│ Shared across    │ All rules/queries   │ Single query only     │
│ Version control  │ External possible   │ In rule definition    │
│ Dynamic updates  │ Yes, no redeploy    │ No, requires edit     │
└──────────────────┴─────────────────────┴───────────────────────┘</div>
                </div>

                <!-- Creating Watchlists -->
                <h2><i class="fas fa-plus-circle"></i> Creating Watchlists</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Configuration → Watchlist → + Add new</span></p>

                    <h4>Watchlist Configuration</h4>
                    <div class="arch-diagram">WATCHLIST CREATION SETTINGS
═══════════════════════════════════════════════════════════════════

GENERAL TAB:
├── Name: Unique identifier (no spaces, use underscores)
│   └── Example: VIP_Users, Critical_Assets, Known_Bad_IPs
├── Alias: Used in KQL queries - _GetWatchlist('Alias')
│   └── Keep short and descriptive
├── Description: Purpose and owner information
└── Source type: 
    ├── Local file (CSV upload)
    └── Azure Storage (blob container)

SOURCE TAB (CSV Upload):
├── File: Upload CSV file (max 3.8 MB per upload)
├── SearchKey: Column used for lookups (must be unique)
│   └── Example: UserPrincipalName, IPAddress, Hostname
├── Rows before header: Skip rows if needed
└── CSV requirements:
    ├── UTF-8 encoding
    ├── Comma-delimited
    ├── First row = headers
    └── No special characters in headers

SOURCE TAB (Azure Storage):
├── Subscription: Select subscription
├── Storage account: Select storage account
├── Container: Blob container name
├── Blob path: Path to CSV file
├── Content type: text/csv
└── Refresh period: 1 hour to 14 days

EXAMPLE CSV FORMAT:
┌─────────────────────────────────────────────────────────────────┐
│ UserPrincipalName,DisplayName,Department,VIPLevel,Notes        │
│ ceo@company.com,Jane Smith,Executive,Critical,Board member     │
│ cfo@company.com,John Doe,Finance,High,C-suite                  │
│ ciso@company.com,Alice Brown,Security,High,Security leader     │
└─────────────────────────────────────────────────────────────────┘</div>

                    <h4>Large Watchlist Strategies</h4>
                    <div class="arch-diagram">HANDLING LARGE WATCHLISTS (>100K rows)
═══════════════════════════════════════════════════════════════════

OPTION 1: AZURE STORAGE AUTO-SYNC
├── Store CSV in Azure Blob Storage
├── Configure Sentinel to sync periodically
├── Supports files larger than 3.8MB portal limit
└── Best for: Threat intel feeds, asset inventories

OPTION 2: MULTIPLE SMALLER WATCHLISTS
├── Split by category (VIP_Executives, VIP_Directors, VIP_Managers)
├── Query with union: 
│   _GetWatchlist('VIP_Exec') | union _GetWatchlist('VIP_Dir')
└── Best for: Logically separate data

OPTION 3: CUSTOM TABLE INSTEAD
├── Use custom log ingestion for very large datasets
├── Query like normal table (no _GetWatchlist)
├── Supports millions of rows with full KQL
└── Best for: Massive datasets, complex schemas

OPTION 4: ADX INTEGRATION
├── Store in Azure Data Explorer
├── Use externaldata() or ADX proxy queries
├── Best for: 10M+ rows, real-time updates
└── Requires ADX cluster</div>
                </div>

                <!-- Watchlist Patterns -->
                <h2><i class="fas fa-puzzle-piece"></i> Enterprise Watchlist Patterns</h2>
                <div class="config-section">
                    <h4>Pattern 1: VIP/High-Value User Monitoring</h4>
                    <div class="arch-diagram">VIP USER WATCHLIST
═══════════════════════════════════════════════════════════════════

CSV STRUCTURE:
UserPrincipalName,DisplayName,Title,VIPLevel,ProtectionTier
ceo@company.com,Jane Smith,CEO,Critical,Tier1-24x7
cfo@company.com,John Doe,CFO,Critical,Tier1-24x7
vp.sales@company.com,Bob Wilson,VP Sales,High,Tier2-Business

KQL - ALERT ON VIP SUSPICIOUS LOGIN:
let VIPs = _GetWatchlist('VIP_Users');
SigninLogs
| where TimeGenerated > ago(1h)
| where UserPrincipalName in (VIPs)
| where RiskLevelDuringSignIn in ("high", "medium")
| project TimeGenerated, UserPrincipalName, IPAddress, 
          RiskLevelDuringSignIn, Location

KQL - ENRICH INCIDENT WITH VIP CONTEXT:
let VIPs = _GetWatchlist('VIP_Users');
SecurityIncident
| where TimeGenerated > ago(24h)
| mv-expand AlertIds
| join kind=inner (
    SecurityAlert
    | mv-expand Entities
    | extend UserPrincipalName = tostring(Entities.UserPrincipalName)
) on $left.AlertIds == $right.SystemAlertId
| lookup kind=leftouter VIPs on UserPrincipalName
| where isnotempty(VIPLevel)
| project IncidentNumber, Title, UserPrincipalName, VIPLevel</div>

                    <h4>Pattern 2: Critical Asset Protection</h4>
                    <div class="arch-diagram">CRITICAL ASSETS WATCHLIST
═══════════════════════════════════════════════════════════════════

CSV STRUCTURE:
Hostname,IPAddress,AssetType,BusinessCriticality,Owner,DataClassification
DC01,10.1.1.10,DomainController,Critical,IT-Infra,Confidential
SQL-PROD-01,10.1.2.20,Database,Critical,DBA-Team,Restricted
HR-APP-01,10.1.3.30,Application,High,HR-IT,PII

KQL - DETECT LATERAL MOVEMENT TO CRITICAL ASSETS:
let CriticalAssets = _GetWatchlist('Critical_Assets');
SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 4624
| where LogonType in (3, 10)  // Network, RemoteInteractive
| where Computer in (CriticalAssets) or 
        TargetServerName in (CriticalAssets)
| where AccountType == "User"
| project TimeGenerated, Account, Computer, IpAddress, LogonType

KQL - VULNERABILITY PRIORITIZATION:
let CriticalAssets = _GetWatchlist('Critical_Assets');
SecurityRecommendation
| where RecommendationSeverity == "High"
| lookup kind=inner CriticalAssets on $left.DeviceName == $right.Hostname
| project DeviceName, RecommendationName, BusinessCriticality
| where BusinessCriticality == "Critical"</div>

                    <h4>Pattern 3: Authorized Service Accounts</h4>
                    <div class="arch-diagram">SERVICE ACCOUNTS ALLOWLIST
═══════════════════════════════════════════════════════════════════

CSV STRUCTURE:
AccountName,Description,AllowedHosts,AllowedHours,Owner
svc_backup,Backup Service,BACKUP-SRV01;BACKUP-SRV02,0-24,IT-Ops
svc_sql,SQL Service,SQL-*,0-24,DBA-Team
svc_deploy,Deployment,DEPLOY-01,6-22,DevOps

KQL - DETECT UNAUTHORIZED SERVICE ACCOUNT USE:
let ServiceAccounts = _GetWatchlist('Service_Accounts');
SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 4624
| where AccountName startswith "svc_"
| lookup kind=leftouter ServiceAccounts on AccountName
| where isempty(Description)  // Not in approved list
| project TimeGenerated, AccountName, Computer, IpAddress

KQL - SERVICE ACCOUNT ANOMALY (WRONG HOST):
let ServiceAccounts = _GetWatchlist('Service_Accounts');
SecurityEvent
| where TimeGenerated > ago(1h)
| where EventID == 4624
| join kind=inner ServiceAccounts on AccountName
| extend AllowedHostList = split(AllowedHosts, ";")
| where not(Computer has_any (AllowedHostList))
| project TimeGenerated, AccountName, Computer, AllowedHosts</div>

                    <h4>Pattern 4: Threat Intelligence IOCs</h4>
                    <div class="arch-diagram">THREAT IOC WATCHLIST
═══════════════════════════════════════════════════════════════════

CSV STRUCTURE:
IOC,IOCType,ThreatActor,Campaign,Confidence,ExpirationDate,Source
evil.com,domain,APT29,SolarWinds,High,2025-12-31,CISA
1.2.3.4,ip,FIN7,Carbanak,Medium,2025-06-30,FBI-Flash
abc123...,hash,Lazarus,AppleJeus,High,2025-09-30,Mandiant

KQL - MATCH NETWORK CONNECTIONS TO IOCs:
let ThreatIOCs = _GetWatchlist('Threat_IOCs')
    | where IOCType == "ip"
    | where todatetime(ExpirationDate) > now()
    | project IOC, ThreatActor, Campaign, Confidence;
DeviceNetworkEvents
| where TimeGenerated > ago(1h)
| where RemoteIP in (ThreatIOCs)
| lookup ThreatIOCs on $left.RemoteIP == $right.IOC
| project TimeGenerated, DeviceName, RemoteIP, ThreatActor, Campaign

KQL - DNS QUERY TO MALICIOUS DOMAIN:
let ThreatDomains = _GetWatchlist('Threat_IOCs')
    | where IOCType == "domain"
    | project IOC, ThreatActor, Confidence;
DnsEvents
| where TimeGenerated > ago(1h)
| where Name has_any (ThreatDomains)
| lookup ThreatDomains on $left.Name == $right.IOC
| project TimeGenerated, Computer, Name, ThreatActor</div>

                    <h4>Pattern 5: Known Scanner/Pentester Allowlist</h4>
                    <div class="arch-diagram">AUTHORIZED SCANNER ALLOWLIST
═══════════════════════════════════════════════════════════════════

CSV STRUCTURE:
IPAddress,ScannerType,Vendor,ApprovalTicket,ValidUntil,Owner
10.5.1.100,Vulnerability,Qualys,CHG0012345,2025-12-31,SecOps
10.5.1.101,Vulnerability,Qualys,CHG0012345,2025-12-31,SecOps
192.168.50.10,Pentest,External,PT-2025-001,2025-02-28,RedTeam

KQL - EXCLUDE AUTHORIZED SCANNERS FROM ALERTS:
let AuthorizedScanners = _GetWatchlist('Authorized_Scanners')
    | where todatetime(ValidUntil) > now()
    | project IPAddress;
SecurityAlert
| where TimeGenerated > ago(1h)
| where AlertName has_any ("Port Scan", "Vulnerability Scan", "Brute Force")
| mv-expand Entities
| extend SourceIP = tostring(Entities.Address)
| where SourceIP !in (AuthorizedScanners)

USE IN ANALYTICS RULE (Exclusion):
let AuthorizedScanners = _GetWatchlist('Authorized_Scanners');
// Your detection logic here
| where SourceIP !in (AuthorizedScanners)</div>
                </div>

                <!-- Watchlist Management -->
                <h2><i class="fas fa-cogs"></i> Watchlist Management</h2>
                <div class="config-section">
                    <h4>Update Methods</h4>
                    <div class="arch-diagram">WATCHLIST UPDATE STRATEGIES
═══════════════════════════════════════════════════════════════════

METHOD 1: MANUAL PORTAL UPDATE
├── Navigate to Watchlist → Edit items
├── Add/remove individual rows
├── Good for: Small, infrequent changes
└── Limitation: Not scalable, no audit trail

METHOD 2: CSV RE-UPLOAD
├── Export current → Modify → Re-upload
├── Replaces entire watchlist
├── Good for: Bulk updates
└── Limitation: Overwrites, risk of data loss

METHOD 3: AZURE STORAGE SYNC
├── Update CSV in blob storage
├── Sentinel syncs automatically (1hr - 14 days)
├── Good for: Automated feeds, scheduled updates
└── Limitation: Sync delay

METHOD 4: LOGIC APP / API
├── Use Sentinel REST API
├── Programmatic add/update/delete
├── Good for: Integration with other systems
└── Limitation: Requires development

RECOMMENDED ENTERPRISE APPROACH:
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│   SOURCE SYSTEM ──▶ AZURE STORAGE ──▶ SENTINEL WATCHLIST        │
│   (HR, CMDB, TI)    (CSV files)      (Auto-sync)                │
│                                                                  │
│   Benefits:                                                      │
│   • Source of truth in external system                          │
│   • Automated sync without manual intervention                   │
│   • Version control via storage versioning                       │
│   • Audit trail in source system                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘</div>

                    <h4>Watchlist API Examples</h4>
                    <div class="arch-diagram">SENTINEL WATCHLIST API
═══════════════════════════════════════════════════════════════════

GET WATCHLIST:
GET https://management.azure.com/subscriptions/{sub}/
    resourceGroups/{rg}/providers/Microsoft.OperationalInsights/
    workspaces/{workspace}/providers/Microsoft.SecurityInsights/
    watchlists/{watchlistAlias}?api-version=2023-02-01

GET WATCHLIST ITEMS:
GET .../watchlists/{watchlistAlias}/watchlistItems?api-version=2023-02-01

ADD WATCHLIST ITEM:
PUT .../watchlists/{watchlistAlias}/watchlistItems/{itemId}
{
  "properties": {
    "itemsKeyValue": {
      "IPAddress": "1.2.3.4",
      "ThreatActor": "APT29",
      "Confidence": "High"
    }
  }
}

DELETE WATCHLIST ITEM:
DELETE .../watchlists/{watchlistAlias}/watchlistItems/{itemId}

LOGIC APP: ADD TO WATCHLIST
┌─────────────────────────────────────────────────────────────────┐
│ Trigger: When threat intel received                              │
│                                                                  │
│ Action 1: Parse threat data                                      │
│ Action 2: HTTP PUT to Watchlist API                             │
│ Action 3: Log success/failure                                    │
└─────────────────────────────────────────────────────────────────┘</div>
                </div>

                <!-- Watchlist Performance -->
                <h2><i class="fas fa-tachometer-alt"></i> Performance Optimization</h2>
                <div class="config-section">
                    <div class="arch-diagram">WATCHLIST PERFORMANCE BEST PRACTICES
═══════════════════════════════════════════════════════════════════

QUERY OPTIMIZATION:

❌ SLOW - Calling _GetWatchlist multiple times:
let VIPs = _GetWatchlist('VIP_Users');
let Critical = _GetWatchlist('Critical_Assets');
Table1 | where User in (VIPs)
| join (Table2 | where Host in (Critical)) on ...

✅ FAST - Cache watchlist in let statement:
let VIPs = materialize(_GetWatchlist('VIP_Users') | project UserPrincipalName);
let Critical = materialize(_GetWatchlist('Critical_Assets') | project Hostname);
// Now use VIPs and Critical multiple times efficiently

SIZE CONSIDERATIONS:
├── &lt;10K rows: No concerns, use freely
├── 10K-100K rows: Use materialize(), limit columns
├── 100K-1M rows: Consider custom table instead
└── &gt;1M rows: Use ADX or custom log ingestion

ANALYTICS RULE OPTIMIZATION:
├── Load watchlist once at start of query
├── Project only needed columns from watchlist
├── Use 'in' operator for simple lookups
├── Use 'lookup' for enrichment (adds columns)
└── Test query performance before enabling rule

EXAMPLE - OPTIMIZED RULE:
// Load once, project only needed columns
let VIPs = materialize(
    _GetWatchlist('VIP_Users') 
    | project UserPrincipalName, VIPLevel
);
// Main detection
SigninLogs
| where TimeGenerated > ago(1h)
| where RiskLevelDuringSignIn in ("high", "medium")
| where UserPrincipalName in (VIPs)
| lookup VIPs on UserPrincipalName
| project TimeGenerated, UserPrincipalName, VIPLevel, IPAddress, RiskLevelDuringSignIn</div>
                </div>

                <!-- Common Failures -->
                <h2><i class="fas fa-exclamation-triangle"></i> What Enterprises Usually Miss</h2>
                <div class="config-section">
                    <div class="arch-diagram">COMMON WATCHLIST FAILURES AND SOLUTIONS
═══════════════════════════════════════════════════════════════════

❌ FAILURE 1: Stale Watchlist Data
   Problem: VIP list from 2 years ago, terminated employees still listed
   Impact: Missed alerts on actual VIPs, noise on ex-employees
   Solution: Automated sync with HR system, quarterly review

❌ FAILURE 2: No Expiration on Threat IOCs
   Problem: IOCs added but never removed
   Impact: Watchlist grows unbounded, FPs on sinkholed domains
   Solution: Add ExpirationDate column, filter in queries

❌ FAILURE 3: Wrong SearchKey Selection
   Problem: SearchKey not unique, duplicates in watchlist
   Impact: Query returns wrong/multiple matches
   Solution: Use truly unique identifier (UPN, IP, hash)

❌ FAILURE 4: Hardcoded Lists in Rules Instead
   Problem: IP list embedded in KQL query
   Impact: Must edit every rule to update, no consistency
   Solution: Migrate to watchlist, reference via _GetWatchlist

❌ FAILURE 5: No Watchlist Governance
   Problem: Anyone creates watchlists, no naming convention
   Impact: Duplicate/conflicting lists, confusion
   Solution: Naming standard, ownership, review process

❌ FAILURE 6: CSV Encoding Issues
   Problem: Excel saves with wrong encoding, special characters
   Impact: Upload fails or data corrupted
   Solution: Always save as UTF-8 CSV, validate before upload

❌ FAILURE 7: Not Testing Watchlist Queries
   Problem: Deploy rule without testing _GetWatchlist
   Impact: Rule fails silently, no detections
   Solution: Test query in Logs before enabling rule

❌ FAILURE 8: Ignoring Watchlist Size Limits
   Problem: Trying to upload 50M row file
   Impact: Upload fails, rule performance issues
   Solution: Use ADX or custom tables for large datasets

❌ FAILURE 9: No Backup of Watchlists
   Problem: Watchlist accidentally deleted or corrupted
   Impact: Detection gaps, manual recreation
   Solution: Export to Azure Storage, version control

❌ FAILURE 10: Using Watchlists for Dynamic Data
   Problem: Watchlist for "currently logged-in users"
   Impact: Stale data, incorrect detections
   Solution: Use real-time queries for dynamic data</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What are watchlists and when would you use them?</button>
                        <div class="qa-answer">
                            <p><strong>Watchlists</strong> are curated reference lists stored in Sentinel that can be used for enrichment, allowlisting, and correlation across analytics rules and hunting queries.</p>
                            <p style="margin-top: 12px;"><strong>Key use cases:</strong></p>
                            <ul>
                                <li><strong>VIP monitoring:</strong> Enhanced alerting for executives and high-value users</li>
                                <li><strong>Asset criticality:</strong> Prioritize alerts on critical servers/databases</li>
                                <li><strong>Allowlisting:</strong> Exclude authorized scanners, service accounts from alerts</li>
                                <li><strong>Threat IOCs:</strong> Custom threat intelligence not in built-in TI feeds</li>
                                <li><strong>Geo-fencing:</strong> List of allowed/blocked countries for access</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Key benefit:</strong> Update the watchlist once, and all rules using it automatically get the new data without redeploying rules.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you use a watchlist in a KQL detection rule?</button>
                        <div class="qa-answer">
                            <p><strong>Two main patterns:</strong></p>
                            <div class="arch-diagram" style="margin: 10px 0;">// Pattern 1: Simple lookup with 'in' operator
let VIPs = _GetWatchlist('VIP_Users') | project UserPrincipalName;
SigninLogs
| where UserPrincipalName in (VIPs)
| where RiskLevelDuringSignIn == "high"

// Pattern 2: Enrichment with 'lookup' operator
let VIPs = _GetWatchlist('VIP_Users');
SigninLogs
| where RiskLevelDuringSignIn == "high"
| lookup kind=leftouter VIPs on UserPrincipalName
| where isnotempty(VIPLevel)  // Only VIPs
| project TimeGenerated, UserPrincipalName, VIPLevel, IPAddress</div>
                            <p style="margin-top: 12px;"><strong>Best practice:</strong> Use <code>materialize()</code> when referencing the same watchlist multiple times in a query.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you keep watchlists updated automatically?</button>
                        <div class="qa-answer">
                            <p><strong>Enterprise automation approach:</strong></p>
                            <ol>
                                <li><strong>Azure Storage sync:</strong> Configure watchlist to sync from blob storage CSV, update the blob via external process</li>
                                <li><strong>Logic App integration:</strong> Build playbook that updates watchlist via REST API when source system changes</li>
                                <li><strong>Scheduled pipeline:</strong> Azure Data Factory or Power Automate exports from HR/CMDB to blob storage</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Example architecture:</strong></p>
                            <div class="arch-diagram" style="margin: 10px 0;">HR System → Azure Data Factory (daily) → Blob Storage → Sentinel Watchlist
                 └─────────────────────────────────────┘
                        Automated, no manual intervention</div>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What are the limitations of watchlists?</button>
                        <div class="qa-answer">
                            <p><strong>Key limitations to consider:</strong></p>
                            <ul>
                                <li><strong>Size:</strong> 10 million row limit (use ADX for larger)</li>
                                <li><strong>Upload:</strong> 3.8 MB max for portal upload (use Storage Account for larger)</li>
                                <li><strong>Sync delay:</strong> Storage Account sync can be 1 hour minimum</li>
                                <li><strong>Performance:</strong> Large watchlists can slow query execution</li>
                                <li><strong>No complex schema:</strong> Flat CSV structure only</li>
                                <li><strong>SearchKey:</strong> Must be unique, can't have duplicates</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>When to use alternatives:</strong></p>
                            <ul>
                                <li>>1M rows → Consider custom table or ADX</li>
                                <li>Complex relationships → Use custom tables with joins</li>
                                <li>Real-time updates needed → Use external API queries</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you implement a VIP monitoring program using watchlists?</button>
                        <div class="qa-answer">
                            <p><strong>Complete VIP monitoring implementation:</strong></p>
                            <ol>
                                <li><strong>Create VIP watchlist:</strong>
                                    <ul>
                                        <li>Columns: UserPrincipalName, DisplayName, VIPLevel (Critical/High/Medium), ProtectionTier</li>
                                        <li>Sync from HR system via Azure Storage</li>
                                    </ul>
                                </li>
                                <li><strong>Analytics rules:</strong>
                                    <ul>
                                        <li>VIP risky sign-in (lower threshold than normal users)</li>
                                        <li>VIP mailbox forwarding rule created</li>
                                        <li>VIP account disabled/deleted</li>
                                        <li>VIP password changed from unusual location</li>
                                    </ul>
                                </li>
                                <li><strong>Automation:</strong>
                                    <ul>
                                        <li>Playbook to auto-escalate VIP incidents</li>
                                        <li>Notify security leadership for Critical VIPs</li>
                                    </ul>
                                </li>
                                <li><strong>Workbook:</strong> VIP security dashboard with risk scores, recent activity, incident history</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you troubleshoot a watchlist that isn't working in a rule?</button>
                        <div class="qa-answer">
                            <p><strong>Troubleshooting checklist:</strong></p>
                            <ol>
                                <li><strong>Verify watchlist exists:</strong> <code>_GetWatchlist('WatchlistAlias') | take 10</code></li>
                                <li><strong>Check column names:</strong> Ensure exact match with query (case-sensitive)</li>
                                <li><strong>Validate data format:</strong> IP as string vs IP, dates formatted correctly</li>
                                <li><strong>Test join logic:</strong> Run query in Logs before enabling rule</li>
                                <li><strong>Check for duplicates:</strong> SearchKey must be unique</li>
                                <li><strong>Verify sync status:</strong> For Storage Account, check last sync time</li>
                            </ol>
                            <div class="arch-diagram" style="margin: 10px 0;">// Debug query - check if watchlist has expected data
_GetWatchlist('VIP_Users')
| summarize Count = count(), 
            Columns = strcat_array(array_sort_asc(columnifexists("*", "")), ", ")
| project Count, SampleColumns = Columns</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
