<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Use Cases | Microsoft Sentinel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <a href="../index.html" class="back-home"><i class="fas fa-arrow-left"></i> Nik's SIEM</a>
            
            <div class="breadcrumb">
                <a href="../index.html">Home</a>
                <span class="separator">/</span>
                <a href="index.html">Sentinel</a>
                <span class="separator">/</span>
                <span class="current">Security Use Cases</span>
            </div>

<h1><i class="fas fa-shield-alt"></i> Sentinel Security Use Cases</h1>
                <p class="lead">Production-ready KQL queries for Microsoft Sentinel covering authentication, malware, lateral movement, and more. Each query includes MITRE mapping and implementation guidance.</p>

                <!-- Authentication Monitoring -->
                <h2><i class="fas fa-sign-in-alt"></i> Authentication Monitoring</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1110</span> Brute Force Detection</h3>
                    <div class="code-block">SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0  // Failed logins
| summarize 
    FailedAttempts = count(),
    TargetedAccounts = dcount(UserPrincipalName),
    Accounts = make_set(UserPrincipalName, 10)
    by IPAddress, bin(TimeGenerated, 10m)
| where FailedAttempts > 10 or TargetedAccounts > 3
| extend AttackType = case(
    TargetedAccounts > 5 and FailedAttempts > 20, "Credential Stuffing",
    TargetedAccounts == 1 and FailedAttempts > 10, "Brute Force",
    TargetedAccounts > 1, "Password Spraying",
    "Multiple Failed Logins"
)
| project TimeGenerated, IPAddress, AttackType, FailedAttempts, TargetedAccounts, Accounts</div>
                    <p style="color: #8b949e; margin-top: 12px;"><strong>Data Source:</strong> SigninLogs (Azure AD)</p>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1078</span> Successful Login After Failures</h3>
                    <div class="code-block">let FailedLogins = SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0
| summarize FailCount = count() by IPAddress, UserPrincipalName;
let SuccessfulLogins = SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType == 0
| summarize SuccessCount = count(), LastSuccess = max(TimeGenerated) by IPAddress, UserPrincipalName;
FailedLogins
| join kind=inner SuccessfulLogins on IPAddress, UserPrincipalName
| where FailCount > 5
| project UserPrincipalName, IPAddress, FailCount, SuccessCount, LastSuccess
| extend RiskLevel = case(FailCount > 20, "High", FailCount > 10, "Medium", "Low")</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1078</span> Impossible Travel</h3>
                    <div class="code-block">SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == 0
| project TimeGenerated, UserPrincipalName, IPAddress, Location, 
          Latitude = toreal(LocationDetails.geoCoordinates.latitude),
          Longitude = toreal(LocationDetails.geoCoordinates.longitude)
| order by UserPrincipalName, TimeGenerated asc
| serialize
| extend PrevTime = prev(TimeGenerated, 1), 
         PrevLat = prev(Latitude, 1), 
         PrevLon = prev(Longitude, 1),
         PrevUser = prev(UserPrincipalName, 1)
| where UserPrincipalName == PrevUser
| extend TimeDiffHours = datetime_diff('hour', TimeGenerated, PrevTime)
| extend DistanceKm = geo_distance_2points(Longitude, Latitude, PrevLon, PrevLat) / 1000
| where TimeDiffHours > 0
| extend SpeedKmH = DistanceKm / TimeDiffHours
| where SpeedKmH > 800 and DistanceKm > 500
| project TimeGenerated, UserPrincipalName, DistanceKm, TimeDiffHours, SpeedKmH</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1078</span> Off-Hours Sign-in</h3>
                    <div class="code-block">SigninLogs
| where TimeGenerated > ago(7d)
| where ResultType == 0
| extend HourOfDay = datetime_part("hour", TimeGenerated)
| extend DayOfWeek = dayofweek(TimeGenerated)
| where (HourOfDay < 6 or HourOfDay > 20) or (DayOfWeek == 0d or DayOfWeek == 6d)
| extend TimeContext = case(
    DayOfWeek == 0d or DayOfWeek == 6d, "Weekend",
    HourOfDay < 6, "Early Morning",
    HourOfDay > 20, "Late Night",
    "Unknown"
)
| summarize Count = count() by UserPrincipalName, AppDisplayName, TimeContext
| order by Count desc</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1078</span> First-Time User Login to Application</h3>
                    <div class="code-block">let LookbackPeriod = 30d;
let RecentLogins = SigninLogs
| where TimeGenerated > ago(1d)
| where ResultType == 0
| distinct UserPrincipalName, AppDisplayName, TimeGenerated;
let HistoricalLogins = SigninLogs
| where TimeGenerated between (ago(LookbackPeriod) .. ago(1d))
| where ResultType == 0
| distinct UserPrincipalName, AppDisplayName;
RecentLogins
| join kind=leftanti HistoricalLogins on UserPrincipalName, AppDisplayName
| project TimeGenerated, UserPrincipalName, AppDisplayName
| extend AlertReason = "First time user accessed this application"</div>
                </div>

                <!-- Malware and Execution -->
                <h2><i class="fas fa-bug"></i> Malware & Execution Detection</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1059.001</span> PowerShell Encoded Commands</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any ("-enc", "-EncodedCommand", "-e ")
| extend EncodedPart = extract(@"-[eE]nc(?:odedCommand)?\s+([A-Za-z0-9+/=]+)", 1, ProcessCommandLine)
| where strlen(EncodedPart) > 100
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine, 
          InitiatingProcessFileName, EncodedLength = strlen(EncodedPart)
| order by EncodedLength desc</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1059.001</span> PowerShell Download Cradle</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any (
    "Net.WebClient", "DownloadString", "DownloadFile",
    "Invoke-WebRequest", "iwr ", "wget ", "curl ",
    "Start-BitsTransfer", "Invoke-RestMethod"
)
| extend URL = extract(@"(https?://[^\s'\"]+)", 1, ProcessCommandLine)
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine, URL,
          InitiatingProcessFileName</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1218</span> LOLBin Abuse</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName in~ ("certutil.exe", "mshta.exe", "regsvr32.exe", 
                      "rundll32.exe", "msiexec.exe", "cmstp.exe",
                      "wmic.exe", "installutil.exe", "regasm.exe")
| where ProcessCommandLine has_any ("http", "ftp", "\\\\", "-decode", "/i:", "scrobj")
| extend Technique = case(
    FileName =~ "certutil.exe", "Certutil download/decode",
    FileName =~ "mshta.exe", "MSHTA script execution",
    FileName =~ "regsvr32.exe", "Regsvr32 COM scriptlet",
    FileName =~ "wmic.exe", "WMIC remote execution",
    "LOLBin abuse"
)
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine, 
          Technique, InitiatingProcessFileName</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1059</span> Office Application Spawning Shell</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where InitiatingProcessFileName in~ ("WINWORD.EXE", "EXCEL.EXE", "POWERPNT.EXE", 
                                        "OUTLOOK.EXE", "MSACCESS.EXE")
| where FileName in~ ("cmd.exe", "powershell.exe", "wscript.exe", 
                      "cscript.exe", "mshta.exe", "regsvr32.exe")
| project TimeGenerated, DeviceName, AccountName, 
          InitiatingProcessFileName, FileName, ProcessCommandLine</div>
                </div>

                <!-- Lateral Movement -->
                <h2><i class="fas fa-arrows-alt"></i> Lateral Movement</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1021.001</span> RDP Connection Monitoring</h3>
                    <div class="code-block">SecurityEvent
| where TimeGenerated > ago(1d)
| where EventID == 4624 and LogonType == 10
| summarize 
    ConnectionCount = count(),
    UniqueSourceIPs = dcount(IpAddress),
    SourceIPs = make_set(IpAddress, 10)
    by TargetUserName, Computer
| where ConnectionCount > 10 or UniqueSourceIPs > 5
| project TargetUserName, Computer, ConnectionCount, UniqueSourceIPs, SourceIPs</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1021.002</span> SMB Lateral Movement</h3>
                    <div class="code-block">DeviceNetworkEvents
| where TimeGenerated > ago(1d)
| where RemotePort == 445
| where not(ipv4_is_private(RemoteIP) == false)
| summarize 
    UniqueTargets = dcount(RemoteIP),
    Targets = make_set(RemoteIP, 20),
    ConnectionCount = count()
    by DeviceName, InitiatingProcessFileName
| where UniqueTargets > 5
| extend AlertLevel = case(
    UniqueTargets > 20, "Critical",
    UniqueTargets > 10, "High",
    "Medium"
)
| order by UniqueTargets desc</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1047</span> WMI Remote Execution</h3>
                    <div class="code-block">// WMI remote command
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName =~ "wmic.exe"
| where ProcessCommandLine has "/node:"
| extend TargetHost = extract(@"/node:(\S+)", 1, ProcessCommandLine)
| project TimeGenerated, DeviceName, AccountName, TargetHost, ProcessCommandLine

// WMI spawning processes
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where InitiatingProcessFileName =~ "WmiPrvSE.exe"
| where FileName in~ ("cmd.exe", "powershell.exe", "cscript.exe", "wscript.exe")
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1021.006</span> Windows Remote Management</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where InitiatingProcessFileName =~ "wsmprovhost.exe"
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine
| order by TimeGenerated desc</div>
                </div>

                <!-- Persistence -->
                <h2><i class="fas fa-anchor"></i> Persistence Detection</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1547.001</span> Registry Run Key Modification</h3>
                    <div class="code-block">DeviceRegistryEvents
| where TimeGenerated > ago(1d)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any (@"\CurrentVersion\Run", @"\CurrentVersion\RunOnce")
| where not(RegistryValueData has_any ("Microsoft", "Windows", "VMware", "CrowdStrike"))
| project TimeGenerated, DeviceName, InitiatingProcessAccountName,
          RegistryKey, RegistryValueName, RegistryValueData,
          InitiatingProcessFileName</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1053.005</span> Scheduled Task Creation</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName =~ "schtasks.exe"
| where ProcessCommandLine has "/create"
| extend TaskName = extract(@"/tn\s+[\"']?([^\"'/]+)", 1, ProcessCommandLine)
| extend TaskAction = extract(@"/tr\s+[\"']?([^\"']+)", 1, ProcessCommandLine)
| where not(TaskName has_any ("Microsoft", "Windows", "Adobe", "Google"))
| project TimeGenerated, DeviceName, AccountName, TaskName, TaskAction, ProcessCommandLine

// Also check Security Events
SecurityEvent
| where TimeGenerated > ago(1d)
| where EventID == 4698
| project TimeGenerated, Computer, SubjectUserName, TaskName, TaskContent</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1543.003</span> Service Creation</h3>
                    <div class="code-block">SecurityEvent
| where TimeGenerated > ago(1d)
| where EventID == 4697
| where not(ServiceFileName has_any ("Microsoft", "Windows", "System32"))
| project TimeGenerated, Computer, SubjectUserName, ServiceName, 
          ServiceFileName, ServiceType

// Via sc.exe
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName =~ "sc.exe"
| where ProcessCommandLine has "create"
| extend ServicePath = extract(@"binPath=\s*[\"']?([^\"']+)", 1, ProcessCommandLine)
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine, ServicePath</div>
                </div>

                <!-- Credential Access -->
                <h2><i class="fas fa-key"></i> Credential Access</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1003.001</span> LSASS Memory Access</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName in~ ("procdump.exe", "procdump64.exe", "mimikatz.exe", 
                      "nanodump.exe", "sqldumper.exe")
| where ProcessCommandLine has_any ("lsass", "-ma", "sekurlsa")
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine

// comsvcs.dll MiniDump
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName =~ "rundll32.exe"
| where ProcessCommandLine has "comsvcs.dll" and ProcessCommandLine has "MiniDump"
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1558.003</span> Kerberoasting</h3>
                    <div class="code-block">SecurityEvent
| where TimeGenerated > ago(1d)
| where EventID == 4769
| where TicketEncryptionType == "0x17"  // RC4
| summarize RequestCount = count() by IpAddress, ServiceName, TargetUserName
| where RequestCount > 5
| order by RequestCount desc</div>
                </div>

                <!-- Data Exfiltration -->
                <h2><i class="fas fa-cloud-upload-alt"></i> Data Exfiltration</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1048</span> Large Data Transfer</h3>
                    <div class="code-block">DeviceNetworkEvents
| where TimeGenerated > ago(1d)
| where not(ipv4_is_private(RemoteIP))
| summarize TotalBytes = sum(SentBytes) by DeviceName, RemoteIP, bin(TimeGenerated, 1h)
| where TotalBytes > 104857600  // 100MB
| extend MBTransferred = round(TotalBytes / 1048576.0, 2)
| order by MBTransferred desc</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1567</span> Cloud Storage Upload</h3>
                    <div class="code-block">// Web proxy or firewall logs
CommonSecurityLog
| where TimeGenerated > ago(1d)
| where RequestURL has_any ("dropbox.com", "drive.google.com", "onedrive.live.com",
                            "mega.nz", "box.com", "wetransfer.com")
| where RequestMethod in ("POST", "PUT")
| summarize TotalBytes = sum(SentBytes), UploadCount = count() 
            by SourceIP, SourceUserName, RequestURL
| where TotalBytes > 10485760  // 10MB
| extend MBUploaded = round(TotalBytes / 1048576.0, 2)</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1041</span> DNS Tunneling Detection</h3>
                    <div class="code-block">DnsEvents
| where TimeGenerated > ago(1d)
| extend QueryLength = strlen(Name)
| where QueryLength > 50
| extend Domain = tostring(split(Name, ".")[-2]) + "." + tostring(split(Name, ".")[-1])
| summarize 
    QueryCount = count(),
    AvgLength = avg(QueryLength),
    UniqueQueries = dcount(Name)
    by ClientIP, Domain
| where QueryCount > 100 and AvgLength > 40
| extend Suspicion = case(
    AvgLength > 60 and UniqueQueries > 1000, "High - Likely DNS Tunnel",
    AvgLength > 50, "Medium - Investigate",
    "Low"
)</div>
                </div>

                <!-- Defense Evasion -->
                <h2><i class="fas fa-eye-slash"></i> Defense Evasion</h2>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1070.001</span> Security Log Cleared</h3>
                    <div class="code-block">SecurityEvent
| where TimeGenerated > ago(1d)
| where EventID == 1102
| project TimeGenerated, Computer, SubjectUserName, SubjectDomainName

// Via command line
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName =~ "wevtutil.exe"
| where ProcessCommandLine has_any ("cl", "clear-log")
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1562.001</span> Security Tool Tampering</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where ProcessCommandLine has_any (
    "Set-MpPreference", "DisableRealtimeMonitoring",
    "sc stop WinDefend", "net stop WinDefend"
)
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine</div>
                </div>

                <div class="usecase-card">
                    <h3><span class="mitre-tag">T1036</span> Process Masquerading</h3>
                    <div class="code-block">DeviceProcessEvents
| where TimeGenerated > ago(1d)
| where FileName in~ ("cmd.exe", "powershell.exe", "svchost.exe", 
                      "lsass.exe", "csrss.exe", "services.exe")
| where not(FolderPath has_any (@"C:\Windows\System32", @"C:\Windows\SysWOW64"))
| project TimeGenerated, DeviceName, FileName, FolderPath, ProcessCommandLine</div>
                </div>

                <!-- Azure AD Specific -->
                <h2><i class="fas fa-cloud"></i> Azure AD Security</h2>

                <div class="usecase-card">
                    <h3>Risky Sign-in Detection</h3>
                    <div class="code-block">SigninLogs
| where TimeGenerated > ago(1d)
| where RiskLevelDuringSignIn in ("high", "medium")
| project TimeGenerated, UserPrincipalName, IPAddress, Location,
          RiskLevelDuringSignIn, RiskState, AppDisplayName, 
          ConditionalAccessStatus
| order by RiskLevelDuringSignIn</div>
                </div>

                <div class="usecase-card">
                    <h3>New App Consent Granted</h3>
                    <div class="code-block">AuditLogs
| where TimeGenerated > ago(7d)
| where OperationName == "Consent to application"
| extend AppName = tostring(TargetResources[0].displayName)
| extend UserWhoConsented = tostring(InitiatedBy.user.userPrincipalName)
| project TimeGenerated, AppName, UserWhoConsented, 
          TargetResources, AdditionalDetails</div>
                </div>

                <div class="usecase-card">
                    <h3>Privileged Role Assignment</h3>
                    <div class="code-block">AuditLogs
| where TimeGenerated > ago(1d)
| where OperationName has "Add member to role"
| extend RoleName = tostring(TargetResources[0].displayName)
| extend UserAdded = tostring(TargetResources[1].userPrincipalName)
| extend AddedBy = tostring(InitiatedBy.user.userPrincipalName)
| where RoleName has_any ("Global Administrator", "Security Administrator", 
                          "Privileged Role Administrator", "Exchange Administrator")
| project TimeGenerated, RoleName, UserAdded, AddedBy</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you correlate Azure AD and endpoint data in Sentinel?</button>
                        <div class="qa-answer">
                            <div class="code-block">// Join SigninLogs with DeviceProcessEvents
let SuspiciousLogins = SigninLogs
| where TimeGenerated > ago(1d)
| where RiskLevelDuringSignIn == "high"
| project LoginTime = TimeGenerated, UserPrincipalName, IPAddress;
DeviceProcessEvents
| where TimeGenerated > ago(1d)
| join kind=inner SuspiciousLogins on $left.AccountUpn == $right.UserPrincipalName
| where TimeGenerated between (LoginTime .. (LoginTime + 1h))
| project TimeGenerated, DeviceName, AccountUpn, FileName, ProcessCommandLine</div>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you detect credential theft in Sentinel?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>LSASS access:</strong> Monitor for tools accessing lsass.exe</li>
                                <li><strong>Kerberoasting:</strong> Look for RC4 ticket requests (Event 4769)</li>
                                <li><strong>DCSync:</strong> Replication requests from non-DCs</li>
                                <li><strong>Mimikatz patterns:</strong> Known command line patterns</li>
                                <li><strong>SAM/NTDS access:</strong> File access to credential stores</li>
                            </ul>
                        </div>
                    </div>
                </div>

        </main>
    </div>
    <script>
        // Q&A toggle functionality
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) { answer.style.display = 'block'; }
            });
        });
    </script>
</body>
</html>