<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="sentinel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Advanced | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>

            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel active"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
<nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-connectors.html" class="nav-link"><i class="fas fa-plug"></i> Data Connectors</a>
                    <a href="dcr-dce-guide.html" class="nav-link"><i class="fas fa-cogs"></i> DCR & DCE Deep Dive</a>
                    <a href="event-hub.html" class="nav-link"><i class="fas fa-broadcast-tower"></i> Event Hub Integration</a>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion & Cost</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">KQL Query Language</div>
                    <a href="kql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> KQL Fundamentals</a>
                    <a href="kql-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> KQL Intermediate</a>
                    <a href="kql-advanced.html" class="nav-link active"><i class="fas fa-code"></i> Advanced KQL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="analytics-rules.html" class="nav-link"><i class="fas fa-bell"></i> Analytics Rules</a>
                    <a href="automation.html" class="nav-link"><i class="fas fa-robot"></i> Automation</a>
                    <a href="workbooks.html" class="nav-link"><i class="fas fa-chart-bar"></i> Workbooks</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Content & Intelligence</div>
                    <a href="content-hub.html" class="nav-link"><i class="fas fa-cube"></i> Content Hub & ASIM</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users-cog"></i> SOC Operations</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">KQL Advanced</span>
                </div>
                <div class="top-actions">
                    <button class="top-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <section class="content-section">

<div class="breadcrumb"><a href="index.html">Home</a><span class="separator">/</span><a href="index.html">Microsoft Sentinel</a><span class="separator">/</span><span>KQL Advanced</span></div>
<div class="page-header">
    <h1><i class="fab fa-microsoft" style="color: #0078d4;"></i> KQL Advanced</h1>
    <p class="lead">Master advanced KQL techniques including parsing, custom functions, performance optimization, and complex detection patterns.</p>
</div>

<h2>String Parsing</h2>
<p>Extract structured data from unstructured strings using parse operators.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Parse Examples</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// parse - extract values from structured strings</span>
<span class="table">SecurityEvent</span>
| <span class="keyword">where</span> EventID == <span class="number">4688</span>
| <span class="keyword">parse</span> CommandLine <span class="keyword">with</span> * <span class="string">"-enc "</span> EncodedCommand
| <span class="keyword">where</span> <span class="function">isnotempty</span>(EncodedCommand)

<span class="comment">// parse_json - parse JSON strings</span>
<span class="table">AuditLogs</span>
| <span class="keyword">extend</span> ModifiedProperties = <span class="function">parse_json</span>(tostring(TargetResources[<span class="number">0</span>].modifiedProperties))

<span class="comment">// parse_url - extract URL components</span>
<span class="table">UrlClickEvents</span>
| <span class="keyword">extend</span> UrlParts = <span class="function">parse_url</span>(Url)
| <span class="keyword">extend</span> 
    Host = tostring(UrlParts.Host),
    Path = tostring(UrlParts.Path),
    Query = tostring(UrlParts.Query)

<span class="comment">// extract with regex</span>
<span class="table">SecurityEvent</span>
| <span class="keyword">extend</span> IPAddress = <span class="function">extract</span>(<span class="string">@"(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"</span>, <span class="number">1</span>, CommandLine)

<span class="comment">// split - break string into array</span>
<span class="table">SigninLogs</span>
| <span class="keyword">extend</span> Domain = tostring(<span class="function">split</span>(UserPrincipalName, <span class="string">"@"</span>)[<span class="number">1</span>])</code></pre>
    </div>
</div>

<h2>User-Defined Functions</h2>
<p>Create reusable functions for common operations.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Functions</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Scalar function (returns single value)</span>
<span class="keyword">let</span> GetDomain = (upn:string) {
    tostring(<span class="function">split</span>(upn, <span class="string">"@"</span>)[<span class="number">1</span>])
};
<span class="table">SigninLogs</span>
| <span class="keyword">extend</span> Domain = GetDomain(UserPrincipalName)

<span class="comment">// Tabular function (returns table)</span>
<span class="keyword">let</span> GetUserSignins = (user:string, lookback:timespan) {
    <span class="table">SigninLogs</span>
    | <span class="keyword">where</span> TimeGenerated > ago(lookback)
    | <span class="keyword">where</span> UserPrincipalName =~ user
};
GetUserSignins(<span class="string">"user@company.com"</span>, <span class="number">7d</span>)
| <span class="keyword">summarize</span> <span class="function">count</span>() <span class="keyword">by</span> ResultType

<span class="comment">// Decode base64</span>
<span class="keyword">let</span> DecodeBase64 = (encoded:string) {
    <span class="function">base64_decode_tostring</span>(encoded)
};
<span class="table">DeviceProcessEvents</span>
| <span class="keyword">where</span> ProcessCommandLine has <span class="string">"-enc"</span>
| <span class="keyword">parse</span> ProcessCommandLine <span class="keyword">with</span> * <span class="string">"-enc "</span> EncodedPart
| <span class="keyword">extend</span> DecodedCommand = DecodeBase64(EncodedPart)</code></pre>
    </div>
</div>

<h2>mv-expand and mv-apply</h2>
<p>Work with arrays and dynamic data.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Array Operations</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// mv-expand - expand array to rows</span>
<span class="table">SecurityEvent</span>
| <span class="keyword">where</span> EventID == <span class="number">4688</span>
| <span class="keyword">take</span> <span class="number">10</span>
| <span class="keyword">extend</span> CommandParts = <span class="function">split</span>(CommandLine, <span class="string">" "</span>)
| <span class="keyword">mv-expand</span> CommandParts
| <span class="keyword">project</span> TimeGenerated, CommandParts

<span class="comment">// mv-apply - apply operations to each array element</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1d</span>)
| <span class="keyword">summarize</span> IPs = <span class="function">make_set</span>(IPAddress) <span class="keyword">by</span> UserPrincipalName
| <span class="keyword">mv-apply</span> IP = IPs <span class="keyword">to typeof</span>(string) <span class="keyword">on</span> (
    <span class="keyword">summarize</span> IPCount = <span class="function">count</span>()
)

<span class="comment">// Working with JSON arrays</span>
<span class="table">AuditLogs</span>
| <span class="keyword">where</span> OperationName == <span class="string">"Update user"</span>
| <span class="keyword">mv-expand</span> TargetResources
| <span class="keyword">mv-expand</span> ModifiedProperty = TargetResources.modifiedProperties
| <span class="keyword">extend</span> PropertyName = tostring(ModifiedProperty.displayName)</code></pre>
    </div>
</div>

<h2>Performance Optimization</h2>
<div class="info-box tip">
    <div class="info-box-title"><i class="fas fa-lightbulb"></i> Performance Best Practices</div>
    <ul style="margin: 0.5rem 0 0 1rem;">
        <li><strong>Always filter by time first</strong> - TimeGenerated filter should be the first where clause</li>
        <li><strong>Use has instead of contains</strong> - <code>has</code> uses indexes, <code>contains</code> does full scan</li>
        <li><strong>Avoid regex when possible</strong> - Regex is slow; use has/startswith/endswith</li>
        <li><strong>Project early</strong> - Remove unneeded columns early to reduce data volume</li>
        <li><strong>Use materialize</strong> - Cache subquery results used multiple times</li>
        <li><strong>Limit join size</strong> - Filter tables before joining</li>
    </ul>
</div>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Optimized Query</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// BAD - slow query</span>
<span class="table">SecurityEvent</span>
| <span class="keyword">where</span> CommandLine contains <span class="string">"mimikatz"</span>  <span class="comment">// Contains is slow</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)  <span class="comment">// Time filter should be first</span>

<span class="comment">// GOOD - optimized query</span>
<span class="table">SecurityEvent</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)  <span class="comment">// Time filter first</span>
| <span class="keyword">where</span> CommandLine has <span class="string">"mimikatz"</span>  <span class="comment">// has uses index</span>

<span class="comment">// materialize for subquery reuse</span>
<span class="keyword">let</span> RiskyUsers = <span class="function">materialize</span>(
    <span class="table">SigninLogs</span>
    | <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1d</span>)
    | <span class="keyword">where</span> RiskState == <span class="string">"atRisk"</span>
    | <span class="keyword">distinct</span> UserPrincipalName
);
<span class="function">union</span>
    (<span class="table">OfficeActivity</span> | <span class="keyword">where</span> UserId in (RiskyUsers)),
    (<span class="table">AuditLogs</span> | <span class="keyword">where</span> InitiatedBy.user.userPrincipalName in (RiskyUsers))</code></pre>
    </div>
</div>

<h2>Complex Detection Patterns</h2>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Beaconing Detection</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Detect regular interval connections (C2 beaconing)</span>
<span class="table">DeviceNetworkEvents</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">where</span> ActionType == <span class="string">"ConnectionSuccess"</span>
| <span class="keyword">summarize</span> 
    ConnectionCount = <span class="function">count</span>(),
    Timestamps = <span class="function">make_list</span>(TimeGenerated)
    <span class="keyword">by</span> DeviceName, RemoteIP
| <span class="keyword">where</span> ConnectionCount > <span class="number">20</span>
| <span class="keyword">mv-apply</span> Timestamps <span class="keyword">to typeof</span>(datetime) <span class="keyword">on</span> (
    <span class="keyword">order by</span> Timestamps <span class="keyword">asc</span>
    | <span class="keyword">extend</span> NextTime = <span class="function">next</span>(Timestamps)
    | <span class="keyword">extend</span> Interval = <span class="function">datetime_diff</span>(<span class="string">'second'</span>, NextTime, Timestamps)
    | <span class="keyword">summarize</span> 
        AvgInterval = <span class="function">avg</span>(Interval),
        StdDevInterval = <span class="function">stdev</span>(Interval)
)
| <span class="keyword">where</span> StdDevInterval < <span class="number">60</span>  <span class="comment">// Low variance = regular beaconing</span>
| <span class="keyword">where</span> AvgInterval between (<span class="number">30</span> .. <span class="number">3600</span>)</code></pre>
    </div>
</div>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Password Spray Detection</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Detect password spray: many users, few attempts each, same IP</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1h</span>)
| <span class="keyword">where</span> ResultType == <span class="string">"50126"</span>  <span class="comment">// Invalid password</span>
| <span class="keyword">summarize</span> 
    TargetedUsers = <span class="function">dcount</span>(UserPrincipalName),
    UserList = <span class="function">make_set</span>(UserPrincipalName, <span class="number">100</span>),
    AttemptsPerUser = <span class="function">count</span>() / <span class="function">dcount</span>(UserPrincipalName),
    TotalAttempts = <span class="function">count</span>()
    <span class="keyword">by</span> IPAddress
| <span class="keyword">where</span> TargetedUsers > <span class="number">10</span>  <span class="comment">// Many users</span>
| <span class="keyword">where</span> AttemptsPerUser < <span class="number">3</span>  <span class="comment">// Few attempts per user</span></code></pre>
    </div>
</div>

<h2>Working with Watchlists</h2>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Watchlist Queries</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Get watchlist data</span>
<span class="keyword">let</span> VIPUsers = <span class="table">_GetWatchlist</span>(<span class="string">'VIPUsers'</span>) | <span class="keyword">project</span> UserPrincipalName;
<span class="keyword">let</span> KnownBadIPs = <span class="table">_GetWatchlist</span>(<span class="string">'ThreatIntelIPs'</span>) | <span class="keyword">project</span> IPAddress;

<span class="comment">// Use watchlist in query</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">where</span> UserPrincipalName in (VIPUsers)
| <span class="keyword">where</span> IPAddress in (KnownBadIPs)</code></pre>
    </div>
</div>

<h2>Next Steps</h2>
<ul>
    <li><a href="analytics-rules.html">Analytics Rules</a> - Build detections from your queries</li>
    <li><a href="index.html">Detection Engineering</a> - Complete detection lifecycle</li>
</ul>

                </section>
            
                <section class="content-section">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>How would you detect anomalies using KQL?</span>
                        </div>
                        <div class="interview-answer">
                            <p>KQL has several built-in functions for anomaly detection. The main ones are <strong>series_decompose_anomalies</strong> and the <strong>arg_max/arg_min</strong> patterns for statistical outliers.</p>
                            <p>For time-series anomalies, you create a series with make-series, then apply decomposition: <code>| make-series count() on TimeGenerated step 1h | extend anomalies = series_decompose_anomalies(count_)</code></p>
                            <p>For statistical outliers, calculate baseline statistics and flag deviations: <code>| summarize avg_count = avg(count_), stdev_count = stdev(count_) by user | extend threshold = avg_count + (3 * stdev_count) | where count_ > threshold</code></p>
                            <p>Sentinel also has built-in UEBA that does behavioral anomaly detection automatically - you can query the BehaviorAnalytics table for anomalous activities it's detected.</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Microsoft Sentinel Guide</p>
                    <p>Personal Reference Guide</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>