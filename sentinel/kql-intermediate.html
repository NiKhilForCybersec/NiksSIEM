<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="sentinel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Intermediate | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>

            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel active"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
<nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-connectors.html" class="nav-link"><i class="fas fa-plug"></i> Data Connectors</a>
                    <a href="dcr-dce-guide.html" class="nav-link"><i class="fas fa-cogs"></i> DCR & DCE Deep Dive</a>
                    <a href="event-hub.html" class="nav-link"><i class="fas fa-broadcast-tower"></i> Event Hub Integration</a>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion & Cost</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">KQL Query Language</div>
                    <a href="kql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> KQL Fundamentals</a>
                    <a href="kql-intermediate.html" class="nav-link active"><i class="fas fa-layer-group"></i> KQL Intermediate</a>
                    <a href="kql-advanced.html" class="nav-link"><i class="fas fa-code"></i> Advanced KQL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="analytics-rules.html" class="nav-link"><i class="fas fa-bell"></i> Analytics Rules</a>
                    <a href="automation.html" class="nav-link"><i class="fas fa-robot"></i> Automation</a>
                    <a href="workbooks.html" class="nav-link"><i class="fas fa-chart-bar"></i> Workbooks</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Content & Intelligence</div>
                    <a href="content-hub.html" class="nav-link"><i class="fas fa-cube"></i> Content Hub & ASIM</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users-cog"></i> SOC Operations</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">KQL Intermediate</span>
                </div>
                <div class="top-actions">
                    <button class="top-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <section class="content-section">

<div class="breadcrumb"><a href="index.html">Home</a><span class="separator">/</span><a href="index.html">Microsoft Sentinel</a><span class="separator">/</span><span>KQL Intermediate</span></div>
<div class="page-header">
    <h1><i class="fab fa-microsoft" style="color: #0078d4;"></i> KQL Intermediate</h1>
    <p class="lead">Level up your KQL skills with joins, subqueries, let statements, and advanced aggregations for complex security analysis.</p>
</div>

<h2>The let Statement</h2>
<p>The <code>let</code> statement defines variables and subqueries for reuse within your query.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> let Examples</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Define simple variables</span>
<span class="keyword">let</span> TimeRange = <span class="number">7d</span>;
<span class="keyword">let</span> TargetUser = <span class="string">"user@company.com"</span>;
<span class="keyword">let</span> FailureThreshold = <span class="number">10</span>;

<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(TimeRange)
| <span class="keyword">where</span> UserPrincipalName =~ TargetUser

<span class="comment">// Define a list</span>
<span class="keyword">let</span> SuspiciousCountries = <span class="keyword">dynamic</span>([<span class="string">"RU"</span>, <span class="string">"CN"</span>, <span class="string">"KP"</span>, <span class="string">"IR"</span>]);
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">extend</span> Country = tostring(LocationDetails.countryOrRegion)
| <span class="keyword">where</span> Country in (SuspiciousCountries)

<span class="comment">// Define a subquery (tabular)</span>
<span class="keyword">let</span> FailedUsers = 
    <span class="table">SigninLogs</span>
    | <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1h</span>)
    | <span class="keyword">where</span> ResultType != <span class="string">"0"</span>
    | <span class="keyword">summarize</span> Failures = <span class="function">count</span>() <span class="keyword">by</span> UserPrincipalName
    | <span class="keyword">where</span> Failures > <span class="number">5</span>
    | <span class="keyword">project</span> UserPrincipalName;

<span class="comment">// Use the subquery</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1h</span>)
| <span class="keyword">where</span> UserPrincipalName in (FailedUsers)
| <span class="keyword">where</span> ResultType == <span class="string">"0"</span>  <span class="comment">// Successful after failures</span></code></pre>
    </div>
</div>

<h2>Joins</h2>
<p>Joins combine data from multiple tables based on matching columns.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Join Examples</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Inner join - only matching rows</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">where</span> ResultType == <span class="string">"0"</span>
| <span class="keyword">join</span> <span class="keyword">kind</span>=inner (
    <span class="table">AuditLogs</span>
    | <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
    | <span class="keyword">where</span> OperationName == <span class="string">"Add member to role"</span>
) <span class="keyword">on</span> $left.UserPrincipalName == $right.InitiatedBy.user.userPrincipalName

<span class="comment">// Left outer join - all rows from left, matching from right</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">join</span> <span class="keyword">kind</span>=leftouter (
    <span class="table">IdentityInfo</span>
    | <span class="keyword">project</span> AccountUPN, Department, JobTitle
) <span class="keyword">on</span> $left.UserPrincipalName == $right.AccountUPN

<span class="comment">// Anti join - rows in left NOT in right</span>
<span class="keyword">let</span> KnownGoodIPs = 
    <span class="table">_GetWatchlist</span>(<span class="string">'AllowedIPs'</span>) 
    | <span class="keyword">project</span> IPAddress;

<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">join</span> <span class="keyword">kind</span>=leftanti (KnownGoodIPs) <span class="keyword">on</span> IPAddress</code></pre>
    </div>
</div>

<h3>Join Types</h3>
<table>
    <thead><tr><th>Type</th><th>Description</th><th>Use Case</th></tr></thead>
    <tbody>
        <tr><td><code>inner</code></td><td>Only matching rows from both</td><td>Correlate events that must exist in both tables</td></tr>
        <tr><td><code>leftouter</code></td><td>All left rows, matching right</td><td>Enrich data while keeping all original rows</td></tr>
        <tr><td><code>rightouter</code></td><td>All right rows, matching left</td><td>Less common, opposite of leftouter</td></tr>
        <tr><td><code>fullouter</code></td><td>All rows from both</td><td>Combine data keeping everything</td></tr>
        <tr><td><code>leftanti</code></td><td>Left rows NOT in right</td><td>Find events not in allow list</td></tr>
        <tr><td><code>leftsemi</code></td><td>Left rows that ARE in right</td><td>Filter to matching only (no right columns)</td></tr>
    </tbody>
</table>

<h2>Union</h2>
<p>The <code>union</code> operator combines rows from multiple tables or queries.</p>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Union Examples</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Combine multiple tables</span>
<span class="function">union</span> <span class="table">SigninLogs</span>, <span class="table">AADNonInteractiveUserSignInLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">where</span> UserPrincipalName =~ <span class="string">"user@company.com"</span>

<span class="comment">// Union with wildcard (all tables matching pattern)</span>
<span class="function">union</span> <span class="table">Device*</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1h</span>)
| <span class="keyword">where</span> DeviceName =~ <span class="string">"WORKSTATION01"</span>
| <span class="keyword">summarize</span> <span class="function">count</span>() <span class="keyword">by</span> Type

<span class="comment">// Union with isfuzzy (ignore missing tables)</span>
<span class="function">union</span> isfuzzy=true <span class="table">SigninLogs</span>, <span class="table">CustomSecurityLog_CL</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)</code></pre>
    </div>
</div>

<h2>Advanced Aggregations</h2>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Advanced Aggregations</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// arg_max - row with maximum value</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)
| <span class="keyword">summarize</span> <span class="function">arg_max</span>(TimeGenerated, *) <span class="keyword">by</span> UserPrincipalName

<span class="comment">// Percentiles</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)
| <span class="keyword">summarize</span> <span class="function">percentiles</span>(DurationMs, <span class="number">50</span>, <span class="number">90</span>, <span class="number">99</span>)

<span class="comment">// make_set with limit</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">summarize</span> IPAddresses = <span class="function">make_set</span>(IPAddress, <span class="number">100</span>) <span class="keyword">by</span> UserPrincipalName

<span class="comment">// bag_pack - create JSON object</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">summarize</span> Details = <span class="function">bag_pack</span>(
    <span class="string">"TotalCount"</span>, <span class="function">count</span>(),
    <span class="string">"SuccessCount"</span>, <span class="function">countif</span>(ResultType == <span class="string">"0"</span>),
    <span class="string">"FailCount"</span>, <span class="function">countif</span>(ResultType != <span class="string">"0"</span>)
) <span class="keyword">by</span> UserPrincipalName</code></pre>
    </div>
</div>

<h2>Row Operations</h2>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Row Operations</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// prev() - access previous row value</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)
| <span class="keyword">where</span> UserPrincipalName =~ <span class="string">"user@company.com"</span>
| <span class="keyword">order by</span> TimeGenerated <span class="keyword">asc</span>
| <span class="keyword">extend</span> PreviousIP = <span class="function">prev</span>(IPAddress)
| <span class="keyword">where</span> IPAddress != PreviousIP

<span class="comment">// next() - access next row value</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">7d</span>)
| <span class="keyword">order by</span> TimeGenerated <span class="keyword">asc</span>
| <span class="keyword">extend</span> NextEventTime = <span class="function">next</span>(TimeGenerated)
| <span class="keyword">extend</span> TimeBetweenEvents = <span class="function">datetime_diff</span>(<span class="string">'second'</span>, NextEventTime, TimeGenerated)

<span class="comment">// row_number() - add sequential numbers</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">order by</span> TimeGenerated <span class="keyword">desc</span>
| <span class="keyword">extend</span> RowNum = <span class="function">row_number</span>()</code></pre>
    </div>
</div>

<h2>Practical Examples</h2>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Detect Impossible Travel</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Detect impossible travel for all users</span>
<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">24h</span>)
| <span class="keyword">where</span> ResultType == <span class="string">"0"</span>
| <span class="keyword">extend</span> Country = tostring(LocationDetails.countryOrRegion)
| <span class="keyword">order by</span> UserPrincipalName, TimeGenerated <span class="keyword">asc</span>
| <span class="keyword">extend</span> 
    PrevCountry = <span class="function">prev</span>(Country, <span class="number">1</span>, <span class="string">""</span>),
    PrevUser = <span class="function">prev</span>(UserPrincipalName, <span class="number">1</span>, <span class="string">""</span>),
    PrevTime = <span class="function">prev</span>(TimeGenerated)
| <span class="keyword">where</span> UserPrincipalName == PrevUser
| <span class="keyword">where</span> Country != PrevCountry
| <span class="keyword">extend</span> MinutesBetween = <span class="function">datetime_diff</span>(<span class="string">'minute'</span>, TimeGenerated, PrevTime)
| <span class="keyword">where</span> MinutesBetween < <span class="number">120</span>
| <span class="keyword">project</span> TimeGenerated, UserPrincipalName, FromCountry = PrevCountry, ToCountry = Country, MinutesBetween</code></pre>
    </div>
</div>

<div class="query-example">
    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> First Time Country Access</span></div>
    <div class="query-body">
<pre class="code-block"><code><span class="comment">// Users accessing from a country for the first time</span>
<span class="keyword">let</span> LookbackDays = <span class="number">30</span>;
<span class="keyword">let</span> HistoricalCountries = 
    <span class="table">SigninLogs</span>
    | <span class="keyword">where</span> TimeGenerated between (ago(LookbackDays) .. ago(<span class="number">1d</span>))
    | <span class="keyword">where</span> ResultType == <span class="string">"0"</span>
    | <span class="keyword">extend</span> Country = tostring(LocationDetails.countryOrRegion)
    | <span class="keyword">summarize</span> Countries = <span class="function">make_set</span>(Country) <span class="keyword">by</span> UserPrincipalName;

<span class="table">SigninLogs</span>
| <span class="keyword">where</span> TimeGenerated > ago(<span class="number">1d</span>)
| <span class="keyword">where</span> ResultType == <span class="string">"0"</span>
| <span class="keyword">extend</span> Country = tostring(LocationDetails.countryOrRegion)
| <span class="keyword">join</span> <span class="keyword">kind</span>=leftouter (HistoricalCountries) <span class="keyword">on</span> UserPrincipalName
| <span class="keyword">where</span> Country !in (Countries)
| <span class="keyword">project</span> TimeGenerated, UserPrincipalName, NewCountry = Country, IPAddress</code></pre>
    </div>
</div>

<h2>Next Steps</h2>
<ul>
    <li><a href="kql-advanced.html">KQL Advanced</a> - Custom functions, parsing, and optimization</li>
    <li><a href="analytics-rules.html">Analytics Rules</a> - Turn queries into detections</li>
</ul>

                </section>
            
                <section class="content-section">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>How do you join tables in KQL?</span>
                        </div>
                        <div class="interview-answer">
                            <p>KQL supports several join types. The basic syntax is: <code>Table1 | join kind=inner (Table2) on CommonField</code></p>
                            <p><strong>inner</strong> returns only matching rows from both tables. <strong>leftouter</strong> keeps all rows from the left table and adds matching right table data (nulls where no match). <strong>rightouter</strong> is the opposite. <strong>fullouter</strong> keeps all rows from both.</p>
                            <p>There's also <strong>leftanti</strong> which returns left rows that have NO match in the right table - useful for finding missing data.</p>
                            <p>Performance tip: put the smaller table on the right side of the join, and filter both tables before joining to reduce the dataset size. KQL evaluates right table first.</p>
                            <p>Example: Finding users with sign-ins but no matching audit events: <code>SigninLogs | join kind=leftanti (AuditLogs | project UserPrincipalName = InitiatedBy.user.userPrincipalName) on UserPrincipalName</code></p>
                        </div>
                    </div>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>Explain the let statement in KQL.</span>
                        </div>
                        <div class="interview-answer">
                            <p><strong>let</strong> creates named expressions that can be reused in the query. It's useful for defining variables, subqueries, or functions.</p>
                            <p>Common uses: <strong>1)</strong> Defining time ranges: <code>let lookback = ago(7d);</code> <strong>2)</strong> Creating lists for filtering: <code>let suspiciousIPs = dynamic(["1.2.3.4", "5.6.7.8"]);</code> <strong>3)</strong> Subqueries: <code>let failedUsers = SigninLogs | where ResultType != 0 | distinct UserPrincipalName;</code></p>
                            <p>The subquery approach is powerful for complex analytics. You can define intermediate results and reference them multiple times without repeating the query.</p>
                            <p>Note: let statements must be separated by semicolons, and the final query doesn't end with a semicolon.</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Microsoft Sentinel Guide</p>
                    <p>Personal Reference Guide</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>