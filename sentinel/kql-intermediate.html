<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Intermediate | Sentinel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="../xsiam/index.html" class="sidebar-nav-link" data-platform="xsiam">
                            <span class="platform-dot"></span>
                            <span>XSIAM</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../splunk/index.html" class="sidebar-nav-link" data-platform="splunk">
                            <span class="platform-dot"></span>
                            <span>Splunk</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../sentinel/index.html" class="sidebar-nav-link active" data-platform="sentinel">
                            <span class="platform-dot"></span>
                            <span>Sentinel</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../crowdstrike/index.html" class="sidebar-nav-link" data-platform="crowdstrike">
                            <span class="platform-dot"></span>
                            <span>CrowdStrike</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../cortex/index.html" class="sidebar-nav-link" data-platform="cortex">
                            <span class="platform-dot"></span>
                            <span>Cortex XDR</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../mde/index.html" class="sidebar-nav-link" data-platform="mde">
                            <span class="platform-dot"></span>
                            <span>Defender for Endpoint</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="../operations/index.html" class="sidebar-nav-link" data-platform="operations">
                            <span class="platform-dot"></span>
                            <span>SOC Operations</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Current Platform Pages -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Sentinel Pages</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item">
                        <a href="analytics-rules.html" class="sidebar-nav-link">
                            <i class="fas fa-project-diagram"></i>
                            <span>Analytics Rules</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="architecture.html" class="sidebar-nav-link">
                            <i class="fas fa-sitemap"></i>
                            <span>Architecture</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="automation.html" class="sidebar-nav-link">
                            <i class="fas fa-robot"></i>
                            <span>Automation</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="content-hub.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Content Hub</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="custom-log-onboarding.html" class="sidebar-nav-link">
                            <i class="fas fa-download"></i>
                            <span>Custom Log Onboarding</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="data-connectors.html" class="sidebar-nav-link">
                            <i class="fas fa-database"></i>
                            <span>Data Connectors</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="data-ingestion.html" class="sidebar-nav-link">
                            <i class="fas fa-database"></i>
                            <span>Data Ingestion</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="dcr-dce-guide.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Dcr Dce Guide</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="enterprise-scenarios.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Enterprise Scenarios</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="event-hub.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Event Hub</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="index.html" class="sidebar-nav-link">
                            <i class="fas fa-home"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="kql-advanced.html" class="sidebar-nav-link">
                            <i class="fas fa-terminal"></i>
                            <span>Kql Advanced</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="kql-fundamentals.html" class="sidebar-nav-link">
                            <i class="fas fa-code"></i>
                            <span>Kql Fundamentals</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="kql-intermediate.html" class="sidebar-nav-link active">
                            <i class="fas fa-code"></i>
                            <span>Kql Intermediate</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="parsing-flows.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Parsing Flows</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="retention-tiers.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Retention Tiers</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="security-usecases.html" class="sidebar-nav-link">
                            <i class="fas fa-file-alt"></i>
                            <span>Security Usecases</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="soc-operations.html" class="sidebar-nav-link">
                            <i class="fas fa-building"></i>
                            <span>Soc Operations</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="threat-hunting.html" class="sidebar-nav-link">
                            <i class="fas fa-crosshairs"></i>
                            <span>Threat Hunting</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="threat-intel.html" class="sidebar-nav-link">
                            <i class="fas fa-crosshairs"></i>
                            <span>Threat Intel</span>
                        </a>
                    </li>
                    <li class="sidebar-nav-item">
                        <a href="workbooks.html" class="sidebar-nav-link">
                            <i class="fas fa-book"></i>
                            <span>Workbooks</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </aside>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        
        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Kql Intermediate</span>
                </div>

                <h1><i class="fas fa-code"></i> KQL Intermediate</h1>
                <p class="lead">Elevate your KQL skills with joins, unions, advanced aggregations, string manipulation, time series analysis, and complex query patterns for security investigations.</p>

                <!-- Joins Deep Dive -->
                <h2><i class="fas fa-link"></i> Joins Deep Dive</h2>
                <div class="config-section">
                    <h4>Join Types Explained</h4>
                    <div class="code-block">KQL Join Types:

INNER JOIN (default):
├── Returns only matching rows from both tables
├── Use: Enrichment when match is required
└── Lost records: Non-matching rows from both sides

SigninLogs
| where TimeGenerated > ago(1h)
| join kind=inner (
    IdentityInfo
    | project AccountUPN, Department, JobTitle
) on $left.UserPrincipalName == $right.AccountUPN

LEFTOUTER JOIN:
├── Returns ALL left rows + matching right rows
├── Non-matching right: NULL values
├── Use: Keep all source records, add context if exists
└── Lost records: None from left table

SigninLogs
| where TimeGenerated > ago(1h)
| join kind=leftouter (
    SecurityAlert
    | where TimeGenerated > ago(24h)
    | project AlertTime = TimeGenerated, UserPrincipalName, AlertName
) on UserPrincipalName
| extend HasAlert = isnotnull(AlertName)

LEFTANTI JOIN:
├── Returns left rows NOT in right table
├── Use: Find new/unique items, gap analysis
├── Example: New users, first-time behaviors

// Users logged in today who NEVER logged in before
let TodayLogins = SigninLogs
    | where TimeGenerated > ago(1d)
    | where ResultType == 0
    | distinct UserPrincipalName;
let HistoricalLogins = SigninLogs
    | where TimeGenerated between (ago(90d) .. ago(1d))
    | where ResultType == 0
    | distinct UserPrincipalName;
TodayLogins
| join kind=leftanti HistoricalLogins on UserPrincipalName

LEFTSEMI JOIN:
├── Returns left rows that EXIST in right table
├── Only returns left columns (not right)
├── Use: Filter left by existence in right

// Users who have alerts
SigninLogs
| where TimeGenerated > ago(1h)
| join kind=leftsemi (
    SecurityAlert
    | where TimeGenerated > ago(24h)
    | distinct UserPrincipalName
) on UserPrincipalName</div>

                    <h4>Join Best Practices</h4>
                    <div class="code-block">Join Optimization Tips:

1. REDUCE TABLE SIZE BEFORE JOINING
   // BAD - joins full tables
   SigninLogs | join IdentityInfo on UserPrincipalName
   
   // GOOD - filter first, then join
   SigninLogs
   | where TimeGenerated > ago(1h)
   | where ResultType != 0
   | join kind=inner (
       IdentityInfo
       | project AccountUPN, Department
   ) on $left.UserPrincipalName == $right.AccountUPN

2. USE LOOKUP FOR REFERENCE DATA
   // More efficient than join for small reference tables
   SigninLogs
   | lookup kind=leftouter IdentityInfo on $left.UserPrincipalName == $right.AccountUPN

3. JOIN KEY SYNTAX
   // Same column name in both tables
   | join OtherTable on UserPrincipalName
   
   // Different column names
   | join OtherTable on $left.User == $right.AccountName
   
   // Multiple keys
   | join OtherTable on UserPrincipalName, IPAddress

4. AVOID CROSS JOINS
   // Never join without ON clause
   // This creates cartesian product (rows * rows)</div>

                    <h4>Security Join Patterns</h4>
                    <div class="code-block">// Enrich sign-ins with user risk
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == 0
| join kind=leftouter (
    AADRiskyUsers
    | where TimeGenerated > ago(7d)
    | summarize arg_max(TimeGenerated, *) by UserPrincipalName
    | project UserPrincipalName, RiskLevel, RiskState
) on UserPrincipalName
| where RiskLevel in ("high", "medium")

// Correlate sign-ins with device compliance
SigninLogs
| where TimeGenerated > ago(24h)
| join kind=leftouter (
    IntuneDevices
    | where TimeGenerated > ago(7d)
    | summarize arg_max(TimeGenerated, *) by DeviceId
    | project DeviceId, ComplianceState, EncryptionStatus
) on DeviceId
| where ComplianceState != "compliant"

// Find alerts for users who signed in from new locations
let NewLocationLogins = SigninLogs
    | where TimeGenerated > ago(1d)
    | where ResultType == 0
    | join kind=leftanti (
        SigninLogs
        | where TimeGenerated between (ago(30d) .. ago(1d))
        | distinct UserPrincipalName, Location
    ) on UserPrincipalName, Location
    | distinct UserPrincipalName;
SecurityAlert
| where TimeGenerated > ago(1d)
| join kind=inner NewLocationLogins on $left.CompromisedEntity == $right.UserPrincipalName</div>
                </div>

                <!-- Union Operations -->
                <h2><i class="fas fa-object-group"></i> Union Operations</h2>
                <div class="config-section">
                    <h4>Union Syntax</h4>
                    <div class="code-block">// Basic union - combine multiple tables
union SigninLogs, AADNonInteractiveUserSignInLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0
| summarize FailedLogins = count() by UserPrincipalName

// Union with source tracking
union withsource=SourceTable
    SigninLogs,
    AADNonInteractiveUserSignInLogs,
    AADServicePrincipalSignInLogs
| where TimeGenerated > ago(1h)
| summarize count() by SourceTable

// Union with different schemas (isfuzzy)
union isfuzzy=true
    (SigninLogs | project TimeGenerated, User = UserPrincipalName, Action = "SignIn"),
    (SecurityEvent | where EventID == 4624 | project TimeGenerated, User = TargetUserName, Action = "Logon")
| where TimeGenerated > ago(1h)

// Union for cross-table search
union withsource=TableName *
| where TimeGenerated > ago(24h)
| where * contains "mimikatz"
| project TimeGenerated, TableName, *</div>

                    <h4>Security Union Patterns</h4>
                    <div class="code-block">// All authentication failures across sources
union withsource=Source
    (SigninLogs | where ResultType != 0 | project TimeGenerated, User = UserPrincipalName, IP = IPAddress, Result = ResultType),
    (SecurityEvent | where EventID == 4625 | project TimeGenerated, User = TargetUserName, IP = IpAddress, Result = FailureReason),
    (Syslog | where Facility == "auth" and SyslogMessage contains "Failed" | project TimeGenerated, User = extract("user=([^\\s]+)", 1, SyslogMessage), IP = HostIP, Result = "Failed")
| where TimeGenerated > ago(24h)
| summarize FailedAttempts = count() by User, IP, Source
| where FailedAttempts > 5

// Search for IOC across all tables
let IOCs = dynamic(["malicious.com", "evil.exe", "192.168.100.1"]);
union withsource=TableName *
| where TimeGenerated > ago(7d)
| where * has_any (IOCs)
| project TimeGenerated, TableName, *
| take 1000</div>
                </div>

                <!-- String Functions -->
                <h2><i class="fas fa-font"></i> String Functions</h2>
                <div class="config-section">
                    <h4>String Extraction</h4>
                    <div class="code-block">// Extract with regex - capture groups
SecurityEvent
| where EventID == 4688
| extend ProcessName = extract(@"\\([^\\]+)$", 1, NewProcessName)
| extend FileExtension = extract(@"\.([^.]+)$", 1, NewProcessName)

// Extract multiple values
SecurityEvent
| where EventID == 4624
| extend Domain = extract(@"^([^\\]+)\\", 1, TargetUserName)
| extend Username = extract(@"\\(.+)$", 1, TargetUserName)

// Parse key-value pairs
AzureActivity
| extend ParsedClaims = parse_json(Claims)
| extend ClientIP = tostring(ParsedClaims.ipaddr)
| extend AppId = tostring(ParsedClaims.appid)

// Parse URL components
SigninLogs
| extend UrlParts = parse_url(ResourceDisplayName)
| extend Host = tostring(UrlParts.Host)
| extend Path = tostring(UrlParts.Path)

// Split and access array elements
CommonSecurityLog
| extend PathParts = split(DeviceCustomString1, "/")
| extend FileName = PathParts[-1]
| extend ParentFolder = PathParts[-2]</div>

                    <h4>String Matching</h4>
                    <div class="code-block">// Contains vs Has
// contains: substring match (slower, any position)
// has: whole term match (faster, word boundaries)

// contains example - finds "note" in "notepad.exe"
| where ProcessName contains "note"

// has example - finds "notepad" as whole word, NOT "notepad.exe"
| where ProcessName has "notepad"

// has_any - multiple whole terms
| where CommandLine has_any ("mimikatz", "psexec", "procdump")

// has_all - must have all terms
| where CommandLine has_all ("powershell", "-enc", "invoke")

// startswith, endswith
| where FilePath startswith "C:\\Windows\\Temp"
| where FileName endswith ".exe"

// Regex matching
| where CommandLine matches regex @"-enc[odedcommand]*\s+[A-Za-z0-9+/=]{20,}"
| where Email matches regex @"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"

// Case sensitivity
| where ProcessName =~ "POWERSHELL.EXE"  // Case-insensitive
| where ProcessName == "powershell.exe"   // Case-sensitive</div>

                    <h4>String Manipulation</h4>
                    <div class="code-block">// Concatenation
| extend FullPath = strcat(FolderPath, "\\", FileName)
| extend Message = strcat_delim(" - ", Severity, AlertName, Description)

// Substring
| extend First10Chars = substring(CommandLine, 0, 10)
| extend AfterPosition = substring(Email, indexof(Email, "@") + 1)

// Replace
| extend CleanPath = replace_string(FilePath, "\\\\", "/")
| extend NoWhitespace = replace_regex(CommandLine, @"\s+", " ")

// Trim
| extend CleanUser = trim(" ", UserName)
| extend NoQuotes = trim("\"", FilePath)

// Case conversion
| extend LowerUser = tolower(UserPrincipalName)
| extend UpperHost = toupper(Computer)

// String length
| extend CmdLength = strlen(CommandLine)
| where CmdLength > 1000  // Suspiciously long command</div>
                </div>

                <!-- Time Operations -->
                <h2><i class="fas fa-clock"></i> Time Operations</h2>
                <div class="config-section">
                    <h4>Time Filtering</h4>
                    <div class="code-block">// Relative time
| where TimeGenerated > ago(24h)
| where TimeGenerated > ago(7d) and TimeGenerated < ago(1d)

// Absolute time
| where TimeGenerated > datetime(2024-01-01)
| where TimeGenerated between (datetime(2024-01-01) .. datetime(2024-01-31))

// Dynamic time windows
let StartTime = ago(24h);
let EndTime = now();
SigninLogs
| where TimeGenerated between (StartTime .. EndTime)

// Business hours filter (UTC)
| extend HourOfDay = datetime_part("hour", TimeGenerated)
| extend DayOfWeek = dayofweek(TimeGenerated)
| where HourOfDay < 8 or HourOfDay > 18  // Outside 8am-6pm
| where DayOfWeek in (0d, 6d)  // Weekend (Sunday=0, Saturday=6)

// Time zone conversion
| extend LocalTime = TimeGenerated + 5h  // EST offset
| extend LocalTime = datetime_utc_to_local(TimeGenerated, "America/New_York")</div>

                    <h4>Time Calculations</h4>
                    <div class="code-block">// Time differences
SigninLogs
| summarize 
    FirstLogin = min(TimeGenerated),
    LastLogin = max(TimeGenerated)
  by UserPrincipalName
| extend DaysSinceLastLogin = datetime_diff('day', now(), LastLogin)
| extend HoursBetweenLogins = datetime_diff('hour', LastLogin, FirstLogin)

// Session duration
SecurityEvent
| where EventID in (4624, 4634)
| summarize 
    LoginTime = minif(TimeGenerated, EventID == 4624),
    LogoutTime = maxif(TimeGenerated, EventID == 4634)
  by TargetUserName, Computer, LogonId
| extend SessionDuration = LogoutTime - LoginTime
| extend SessionMinutes = toint(SessionDuration / 1m)

// Time since event
| extend HoursSinceEvent = datetime_diff('hour', now(), TimeGenerated)
| extend MinutesSinceEvent = (now() - TimeGenerated) / 1m

// Format timestamp
| extend FormattedTime = format_datetime(TimeGenerated, "yyyy-MM-dd HH:mm:ss")
| extend DateOnly = format_datetime(TimeGenerated, "yyyy-MM-dd")
| extend TimeOnly = format_datetime(TimeGenerated, "HH:mm:ss")</div>

                    <h4>Time Binning</h4>
                    <div class="code-block">// Bin for aggregation
SigninLogs
| where TimeGenerated > ago(24h)
| summarize count() by bin(TimeGenerated, 1h)

// Multiple bin sizes
| summarize 
    Hourly = count() by bin(TimeGenerated, 1h),
    Daily = count() by bin(TimeGenerated, 1d)

// Start of period
| extend StartOfHour = bin(TimeGenerated, 1h)
| extend StartOfDay = startofday(TimeGenerated)
| extend StartOfWeek = startofweek(TimeGenerated)
| extend StartOfMonth = startofmonth(TimeGenerated)

// Time chart
SigninLogs
| where TimeGenerated > ago(7d)
| where ResultType != 0
| summarize FailedLogins = count() by bin(TimeGenerated, 1h)
| render timechart</div>
                </div>

                <!-- Advanced Aggregations -->
                <h2><i class="fas fa-calculator"></i> Advanced Aggregations</h2>
                <div class="config-section">
                    <h4>Statistical Functions</h4>
                    <div class="code-block">// Basic statistics
SigninLogs
| summarize 
    TotalLogins = count(),
    UniqueUsers = dcount(UserPrincipalName),
    UniqueIPs = dcount(IPAddress),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated)
  by Location

// Percentiles
DeviceNetworkEvents
| summarize 
    P50_Bytes = percentile(BytesSent, 50),
    P90_Bytes = percentile(BytesSent, 90),
    P99_Bytes = percentile(BytesSent, 99),
    Avg_Bytes = avg(BytesSent)
  by DeviceName

// Standard deviation for anomaly detection
SecurityEvent
| where EventID == 4625
| summarize FailedLogins = count() by Computer, bin(TimeGenerated, 1h)
| summarize 
    AvgFailures = avg(FailedLogins),
    StdevFailures = stdev(FailedLogins)
  by Computer
| join kind=inner (
    SecurityEvent
    | where EventID == 4625
    | where TimeGenerated > ago(1h)
    | summarize CurrentFailures = count() by Computer
) on Computer
| extend ZScore = (CurrentFailures - AvgFailures) / StdevFailures
| where ZScore > 3</div>

                    <h4>Collection Functions</h4>
                    <div class="code-block">// make_set - unique values as array
SigninLogs
| where TimeGenerated > ago(24h)
| summarize 
    IPAddresses = make_set(IPAddress, 100),
    Locations = make_set(Location, 10)
  by UserPrincipalName

// make_list - all values (including duplicates)
| summarize 
    AllIPs = make_list(IPAddress, 1000),
    AllApps = make_list(AppDisplayName, 100)
  by UserPrincipalName

// make_bag - key-value pairs
| summarize Properties = make_bag(pack("IP", IPAddress, "App", AppDisplayName))
  by UserPrincipalName

// arg_max/arg_min - row with max/min value
IdentityInfo
| summarize arg_max(TimeGenerated, *) by AccountUPN  // Latest record per user

// Conditional aggregation
SigninLogs
| summarize 
    TotalLogins = count(),
    SuccessfulLogins = countif(ResultType == 0),
    FailedLogins = countif(ResultType != 0),
    MFALogins = countif(AuthenticationRequirement == "multiFactorAuthentication")
  by UserPrincipalName
| extend SuccessRate = round(100.0 * SuccessfulLogins / TotalLogins, 2)</div>

                    <h4>Windowing Functions</h4>
                    <div class="code-block">// Running totals and averages
SigninLogs
| where TimeGenerated > ago(7d)
| summarize DailyLogins = count() by bin(TimeGenerated, 1d)
| order by TimeGenerated asc
| extend RunningTotal = row_cumsum(DailyLogins)
| extend MovingAvg = avg_rolling(DailyLogins, 3)

// Prev/Next values
| serialize
| extend PrevLogins = prev(DailyLogins, 1)
| extend NextLogins = next(DailyLogins, 1)
| extend ChangeFromPrev = DailyLogins - PrevLogins

// Row number
| serialize RowNum = row_number()

// Ranking
SecurityAlert
| summarize AlertCount = count() by AlertSeverity
| order by AlertCount desc
| extend Rank = row_number()</div>
                </div>

                <!-- Let Statements -->
                <h2><i class="fas fa-equals"></i> Let Statements</h2>
                <div class="config-section">
                    <h4>Variables and Subqueries</h4>
                    <div class="code-block">// Scalar variables
let LookbackPeriod = 24h;
let FailureThreshold = 10;
let SuspiciousApps = dynamic(["PowerShell", "cmd.exe", "wscript.exe"]);

SigninLogs
| where TimeGenerated > ago(LookbackPeriod)
| where ResultType != 0
| summarize FailedAttempts = count() by UserPrincipalName
| where FailedAttempts > FailureThreshold

// Tabular subqueries
let HighRiskUsers = 
    AADRiskyUsers
    | where RiskLevel == "high"
    | distinct UserPrincipalName;

let RecentAlerts =
    SecurityAlert
    | where TimeGenerated > ago(24h)
    | distinct CompromisedEntity;

SigninLogs
| where TimeGenerated > ago(1h)
| where UserPrincipalName in (HighRiskUsers) or UserPrincipalName in (RecentAlerts)

// Function-like let
let GetUserActivity = (user: string, hours: int) {
    SigninLogs
    | where TimeGenerated > ago(hours * 1h)
    | where UserPrincipalName == user
    | summarize count() by IPAddress, Location
};
GetUserActivity("user@domain.com", 24)</div>

                    <h4>Complex Query Patterns</h4>
                    <div class="code-block">// Baseline comparison pattern
let BaselinePeriod = 30d;
let CurrentPeriod = 1d;

let Baseline = SigninLogs
    | where TimeGenerated between (ago(BaselinePeriod) .. ago(CurrentPeriod))
    | where ResultType == 0
    | summarize 
        BaselineLogins = count(),
        BaselineIPs = dcount(IPAddress),
        BaselineLocations = dcount(Location)
      by UserPrincipalName;

let Current = SigninLogs
    | where TimeGenerated > ago(CurrentPeriod)
    | where ResultType == 0
    | summarize 
        CurrentLogins = count(),
        CurrentIPs = dcount(IPAddress),
        CurrentLocations = dcount(Location)
      by UserPrincipalName;

Current
| join kind=leftouter Baseline on UserPrincipalName
| extend 
    LoginDeviation = CurrentLogins - BaselineLogins,
    IPDeviation = CurrentIPs - BaselineIPs,
    LocationDeviation = CurrentLocations - BaselineLocations
| where LoginDeviation > 2 * BaselineLogins or IPDeviation > 3 or LocationDeviation > 2</div>
                </div>

                <!-- Security Query Patterns -->
                <h2><i class="fas fa-shield-alt"></i> Security Query Patterns</h2>
                <div class="config-section">
                    <h4>User Behavior Analysis</h4>
                    <div class="code-block">// Impossible travel detection
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == 0
| project TimeGenerated, UserPrincipalName, IPAddress, Location
| order by UserPrincipalName, TimeGenerated asc
| serialize
| extend PrevTime = prev(TimeGenerated, 1)
| extend PrevLocation = prev(Location, 1)
| extend PrevUser = prev(UserPrincipalName, 1)
| where UserPrincipalName == PrevUser
| extend TimeDiffMinutes = datetime_diff('minute', TimeGenerated, PrevTime)
| where Location != PrevLocation and TimeDiffMinutes < 60
| project TimeGenerated, UserPrincipalName, FromLocation = PrevLocation, ToLocation = Location, TimeDiffMinutes

// First-time activity detection
let KnownActivity = SigninLogs
    | where TimeGenerated between (ago(30d) .. ago(1d))
    | where ResultType == 0
    | distinct UserPrincipalName, IPAddress, Location, AppDisplayName;

SigninLogs
| where TimeGenerated > ago(1d)
| where ResultType == 0
| join kind=leftanti KnownActivity on UserPrincipalName, IPAddress
| summarize 
    NewIPs = dcount(IPAddress),
    NewLocations = dcount(Location)
  by UserPrincipalName
| where NewIPs > 0 or NewLocations > 0

// Dormant account activity
let ActiveUsers = SigninLogs
    | where TimeGenerated between (ago(90d) .. ago(30d))
    | where ResultType == 0
    | distinct UserPrincipalName;

let InactiveUsers = IdentityInfo
    | distinct AccountUPN
    | join kind=leftanti ActiveUsers on $left.AccountUPN == $right.UserPrincipalName;

SigninLogs
| where TimeGenerated > ago(1d)
| where ResultType == 0
| join kind=inner InactiveUsers on $left.UserPrincipalName == $right.AccountUPN
| project TimeGenerated, UserPrincipalName, IPAddress, Location, AppDisplayName</div>

                    <h4>Attack Detection Patterns</h4>
                    <div class="code-block">// Password spray detection
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType in (50126, 50053, 50055)  // Invalid password codes
| summarize 
    FailedAttempts = count(),
    UniqueUsers = dcount(UserPrincipalName),
    TargetedUsers = make_set(UserPrincipalName, 20)
  by IPAddress, bin(TimeGenerated, 10m)
| where UniqueUsers > 10 and FailedAttempts > 20

// Brute force detection
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0
| summarize 
    FailedAttempts = count(),
    UniqueIPs = dcount(IPAddress),
    SourceIPs = make_set(IPAddress, 10)
  by UserPrincipalName, bin(TimeGenerated, 15m)
| where FailedAttempts > 20

// Credential stuffing (successful logins from spray IPs)
let SprayIPs = SigninLogs
    | where TimeGenerated > ago(1h)
    | where ResultType != 0
    | summarize FailedUsers = dcount(UserPrincipalName) by IPAddress
    | where FailedUsers > 10
    | project IPAddress;

SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType == 0
| where IPAddress in (SprayIPs)
| project TimeGenerated, UserPrincipalName, IPAddress, Location, AppDisplayName</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: When would you use leftanti vs inner join?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>inner:</strong> Get records that exist in BOTH tables (enrichment with required match)</li>
                                <li><strong>leftanti:</strong> Get records that DON'T exist in right table (finding new, unique, missing items)</li>
                            </ul>
                            <p><strong>Example:</strong> Find new users (leftanti against historical), enrich with department (inner with IdentityInfo)</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: What's the difference between has and contains?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>has:</strong> Matches whole terms (word boundaries), faster, case-insensitive</li>
                                <li><strong>contains:</strong> Matches any substring, slower, case-insensitive</li>
                            </ul>
                            <p><strong>Example:</strong> "notepad.exe" has "notepad" = TRUE, but "notepad.exe" has "note" = FALSE</p>
                            <p>Use <code>has</code> for performance, <code>contains</code> for partial matches.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you detect impossible travel in KQL?</button>
                        <div class="qa-answer">
                            <div class="code-block">SigninLogs
| where ResultType == 0
| order by UserPrincipalName, TimeGenerated
| serialize
| extend PrevTime = prev(TimeGenerated)
| extend PrevLocation = prev(Location)
| extend PrevUser = prev(UserPrincipalName)
| where UserPrincipalName == PrevUser
| extend TimeDiffMin = datetime_diff('minute', TimeGenerated, PrevTime)
| where Location != PrevLocation and TimeDiffMin < 60</div>
                            <p>Compare consecutive logins for same user, flag if different locations within impossible timeframe.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you find statistical anomalies in KQL?</button>
                        <div class="qa-answer">
                            <p>Use z-score calculation:</p>
                            <div class="code-block">// Calculate baseline
| summarize Avg = avg(count), Stdev = stdev(count) by Entity
// Compare current to baseline
| extend ZScore = (Current - Avg) / Stdev
| where ZScore > 3  // More than 3 standard deviations</div>
                            <p>Z-score > 3 indicates anomaly (99.7% confidence).</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: Explain the let statement in KQL.</button>
                        <div class="qa-answer">
                            <p><code>let</code> creates reusable variables and subqueries:</p>
                            <ul>
                                <li><strong>Scalar:</strong> <code>let threshold = 10;</code></li>
                                <li><strong>Dynamic:</strong> <code>let apps = dynamic(["app1", "app2"]);</code></li>
                                <li><strong>Tabular:</strong> <code>let riskyUsers = Table | where ...;</code></li>
                                <li><strong>Function:</strong> <code>let fn = (x:int) { x * 2 };</code></li>
                            </ul>
                            <p>Benefits: Code reuse, readability, performance (subquery evaluated once).</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        // Q&A toggle
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        // Close sidebar on resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>