<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="sentinel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Fundamentals | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>

            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel active"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
<nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-connectors.html" class="nav-link"><i class="fas fa-plug"></i> Data Connectors</a>
                    <a href="dcr-dce-guide.html" class="nav-link"><i class="fas fa-cogs"></i> DCR & DCE Deep Dive</a>
                    <a href="event-hub.html" class="nav-link"><i class="fas fa-broadcast-tower"></i> Event Hub Integration</a>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion & Cost</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">KQL Query Language</div>
                    <a href="kql-fundamentals.html" class="nav-link active"><i class="fas fa-terminal"></i> KQL Fundamentals</a>
                    <a href="kql-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> KQL Intermediate</a>
                    <a href="kql-advanced.html" class="nav-link"><i class="fas fa-code"></i> Advanced KQL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="analytics-rules.html" class="nav-link"><i class="fas fa-bell"></i> Analytics Rules</a>
                    <a href="automation.html" class="nav-link"><i class="fas fa-robot"></i> Automation</a>
                    <a href="workbooks.html" class="nav-link"><i class="fas fa-chart-bar"></i> Workbooks</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Content & Intelligence</div>
                    <a href="content-hub.html" class="nav-link"><i class="fas fa-cube"></i> Content Hub & ASIM</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users-cog"></i> SOC Operations</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">KQL Fundamentals</span>
                </div>
                <div class="top-actions">
                    <button class="top-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <section class="content-section">

                <!-- WHY LEARN KQL -->
                <h2 id="why-kql"><i class="fas fa-question-circle"></i> Why Learn KQL?</h2>

                <div class="info-box info">
                    <div class="info-box-title"><i class="fas fa-lightbulb"></i> KQL is Your Investigation Superpower</div>
                    <p style="margin: 0.5rem 0;">KQL (Kusto Query Language) is the query language for Microsoft Sentinel, Defender, and Azure. Mastering KQL means you can find anything in your security data.</p>
                </div>

                <table>
                    <thead><tr><th>Without KQL Skills</th><th>With KQL Skills</th></tr></thead>
                    <tbody>
                        <tr><td>Limited to pre-built queries</td><td>Write custom queries for any situation</td></tr>
                        <tr><td>Can't answer specific questions</td><td>Find exactly what you need</td></tr>
                        <tr><td>Slow investigations</td><td>Fast, targeted data retrieval</td></tr>
                        <tr><td>Dependent on others for queries</td><td>Self-sufficient analyst</td></tr>
                        <tr><td>Miss connections in data</td><td>Correlate across tables</td></tr>
                    </tbody>
                </table>

                <!-- BASIC STRUCTURE -->
                <h2 id="basics"><i class="fas fa-layer-group"></i> Basic Query Structure</h2>

                <h3>The Pipe Model</h3>
                <p>KQL queries flow data through a series of operators, each transforming the data:</p>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.8rem;">
<pre style="margin: 0;">
TableName              <span style="color: #6aa3f7;">// Start with a table</span>
| where Condition      <span style="color: #6aa3f7;">// Filter rows</span>
| project Column1, Column2  <span style="color: #6aa3f7;">// Select columns</span>
| order by Column1 desc     <span style="color: #6aa3f7;">// Sort results</span>
</pre>
                </div>

                <h3>Essential Operators - When to Use What</h3>
                <table>
                    <thead><tr><th>Operator</th><th>Purpose</th><th>When to Use</th><th>Example</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><code>where</code></td>
                            <td>Filter rows</td>
                            <td>Reduce data to what you need</td>
                            <td><code>| where Status == "Failed"</code></td>
                        </tr>
                        <tr>
                            <td><code>project</code></td>
                            <td>Select columns</td>
                            <td>Show only relevant fields</td>
                            <td><code>| project TimeGenerated, User, IP</code></td>
                        </tr>
                        <tr>
                            <td><code>summarize</code></td>
                            <td>Aggregate data</td>
                            <td>Count, group, find patterns</td>
                            <td><code>| summarize count() by User</code></td>
                        </tr>
                        <tr>
                            <td><code>order by</code></td>
                            <td>Sort results</td>
                            <td>Find most/least/newest</td>
                            <td><code>| order by TimeGenerated desc</code></td>
                        </tr>
                        <tr>
                            <td><code>extend</code></td>
                            <td>Add calculated columns</td>
                            <td>Create new fields from existing</td>
                            <td><code>| extend Hour = hourofday(TimeGenerated)</code></td>
                        </tr>
                        <tr>
                            <td><code>join</code></td>
                            <td>Combine tables</td>
                            <td>Correlate data across sources</td>
                            <td><code>| join OtherTable on UserId</code></td>
                        </tr>
                    </tbody>
                </table>

                <!-- COMMON PATTERNS -->
                <h2 id="patterns"><i class="fas fa-puzzle-piece"></i> Common Query Patterns</h2>

                <h3>Pattern 1: Find Events in Time Range</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Last 24 hours (most common)</span>
SigninLogs
| where TimeGenerated > ago(24h)

<span style="color: #6aa3f7;">// Specific date range</span>
SigninLogs
| where TimeGenerated between (datetime(2025-01-01) .. datetime(2025-01-02))

<span style="color: #6aa3f7;">// Last 7 days, excluding last 24 hours (baseline comparison)</span>
SigninLogs
| where TimeGenerated between (ago(7d) .. ago(24h))
</pre>
                </div>
                <p><strong>When to use:</strong> Always start with a time filter - it's the most important performance optimization.</p>

                <h3>Pattern 2: Find Specific User/Device Activity</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Exact match</span>
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName == "john.smith@company.com"

<span style="color: #6aa3f7;">// Partial match (contains)</span>
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName has "smith"

<span style="color: #6aa3f7;">// Case-insensitive exact match</span>
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName =~ "JOHN.SMITH@company.com"

<span style="color: #6aa3f7;">// Multiple values</span>
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName in ("user1@company.com", "user2@company.com")
</pre>
                </div>
                <p><strong>When to use:</strong> When investigating a specific user or device.</p>

                <h3>Pattern 3: Count and Group</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Count events per user</span>
SigninLogs
| where TimeGenerated > ago(24h)
| summarize EventCount = count() by UserPrincipalName
| order by EventCount desc

<span style="color: #6aa3f7;">// Count distinct values</span>
SigninLogs
| where TimeGenerated > ago(24h)
| summarize 
    UniqueUsers = dcount(UserPrincipalName),
    UniqueIPs = dcount(IPAddress),
    TotalEvents = count()

<span style="color: #6aa3f7;">// Group by multiple fields</span>
SigninLogs
| where TimeGenerated > ago(24h)
| summarize count() by UserPrincipalName, ResultType, Location
</pre>
                </div>
                <p><strong>When to use:</strong> When looking for patterns, anomalies, or top talkers.</p>

                <h3>Pattern 4: Timeline Analysis</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Events per hour</span>
SigninLogs
| where TimeGenerated > ago(24h)
| summarize count() by bin(TimeGenerated, 1h)
| render timechart

<span style="color: #6aa3f7;">// First and last occurrence</span>
SigninLogs
| where TimeGenerated > ago(7d)
| where UserPrincipalName == "user@company.com"
| summarize FirstSeen = min(TimeGenerated), LastSeen = max(TimeGenerated)

<span style="color: #6aa3f7;">// All activity for user, chronologically</span>
SigninLogs
| where TimeGenerated > ago(24h)
| where UserPrincipalName == "user@company.com"
| project TimeGenerated, IPAddress, Location, AppDisplayName, ResultType
| order by TimeGenerated asc
</pre>
                </div>
                <p><strong>When to use:</strong> When building attack timeline or understanding sequence of events.</p>

                <!-- STRING OPERATIONS -->
                <h2 id="strings"><i class="fas fa-font"></i> String Operations</h2>

                <h3>Comparison Operators</h3>
                <table>
                    <thead><tr><th>Operator</th><th>Meaning</th><th>Case Sensitive?</th><th>Example</th></tr></thead>
                    <tbody>
                        <tr><td><code>==</code></td><td>Exact match</td><td>Yes</td><td><code>| where User == "Admin"</code></td></tr>
                        <tr><td><code>=~</code></td><td>Exact match</td><td>No</td><td><code>| where User =~ "admin"</code></td></tr>
                        <tr><td><code>has</code></td><td>Contains word</td><td>No</td><td><code>| where Cmd has "password"</code></td></tr>
                        <tr><td><code>contains</code></td><td>Contains substring</td><td>No</td><td><code>| where Cmd contains "pass"</code></td></tr>
                        <tr><td><code>startswith</code></td><td>Starts with</td><td>No</td><td><code>| where User startswith "admin"</code></td></tr>
                        <tr><td><code>endswith</code></td><td>Ends with</td><td>No</td><td><code>| where Email endswith "@company.com"</code></td></tr>
                        <tr><td><code>matches regex</code></td><td>Regex match</td><td>Yes</td><td><code>| where IP matches regex @"\d+\.\d+\.\d+\.\d+"</code></td></tr>
                    </tbody>
                </table>

                <div class="info-box warning">
                    <div class="info-box-title"><i class="fas fa-exclamation-triangle"></i> Performance Tip</div>
                    <p><code>has</code> is faster than <code>contains</code> because it uses indexes. Use <code>has</code> when searching for whole words.</p>
                </div>

                <!-- COMMON MISTAKES -->
                <h2 id="mistakes"><i class="fas fa-times-circle"></i> Common Mistakes and How to Avoid Them</h2>

                <table>
                    <thead><tr><th>Mistake</th><th>Problem</th><th>Solution</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>No time filter</td>
                            <td>Query scans entire table, times out</td>
                            <td>Always add <code>| where TimeGenerated > ago(Xd)</code></td>
                        </tr>
                        <tr>
                            <td>Using <code>==</code> when data has different case</td>
                            <td>Misses matches due to case sensitivity</td>
                            <td>Use <code>=~</code> for case-insensitive</td>
                        </tr>
                        <tr>
                            <td><code>summarize</code> before <code>where</code></td>
                            <td>Aggregates all data then filters (slow)</td>
                            <td>Filter first with <code>where</code>, then <code>summarize</code></td>
                        </tr>
                        <tr>
                            <td>Using <code>*</code> or no column selection</td>
                            <td>Returns all columns, hard to read</td>
                            <td>Use <code>project</code> to select needed columns</td>
                        </tr>
                        <tr>
                            <td>Regex for simple patterns</td>
                            <td>Slower than built-in operators</td>
                            <td>Use <code>has</code>, <code>contains</code> first</td>
                        </tr>
                    </tbody>
                </table>

                <!-- INVESTIGATION QUERIES -->
                <h2 id="investigation"><i class="fas fa-search"></i> Ready-to-Use Investigation Queries</h2>

                <h3>User Investigation Starter</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Complete user activity overview</span>
let targetUser = "user@company.com";
let lookback = 7d;
SigninLogs
| where TimeGenerated > ago(lookback)
| where UserPrincipalName =~ targetUser
| summarize 
    TotalSignins = count(),
    SuccessfulSignins = countif(ResultType == 0),
    FailedSignins = countif(ResultType != 0),
    UniqueIPs = make_set(IPAddress),
    UniqueLocations = make_set(Location),
    UniqueApps = make_set(AppDisplayName),
    FirstSeen = min(TimeGenerated),
    LastSeen = max(TimeGenerated)
</pre>
                </div>

                <h3>Failed Logon Analysis</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Failed logons by user (possible brute force targets)</span>
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType != 0
| summarize 
    FailedCount = count(),
    UniqueIPs = dcount(IPAddress),
    Reasons = make_set(ResultDescription)
    by UserPrincipalName
| where FailedCount > 10
| order by FailedCount desc
</pre>
                </div>

                <h3>Process Execution Analysis</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem; margin: 0.5rem 0;">
<pre style="margin: 0;">
<span style="color: #6aa3f7;">// Suspicious process execution</span>
DeviceProcessEvents
| where Timestamp > ago(24h)
| where FileName in~ ("powershell.exe", "cmd.exe", "wscript.exe", "cscript.exe")
| where ProcessCommandLine has_any ("encoded", "bypass", "hidden", "invoke", "download")
| project Timestamp, DeviceName, AccountName, FileName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
</pre>
                </div>

                <!-- PRACTICE EXERCISES -->
                <h2 id="practice"><i class="fas fa-dumbbell"></i> Practice Exercises</h2>

                <table>
                    <thead><tr><th>Exercise</th><th>Skill Tested</th><th>Hint</th></tr></thead>
                    <tbody>
                        <tr><td>Find all failed sign-ins from last 24 hours</td><td>Basic filtering</td><td>Use <code>where ResultType != 0</code></td></tr>
                        <tr><td>Count sign-ins per application</td><td>Summarize</td><td>Use <code>summarize count() by AppDisplayName</code></td></tr>
                        <tr><td>Find users who signed in from more than 3 countries</td><td>Aggregation + filtering</td><td>Use <code>dcount()</code> then <code>where</code></td></tr>
                        <tr><td>Show hourly sign-in trend as chart</td><td>Time binning + visualization</td><td>Use <code>bin(TimeGenerated, 1h)</code> + <code>render timechart</code></td></tr>
                    </tbody>
                </table>

            
                </section>
            
                <section class="content-section">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>Explain the basic structure of a KQL query.</span>
                        </div>
                        <div class="interview-answer">
                            <p>KQL uses a pipe-based syntax where data flows through a series of operators. You start with a table name like SigninLogs or SecurityEvent, then pipe the results through operators that filter, transform, or aggregate.</p>
                            <p>The most common operators are: <strong>where</strong> for filtering rows, <strong>project</strong> for selecting columns, <strong>extend</strong> for adding calculated columns, <strong>summarize</strong> for aggregation, and <strong>sort</strong> for ordering results.</p>
                            <p>A typical query might look like: <code>SigninLogs | where TimeGenerated > ago(1h) | where ResultType != 0 | summarize count() by UserPrincipalName | sort by count_ desc</code></p>
                            <p>That reads the SigninLogs table, filters to the last hour, keeps only failed logins, counts failures per user, and sorts by count descending. Each pipe passes results to the next operator.</p>
                        </div>
                    </div>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>What's the difference between project and extend in KQL?</span>
                        </div>
                        <div class="interview-answer">
                            <p><strong>project</strong> selects which columns to include in the output and removes all others. It's like SQL SELECT - you specify exactly what you want to see.</p>
                            <p><strong>extend</strong> adds new calculated columns while keeping all existing columns. Use it when you want to add a computation without losing the original data.</p>
                            <p>There's also <strong>project-away</strong> which removes specific columns but keeps the rest, and <strong>project-rename</strong> for renaming columns.</p>
                            <p>Example: <code>| extend FailureReason = case(ResultType == 50126, "Invalid username or password", "Other")</code> adds a new column while keeping everything else. <code>| project TimeGenerated, User, FailureReason</code> would then select just those three columns.</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Microsoft Sentinel Guide</p>
                    <p>Personal Reference Guide</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>