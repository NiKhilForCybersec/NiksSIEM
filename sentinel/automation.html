<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation & SOAR | Microsoft Sentinel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <a href="../index.html" class="back-home"><i class="fas fa-arrow-left"></i> Nik's SIEM</a>
            
            <div class="breadcrumb">
                <a href="../index.html">Home</a>
                <span class="separator">/</span>
                <a href="index.html">Sentinel</a>
                <span class="separator">/</span>
                <span class="current">Automation & SOAR</span>
            </div>

<h1><i class="fas fa-robot"></i> Automation & SOAR</h1>
                <p class="lead">Master Microsoft Sentinel automation capabilities. Learn playbooks, automation rules, Logic Apps integration, and how to build automated security response workflows.</p>

                <!-- Automation Overview -->
                <h2><i class="fas fa-info-circle"></i> Automation Overview</h2>
                <div class="config-section">
                    <h4>Sentinel SOAR Capabilities</h4>
                    <div class="code-block">Sentinel Automation Components:

AUTOMATION RULES:
├── Lightweight automation
├── No-code configuration
├── Triage and routing
├── Trigger playbooks
└── Incident management

PLAYBOOKS (Logic Apps):
├── Full workflow automation
├── Complex logic and conditions
├── External system integration
├── Custom response actions
└── Azure Logic Apps powered

USE CASES:
├── Auto-enrich incidents with context
├── Block malicious IPs/domains
├── Isolate compromised endpoints
├── Send notifications (email, Teams)
├── Create tickets (ServiceNow, Jira)
├── Gather threat intelligence
└── Orchestrate multi-step responses

SOAR WORKFLOW:
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│   Alert/Incident ──▶ Automation Rule ──▶ Playbook ──▶      │
│                          │                   │              │
│                          ▼                   ▼              │
│                     Triage Actions      Response Actions    │
│                     ├── Assign owner    ├── Enrich data    │
│                     ├── Set severity    ├── Block IOC      │
│                     ├── Add tags        ├── Isolate host   │
│                     └── Close if FP     ├── Notify team    │
│                                         └── Create ticket  │
│                                                             │
└─────────────────────────────────────────────────────────────┘</div>
                </div>

                <!-- Automation Rules -->
                <h2><i class="fas fa-cogs"></i> Automation Rules</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Configuration → Automation → Automation rules</span></p>

                    <h4>Automation Rule Configuration</h4>
                    <div class="code-block">Automation Rule Components:

TRIGGER:
├── When incident is created
├── When incident is updated
└── When alert is created

CONDITIONS (AND logic):
├── Analytic rule name
├── Incident provider
├── Incident severity
├── Incident status
├── Incident tactics
├── Entity type present
├── Tag contains
└── Custom conditions

ACTIONS:
├── Run playbook
├── Change status
├── Change severity
├── Assign owner
├── Add tags
└── Multiple actions (sequential)

EXPIRATION:
├── No expiration (default)
├── Specific date/time
└── Useful for temporary rules

EXAMPLE RULES:

1. AUTO-ASSIGN HIGH SEVERITY:
   Trigger: Incident created
   Condition: Severity = High
   Action: Assign to security-leads@company.com

2. AUTO-CLOSE FALSE POSITIVE:
   Trigger: Incident created
   Condition: Title contains "Known Scanner"
   Action: Close as False Positive

3. TRIGGER ENRICHMENT PLAYBOOK:
   Trigger: Incident created
   Condition: Any (no filter)
   Action: Run playbook "Enrich-Incident"

4. AUTO-TAG BY TACTIC:
   Trigger: Incident created
   Condition: Tactics contains "Initial Access"
   Action: Add tag "Tier1-Priority"</div>

                    <h4>Rule Ordering</h4>
                    <div class="code-block">Automation Rule Ordering:

ORDER MATTERS:
├── Rules execute in order (1, 2, 3...)
├── Set order in rule configuration
├── Lower number = higher priority
└── All matching rules execute

BEST PRACTICES:
├── Put specific rules before general
├── Put closing rules at end
├── Group by incident type
└── Document rule dependencies

EXAMPLE ORDER:
1. Close known false positives (stop processing)
2. Assign high severity to tier 2
3. Assign medium severity to tier 1
4. Run enrichment playbook (all incidents)
5. Add default tags

STOP PROCESSING:
├── Not available in automation rules
├── All matching rules will execute
├── Design rules to not conflict
└── Use conditions to prevent overlap</div>
                </div>

                <!-- Playbooks -->
                <h2><i class="fas fa-book-open"></i> Playbooks (Logic Apps)</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Configuration → Automation → Playbooks</span></p>

                    <h4>Playbook Architecture</h4>
                    <div class="code-block">Playbook Architecture:

WHAT IS A PLAYBOOK:
├── Azure Logic App with Sentinel connector
├── Visual workflow designer
├── Hundreds of connectors available
├── Custom HTTP actions for any API
└── Runs in your Azure subscription

TRIGGER TYPES:
├── Microsoft Sentinel Incident (most common)
├── Microsoft Sentinel Alert
├── HTTP Request (manual/API trigger)
└── Recurrence (scheduled)

CONNECTOR CATEGORIES:
├── Microsoft Security: Sentinel, Defender, Azure AD
├── Productivity: Teams, Outlook, SharePoint
├── ITSM: ServiceNow, Jira, Zendesk
├── Threat Intel: VirusTotal, AbuseIPDB, OTX
├── Infrastructure: Azure, AWS, custom APIs
└── Communication: Slack, PagerDuty, Twilio

MANAGED IDENTITY:
├── System-assigned (recommended)
├── No credentials to manage
├── RBAC for Sentinel access
├── Required role: Sentinel Responder
└── Configure in Logic App settings</div>

                    <h4>Common Playbook Patterns</h4>
                    <div class="code-block">Common Playbook Patterns:

1. INCIDENT ENRICHMENT:
   Trigger: Sentinel Incident
   ├── Get incident entities (IPs, Users, Hosts)
   ├── For each IP:
   │   ├── Query VirusTotal
   │   ├── Query AbuseIPDB
   │   └── Query Threat Intel
   ├── Add comment with findings
   └── Update incident tags

2. NOTIFICATION:
   Trigger: Sentinel Incident
   ├── Get incident details
   ├── Format message
   ├── Send Teams message to SOC channel
   ├── Send email to incident owner
   └── Post to Slack (optional)

3. TICKET CREATION:
   Trigger: Sentinel Incident
   ├── Get incident details
   ├── Create ServiceNow incident
   ├── Link ticket to Sentinel incident
   └── Add comment with ticket number

4. CONTAINMENT:
   Trigger: Sentinel Incident
   ├── Get entities (compromised hosts)
   ├── For each host:
   │   ├── Isolate via MDE API
   │   └── Disable user in Azure AD
   ├── Add containment comment
   └── Update incident status

5. IOC BLOCKING:
   Trigger: Sentinel Incident
   ├── Extract IOCs (IPs, domains, hashes)
   ├── Add to Sentinel Threat Intel
   ├── Block in firewall (Palo Alto API)
   ├── Add to Defender block list
   └── Document actions in incident</div>

                    <h4>Playbook Example: IP Enrichment</h4>
                    <div class="code-block">IP Enrichment Playbook Steps:

1. TRIGGER: When Azure Sentinel incident is triggered

2. GET INCIDENT
   Action: Entities - Get IPs
   Incident ARM ID: @triggerBody()?['object']?['id']

3. FOR EACH IP
   Action: For each
   Select: @body('Entities_-_Get_IPs')?['IPs']

4. VIRUSTOTAL LOOKUP
   Action: HTTP
   Method: GET
   URI: https://www.virustotal.com/api/v3/ip_addresses/@{items('For_each')?['Address']}
   Headers: x-apikey: [VT API Key]

5. PARSE RESPONSE
   Action: Parse JSON
   Content: @body('HTTP')
   Schema: (VT response schema)

6. ADD COMMENT
   Action: Add comment to incident (V3)
   Incident ARM ID: @triggerBody()?['object']?['id']
   Message: 
     IP: @{items('For_each')?['Address']}
     VT Score: @{body('Parse_JSON')?['data']?['attributes']?['last_analysis_stats']?['malicious']}
     Country: @{body('Parse_JSON')?['data']?['attributes']?['country']}

7. UPDATE TAGS (if malicious)
   Condition: malicious_count > 5
   Action: Update incident - Add tag "Confirmed-Malicious"</div>
                </div>

                <!-- Sentinel Connectors -->
                <h2><i class="fas fa-plug"></i> Key Connectors</h2>
                <div class="config-section">
                    <h4>Sentinel-Specific Actions</h4>
                    <div class="code-block">Microsoft Sentinel Connector Actions:

INCIDENT ACTIONS:
├── Get incident: Retrieve incident details
├── Update incident: Modify status, severity, owner
├── Add comment: Add investigation notes
├── Add task: Create tasks for analysts
├── Get entities: Extract IPs, users, hosts, etc.
└── List incidents: Query incidents

ALERT ACTIONS:
├── Get alert: Retrieve alert details
├── Update alert status
└── Add alert comment

WATCHLIST ACTIONS:
├── Get watchlist items
├── Add watchlist item
├── Delete watchlist item
└── Update watchlist item

THREAT INTELLIGENCE:
├── Create threat indicator
├── Get threat indicator
├── Update threat indicator
└── Delete threat indicator

EXAMPLE: Update Incident
Action: Update incident (V2)
├── Incident ARM ID: from trigger
├── Status: Active / Closed
├── Classification: True Positive / False Positive
├── Classification Reason: (dropdown)
├── Severity: High / Medium / Low / Informational
├── Owner: user@domain.com or Object ID
└── Tags: add or remove</div>

                    <h4>External Connectors</h4>
                    <div class="code-block">Popular External Connectors:

MICROSOFT DEFENDER:
├── Microsoft Defender for Endpoint
│   ├── Isolate machine
│   ├── Run antivirus scan
│   ├── Collect investigation package
│   └── Stop and quarantine file
├── Microsoft Defender for Cloud Apps
│   ├── Disable user
│   ├── Require re-authentication
│   └── Suspend user

AZURE AD:
├── Get user
├── Disable/Enable account
├── Reset password
├── Revoke sessions
├── Get sign-in logs
└── Add to group

SERVICENOW:
├── Create incident
├── Update incident
├── Add work notes
├── Get incident details
└── Close incident

TEAMS/OUTLOOK:
├── Send adaptive card
├── Post message to channel
├── Send email
├── Create Teams meeting
└── Create Outlook event

VIRUSTOTAL:
├── Get IP report
├── Get domain report
├── Get file report
├── Scan file
└── Scan URL</div>
                </div>

                <!-- Best Practices -->
                <h2><i class="fas fa-check-double"></i> Best Practices</h2>
                <div class="config-section">
                    <div class="code-block">Automation Best Practices:

DESIGN PRINCIPLES:
├── Start simple, iterate
├── Test in non-production first
├── Use managed identities
├── Implement error handling
├── Log all actions
└── Document thoroughly

SECURITY:
├── Use Key Vault for secrets
├── Minimum privilege access
├── Audit playbook runs
├── Review connector permissions
└── Secure HTTP endpoints

PERFORMANCE:
├── Use parallel branches for independent actions
├── Implement timeouts
├── Handle API rate limits
├── Use pagination for large datasets
└── Avoid infinite loops

ERROR HANDLING:
├── Configure run after (failure handling)
├── Use Try-Catch patterns (Scope actions)
├── Send alerts on playbook failures
├── Retry transient failures
└── Graceful degradation

NAMING CONVENTIONS:
├── Playbooks: Sentinel-[Action]-[Target]
│   Example: Sentinel-Enrich-IP
├── Automation Rules: AR-[Trigger]-[Action]
│   Example: AR-HighSev-AssignTier2
└── Use consistent prefixes for filtering

TESTING:
├── Test with sample incidents
├── Verify all paths (success/failure)
├── Check Logic App run history
├── Monitor for errors
└── Validate external integrations</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: What's the difference between automation rules and playbooks?</button>
                        <div class="qa-answer">
                            <p><strong>Automation Rules:</strong></p>
                            <ul>
                                <li>Lightweight, no-code configuration</li>
                                <li>Triage actions: assign, tag, change severity, close</li>
                                <li>Can trigger playbooks</li>
                            </ul>
                            <p><strong>Playbooks:</strong></p>
                            <ul>
                                <li>Full Logic Apps workflows</li>
                                <li>Complex multi-step automation</li>
                                <li>External system integration</li>
                                <li>Custom response actions</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you authenticate playbooks to Sentinel?</button>
                        <div class="qa-answer">
                            <ol>
                                <li>Enable <strong>System-assigned managed identity</strong> on Logic App</li>
                                <li>Grant <strong>Microsoft Sentinel Responder</strong> role to the identity</li>
                                <li>Scope: Resource group containing Sentinel workspace</li>
                            </ol>
                            <p>This eliminates credential management and follows least-privilege principles.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: Describe a playbook you would build for incident enrichment.</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Trigger:</strong> Sentinel incident created</li>
                                <li><strong>Get entities:</strong> Extract IPs, users, hosts</li>
                                <li><strong>For each IP:</strong> Query VirusTotal, AbuseIPDB</li>
                                <li><strong>For each user:</strong> Check Azure AD risk, recent sign-ins</li>
                                <li><strong>Add comment:</strong> Summarize findings in incident</li>
                                <li><strong>Update tags:</strong> Tag as "Enriched" or "High-Risk"</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you handle errors in playbooks?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>Configure Run After:</strong> Set actions to run on success, failure, or both</li>
                                <li><strong>Scope actions:</strong> Group actions in Scope for try-catch pattern</li>
                                <li><strong>Error notification:</strong> Send Teams/email on playbook failure</li>
                                <li><strong>Retry policies:</strong> Configure for transient failures</li>
                                <li><strong>Graceful degradation:</strong> Continue with partial results if one enrichment fails</li>
                            </ul>
                        </div>
                    </div>
                </div>

        </main>
    </div>
    <script>
        // Q&A toggle functionality
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) { answer.style.display = 'block'; }
            });
        });
    </script>
</body>
</html>