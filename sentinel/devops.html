<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel as Code | Microsoft Sentinel</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Sentinel as Code</span>
                </div>

                <h1><i class="fas fa-code-branch"></i> Sentinel as Code (DevOps)</h1>
                <p class="lead">Master Infrastructure as Code for Microsoft Sentinel. Learn ARM templates, Bicep, Terraform, and CI/CD pipelines for managing Sentinel at enterprise scale.</p>

                <!-- Why Sentinel as Code -->
                <h2><i class="fas fa-info-circle"></i> Why Sentinel as Code?</h2>
                <div class="config-section">
                    <div class="arch-diagram">BENEFITS OF SENTINEL AS CODE
═══════════════════════════════════════════════════════════════════

VERSION CONTROL:
├── Track all changes in Git
├── See who changed what and when
├── Roll back to previous versions
├── Code review for security changes
└── Audit trail for compliance

CONSISTENCY:
├── Same configuration across environments (dev/prod)
├── No manual configuration drift
├── Standardized naming conventions
├── Reproducible deployments
└── Disaster recovery ready

AUTOMATION:
├── Deploy rules across multiple workspaces
├── CI/CD pipelines for continuous deployment
├── Automated testing before deployment
├── Scheduled sync with detection repositories
└── Scale to hundreds of rules/workspaces

COLLABORATION:
├── Team works on same codebase
├── Pull requests for changes
├── Branch-based development
├── Shared rule libraries
└── Community detection content

WHAT CAN BE MANAGED AS CODE:
├── Analytics Rules (scheduled, NRT, ML)
├── Automation Rules
├── Playbooks (Logic Apps)
├── Workbooks
├── Watchlists
├── Data Connectors
├── Hunting Queries
├── Parsers (Functions)
└── Data Collection Rules</div>
                </div>

                <!-- Repository Structure -->
                <h2><i class="fas fa-folder-tree"></i> Repository Structure</h2>
                <div class="config-section">
                    <div class="arch-diagram">RECOMMENDED REPOSITORY STRUCTURE
═══════════════════════════════════════════════════════════════════

sentinel-content/
├── .github/
│   └── workflows/
│       ├── deploy-analytics-rules.yml
│       ├── deploy-playbooks.yml
│       ├── validate-content.yml
│       └── sync-from-sentinel.yml
│
├── analytics-rules/
│   ├── identity/
│   │   ├── brute-force-detection.json
│   │   ├── impossible-travel.json
│   │   └── mfa-bypass.json
│   ├── endpoint/
│   │   ├── suspicious-process.json
│   │   └── ransomware-indicators.json
│   ├── network/
│   │   └── c2-beaconing.json
│   └── cloud/
│       └── azure-admin-abuse.json
│
├── automation-rules/
│   ├── auto-assign-high-severity.json
│   └── auto-close-informational.json
│
├── playbooks/
│   ├── enrichment/
│   │   └── enrich-ip-virustotal/
│   │       ├── azuredeploy.json
│   │       └── parameters.json
│   └── response/
│       └── block-ip-firewall/
│           └── azuredeploy.json
│
├── workbooks/
│   ├── security-operations.json
│   └── cost-monitoring.json
│
├── watchlists/
│   ├── vip-users.csv
│   └── critical-assets.csv
│
├── hunting-queries/
│   └── persistence-techniques.yaml
│
├── parsers/
│   └── custom-firewall-parser.json
│
├── infrastructure/
│   ├── main.bicep
│   ├── sentinel.bicep
│   └── parameters/
│       ├── dev.bicepparam
│       └── prod.bicepparam
│
├── tests/
│   ├── validate-kql-syntax.ps1
│   └── test-rule-logic.ps1
│
└── README.md</div>
                </div>

                <!-- ARM Templates -->
                <h2><i class="fas fa-file-code"></i> ARM Templates</h2>
                <div class="config-section">
                    <h4>Analytics Rule ARM Template</h4>
                    <div class="arch-diagram">ANALYTICS RULE - ARM TEMPLATE EXAMPLE
═══════════════════════════════════════════════════════════════════

{
  "$schema": "https://schema.management.azure.com/.../deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspaceName": {
      "type": "string"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "apiVersion": "2022-11-01-preview",
      "name": "[concat(parameters('workspaceName'),
                '/Microsoft.SecurityInsights/brute-force-detection')]",
      "kind": "Scheduled",
      "properties": {
        "displayName": "Brute Force Attack Detected",
        "description": "Detects multiple failed logins followed by success",
        "severity": "High",
        "enabled": true,
        "query": "SigninLogs\n| where TimeGenerated > ago(1h)\n| where ResultType != 0\n| summarize FailCount = count() by UserPrincipalName\n| where FailCount > 10",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "suppressionDuration": "PT5H",
        "suppressionEnabled": false,
        "tactics": ["CredentialAccess"],
        "techniques": ["T1110"],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "FullName",
                "columnName": "UserPrincipalName"
              }
            ]
          }
        ],
        "alertDetailsOverride": {
          "alertDisplayNameFormat": "Brute force on {{UserPrincipalName}}",
          "alertDescriptionFormat": "{{FailCount}} failed attempts detected"
        }
      }
    }
  ]
}</div>

                    <h4>Playbook (Logic App) ARM Template</h4>
                    <div class="arch-diagram">PLAYBOOK - ARM TEMPLATE STRUCTURE
═══════════════════════════════════════════════════════════════════

{
  "$schema": "https://schema.management.azure.com/.../deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "PlaybookName": { "type": "string" },
    "SentinelWorkspaceId": { "type": "string" }
  },
  "resources": [
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('PlaybookName')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.management.azure.com/.../workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "triggers": {
            "Microsoft_Sentinel_incident": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              }
            }
          },
          "actions": {
            // Your playbook actions here
          }
        }
      }
    }
  ]
}</div>
                </div>

                <!-- Bicep -->
                <h2><i class="fas fa-b"></i> Bicep Deployment</h2>
                <div class="config-section">
                    <div class="arch-diagram">BICEP - MODERN ARM ALTERNATIVE
═══════════════════════════════════════════════════════════════════

// main.bicep - Sentinel deployment
param location string = resourceGroup().location
param workspaceName string
param retentionInDays int = 90

// Log Analytics Workspace
resource workspace 'Microsoft.OperationalInsights/workspaces@2022-10-01' = {
  name: workspaceName
  location: location
  properties: {
    sku: {
      name: 'PerGB2018'
    }
    retentionInDays: retentionInDays
  }
}

// Enable Sentinel
resource sentinel 'Microsoft.OperationsManagement/solutions@2015-11-01-preview' = {
  name: 'SecurityInsights(${workspaceName})'
  location: location
  properties: {
    workspaceResourceId: workspace.id
  }
  plan: {
    name: 'SecurityInsights(${workspaceName})'
    publisher: 'Microsoft'
    product: 'OMSGallery/SecurityInsights'
    promotionCode: ''
  }
}

// Analytics Rule
resource bruteForceRule 'Microsoft.SecurityInsights/alertRules@2022-11-01' = {
  name: 'brute-force-detection'
  scope: workspace
  kind: 'Scheduled'
  properties: {
    displayName: 'Brute Force Attack Detected'
    severity: 'High'
    enabled: true
    query: '''
      SigninLogs
      | where TimeGenerated > ago(1h)
      | where ResultType != 0
      | summarize FailCount = count() by UserPrincipalName
      | where FailCount > 10
    '''
    queryFrequency: 'PT1H'
    queryPeriod: 'PT1H'
    triggerOperator: 'GreaterThan'
    triggerThreshold: 0
    tactics: ['CredentialAccess']
    techniques: ['T1110']
  }
}

output workspaceId string = workspace.id

DEPLOYMENT COMMANDS:
# Deploy with Bicep CLI
az deployment group create \
  --resource-group sentinel-rg \
  --template-file main.bicep \
  --parameters workspaceName=sentinel-prod

# Use parameter files for environments
az deployment group create \
  --resource-group sentinel-rg \
  --template-file main.bicep \
  --parameters @parameters/prod.bicepparam</div>
                </div>

                <!-- Terraform -->
                <h2><i class="fas fa-cloud"></i> Terraform</h2>
                <div class="config-section">
                    <div class="arch-diagram">TERRAFORM - SENTINEL DEPLOYMENT
═══════════════════════════════════════════════════════════════════

# providers.tf
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

# main.tf
resource "azurerm_log_analytics_workspace" "sentinel" {
  name                = var.workspace_name
  location            = var.location
  resource_group_name = var.resource_group_name
  sku                 = "PerGB2018"
  retention_in_days   = var.retention_days
}

resource "azurerm_sentinel_log_analytics_workspace_onboarding" "sentinel" {
  workspace_id = azurerm_log_analytics_workspace.sentinel.id
}

# analytics-rules.tf
resource "azurerm_sentinel_alert_rule_scheduled" "brute_force" {
  name                       = "brute-force-detection"
  log_analytics_workspace_id = azurerm_log_analytics_workspace.sentinel.id
  display_name               = "Brute Force Attack Detected"
  severity                   = "High"
  enabled                    = true
  
  query = &lt;&lt;QUERY
SigninLogs
| where TimeGenerated > ago(1h)
| where ResultType != 0
| summarize FailCount = count() by UserPrincipalName
| where FailCount > 10
QUERY

  query_frequency = "PT1H"
  query_period    = "PT1H"
  
  trigger_operator  = "GreaterThan"
  trigger_threshold = 0
  
  tactics    = ["CredentialAccess"]
  techniques = ["T1110"]
  
  entity_mapping {
    entity_type = "Account"
    field_mapping {
      identifier  = "FullName"
      column_name = "UserPrincipalName"
    }
  }
}

# variables.tf
variable "workspace_name" {
  description = "Name of the Log Analytics workspace"
  type        = string
}

variable "location" {
  description = "Azure region"
  type        = string
  default     = "eastus"
}

variable "retention_days" {
  description = "Log retention in days"
  type        = number
  default     = 90
}</div>
                </div>

                <!-- CI/CD Pipelines -->
                <h2><i class="fas fa-infinity"></i> CI/CD Pipelines</h2>
                <div class="config-section">
                    <h4>GitHub Actions</h4>
                    <div class="arch-diagram">GITHUB ACTIONS - SENTINEL DEPLOYMENT PIPELINE
═══════════════════════════════════════════════════════════════════

# .github/workflows/deploy-sentinel.yml
name: Deploy Sentinel Content

on:
  push:
    branches: [main]
    paths:
      - 'analytics-rules/**'
      - 'automation-rules/**'
      - 'playbooks/**'
  pull_request:
    branches: [main]

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: sentinel-rg
  WORKSPACE_NAME: sentinel-prod

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Validate ARM Templates
        run: |
          for file in $(find . -name "*.json" -path "./analytics-rules/*"); do
            az deployment group validate \
              --resource-group $RESOURCE_GROUP \
              --template-file $file
          done

      - name: Validate KQL Syntax
        run: |
          pwsh ./tests/validate-kql-syntax.ps1

  deploy-dev:
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment: development
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}
      
      - name: Deploy to Dev
        run: |
          az deployment group create \
            --resource-group sentinel-dev-rg \
            --template-file infrastructure/main.bicep \
            --parameters @infrastructure/parameters/dev.bicepparam

  deploy-prod:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}
      
      - name: Deploy Analytics Rules
        run: |
          for file in $(find ./analytics-rules -name "*.json"); do
            az deployment group create \
              --resource-group $RESOURCE_GROUP \
              --template-file $file \
              --parameters workspaceName=$WORKSPACE_NAME
          done</div>

                    <h4>Azure DevOps Pipeline</h4>
                    <div class="arch-diagram">AZURE DEVOPS - SENTINEL PIPELINE
═══════════════════════════════════════════════════════════════════

# azure-pipelines.yml
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - analytics-rules/*
      - playbooks/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'Sentinel-ServiceConnection'
  resourceGroup: 'sentinel-rg'
  workspaceName: 'sentinel-prod'

stages:
  - stage: Validate
    jobs:
      - job: ValidateContent
        steps:
          - task: AzureCLI@2
            displayName: 'Validate ARM Templates'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment group validate \
                  --resource-group $(resourceGroup) \
                  --template-file analytics-rules/brute-force.json

  - stage: DeployDev
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - deployment: DeployToDev
        environment: 'Sentinel-Dev'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy to Dev'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az deployment group create \
                        --resource-group sentinel-dev-rg \
                        --template-file infrastructure/main.bicep

  - stage: DeployProd
    dependsOn: Validate
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToProd
        environment: 'Sentinel-Prod'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                - task: AzureCLI@2
                  displayName: 'Deploy Analytics Rules'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      for file in $(find ./analytics-rules -name "*.json"); do
                        az deployment group create \
                          --resource-group $(resourceGroup) \
                          --template-file $file
                      done</div>
                </div>

                <!-- Testing -->
                <h2><i class="fas fa-vial"></i> Testing & Validation</h2>
                <div class="config-section">
                    <div class="arch-diagram">SENTINEL CONTENT TESTING STRATEGIES
═══════════════════════════════════════════════════════════════════

1. KQL SYNTAX VALIDATION
# PowerShell script to validate KQL
$query = Get-Content -Path $rulePath | ConvertFrom-Json
$kql = $query.properties.query

# Use Azure Monitor Query API to validate
$validateResult = Invoke-AzOperationalInsightsQuery `
  -WorkspaceId $workspaceId `
  -Query $kql `
  -Timespan (New-TimeSpan -Minutes 5)

2. UNIT TESTING WITH SAMPLE DATA
// Test query against sample data
let TestData = datatable(UserPrincipalName:string, ResultType:int)[
    "user1@company.com", 50126,
    "user1@company.com", 50126,
    // ... more test data
];
TestData
| summarize FailCount = count() by UserPrincipalName
| where FailCount > 10

3. INTEGRATION TESTING
# Deploy to dev workspace
az deployment group create \
  --resource-group sentinel-dev-rg \
  --template-file rule.json

# Wait for rule execution
Start-Sleep -Seconds 300

# Check for incidents
$incidents = Get-AzSentinelIncident `
  -ResourceGroupName sentinel-dev-rg `
  -WorkspaceName sentinel-dev

4. PERFORMANCE TESTING
// Measure query performance
SigninLogs
| where TimeGenerated > ago(7d)
| where ResultType != 0
| summarize FailCount = count() by UserPrincipalName
| where FailCount > 10

// Check execution time in query stats
// Target: < 10 seconds for hourly rule

5. FALSE POSITIVE TESTING
// Run against historical data
let LookbackDays = 30;
SigninLogs
| where TimeGenerated > ago(LookbackDays * 1d)
| where ResultType != 0
| summarize FailCount = count() by UserPrincipalName, bin(TimeGenerated, 1h)
| where FailCount > 10
| summarize DailyAlerts = count() by bin(TimeGenerated, 1d)
// Review: Is alert volume reasonable?</div>
                </div>

                <!-- Common Failures -->
                <h2><i class="fas fa-exclamation-triangle"></i> What Enterprises Usually Miss</h2>
                <div class="config-section">
                    <div class="arch-diagram">COMMON SENTINEL AS CODE FAILURES
═══════════════════════════════════════════════════════════════════

❌ FAILURE 1: No Environment Separation
   Problem: Same templates for dev and prod
   Impact: Untested rules in production
   Solution: Separate parameter files, staged deployments

❌ FAILURE 2: Hardcoded Workspace IDs
   Problem: Workspace ID in template, not parameter
   Impact: Can't deploy to different workspaces
   Solution: Parameterize all environment-specific values

❌ FAILURE 3: No Rollback Strategy
   Problem: Bad rule deployed, no way to revert
   Impact: Detection gaps, alert storms
   Solution: Git tags for releases, automated rollback pipeline

❌ FAILURE 4: Skipping Validation
   Problem: Deploy directly without testing
   Impact: Invalid KQL, broken rules
   Solution: Validate ARM templates and KQL syntax in CI

❌ FAILURE 5: Manual Secrets
   Problem: API keys in template files
   Impact: Security risk, exposed credentials
   Solution: Azure Key Vault, pipeline secrets

❌ FAILURE 6: No Documentation
   Problem: Rules without comments or README
   Impact: Team can't understand rule purpose
   Solution: Require description, MITRE mapping, author

❌ FAILURE 7: Ignoring State Drift
   Problem: Manual changes in portal not in code
   Impact: Code doesn't match reality
   Solution: Regular sync from Sentinel to repo

❌ FAILURE 8: Monolithic Deployments
   Problem: All rules in one giant template
   Impact: Slow deployments, hard to manage
   Solution: One template per rule or logical group

❌ FAILURE 9: No Naming Convention
   Problem: Inconsistent rule names
   Impact: Hard to find, sort, manage rules
   Solution: Enforce naming: [Source]-[Tactic]-[Name]-[Version]

❌ FAILURE 10: Not Using Content Hub
   Problem: Rebuilding what Microsoft provides
   Impact: Wasted effort, missing updates
   Solution: Use Content Hub for standard content, customize only when needed</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Why would you use Infrastructure as Code for Sentinel?</button>
                        <div class="qa-answer">
                            <p><strong>Key benefits of Sentinel as Code:</strong></p>
                            <ul>
                                <li><strong>Version control:</strong> Track all changes in Git, see who changed what</li>
                                <li><strong>Code review:</strong> Pull requests for security rule changes</li>
                                <li><strong>Consistency:</strong> Same configuration across dev/prod environments</li>
                                <li><strong>Disaster recovery:</strong> Rebuild entire Sentinel config from repo</li>
                                <li><strong>Scale:</strong> Deploy to multiple workspaces with single pipeline</li>
                                <li><strong>Testing:</strong> Validate rules before production deployment</li>
                                <li><strong>Compliance:</strong> Audit trail for all security configuration changes</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between ARM, Bicep, and Terraform for Sentinel?</button>
                        <div class="qa-answer">
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Aspect</th><th>ARM</th><th>Bicep</th><th>Terraform</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Syntax</td><td>JSON (verbose)</td><td>DSL (clean)</td><td>HCL (clean)</td></tr>
                                    <tr><td>Learning curve</td><td>Moderate</td><td>Easy</td><td>Easy</td></tr>
                                    <tr><td>Multi-cloud</td><td>Azure only</td><td>Azure only</td><td>Any cloud</td></tr>
                                    <tr><td>State management</td><td>None needed</td><td>None needed</td><td>State file required</td></tr>
                                    <tr><td>Sentinel support</td><td>Full</td><td>Full (compiles to ARM)</td><td>Good (some gaps)</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;"><strong>Recommendation:</strong> Use Bicep for Azure-only shops, Terraform for multi-cloud environments.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you structure a CI/CD pipeline for Sentinel?</button>
                        <div class="qa-answer">
                            <p><strong>Pipeline stages:</strong></p>
                            <ol>
                                <li><strong>Validate:</strong> Check ARM/Bicep syntax, validate KQL queries</li>
                                <li><strong>Test:</strong> Deploy to dev workspace, run test queries</li>
                                <li><strong>Stage:</strong> Deploy to staging with approval gate</li>
                                <li><strong>Production:</strong> Deploy to prod with approval gate</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Best practices:</strong></p>
                            <ul>
                                <li>Use branch policies (require PR for main)</li>
                                <li>Environment-specific parameter files</li>
                                <li>Automated rollback on failure</li>
                                <li>Notify on deployment (Teams/Slack)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you handle secrets in Sentinel deployments?</button>
                        <div class="qa-answer">
                            <p><strong>Secret management approaches:</strong></p>
                            <ol>
                                <li><strong>Azure Key Vault:</strong> Store API keys, connection strings in Key Vault; reference in templates</li>
                                <li><strong>Pipeline secrets:</strong> Use GitHub Secrets or Azure DevOps variable groups</li>
                                <li><strong>Managed Identity:</strong> Use system-assigned identity instead of API keys where possible</li>
                            </ol>
                            <div class="arch-diagram" style="margin: 10px 0;">// Reference Key Vault secret in Bicep
resource keyVault 'Microsoft.KeyVault/vaults@2022-07-01' existing = {
  name: 'my-keyvault'
}

var apiKey = keyVault.getSecret('virustotal-api-key')</div>
                            <p style="margin-top: 12px;"><strong>Never:</strong> Store secrets in code, commit secrets to Git, use plain text in templates</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
