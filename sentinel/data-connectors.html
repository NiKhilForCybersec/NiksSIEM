<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Connectors | Sentinel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        
        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Data Connectors</span>
                </div>

                <h1><i class="fas fa-plug"></i> Sentinel Data Connectors</h1>
                <p class="lead">Master Microsoft Sentinel data connectors. Learn connector types, configuration methods, troubleshooting, and best practices for ingesting security data from diverse sources.</p>

                <!-- Connector Overview -->
                <h2><i class="fas fa-info-circle"></i> Connector Overview</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Configuration → Data connectors</span></p>

                    <h4>Connector Categories</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Category</th><th>Method</th><th>Examples</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Service-to-Service</strong></td><td>Direct API integration</td><td>Azure AD, M365, Azure Activity</td></tr>
                            <tr><td><strong>API-Based</strong></td><td>REST API polling</td><td>AWS, Okta, Salesforce</td></tr>
                            <tr><td><strong>Agent-Based</strong></td><td>AMA or MMA agent</td><td>Windows Events, Syslog</td></tr>
                            <tr><td><strong>Syslog/CEF</strong></td><td>Log forwarder VM</td><td>Firewalls, Network devices</td></tr>
                            <tr><td><strong>Custom (DCR/DCE)</strong></td><td>Data Collection Rules</td><td>Custom applications</td></tr>
                            <tr><td><strong>Codeless (CCP)</strong></td><td>REST API config</td><td>Community connectors</td></tr>
                        </tbody>
                    </table>

                    <h4>Connector Architecture</h4>
                    <div class="arch-diagram">Data Connector Architecture:

SERVICE-TO-SERVICE (Easiest):
┌──────────────┐    Direct API    ┌──────────────┐
│   Azure AD   │─────────────────▶│   Sentinel   │
│   M365       │  (Native)        │  Workspace   │
│   Azure      │                  └──────────────┘
└──────────────┘

API-BASED (Managed):
┌──────────────┐    REST API      ┌──────────────┐
│   AWS        │◀────────────────▶│   Azure      │
│   Okta       │   (Polling)      │   Function   │
│   3rd Party  │                  │   or Logic   │
└──────────────┘                  │   App        │
                                  └──────┬───────┘
                                         │
                                         ▼
                                  ┌──────────────┐
                                  │   Sentinel   │
                                  │   Workspace  │
                                  └──────────────┘

SYSLOG/CEF (Agent-based):
┌──────────────┐    Syslog       ┌──────────────┐    AMA    ┌──────────────┐
│   Firewalls  │────────────────▶│   Linux VM   │─────────▶│   Sentinel   │
│   IDS/IPS    │   UDP/TCP/TLS   │  (Forwarder) │          │   Workspace  │
│   Proxies    │                 └──────────────┘          └──────────────┘
└──────────────┘</div>
                </div>

                <!-- Microsoft Connectors -->
                <h2><i class="fab fa-microsoft"></i> Microsoft Service Connectors</h2>
                <div class="config-section">
                    <h4>Azure AD / Entra ID</h4>
                    <div class="arch-diagram">Azure AD Connector:

TABLES POPULATED:
├── SigninLogs: User sign-in events
├── AADNonInteractiveUserSignInLogs: Non-interactive logins
├── AADServicePrincipalSignInLogs: Service principal activity
├── AADManagedIdentitySignInLogs: Managed identity logins
├── AADProvisioningLogs: User provisioning
├── AuditLogs: Directory changes
└── AADRiskyUsers: Identity Protection

PREREQUISITES:
├── Azure AD P1 or P2 license (for all logs)
├── Global Administrator or Security Administrator
├── Diagnostic settings permissions
└── P2 required for risky users/sign-ins

CONFIGURATION:
1. Go to Data connectors → Azure Active Directory
2. Click "Open connector page"
3. Select log types to enable
4. Click "Apply Changes"

KEY QUERIES:
// Failed sign-ins
SigninLogs
| where ResultType != 0
| summarize count() by UserPrincipalName, ResultType

// Risky sign-ins
SigninLogs
| where RiskLevelDuringSignIn in ("high", "medium")
| project TimeGenerated, UserPrincipalName, RiskLevelDuringSignIn</div>

                    <h4>Microsoft 365 Defender</h4>
                    <div class="arch-diagram">M365 Defender Connector:

TABLES POPULATED:
├── AlertInfo: Defender alerts
├── AlertEvidence: Evidence linked to alerts
├── DeviceInfo: Device inventory
├── DeviceNetworkInfo: Network configuration
├── DeviceProcessEvents: Process execution
├── DeviceNetworkEvents: Network connections
├── DeviceFileEvents: File operations
├── DeviceRegistryEvents: Registry changes
├── DeviceLogonEvents: Authentication
├── DeviceImageLoadEvents: DLL loads
├── DeviceEvents: Other events
├── EmailEvents: Email activity
├── EmailUrlInfo: URLs in emails
├── EmailAttachmentInfo: Attachments
├── IdentityLogonEvents: Identity sign-ins
├── IdentityQueryEvents: Directory queries
├── IdentityDirectoryEvents: AD changes
└── CloudAppEvents: Cloud app activity

CONFIGURATION:
1. Data connectors → Microsoft 365 Defender
2. Connect incidents and alerts
3. Select raw data tables to sync
4. Choose specific product data (MDE, MDO, MDI, MDA)

SYNC OPTIONS:
├── Incidents: Sync M365D incidents to Sentinel
├── Alerts: Include all alerts
├── Raw Data: Device*, Email*, Identity*, CloudApp*
└── Bi-directional sync: Changes reflect in both</div>

                    <h4>Azure Activity</h4>
                    <div class="arch-diagram">Azure Activity Connector:

TABLE: AzureActivity

LOG CATEGORIES:
├── Administrative: Resource operations
├── Service Health: Azure service issues
├── Resource Health: Resource availability
├── Alert: Azure Monitor alerts
├── Autoscale: Scaling events
├── Recommendation: Advisor recommendations
├── Security: Security Center alerts
└── Policy: Azure Policy events

CONFIGURATION:
1. Data connectors → Azure Activity
2. Click "Launch Azure Policy Assignment Wizard"
3. Select subscriptions to monitor
4. Assign policy to send logs to workspace

OR MANUAL (per subscription):
1. Azure Portal → Subscriptions → [Subscription]
2. Activity log → Export to Log Analytics
3. Select workspace and log categories

KEY QUERIES:
// Administrative operations
AzureActivity
| where OperationNameValue has "write" or OperationNameValue has "delete"
| summarize count() by Caller, OperationNameValue

// Failed operations
AzureActivity
| where ActivityStatusValue == "Failed"
| project TimeGenerated, Caller, OperationNameValue, ResourceGroup</div>
                </div>

                <!-- Third-Party Connectors -->
                <h2><i class="fas fa-cloud"></i> Third-Party Cloud Connectors</h2>
                <div class="config-section">
                    <h4>AWS Connector</h4>
                    <div class="arch-diagram">AWS Connector Options:

OPTION 1: AWS S3 Connector (CloudTrail, VPC Flow, GuardDuty)
├── CloudTrail logs → S3 bucket → SQS queue → Sentinel
├── VPC Flow logs → S3 bucket → SQS queue → Sentinel
├── GuardDuty findings → S3 → Sentinel
└── Tables: AWSCloudTrail, AWSVPCFlow, AWSGuardDuty

CONFIGURATION STEPS:
1. Create S3 bucket for logs
2. Enable CloudTrail to write to S3
3. Create SQS queue for notifications
4. Configure S3 event notifications to SQS
5. Create IAM role with cross-account trust
6. Add connector in Sentinel with role ARN

IAM POLICY REQUIRED:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage"
      ],
      "Resource": [
        "arn:aws:s3:::your-bucket/*",
        "arn:aws:sqs:region:account:your-queue"
      ]
    }
  ]
}

OPTION 2: AWS CloudWatch (via Azure Functions)
├── CloudWatch logs → Kinesis → Lambda → Sentinel
└── More real-time, more complex setup</div>

                    <h4>Okta Connector</h4>
                    <div class="arch-diagram">Okta Connector:

TABLE: Okta_CL (custom log)

CONFIGURATION:
1. In Okta Admin Console:
   ├── Security → API → Tokens
   ├── Create new token
   └── Copy token value

2. In Sentinel:
   ├── Data connectors → Okta Single Sign-On
   ├── Deploy Azure Function (template provided)
   ├── Configure Function App settings:
   │   ├── OktaDomain: your-org.okta.com
   │   ├── OktaToken: [API token]
   │   └── WorkspaceId/Key: [from workspace]
   └── Function polls Okta System Log API

DATA COLLECTED:
├── Authentication events
├── User lifecycle events
├── Application access
├── Policy evaluations
├── Admin actions
└── Security events

KEY QUERIES:
// Failed Okta logins
Okta_CL
| where eventType_s == "user.session.start"
| where outcome_result_s == "FAILURE"
| summarize count() by actor_alternateId_s</div>
                </div>

                <!-- Syslog/CEF Collection -->
                <h2><i class="fas fa-server"></i> Syslog/CEF Collection</h2>
                <div class="config-section">
                    <h4>Log Forwarder Setup</h4>
                    <div class="arch-diagram">Syslog/CEF Collection Architecture:

REQUIREMENTS:
├── Linux VM (Ubuntu 18.04+ or RHEL 7+)
├── Azure Monitor Agent (AMA) installed
├── Network access from log sources
├── Data Collection Rule configured
└── Syslog ports open (514 UDP/TCP, 6514 TLS)

SETUP STEPS:

1. DEPLOY LINUX VM
   ├── Size: Standard_D2s_v3 minimum
   ├── OS: Ubuntu 20.04 or RHEL 8
   ├── NSG: Allow syslog ports from sources
   └── Install AMA agent

2. INSTALL AMA
   # For Azure VMs (automatic via DCR assignment)
   # For Arc-enabled (hybrid):
   az connectedmachine extension create \
     --name AzureMonitorLinuxAgent \
     --publisher Microsoft.Azure.Monitor \
     --type AzureMonitorLinuxAgent \
     --machine-name [vmname] \
     --resource-group [rg]

3. CONFIGURE RSYSLOG
   # /etc/rsyslog.d/95-omsagent.conf
   # For CEF:
   if $rawmsg contains "CEF:" then @@127.0.0.1:25226

4. CREATE DCR
   ├── Data sources: Syslog
   ├── Facilities: auth, authpriv, local0-7
   ├── Log levels: Info and above
   └── Destination: Sentinel workspace

5. CONFIGURE SOURCES
   ├── Point firewalls/devices to forwarder IP
   ├── Use TCP for reliability
   ├── Use TLS (port 6514) when possible
   └── Test with logger command</div>

                    <h4>CEF Format</h4>
                    <div class="arch-diagram">Common Event Format (CEF):

FORMAT:
CEF:Version|Device Vendor|Device Product|Device Version|
    Signature ID|Name|Severity|Extension

EXAMPLE:
CEF:0|Palo Alto Networks|PAN-OS|10.0|THREAT|
    Spyware|7|src=192.168.1.100 dst=10.0.0.1 
    suser=jsmith act=alert

SENTINEL TABLE: CommonSecurityLog

KEY FIELDS:
├── DeviceVendor: Vendor name
├── DeviceProduct: Product name
├── Activity: Event description
├── SourceIP: Source IP address
├── DestinationIP: Destination IP
├── SourceUserName: Source user
├── DeviceAction: Action taken
└── LogSeverity: Severity level

COMMON SOURCES:
├── Palo Alto Networks
├── Check Point
├── Fortinet FortiGate
├── Cisco ASA
├── F5 BIG-IP
├── Imperva WAF
└── Trend Micro

TROUBLESHOOTING:
# Check syslog receiving
sudo tcpdump -i any port 514 -n

# Check rsyslog status
sudo systemctl status rsyslog

# Check CEF parsing
CommonSecurityLog
| where TimeGenerated > ago(1h)
| take 10</div>
                </div>

                <!-- Connector Health -->
                <h2><i class="fas fa-heartbeat"></i> Connector Health Monitoring</h2>
                <div class="config-section">
                    <div class="arch-diagram">Connector Health Queries:

// Check data freshness per table
union withsource=TableName *
| summarize LastRecord = max(TimeGenerated) by TableName
| extend HoursSinceLastRecord = datetime_diff('hour', now(), LastRecord)
| where HoursSinceLastRecord > 1
| order by HoursSinceLastRecord desc

// Data volume by table (last 24h)
Usage
| where TimeGenerated > ago(24h)
| summarize DataGB = sum(Quantity)/1024 by DataType
| order by DataGB desc

// Connector status check
SentinelHealth
| where TimeGenerated > ago(1h)
| where Status != "Success"
| summarize count() by SentinelResourceName, Status

// CEF connector health
CommonSecurityLog
| where TimeGenerated > ago(1h)
| summarize Count = count(), 
            LastEvent = max(TimeGenerated) 
  by DeviceVendor, DeviceProduct
| order by LastEvent asc

// Check for parsing errors
_CL
| where TimeGenerated > ago(24h)
| where _IsBillable == true
| summarize count() by Type
| where Type endswith "_CL"

HEALTH WORKBOOK:
├── Built-in: Data connectors health monitoring
├── Shows: Status, last log time, volume
├── Alerts: Configure alerts for gaps
└── Path: Sentinel → Workbooks → Templates</div>
                </div>

                <!-- Enterprise Connector Strategy -->
                <h2><i class="fas fa-project-diagram"></i> Enterprise Connector Strategy</h2>
                <div class="config-section">
                    <h4>Connector Selection Decision Tree</h4>
                    <div class="arch-diagram">DATA CONNECTOR SELECTION DECISION TREE
═══════════════════════════════════════════════════════════════════

START: What data source are you connecting?
│
├─► Microsoft Cloud Service (Azure AD, M365, Defender)?
│   │
│   ├─► Native connector available?
│   │   └─► USE: Service-to-Service Connector
│   │       • Zero infrastructure required
│   │       • Enable in Data Connectors page
│   │       • Requires appropriate license/permissions
│   │
│   └─► Need raw logs not in native connector?
│       └─► USE: Diagnostic Settings
│           • Configure in Azure Monitor
│           • Send to Log Analytics workspace
│
├─► Third-Party Cloud Service (AWS, Okta, Salesforce)?
│   │
│   ├─► Content Hub solution available?
│   │   └─► USE: API-Based Connector (Content Hub)
│   │       • Install from Content Hub
│   │       • Configure API credentials
│   │       • Azure Functions powered
│   │
│   └─► No solution available?
│       └─► BUILD: Custom Connector
│           • Azure Function with API polling
│           • Data Collection Endpoint + DCR
│           • Custom table (_CL)
│
├─► On-Premises Server (Windows/Linux)?
│   │
│   ├─► Windows Server?
│   │   └─► USE: Azure Monitor Agent (AMA)
│   │       • Install AMA extension
│   │       • Create DCR for Windows Events
│   │       • Tables: SecurityEvent, Event, Perf
│   │
│   └─► Linux Server?
│       └─► USE: Azure Monitor Agent (AMA)
│           • Install AMA extension
│           • Create DCR for Syslog
│           • Tables: Syslog
│
├─► Network Device (Firewall, IDS, Proxy)?
│   │
│   ├─► Supports CEF format?
│   │   └─► USE: CEF via AMA
│   │       • Deploy Linux forwarder VM
│   │       • Configure rsyslog
│   │       • Table: CommonSecurityLog
│   │
│   ├─► Syslog only (no CEF)?
│   │   └─► USE: Syslog via AMA
│   │       • Deploy Linux forwarder
│   │       • Table: Syslog
│   │       • May need custom parsing
│   │
│   └─► API available for logs?
│       └─► USE: Custom API Connector
│           • Azure Function polling
│           • Better reliability than syslog
│
└─► Custom Application Logs?
    │
    └─► USE: Custom Log Ingestion
        • Data Collection Endpoint (DCE)
        • Data Collection Rule (DCR)
        • Custom table with _CL suffix
        • See custom-log-onboarding.html</div>

                    <h4>Enterprise Connector Architecture</h4>
                    <div class="arch-diagram">MULTI-ENVIRONMENT CONNECTOR ARCHITECTURE
═══════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────┐
│                     MICROSOFT SENTINEL                          │
│                    Log Analytics Workspace                       │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │
    ┌─────────────────────────┼─────────────────────────┐
    │                         │                         │
    ▼                         ▼                         ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   NATIVE    │      │   AGENT     │      │    API      │
│ CONNECTORS  │      │   BASED     │      │   BASED     │
└─────────────┘      └─────────────┘      └─────────────┘
    │                     │                     │
    ├── Azure AD          ├── Windows AMA      ├── AWS CloudTrail
    ├── M365 Defender     ├── Linux AMA        ├── Okta
    ├── Azure Activity    ├── CEF Forwarder    ├── Salesforce
    ├── Defender Cloud    └── Syslog           ├── Custom APIs
    └── Microsoft TI                           └── Azure Functions

FORWARDER VM SIZING:
├── Small (< 5 GB/day): Standard_D2s_v3 (2 vCPU, 8 GB)
├── Medium (5-20 GB/day): Standard_D4s_v3 (4 vCPU, 16 GB)
├── Large (20-50 GB/day): Standard_D8s_v3 (8 vCPU, 32 GB)
└── Enterprise (> 50 GB/day): Multiple forwarders with load balancer

HIGH AVAILABILITY DESIGN:
┌────────────────────────────────────────────────────────────────┐
│                    Azure Load Balancer                          │
│                  (UDP port 514 / TCP 514)                       │
└────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │Forwarder1│   │Forwarder2│   │Forwarder3│
        │   AMA    │   │   AMA    │   │   AMA    │
        └──────────┘   └──────────┘   └──────────┘</div>
                </div>

                <!-- Common Failures -->
                <h2><i class="fas fa-exclamation-triangle"></i> What Enterprises Usually Miss</h2>
                <div class="config-section">
                    <div class="arch-diagram">COMMON DATA CONNECTOR FAILURES AND SOLUTIONS
═══════════════════════════════════════════════════════════════════

❌ FAILURE 1: Using MMA Instead of AMA
   Problem: Deploying legacy Microsoft Monitoring Agent
   Impact: No DCR flexibility, approaching deprecation
   Solution: Use Azure Monitor Agent (AMA) for all new deployments

❌ FAILURE 2: Single Point of Failure Forwarder
   Problem: One syslog forwarder VM for all network logs
   Impact: Forwarder down = all firewall/network logs lost
   Solution: Deploy HA forwarder pair with load balancer

❌ FAILURE 3: Undersized Forwarder VM
   Problem: Small VM overwhelmed by log volume
   Impact: Dropped logs, high latency, gaps in data
   Solution: Size forwarder based on GB/day, monitor CPU/memory

❌ FAILURE 4: Not Monitoring Connector Health
   Problem: No alerting on connector failures
   Impact: Data gaps discovered during incident investigation
   Solution: Build connector health workbook, alert on gaps > 1 hour

❌ FAILURE 5: Missing Prerequisites
   Problem: Connector enabled but data not flowing
   Impact: False sense of coverage, investigation gaps
   Solution: Verify permissions, licenses, network connectivity first

❌ FAILURE 6: Duplicate Data Collection
   Problem: Same source sending to multiple connectors
   Impact: Double billing, query confusion
   Solution: Audit data paths, use one collection method per source

❌ FAILURE 7: No Data Validation
   Problem: Connector shows connected but data is malformed
   Impact: Analytics rules don't fire, missed detections
   Solution: Query sample data, validate field extraction

❌ FAILURE 8: CEF Field Mapping Issues
   Problem: Vendor uses non-standard CEF extensions
   Impact: Data in wrong fields, enrichment fails
   Solution: Review vendor CEF implementation, use transformation DCR

❌ FAILURE 9: API Connector Rate Limits
   Problem: Custom connector hits API rate limits
   Impact: Delayed data, gaps during high-volume periods
   Solution: Implement backoff/retry, increase polling interval

❌ FAILURE 10: Not Using Content Hub Solutions
   Problem: Building custom connectors for common sources
   Impact: Wasted effort, maintenance burden
   Solution: Check Content Hub first for existing solutions</div>
                </div>

                <!-- Health Monitoring -->
                <h2><i class="fas fa-heartbeat"></i> Connector Health Monitoring</h2>
                <div class="config-section">
                    <div class="arch-diagram">PROACTIVE CONNECTOR HEALTH MONITORING
═══════════════════════════════════════════════════════════════════

DATA SOURCES FOR HEALTH MONITORING:
├── SentinelHealth table (Sentinel-specific health events)
├── Heartbeat table (Agent heartbeat)
├── Usage table (Data ingestion metrics)
├── _LogOperation table (Internal log operations)
└── AzureActivity (Connector configuration changes)

SENTINELHEALTH TABLE:
// Check connector health status
SentinelHealth
| where TimeGenerated > ago(24h)
| where OperationName == "Data fetch status change"
| where Status != "Success"
| project TimeGenerated, SentinelResourceName, Description, Status
| order by TimeGenerated desc

// Connector failure summary
SentinelHealth
| where TimeGenerated > ago(7d)
| where Status == "Failure"
| summarize FailureCount = count() by SentinelResourceName
| order by FailureCount desc

AGENT HEARTBEAT MONITORING:
// Agents not reporting in last 30 minutes
Heartbeat
| summarize LastHeartbeat = max(TimeGenerated) by Computer, OSType
| where LastHeartbeat < ago(30m)
| project Computer, OSType, LastHeartbeat, 
          MinutesSinceHeartbeat = datetime_diff('minute', now(), LastHeartbeat)

// Agent health distribution
Heartbeat
| where TimeGenerated > ago(1h)
| summarize by Computer, OSType
| summarize AgentCount = count() by OSType</div>

                    <h4>Data Gap Detection</h4>
                    <div class="arch-diagram">DATA GAP DETECTION QUERIES
═══════════════════════════════════════════════════════════════════

// Generic gap detection for any table
let TableName = "SecurityEvent";
let ExpectedInterval = 15m;
let Lookback = 24h;
union isfuzzy=true (
    datatable(TimeGenerated:datetime)[]
), (
    SecurityEvent
    | where TimeGenerated > ago(Lookback)
    | summarize Count = count() by bin(TimeGenerated, ExpectedInterval)
    | where Count > 0
)
| make-series Count = sum(Count) on TimeGenerated from ago(Lookback) to now() step ExpectedInterval
| mv-expand TimeGenerated, Count
| extend TimeGenerated = todatetime(TimeGenerated), Count = toint(Count)
| where Count == 0

// Multi-table gap detection
let Tables = dynamic(["SecurityEvent", "SigninLogs", "AuditLogs", "CommonSecurityLog"]);
union withsource=TableName *
| where TimeGenerated > ago(24h)
| where TableName in (Tables)
| summarize LastEvent = max(TimeGenerated), EventCount = count() by TableName
| extend MinutesSinceLastEvent = datetime_diff('minute', now(), LastEvent)
| where MinutesSinceLastEvent > 30
| project TableName, LastEvent, MinutesSinceLastEvent, EventCount

// Ingestion delay detection
SigninLogs
| where TimeGenerated > ago(1h)
| extend IngestionDelay = ingestion_time() - TimeGenerated
| summarize 
    AvgDelay = avg(IngestionDelay),
    MaxDelay = max(IngestionDelay),
    P95Delay = percentile(IngestionDelay, 95)
| extend AvgDelayMinutes = AvgDelay / 1m,
         MaxDelayMinutes = MaxDelay / 1m,
         P95DelayMinutes = P95Delay / 1m</div>

                    <h4>Health Monitoring Playbook</h4>
                    <div class="arch-diagram">AUTOMATED HEALTH MONITORING PLAYBOOK
═══════════════════════════════════════════════════════════════════

TRIGGER: Scheduled (every 15 minutes)

LOGIC APP WORKFLOW:
┌─────────────────────────────────────────────────────────────────┐
│ 1. QUERY SENTINEL                                                │
│    └── Run KQL: Check for data gaps > 30 minutes                │
│                                                                  │
│ 2. FOR EACH GAP DETECTED                                        │
│    ├── Check if existing incident open                          │
│    ├── If no incident: Create new incident                      │
│    └── If existing: Update with current status                  │
│                                                                  │
│ 3. NOTIFY                                                        │
│    ├── Teams message to SOC channel                             │
│    ├── Email to on-call engineer                                │
│    └── PagerDuty for critical gaps (>1 hour)                    │
│                                                                  │
│ 4. LOG RESULTS                                                   │
│    └── Write health check results to custom log                 │
└─────────────────────────────────────────────────────────────────┘

ANALYTICS RULE FOR DATA GAPS:
Name: Critical Data Connector Gap Detected
Severity: High
Query frequency: 15 minutes
Query period: 1 hour

let CriticalTables = dynamic(["SecurityEvent", "SigninLogs", "CommonSecurityLog"]);
union withsource=TableName *
| where TableName in (CriticalTables)
| summarize LastEvent = max(TimeGenerated) by TableName
| extend MinutesSinceLastEvent = datetime_diff('minute', now(), LastEvent)
| where MinutesSinceLastEvent > 60

ALERT THRESHOLDS:
┌────────────────────────┬───────────────┬───────────────────────┐
│ Data Source            │ Warning       │ Critical              │
├────────────────────────┼───────────────┼───────────────────────┤
│ Security Events        │ > 30 min gap  │ > 1 hour gap          │
│ Azure AD Sign-in       │ > 15 min gap  │ > 30 min gap          │
│ Firewall/CEF           │ > 15 min gap  │ > 30 min gap          │
│ Cloud App Logs         │ > 1 hour gap  │ > 4 hour gap          │
│ Office 365             │ > 30 min gap  │ > 1 hour gap          │
└────────────────────────┴───────────────┴───────────────────────┘</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What are the main data connector types in Sentinel?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>Service-to-Service:</strong> Native Azure/M365 integration (Azure AD, M365 Defender)</li>
                                <li><strong>API-Based:</strong> REST API polling (AWS, Okta, third-party)</li>
                                <li><strong>Agent-Based:</strong> AMA or MMA agent (Windows/Linux servers)</li>
                                <li><strong>Syslog/CEF:</strong> Linux forwarder VM (firewalls, network devices)</li>
                                <li><strong>Custom DCR:</strong> Data Collection Rules for custom sources</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you collect firewall logs in Sentinel?</button>
                        <div class="qa-answer">
                            <ol>
                                <li>Deploy Linux VM as log forwarder</li>
                                <li>Install Azure Monitor Agent (AMA)</li>
                                <li>Configure rsyslog to receive logs</li>
                                <li>Create Data Collection Rule for Syslog/CEF</li>
                                <li>Point firewall syslog to forwarder IP</li>
                            </ol>
                            <p>Logs appear in <code>CommonSecurityLog</code> table (CEF) or <code>Syslog</code> table.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you troubleshoot a connector not receiving data?</button>
                        <div class="qa-answer">
                            <ol>
                                <li>Check connector status page for errors</li>
                                <li>Verify prerequisites (permissions, licenses)</li>
                                <li>Query table for recent data: <code>TableName | where TimeGenerated > ago(1h)</code></li>
                                <li>For syslog: Check rsyslog service, tcpdump on port 514</li>
                                <li>Check AMA/agent health on source machine</li>
                                <li>Review DCR configuration and assignments</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What tables does M365 Defender connector populate?</button>
                        <div class="qa-answer">
                            <p>Key tables include:</p>
                            <ul>
                                <li><strong>Alerts:</strong> AlertInfo, AlertEvidence</li>
                                <li><strong>Devices:</strong> DeviceInfo, DeviceProcessEvents, DeviceNetworkEvents, DeviceFileEvents</li>
                                <li><strong>Email:</strong> EmailEvents, EmailUrlInfo, EmailAttachmentInfo</li>
                                <li><strong>Identity:</strong> IdentityLogonEvents, IdentityDirectoryEvents</li>
                                <li><strong>Cloud Apps:</strong> CloudAppEvents</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you design a high-availability syslog/CEF collection architecture?</button>
                        <div class="qa-answer">
                            <p><strong>HA forwarder architecture:</strong></p>
                            <ol>
                                <li><strong>Deploy multiple forwarders:</strong> Minimum 2 VMs in availability set or zones</li>
                                <li><strong>Azure Load Balancer:</strong> Configure UDP/TCP 514 to backend pool
                                    <ul>
                                        <li>Health probe on port 514</li>
                                        <li>Session persistence: None (round-robin)</li>
                                    </ul>
                                </li>
                                <li><strong>Forwarder configuration:</strong>
                                    <ul>
                                        <li>Identical rsyslog.conf on all forwarders</li>
                                        <li>AMA installed with same DCR</li>
                                    </ul>
                                </li>
                                <li><strong>Point sources to LB IP:</strong> All firewalls/devices send to load balancer VIP</li>
                                <li><strong>Monitoring:</strong> Alert on forwarder health, CPU, log gaps</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Note:</strong> Some syslog implementations don't handle load balancer well - test failover scenarios.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you validate data quality after connecting a new source?</button>
                        <div class="qa-answer">
                            <p><strong>Data validation checklist:</strong></p>
                            <ol>
                                <li><strong>Verify data arrival:</strong>
                                    <div class="arch-diagram" style="margin: 10px 0;">TableName
| where TimeGenerated > ago(1h)
| count</div>
                                </li>
                                <li><strong>Check field extraction:</strong>
                                    <div class="arch-diagram" style="margin: 10px 0;">TableName
| where TimeGenerated > ago(1h)
| project-reorder TimeGenerated, *
| take 10</div>
                                </li>
                                <li><strong>Validate key fields populated:</strong> Check SourceIP, UserName, etc. are not empty</li>
                                <li><strong>Test analytics rules:</strong> Run existing rules against new data to confirm matches</li>
                                <li><strong>Compare volume:</strong> Verify EPS matches expected rate from source</li>
                                <li><strong>Check for parsing errors:</strong> Look for raw data in wrong fields</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between AMA and MMA, and when would you use each?</button>
                        <div class="qa-answer">
                            <p><strong>Agent comparison:</strong></p>
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Feature</th><th>AMA (Azure Monitor Agent)</th><th>MMA (Legacy)</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Deployment</td><td>VM Extension, Arc</td><td>Standalone installer</td></tr>
                                    <tr><td>Configuration</td><td>Data Collection Rules (DCR)</td><td>Workspace config</td></tr>
                                    <tr><td>Multi-homing</td><td>Yes, via multiple DCRs</td><td>Limited</td></tr>
                                    <tr><td>Transformation</td><td>Yes, KQL in DCR</td><td>No</td></tr>
                                    <tr><td>Status</td><td>Current, recommended</td><td>Deprecated Aug 2024</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;"><strong>Recommendation:</strong> Always use AMA for new deployments. Migrate existing MMA agents to AMA.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        // Q&A toggle
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        // Close sidebar on resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>