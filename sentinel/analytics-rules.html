<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Rules | Microsoft Sentinel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        .config-section { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin: 16px 0; }
        .code-block { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; font-family: 'Fira Code', monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre; }
        .console-path { background: #0d1117; padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; color: #0078d4; margin: 8px 0; display: inline-block; }
        .rule-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin: 16px 0; border-left: 4px solid #0078d4; }
    </style>
</head>
<body>
    <div class="app-container">
                        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Sentinel Platform</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-connectors.html" class="nav-link"><i class="fas fa-plug"></i> Data Connectors</a>
                    <a href="dcr-dce-guide.html" class="nav-link"><i class="fas fa-cogs"></i> DCR & DCE Guide</a>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion Patterns</a>
                    <a href="event-hub.html" class="nav-link"><i class="fas fa-broadcast-tower"></i> Event Hub</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing & Transform</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">KQL Query Language</div>
                    <a href="kql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> KQL Fundamentals</a>
                    <a href="kql-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> KQL Intermediate</a>
                    <a href="kql-advanced.html" class="nav-link"><i class="fas fa-code"></i> KQL Advanced</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="analytics-rules.html" class="nav-link active"><i class="fas fa-project-diagram"></i> Analytics Rules</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-skull-crossbones"></i> Threat Intelligence</a>
                    <a href="automation.html" class="nav-link"><i class="fas fa-robot"></i> Automation (Playbooks)</a>
                    <a href="content-hub.html" class="nav-link"><i class="fas fa-store"></i> Content Hub</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="workbooks.html" class="nav-link"><i class="fas fa-chart-bar"></i> Workbooks</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users"></i> SOC Operations</a>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">Sentinel</a><span class="separator">/</span>
                    <span class="current">Analytics Rules</span>
                </div>
            </header>
            <main class="main-content">
                <h1><i class="fas fa-chart-line"></i> Analytics Rules</h1>
                <p class="lead">Create and manage detection rules in Microsoft Sentinel to identify threats across your environment. Learn rule types, configuration options, and best practices.</p>

                <!-- Rule Types -->
                <h2><i class="fas fa-layer-group"></i> Analytics Rule Types</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Analytics → Rule Templates</span></p>

                    <table class="styled-table">
                        <thead>
                            <tr><th>Rule Type</th><th>Description</th><th>Use Case</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Scheduled</strong></td>
                                <td>KQL query runs on schedule</td>
                                <td>Most common, flexible detection</td>
                            </tr>
                            <tr>
                                <td><strong>NRT (Near Real-Time)</strong></td>
                                <td>Runs every minute</td>
                                <td>Critical, time-sensitive detections</td>
                            </tr>
                            <tr>
                                <td><strong>Microsoft Security</strong></td>
                                <td>Imports from Microsoft products</td>
                                <td>M365 Defender, Defender for Cloud</td>
                            </tr>
                            <tr>
                                <td><strong>Fusion</strong></td>
                                <td>ML-based correlation</td>
                                <td>Advanced multi-stage attack detection</td>
                            </tr>
                            <tr>
                                <td><strong>ML Behavior Analytics</strong></td>
                                <td>User/entity behavior</td>
                                <td>Anomaly detection, UEBA</td>
                            </tr>
                            <tr>
                                <td><strong>Threat Intelligence</strong></td>
                                <td>IOC matching</td>
                                <td>Known threat indicators</td>
                            </tr>
                            <tr>
                                <td><strong>Anomaly</strong></td>
                                <td>Built-in anomaly detection</td>
                                <td>Baseline deviation detection</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Creating Scheduled Rules -->
                <h2><i class="fas fa-clock"></i> Scheduled Rules</h2>
                <div class="config-section">
                    <p><span class="console-path">Analytics → Create → Scheduled query rule</span></p>

                    <h4>Rule Configuration Tabs</h4>
                    <div class="code-block">Rule Configuration Steps:

1. GENERAL
   - Name: Descriptive rule name
   - Description: What it detects
   - Severity: High/Medium/Low/Informational
   - MITRE ATT&CK: Map to techniques
   - Status: Enabled/Disabled

2. SET RULE LOGIC
   - Rule query: KQL detection query
   - Entity mapping: Map fields to entities
   - Alert details: Dynamic alert content
   - Query scheduling: How often to run
   - Alert threshold: When to generate alert

3. INCIDENT SETTINGS
   - Create incidents: Yes/No
   - Alert grouping: Group related alerts

4. AUTOMATED RESPONSE
   - Automation rules
   - Playbooks to trigger</div>

                    <h4>Query Scheduling Options</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Setting</th><th>Description</th><th>Recommendation</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Run query every</strong></td>
                                <td>Execution frequency</td>
                                <td>5min - 24hr based on urgency</td>
                            </tr>
                            <tr>
                                <td><strong>Lookup data from</strong></td>
                                <td>Time window to search</td>
                                <td>Should overlap with run frequency</td>
                            </tr>
                            <tr>
                                <td><strong>Start running</strong></td>
                                <td>When rule activates</td>
                                <td>Automatically or specific time</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="code-block">Scheduling Example:

Run query every: 15 minutes
Lookup data from: Last 20 minutes
(5 minute overlap catches edge cases)

For critical detections:
Run query every: 5 minutes
Lookup data from: Last 10 minutes

For daily reports:
Run query every: 24 hours
Lookup data from: Last 25 hours</div>
                </div>

                <!-- Entity Mapping -->
                <h2><i class="fas fa-link"></i> Entity Mapping</h2>
                <div class="config-section">
                    <p>Entity mapping connects query results to Sentinel entity types for investigation.</p>

                    <h4>Entity Types</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Entity</th><th>Key Fields</th><th>Use Case</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Account</strong></td><td>Name, UPNSuffix, AadUserId, Sid</td><td>User accounts</td></tr>
                            <tr><td><strong>Host</strong></td><td>HostName, DnsDomain, AzureID</td><td>Computers/servers</td></tr>
                            <tr><td><strong>IP</strong></td><td>Address</td><td>IP addresses</td></tr>
                            <tr><td><strong>URL</strong></td><td>Url</td><td>Web URLs</td></tr>
                            <tr><td><strong>File</strong></td><td>Name, Directory</td><td>File paths</td></tr>
                            <tr><td><strong>FileHash</strong></td><td>Algorithm, Value</td><td>MD5, SHA1, SHA256</td></tr>
                            <tr><td><strong>Process</strong></td><td>ProcessId, CommandLine</td><td>Running processes</td></tr>
                            <tr><td><strong>MailMessage</strong></td><td>Recipient, Sender, Subject</td><td>Email messages</td></tr>
                        </tbody>
                    </table>

                    <h4>Entity Mapping Example</h4>
                    <div class="code-block">Query returning these fields:
| project UserName, HostName, SourceIP, TargetFile

Entity Mappings:
Account:
  - Identifier: Name
  - Value: UserName

Host:
  - Identifier: HostName  
  - Value: HostName

IP:
  - Identifier: Address
  - Value: SourceIP

File:
  - Identifier: Name
  - Value: TargetFile</div>
                </div>

                <!-- Example Rules -->
                <h2><i class="fas fa-shield-alt"></i> Example Detection Rules</h2>
                <div class="config-section">
                    <div class="rule-card">
                        <h4>Brute Force Detection</h4>
                        <div class="code-block">// Rule: Brute Force Attack Detected
SigninLogs
| where TimeGenerated > ago(20m)
| where ResultType != 0
| summarize 
    FailedAttempts = count(),
    DistinctUsers = dcount(UserPrincipalName),
    TargetedUsers = make_set(UserPrincipalName, 10)
    by IPAddress, bin(TimeGenerated, 5m)
| where FailedAttempts > 15 or DistinctUsers > 5
| project TimeGenerated, IPAddress, FailedAttempts, DistinctUsers, TargetedUsers

Settings:
- Run every: 5 minutes
- Lookup: 20 minutes
- Severity: High
- MITRE: T1110 - Brute Force
- Entity: IP (IPAddress)</div>
                    </div>

                    <div class="rule-card">
                        <h4>Suspicious PowerShell Execution</h4>
                        <div class="code-block">// Rule: Suspicious PowerShell Command Line
DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any (
    "-enc", "-EncodedCommand",
    "IEX", "Invoke-Expression",
    "DownloadString", "DownloadFile",
    "-nop", "-noprofile",
    "bypass", "-w hidden"
)
| project TimeGenerated, DeviceName, AccountName, ProcessCommandLine, 
          InitiatingProcessFileName

Settings:
- Run every: 15 minutes
- Lookup: 1 hour
- Severity: Medium
- MITRE: T1059.001 - PowerShell
- Entities: Host (DeviceName), Account (AccountName)</div>
                    </div>

                    <div class="rule-card">
                        <h4>Impossible Travel</h4>
                        <div class="code-block">// Rule: Impossible Travel Detection
let threshold_hours = 2;
let threshold_distance_km = 500;
SigninLogs
| where TimeGenerated > ago(24h)
| where ResultType == 0
| extend Lat = toreal(LocationDetails.geoCoordinates.latitude)
| extend Lon = toreal(LocationDetails.geoCoordinates.longitude)
| order by UserPrincipalName, TimeGenerated
| serialize
| extend PrevTime = prev(TimeGenerated), PrevLat = prev(Lat), PrevLon = prev(Lon), PrevUser = prev(UserPrincipalName)
| where UserPrincipalName == PrevUser
| extend HoursDiff = datetime_diff('hour', TimeGenerated, PrevTime)
| extend DistanceKm = geo_distance_2points(Lon, Lat, PrevLon, PrevLat) / 1000
| where HoursDiff > 0 and HoursDiff < threshold_hours and DistanceKm > threshold_distance_km
| project TimeGenerated, UserPrincipalName, IPAddress, Location, DistanceKm, HoursDiff

Settings:
- Run every: 1 hour
- Lookup: 24 hours
- Severity: High
- MITRE: T1078 - Valid Accounts</div>
                    </div>

                    <div class="rule-card">
                        <h4>New Inbox Rule (BEC Detection)</h4>
                        <div class="code-block">// Rule: Suspicious Inbox Rule Created
OfficeActivity
| where TimeGenerated > ago(1h)
| where Operation == "New-InboxRule"
| extend RuleParameters = parse_json(Parameters)
| extend ForwardTo = tostring(RuleParameters.ForwardTo)
| extend RedirectTo = tostring(RuleParameters.RedirectTo)
| extend DeleteMessage = tostring(RuleParameters.DeleteMessage)
| where isnotempty(ForwardTo) or isnotempty(RedirectTo) or DeleteMessage == "True"
| project TimeGenerated, UserId, ClientIP, Operation, ForwardTo, RedirectTo, DeleteMessage

Settings:
- Run every: 15 minutes
- Lookup: 1 hour
- Severity: Medium
- MITRE: T1114.003 - Email Forwarding Rule</div>
                    </div>
                </div>

                <!-- NRT Rules -->
                <h2><i class="fas fa-bolt"></i> Near Real-Time (NRT) Rules</h2>
                <div class="config-section">
                    <p>NRT rules run every minute for time-critical detections.</p>

                    <h4>NRT vs Scheduled</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Aspect</th><th>NRT</th><th>Scheduled</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Frequency</td><td>Every 1 minute</td><td>5 min - 24 hours</td></tr>
                            <tr><td>Latency</td><td>~1 minute</td><td>Depends on schedule</td></tr>
                            <tr><td>Lookback</td><td>Up to 14 days</td><td>Up to 14 days</td></tr>
                            <tr><td>Use Case</td><td>Critical threats</td><td>General detection</td></tr>
                            <tr><td>Cost</td><td>Higher (more queries)</td><td>Lower</td></tr>
                        </tbody>
                    </table>

                    <h4>Good NRT Candidates</h4>
                    <ul style="color: #8b949e;">
                        <li>Ransomware indicators</li>
                        <li>Known malicious hashes</li>
                        <li>Critical credential theft</li>
                        <li>Active C2 communication</li>
                        <li>Security tool tampering</li>
                    </ul>

                    <div class="code-block">// NRT Rule: LSASS Memory Access
DeviceProcessEvents
| where FileName in~ ("procdump.exe", "mimikatz.exe", "nanodump.exe")
| where ProcessCommandLine has_any ("lsass", "-ma", "sekurlsa")
| project TimeGenerated, DeviceName, AccountName, FileName, ProcessCommandLine</div>
                </div>

                <!-- Alert Details -->
                <h2><i class="fas fa-info-circle"></i> Custom Alert Details</h2>
                <div class="config-section">
                    <p>Customize alert content using query result fields.</p>

                    <h4>Dynamic Alert Fields</h4>
                    <div class="code-block">Alert Name Format:
"Brute Force from {{IPAddress}} targeting {{DistinctUsers}} users"

Alert Description Format:
"Detected {{FailedAttempts}} failed login attempts from IP {{IPAddress}} 
against {{DistinctUsers}} unique accounts. Targeted users: {{TargetedUsers}}"

Custom Details (key-value pairs shown in alert):
- Source IP: {{IPAddress}}
- Failed Attempts: {{FailedAttempts}}
- Targeted Users: {{TargetedUsers}}</div>

                    <h4>Using Custom Details</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Field</th><th>Example Value</th><th>Purpose</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Alert Name</td><td>Dynamic with {{field}}</td><td>Identify alert at glance</td></tr>
                            <tr><td>Description</td><td>Dynamic narrative</td><td>Context for analyst</td></tr>
                            <tr><td>Custom Details</td><td>Key-value pairs</td><td>Quick reference data</td></tr>
                            <tr><td>Tactics</td><td>MITRE tactics</td><td>Attack classification</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Incident Settings -->
                <h2><i class="fas fa-folder"></i> Incident Settings</h2>
                <div class="config-section">
                    <h4>Alert Grouping</h4>
                    <div class="code-block">Alert Grouping Options:

Group alerts into a single incident if:
- Alerts are triggered by this rule
- Within time frame: [1-24 hours, 1-7 days]

Grouping By:
□ All entities match
□ Selected entities match (Account, Host, IP, etc.)

Example:
- Group all brute force alerts from same IP
- Group alerts affecting same user within 24 hours

Reopening Incidents:
□ Reopen if new alert added to resolved incident</div>

                    <h4>Grouping Best Practices</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Same attacker:</strong> Group by source IP</li>
                        <li><strong>Same target:</strong> Group by affected host or user</li>
                        <li><strong>Attack campaign:</strong> Group by matching entities</li>
                        <li><strong>Time window:</strong> 24 hours for most rules</li>
                    </ul>
                </div>

                <!-- Automation -->
                <h2><i class="fas fa-robot"></i> Automated Response</h2>
                <div class="config-section">
                    <h4>Automation Rules</h4>
                    <div class="code-block">Automation Rule Capabilities:

When incident is created:
- Change status (New → Active)
- Assign to analyst or group
- Add tags
- Change severity
- Run playbook

Conditions:
- Analytics rule name
- Incident severity
- Entities present
- Incident title contains

Example Automation:
Trigger: "Brute Force" rule
Conditions: Severity = High
Actions:
  1. Assign to: SOC-Tier2
  2. Add tag: "authentication-attack"
  3. Run playbook: "Enrich-IP-Address"</div>

                    <h4>Common Playbook Actions</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Action</th><th>Playbook</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>IP Enrichment</td><td>Get-IPReputation, GeoIP-Lookup</td></tr>
                            <tr><td>User Investigation</td><td>Get-AADUserDetails, Get-Manager</td></tr>
                            <tr><td>Containment</td><td>Isolate-Device, Block-IP</td></tr>
                            <tr><td>Notification</td><td>Send-TeamsMessage, Create-Ticket</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Rule Tuning -->
                <h2><i class="fas fa-sliders-h"></i> Rule Tuning</h2>
                <div class="config-section">
                    <h4>Reducing False Positives</h4>
                    <div class="code-block">Tuning Strategies:

1. Add Exclusions in Query
   | where UserPrincipalName !in ("service-account@domain.com")
   | where IPAddress !in ("10.0.0.1", "10.0.0.2")

2. Adjust Thresholds
   | where FailedAttempts > 20  // Increase from 10
   
3. Add Time Context
   | where hourofday(TimeGenerated) !between (9 .. 17)  // After hours only

4. Exclude Known Behavior
   | where not(ProcessCommandLine has "approved-script.ps1")

5. Use Watchlists for Exclusions
   | join kind=leftanti (
       _GetWatchlist('SafeIPs') | project IPAddress
   ) on IPAddress</div>

                    <h4>Tuning Workflow</h4>
                    <div class="code-block">1. Identify high-FP rule
2. Analyze false positive patterns
3. Test exclusion in hunting query
4. Update rule with exclusion
5. Monitor for reduced FPs
6. Document changes</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: When would you use NRT vs scheduled rules?</button>
                        <div class="qa-answer">
                            <p><strong>Use NRT for:</strong></p>
                            <ul>
                                <li>Critical threats requiring immediate response</li>
                                <li>Known malicious indicators (IOCs)</li>
                                <li>Active attack patterns (ransomware, credential theft)</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Use Scheduled for:</strong></p>
                            <ul>
                                <li>General detection rules</li>
                                <li>Aggregation-based detections (stats over time)</li>
                                <li>Cost optimization</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you reduce false positives in Sentinel rules?</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Analyze FP patterns:</strong> What triggers false alerts?</li>
                                <li><strong>Add query exclusions:</strong> Filter known-good activity</li>
                                <li><strong>Use watchlists:</strong> Dynamic exclusion lists</li>
                                <li><strong>Adjust thresholds:</strong> Increase sensitivity requirements</li>
                                <li><strong>Add context:</strong> Time, location, user type</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What is entity mapping and why is it important?</button>
                        <div class="qa-answer">
                            <p>Entity mapping connects query fields to Sentinel entity types (Account, Host, IP, etc.):</p>
                            <ul>
                                <li><strong>Investigation:</strong> Enables entity pages and timelines</li>
                                <li><strong>Correlation:</strong> Groups alerts by same entity</li>
                                <li><strong>Enrichment:</strong> Adds context to entities</li>
                                <li><strong>UEBA:</strong> Connects to behavior analytics</li>
                            </ul>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>

                <!-- Rule Templates -->
                <h2><i class="fas fa-copy"></i> Rule Templates</h2>
                <div class="config-section">
                    <p><span class="console-path">Analytics → Rule Templates</span></p>

                    <h4>Template Sources</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Source</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Microsoft Security Research</strong></td><td>Built-in Sentinel templates</td></tr>
                            <tr><td><strong>Data Connectors</strong></td><td>Templates from connector providers</td></tr>
                            <tr><td><strong>Content Hub</strong></td><td>Solutions with bundled rules</td></tr>
                            <tr><td><strong>Community</strong></td><td>GitHub and community contributions</td></tr>
                        </tbody>
                    </table>

                    <h4>Using Templates</h4>
                    <div class="code-block">Template Workflow:

1. Browse Rule Templates
   - Filter by data source
   - Filter by MITRE tactic
   - Filter by severity

2. Review Template
   - Check required data sources
   - Review detection logic
   - Understand what it detects

3. Create Rule from Template
   - Customize thresholds
   - Adjust scheduling
   - Add entity mappings
   - Configure automation

4. Test and Tune
   - Run in detection-only first
   - Monitor for false positives
   - Adjust as needed</div>
                </div>

                <!-- Watchlists -->
                <h2><i class="fas fa-list-alt"></i> Using Watchlists in Rules</h2>
                <div class="config-section">
                    <p><span class="console-path">Configuration → Watchlist</span></p>

                    <h4>Watchlist Use Cases</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>VIP Users:</strong> Enhanced monitoring for executives</li>
                        <li><strong>High-Risk IPs:</strong> Threat intelligence indicators</li>
                        <li><strong>Allowed Applications:</strong> Whitelist for detections</li>
                        <li><strong>Terminated Employees:</strong> Monitor for unauthorized access</li>
                    </ul>

                    <h4>Watchlist in Rules</h4>
                    <div class="code-block">// Join with watchlist (include matches)
SigninLogs
| where ResultType == 0
| join kind=inner (
    _GetWatchlist('VIPUsers') 
    | project UserPrincipalName
) on UserPrincipalName
| project TimeGenerated, UserPrincipalName, IPAddress, AppDisplayName

// Exclude watchlist entries
DeviceProcessEvents
| where FileName =~ "powershell.exe"
| join kind=leftanti (
    _GetWatchlist('ApprovedScripts')
    | project ScriptPath
) on $left.ProcessCommandLine == $right.ScriptPath

// Check if IP is in threat list
NetworkEvents
| extend ThreatMatch = IPAddress in (_GetWatchlist('ThreatIntelIPs').IPAddress)
| where ThreatMatch == true</div>
                </div>

                <!-- Microsoft Security Rules -->
                <h2><i class="fas fa-shield-alt"></i> Microsoft Security Rules</h2>
                <div class="config-section">
                    <p>Import alerts from other Microsoft security products.</p>

                    <h4>Supported Products</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Product</th><th>Alert Types</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Microsoft Defender for Endpoint</td><td>Endpoint detections</td></tr>
                            <tr><td>Microsoft Defender for Identity</td><td>Identity threats</td></tr>
                            <tr><td>Microsoft Defender for Office 365</td><td>Email/collaboration</td></tr>
                            <tr><td>Microsoft Defender for Cloud Apps</td><td>Cloud app threats</td></tr>
                            <tr><td>Microsoft Defender for Cloud</td><td>Infrastructure threats</td></tr>
                            <tr><td>Azure AD Identity Protection</td><td>Identity risks</td></tr>
                        </tbody>
                    </table>

                    <h4>Configuration</h4>
                    <div class="code-block">Microsoft Security Rule Settings:

Microsoft service: Microsoft Defender for Endpoint

Filter by severity:
☑ High
☑ Medium
☐ Low
☐ Informational

Filter by specific alerts: (optional)
- Include only: [specific alert names]
- Exclude: [alert names to ignore]

Auto-created incidents include:
- All entities from source alert
- Original severity
- MITRE ATT&CK mapping from source</div>
                </div>

                <!-- Fusion Rules -->
                <h2><i class="fas fa-project-diagram"></i> Fusion Detection</h2>
                <div class="config-section">
                    <p>ML-based correlation of alerts from multiple sources.</p>

                    <h4>Fusion Capabilities</h4>
                    <div class="code-block">Fusion Detection Scenarios:

Multi-Stage Attacks:
- Combines alerts across products
- Detects kill chain progression
- Example: Phishing → Credential theft → Lateral movement

Anomaly Correlation:
- Correlates UEBA anomalies with alerts
- Identifies suspicious behavior chains

Supported Sources:
- Azure AD Identity Protection
- Microsoft Defender products
- Scheduled analytics rules
- UEBA anomalies
- Third-party connectors</div>

                    <h4>Fusion Examples</h4>
                    <ul style="color: #8b949e;">
                        <li>Sign-in from unfamiliar location → Impossible travel → Mass file download</li>
                        <li>Suspicious inbox rule → External forwarding → Data exfiltration</li>
                        <li>Malicious IP connection → Process execution → Persistence</li>
                    </ul>
                </div>

                <!-- Rule Management -->
                <h2><i class="fas fa-tasks"></i> Rule Management</h2>
                <div class="config-section">
                    <h4>Rule Health Monitoring</h4>
                    <div class="code-block">// Check rule execution status
SentinelHealth
| where TimeGenerated > ago(24h)
| where SentinelResourceType == "Analytics Rule"
| where Status != "Success"
| project TimeGenerated, SentinelResourceName, Status, Description

// Rules with no alerts
let RulesWithAlerts = SecurityAlert
| where TimeGenerated > ago(7d)
| distinct AlertType;
SentinelHealth
| where SentinelResourceType == "Analytics Rule"
| where SentinelResourceName !in (RulesWithAlerts)
| distinct SentinelResourceName</div>

                    <h4>Rule Export/Import</h4>
                    <div class="code-block">Export Rules:
Analytics → [Rule] → Export → ARM Template

Import Rules:
- Deploy via ARM template
- Use Azure DevOps pipelines
- Infrastructure as Code

Recommended Practice:
- Version control all rules
- Use CI/CD for deployment
- Test in dev environment first</div>
                </div>

                <!-- Best Practices -->
                <h2><i class="fas fa-check-circle"></i> Rule Best Practices</h2>
                <div class="config-section">
                    <div class="code-block">Detection Rule Best Practices:

NAMING:
✓ Use consistent naming convention
✓ Include severity or category
✓ Example: "[HIGH] Brute Force - Multiple Failed Logins"

QUERY:
✓ Filter early for performance
✓ Use timegenerated in where clause
✓ Project only needed fields
✓ Test query before saving

SCHEDULING:
✓ Match frequency to detection urgency
✓ Overlap lookback with frequency
✓ Consider data ingestion delay

ENTITIES:
✓ Map all relevant entities
✓ Include Account, Host, IP at minimum
✓ Enable investigation capabilities

AUTOMATION:
✓ Set up basic enrichment playbooks
✓ Configure alert grouping
✓ Auto-assign where appropriate

DOCUMENTATION:
✓ Describe what rule detects
✓ Document tuning decisions
✓ Include MITRE ATT&CK mapping</div>
                </div>

                <!-- More Interview Questions -->
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How does Fusion detection work in Sentinel?</button>
                        <div class="qa-answer">
                            <p>Fusion uses ML to correlate alerts from multiple sources:</p>
                            <ul>
                                <li>Combines alerts across security products</li>
                                <li>Detects multi-stage attack patterns</li>
                                <li>Creates high-fidelity incidents from low-signal alerts</li>
                                <li>Maps to kill chain stages automatically</li>
                            </ul>
                            <p style="margin-top: 12px;">Example: Individual alerts (suspicious login + privilege escalation + data access) become one Fusion incident showing complete attack chain.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you test a new analytics rule before production?</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Test query in Logs:</strong> Verify logic returns expected results</li>
                                <li><strong>Check for performance:</strong> Ensure query runs efficiently</li>
                                <li><strong>Review entity mapping:</strong> Verify entities populate correctly</li>
                                <li><strong>Enable in detection-only:</strong> Don't create incidents initially</li>
                                <li><strong>Monitor for false positives:</strong> Tune before full deployment</li>
                                <li><strong>Enable incident creation:</strong> After tuning is complete</li>
                            </ol>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>
