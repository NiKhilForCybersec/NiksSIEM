<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="sentinel">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Rules | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>

            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel active"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
<nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-connectors.html" class="nav-link"><i class="fas fa-plug"></i> Data Connectors</a>
                    <a href="dcr-dce-guide.html" class="nav-link"><i class="fas fa-cogs"></i> DCR & DCE Deep Dive</a>
                    <a href="event-hub.html" class="nav-link"><i class="fas fa-broadcast-tower"></i> Event Hub Integration</a>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion & Cost</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">KQL Query Language</div>
                    <a href="kql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> KQL Fundamentals</a>
                    <a href="kql-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> KQL Intermediate</a>
                    <a href="kql-advanced.html" class="nav-link"><i class="fas fa-code"></i> Advanced KQL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="analytics-rules.html" class="nav-link active"><i class="fas fa-bell"></i> Analytics Rules</a>
                    <a href="automation.html" class="nav-link"><i class="fas fa-robot"></i> Automation</a>
                    <a href="workbooks.html" class="nav-link"><i class="fas fa-chart-bar"></i> Workbooks</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Content & Intelligence</div>
                    <a href="content-hub.html" class="nav-link"><i class="fas fa-cube"></i> Content Hub & ASIM</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users-cog"></i> SOC Operations</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Analytics Rules</span>
                </div>
                <div class="top-actions">
                    <button class="top-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <section class="content-section">

                <h2>What Are Analytics Rules?</h2>
                <p>Analytics rules are automated queries that run on a schedule to detect suspicious activity. When a rule matches, it creates an alert or incident for analyst review.</p>

                <h2>Rule Types</h2>
                <table>
                    <thead><tr><th>Type</th><th>Description</th><th>Best For</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Scheduled</strong></td><td>KQL query runs on schedule (5min to 14 days)</td><td>Most custom detections</td></tr>
                        <tr><td><strong>NRT (Near Real-Time)</strong></td><td>Runs every minute, limited query</td><td>Critical, time-sensitive threats</td></tr>
                        <tr><td><strong>Microsoft Security</strong></td><td>Ingests alerts from Microsoft products</td><td>M365 Defender, Azure Defender</td></tr>
                        <tr><td><strong>Fusion</strong></td><td>ML-based correlation of low-fidelity alerts</td><td>Multi-stage attacks</td></tr>
                        <tr><td><strong>ML Behavior Analytics</strong></td><td>Anomaly detection with ML</td><td>Unusual behavior patterns</td></tr>
                        <tr><td><strong>Threat Intelligence</strong></td><td>Matches IOCs against logs</td><td>Known malicious indicators</td></tr>
                    </tbody>
                </table>

                <h2>Creating a Scheduled Rule</h2>
                <h3>Rule Components</h3>
                <table>
                    <thead><tr><th>Component</th><th>Description</th><th>Best Practice</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Name</strong></td><td>Rule identifier</td><td>Descriptive, include technique ID</td></tr>
                        <tr><td><strong>Description</strong></td><td>What it detects</td><td>Include MITRE mapping, FP guidance</td></tr>
                        <tr><td><strong>Severity</strong></td><td>Alert priority</td><td>High=credential theft, Low=recon</td></tr>
                        <tr><td><strong>Tactics</strong></td><td>MITRE ATT&CK mapping</td><td>Always map to framework</td></tr>
                        <tr><td><strong>Query</strong></td><td>KQL detection logic</td><td>Test thoroughly, optimize</td></tr>
                        <tr><td><strong>Entity Mapping</strong></td><td>Extract key entities</td><td>Account, Host, IP, File hash</td></tr>
                        <tr><td><strong>Alert Grouping</strong></td><td>How alerts combine</td><td>Group by entity to reduce noise</td></tr>
                        <tr><td><strong>Schedule</strong></td><td>How often to run</td><td>Match to threat urgency</td></tr>
                    </tbody>
                </table>

                <h2>Example: Suspicious PowerShell Detection</h2>
                <div class="query-example">
                    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Complete Rule Query</span></div>
                    <div class="query-body">
<pre class="code-block"><code>// Rule: Suspicious Encoded PowerShell Execution
// MITRE: T1059.001 - PowerShell
// Severity: High
DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any ("-enc", "-encoded", "-e ")
| extend DecodedCommand = base64_decode_tostring(
    extract(@"-e[nc]*\s+([A-Za-z0-9+/=]+)", 1, ProcessCommandLine)
)
| where DecodedCommand has_any (
    "downloadstring", "invoke-webrequest", "webclient",
    "invoke-expression", "iex ", "bypass"
)
| project 
    TimeGenerated,
    DeviceName,
    AccountName,
    ProcessCommandLine,
    DecodedCommand,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine
| extend 
    AccountCustomEntity = AccountName,
    HostCustomEntity = DeviceName</code></pre>
                    </div>
                </div>

                <h3>Rule Settings</h3>
                <ul>
                    <li><strong>Run every:</strong> 1 hour</li>
                    <li><strong>Lookup data from:</strong> Last 1 hour</li>
                    <li><strong>Alert threshold:</strong> Greater than 0</li>
                    <li><strong>Event grouping:</strong> Group all events into single alert</li>
                </ul>

                <h2>Entity Mapping</h2>
                <p>Entity mapping extracts key information for investigation:</p>
                <table>
                    <thead><tr><th>Entity Type</th><th>Identifier</th><th>Column Example</th></tr></thead>
                    <tbody>
                        <tr><td>Account</td><td>Name, UPNSuffix, AadUserId</td><td>AccountName, AccountUpn</td></tr>
                        <tr><td>Host</td><td>HostName, DnsDomain, AzureID</td><td>DeviceName, Computer</td></tr>
                        <tr><td>IP</td><td>Address</td><td>IPAddress, RemoteIP</td></tr>
                        <tr><td>File</td><td>Name, Directory, Hash</td><td>FileName, SHA256</td></tr>
                        <tr><td>URL</td><td>Url</td><td>Url, RemoteUrl</td></tr>
                        <tr><td>Process</td><td>CommandLine, ProcessId</td><td>ProcessCommandLine</td></tr>
                    </tbody>
                </table>

                <h2>Tuning Rules</h2>
                <h3>Reducing False Positives</h3>
                <ul>
                    <li><strong>Add exclusions</strong> - Known good processes, service accounts</li>
                    <li><strong>Increase specificity</strong> - Add more conditions</li>
                    <li><strong>Use allow lists</strong> - Watchlists for known-good</li>
                    <li><strong>Threshold tuning</strong> - Adjust count thresholds</li>
                </ul>

                <div class="query-example">
                    <div class="query-header"><span class="query-platform"><i class="fab fa-microsoft"></i> Adding Exclusions</span></div>
                    <div class="query-body">
<pre class="code-block"><code>// Exclude known admin scripts
let ExcludedPaths = dynamic([
    "C:\AdminScripts\",
    "C:\Program Files\Company\Tools\"
]);
let ExcludedAccounts = dynamic(["svc_automation", "svc_deploy"]);
DeviceProcessEvents
| where TimeGenerated > ago(1h)
| where FileName =~ "powershell.exe"
| where not(FolderPath has_any (ExcludedPaths))
| where not(AccountName has_any (ExcludedAccounts))
// ... rest of detection logic</code></pre>
                    </div>
                </div>

                <h2>Best Practices</h2>
                <div class="info-box tip">
                    <div class="info-box-title"><i class="fas fa-lightbulb"></i> Rule Development Best Practices</div>
                    <ul style="margin: 0.5rem 0 0 1rem;">
                        <li><strong>Test before deploy</strong> - Run query manually first</li>
                        <li><strong>Start broad, then tune</strong> - Easier to add exclusions than miss threats</li>
                        <li><strong>Document exclusions</strong> - Record why each was added</li>
                        <li><strong>Review regularly</strong> - Rules need maintenance</li>
                        <li><strong>Map to MITRE</strong> - Always include technique IDs</li>
                        <li><strong>Include FP guidance</strong> - Help analysts distinguish real from false</li>
                        <li><strong>Version control</strong> - Store rules in git</li>
                    </ul>
                </div>

                <h2>Common Mistakes</h2>
                <div class="info-box danger">
                    <div class="info-box-title"><i class="fas fa-times-circle"></i> Avoid These</div>
                    <ul style="margin: 0.5rem 0 0 1rem;">
                        <li>No time filter - query scans entire table</li>
                        <li>Using contains instead of has - slow performance</li>
                        <li>No entity mapping - harder to investigate</li>
                        <li>Too broad detection - alert fatigue</li>
                        <li>No MITRE mapping - missed context</li>
                        <li>Not testing on historical data - missed FPs</li>
                    </ul>
                </div>
            
                </section>
            
                <section class="content-section">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>What are the different types of analytics rules in Sentinel?</span>
                        </div>
                        <div class="interview-answer">
                            <p>Sentinel has several rule types:</p>
                            <p><strong>Scheduled rules</strong> are the most common - KQL queries that run on a schedule (every 5 minutes to 14 days). Full query flexibility, supports entity mapping and MITRE ATT&CK tagging.</p>
                            <p><strong>NRT (Near Real-Time) rules</strong> run within about a minute of data arriving. They have some limitations - no joins, limited lookback - but much faster detection for time-sensitive threats.</p>
                            <p><strong>Fusion rules</strong> use Microsoft's ML to correlate low-fidelity signals across multiple data sources into high-confidence incidents. You can't write custom Fusion rules but can tune which scenarios it detects.</p>
                            <p><strong>Microsoft Security rules</strong> create incidents from alerts in other Microsoft services like Defender for Cloud or Defender XDR.</p>
                            <p><strong>Anomaly rules</strong> are built-in ML rules that detect behavioral anomalies. You can tune thresholds but not the underlying logic.</p>
                            <p>For custom detection, I usually start with Scheduled rules. If sub-minute detection matters and the logic is simple, NRT. Fusion is great for multi-stage attack detection without writing complex correlation.</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Microsoft Sentinel Guide</p>
                    <p>Personal Reference Guide</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>