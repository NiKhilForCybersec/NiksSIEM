<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEBA | Microsoft Sentinel</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">UEBA</span>
                </div>

                <h1><i class="fas fa-user-secret"></i> User & Entity Behavior Analytics (UEBA)</h1>
                <p class="lead">Master Sentinel UEBA for detecting insider threats, compromised accounts, and anomalous behavior. Learn to configure, tune, and operationalize behavior analytics.</p>

                <!-- UEBA Overview -->
                <h2><i class="fas fa-info-circle"></i> UEBA Overview</h2>
                <div class="config-section">
                    <div class="arch-diagram">WHAT IS UEBA?
═══════════════════════════════════════════════════════════════════

User and Entity Behavior Analytics (UEBA) uses machine learning to:
├── Establish behavioral baselines for users, hosts, and IPs
├── Detect anomalies that deviate from normal patterns
├── Assign investigation priority scores
└── Surface high-risk activities that rules might miss

UEBA vs RULE-BASED DETECTION:
┌─────────────────────────────────────────────────────────────────┐
│     Rule-Based Detection     │        UEBA Detection           │
├──────────────────────────────┼──────────────────────────────────┤
│ Detects known patterns       │ Detects unknown anomalies        │
│ "Alert if >10 failed logins" │ "Alert if behavior is unusual"   │
│ Static thresholds            │ Dynamic per-entity baselines     │
│ Easy to evade (stay under)   │ Harder to evade (adapts)         │
│ Low false positive rate      │ Higher FP rate, needs tuning     │
│ Misses novel attacks         │ Can catch zero-days              │
└──────────────────────────────┴──────────────────────────────────┘

ENTITIES TRACKED:
├── Users (Azure AD/on-prem AD accounts)
├── Hosts (devices, servers)
├── IP addresses
├── Cloud resources
└── Applications

KEY OUTPUTS:
├── Investigation Priority Score (0-10)
├── Anomaly timelines
├── Peer group analysis
├── Blast radius assessment
└── Entity pages with context</div>
                </div>

                <!-- Enabling UEBA -->
                <h2><i class="fas fa-toggle-on"></i> Enabling UEBA</h2>
                <div class="config-section">
                    <p><span class="console-path">Sentinel → Configuration → Settings → Settings tab → UEBA</span></p>

                    <h4>UEBA Configuration</h4>
                    <div class="arch-diagram">UEBA SETUP STEPS
═══════════════════════════════════════════════════════════════════

STEP 1: ENABLE UEBA
├── Navigate to Sentinel Settings
├── Select "Settings" tab
├── Under "User and entity behavior analytics", click "Configure UEBA"
└── Toggle "Enable UEBA" to On

STEP 2: SELECT DATA SOURCES
├── Azure Active Directory (required for user behavior)
│   ├── Sign-in logs
│   ├── Audit logs
│   └── Requires: Azure AD P1/P2 or appropriate license
├── Azure Activity (cloud resource behavior)
├── Security Events (Windows host behavior)
│   └── Requires: Windows devices with Security Events connector
├── Microsoft 365 (collaboration behavior)
└── DNS logs (network behavior)

STEP 3: ENTITY SYNC
├── Enable Active Directory sync
│   └── Syncs user attributes (manager, department, title)
├── Configure on-prem AD sync if applicable
│   └── Uses Azure AD Connect or direct connector
└── Wait 7-14 days for baseline to build

STEP 4: VERIFY CONFIGURATION
// Check UEBA data is flowing
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| summarize count() by ActivityType
| order by count_ desc

// Check entity information
IdentityInfo
| where TimeGenerated > ago(24h)
| summarize count() by AccountObjectId
| take 10

PREREQUISITES:
├── Sentinel workspace with appropriate license
├── Data connectors enabled (AAD, SecurityEvents at minimum)
├── Azure AD P1/P2 for rich sign-in context
├── 7-14 days for ML model training
└── Sufficient historical data for baselines</div>

                    <h4>Data Sources Impact</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Data Source</th><th>Entity Types</th><th>Anomalies Detected</th><th>Required?</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Azure AD Sign-in</td><td>Users</td><td>Unusual location, time, device, app</td><td>Highly recommended</td></tr>
                            <tr><td>Azure AD Audit</td><td>Users</td><td>Privilege changes, group modifications</td><td>Highly recommended</td></tr>
                            <tr><td>Security Events</td><td>Users, Hosts</td><td>Logon anomalies, process execution</td><td>Recommended</td></tr>
                            <tr><td>Azure Activity</td><td>Users, Resources</td><td>Unusual Azure operations</td><td>Optional</td></tr>
                            <tr><td>Microsoft 365</td><td>Users</td><td>File access, sharing anomalies</td><td>Optional</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- UEBA Tables -->
                <h2><i class="fas fa-table"></i> UEBA Tables & Schema</h2>
                <div class="config-section">
                    <h4>BehaviorAnalytics Table</h4>
                    <div class="arch-diagram">BehaviorAnalytics TABLE - PRIMARY UEBA OUTPUT
═══════════════════════════════════════════════════════════════════

KEY COLUMNS:
├── TimeGenerated: When anomaly was detected
├── UserPrincipalName: User involved
├── SourceIPAddress: IP of activity
├── ActivityType: Type of behavior analyzed
├── ActionType: Specific action (e.g., FailedLogOn, ResourceAccess)
├── InvestigationPriority: Score 0-10 (higher = more anomalous)
├── ActivityInsights: JSON with anomaly details
├── UsersInsights: JSON with user context
├── DevicesInsights: JSON with device context
└── SourceDevice: Device name if applicable

ACTIVITY TYPES:
├── LogOn / FailedLogOn
├── ResourceAccess
├── ElevationAction
├── CloudResourceAccess
├── DataAccess
└── NetworkActivity

SAMPLE QUERY - HIGH PRIORITY ANOMALIES:
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where InvestigationPriority > 5
| project TimeGenerated, UserPrincipalName, ActivityType, 
          ActionType, InvestigationPriority, SourceIPAddress
| order by InvestigationPriority desc

PARSING ActivityInsights:
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where InvestigationPriority > 3
| extend Insights = parse_json(ActivityInsights)
| extend AnomalyDetails = Insights.AnomalyDetails
| extend FirstTimeSeen = Insights.FirstTimeSeen
| project TimeGenerated, UserPrincipalName, AnomalyDetails, FirstTimeSeen</div>

                    <h4>IdentityInfo Table</h4>
                    <div class="arch-diagram">IdentityInfo TABLE - ENTITY CONTEXT
═══════════════════════════════════════════════════════════════════

PURPOSE: Enriched user information for investigation context

KEY COLUMNS:
├── AccountObjectId: Azure AD object ID
├── AccountUPN: User Principal Name
├── AccountDisplayName: Display name
├── JobTitle: From Azure AD
├── Department: From Azure AD
├── Manager: Manager's UPN
├── IsAccountEnabled: Account status
├── City, Country, State: Location info
├── GroupMembership: Security groups
├── AssignedRoles: Azure AD roles
└── RiskLevel: Current risk level

ENRICHMENT QUERY:
let Anomalies = BehaviorAnalytics
    | where TimeGenerated > ago(24h)
    | where InvestigationPriority > 5;
Anomalies
| join kind=leftouter (
    IdentityInfo
    | summarize arg_max(TimeGenerated, *) by AccountUPN
) on $left.UserPrincipalName == $right.AccountUPN
| project TimeGenerated, UserPrincipalName, InvestigationPriority,
          Department, JobTitle, Manager, RiskLevel

MANAGER HIERARCHY QUERY:
IdentityInfo
| where TimeGenerated > ago(7d)
| summarize arg_max(TimeGenerated, *) by AccountUPN
| where isnotempty(Manager)
| project AccountUPN, Manager, Department, JobTitle</div>
                </div>

                <!-- Investigation Priority -->
                <h2><i class="fas fa-sort-amount-down"></i> Investigation Priority Score</h2>
                <div class="config-section">
                    <div class="arch-diagram">INVESTIGATION PRIORITY SCORE EXPLAINED
═══════════════════════════════════════════════════════════════════

SCORE RANGE: 0 - 10

SCORE INTERPRETATION:
├── 0-2: Low priority, minor deviation from baseline
├── 3-4: Medium-low, noticeable but not alarming
├── 5-6: Medium-high, should investigate soon
├── 7-8: High priority, investigate immediately
└── 9-10: Critical, potential active compromise

FACTORS THAT INCREASE SCORE:
├── First time activity (never seen before for this user)
├── Activity from unusual location
├── Activity at unusual time
├── Activity on unusual device
├── Access to sensitive resources
├── Deviation from peer group behavior
├── Multiple anomalies in short timeframe
├── User has privileged access
└── Activity matches known attack patterns

SCORE CALCULATION (Simplified):
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│  Base Score (activity rarity)                                    │
│      + Sensitivity bonus (privileged user/critical resource)    │
│      + Temporal anomaly (unusual time)                           │
│      + Spatial anomaly (unusual location)                        │
│      + Peer deviation (different from similar users)            │
│      + Attack pattern match                                      │
│  ────────────────────────────────────────────                   │
│  = Investigation Priority (capped at 10)                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

QUERY - SCORE DISTRIBUTION:
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| summarize Count = count() by Priority = bin(InvestigationPriority, 1)
| order by Priority asc
| render columnchart</div>

                    <h4>Entity Pages</h4>
                    <div class="arch-diagram">USING ENTITY PAGES FOR INVESTIGATION
═══════════════════════════════════════════════════════════════════

ACCESS: Sentinel → Entity behavior → Select entity
   OR:  Click on entity in incident → View full details

ENTITY PAGE COMPONENTS:
├── OVERVIEW
│   ├── Investigation priority score
│   ├── Risk indicators
│   ├── Entity timeline
│   └── Related incidents
│
├── INSIGHTS
│   ├── Activity patterns (typical vs observed)
│   ├── Peer group comparison
│   ├── First-time activities
│   └── Anomaly breakdown
│
├── TIMELINE
│   ├── Chronological activity view
│   ├── Filter by activity type
│   ├── Highlight anomalies
│   └── Drill into raw events
│
└── RELATED ENTITIES
    ├── Devices used
    ├── IPs connected from
    ├── Resources accessed
    └── Users interacted with (for file sharing, etc.)</div>
                </div>

                <!-- UEBA Hunting Queries -->
                <h2><i class="fas fa-crosshairs"></i> UEBA Hunting Queries</h2>
                <div class="config-section">
                    <h4>Insider Threat Detection</h4>
                    <div class="arch-diagram">INSIDER THREAT HUNTING WITH UEBA
═══════════════════════════════════════════════════════════════════

// Users with spike in investigation priority
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| summarize 
    AvgPriority = avg(InvestigationPriority),
    MaxPriority = max(InvestigationPriority),
    AnomalyCount = count()
    by UserPrincipalName
| where MaxPriority > 7
| where AnomalyCount > 5
| order by MaxPriority desc

// First-time access to sensitive resources
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where ActivityType == "ResourceAccess"
| extend Insights = parse_json(ActivityInsights)
| where Insights.FirstTimeSeen == true
| where InvestigationPriority > 4
| project TimeGenerated, UserPrincipalName, ActionType, 
          InvestigationPriority, SourceIPAddress

// Unusual after-hours activity
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| extend Hour = datetime_part("hour", TimeGenerated)
| where Hour < 6 or Hour > 22  // Before 6 AM or after 10 PM
| where InvestigationPriority > 3
| summarize 
    AfterHoursActivities = count(),
    MaxPriority = max(InvestigationPriority)
    by UserPrincipalName
| where AfterHoursActivities > 3
| order by MaxPriority desc

// Users accessing resources outside their peer group
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| extend Insights = parse_json(UsersInsights)
| where Insights.PeerGroupDeviation == true
| where InvestigationPriority > 5
| project TimeGenerated, UserPrincipalName, ActivityType, 
          InvestigationPriority</div>

                    <h4>Compromised Account Detection</h4>
                    <div class="arch-diagram">COMPROMISED ACCOUNT HUNTING WITH UEBA
═══════════════════════════════════════════════════════════════════

// Impossible travel with high priority
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where ActivityType == "LogOn"
| extend Insights = parse_json(ActivityInsights)
| where Insights.ImpossibleTravel == true
| where InvestigationPriority > 5
| project TimeGenerated, UserPrincipalName, SourceIPAddress, 
          InvestigationPriority, Insights

// Sudden change in activity patterns
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| summarize 
    DistinctIPs = dcount(SourceIPAddress),
    DistinctDevices = dcount(SourceDevice),
    DistinctActivities = dcount(ActionType),
    AvgPriority = avg(InvestigationPriority)
    by UserPrincipalName, bin(TimeGenerated, 1d)
| order by UserPrincipalName, TimeGenerated
| serialize
| extend PrevDistinctIPs = prev(DistinctIPs, 1)
| where DistinctIPs > PrevDistinctIPs * 3  // 3x increase in IPs used
| where AvgPriority > 3

// Failed logins followed by successful login from different location
let FailedLogins = BehaviorAnalytics
    | where TimeGenerated > ago(24h)
    | where ActionType == "FailedLogOn"
    | summarize FailCount = count(), FailIPs = make_set(SourceIPAddress) 
      by UserPrincipalName;
let SuccessLogins = BehaviorAnalytics
    | where TimeGenerated > ago(24h)
    | where ActionType == "LogOn"
    | where InvestigationPriority > 4
    | project UserPrincipalName, SuccessIP = SourceIPAddress, InvestigationPriority;
FailedLogins
| join kind=inner SuccessLogins on UserPrincipalName
| where not(SuccessIP in (FailIPs))  // Success from different IP than failures
| where FailCount > 3
| project UserPrincipalName, FailCount, FailIPs, SuccessIP, InvestigationPriority</div>

                    <h4>Privilege Escalation Detection</h4>
                    <div class="arch-diagram">PRIVILEGE ABUSE HUNTING WITH UEBA
═══════════════════════════════════════════════════════════════════

// Elevation actions with high anomaly score
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where ActivityType == "ElevationAction"
| where InvestigationPriority > 5
| project TimeGenerated, UserPrincipalName, ActionType, 
          InvestigationPriority, SourceIPAddress

// First-time admin activity
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| where ActivityType in ("ElevationAction", "ResourceAccess")
| extend Insights = parse_json(ActivityInsights)
| where Insights.FirstTimeSeen == true
| where InvestigationPriority > 5
| join kind=inner (
    IdentityInfo
    | where TimeGenerated > ago(7d)
    | where AssignedRoles has_any ("Global Administrator", "Security Administrator")
    | distinct AccountUPN
) on $left.UserPrincipalName == $right.AccountUPN
| project TimeGenerated, UserPrincipalName, ActivityType, 
          ActionType, InvestigationPriority

// Privileged users with behavioral anomalies
let PrivUsers = IdentityInfo
    | where TimeGenerated > ago(7d)
    | where isnotempty(AssignedRoles)
    | distinct AccountUPN;
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where UserPrincipalName in (PrivUsers)
| where InvestigationPriority > 4
| summarize 
    AnomalyCount = count(),
    MaxPriority = max(InvestigationPriority),
    Activities = make_set(ActivityType)
    by UserPrincipalName
| where AnomalyCount > 2
| order by MaxPriority desc</div>
                </div>

                <!-- UEBA Tuning -->
                <h2><i class="fas fa-sliders-h"></i> Tuning UEBA</h2>
                <div class="config-section">
                    <div class="arch-diagram">UEBA TUNING STRATEGIES
═══════════════════════════════════════════════════════════════════

CHALLENGE: UEBA can generate noise - tune for your environment

APPROACH 1: FILTER BY PRIORITY IN RULES
// Only alert on high priority anomalies
BehaviorAnalytics
| where InvestigationPriority > 7  // High threshold
| where ActivityType in ("LogOn", "ElevationAction")  // Focus on risky activities

APPROACH 2: COMBINE WITH OTHER SIGNALS
// UEBA anomaly + threat intel match = high confidence
BehaviorAnalytics
| where InvestigationPriority > 4
| join kind=inner (
    ThreatIntelligenceIndicator
    | where ExpirationDateTime > now()
    | where IndicatorType == "ipv4-addr"
    | project ThreatIP = NetworkIP
) on $left.SourceIPAddress == $right.ThreatIP

APPROACH 3: EXCLUDE KNOWN PATTERNS
// Exclude service accounts that have predictable "anomalies"
let ServiceAccounts = _GetWatchlist('Service_Accounts') | project AccountName;
BehaviorAnalytics
| where InvestigationPriority > 5
| where UserPrincipalName !in (ServiceAccounts)

APPROACH 4: FOCUS ON SPECIFIC ACTIVITY TYPES
// Filter to most security-relevant activities
BehaviorAnalytics
| where ActivityType in (
    "LogOn", 
    "FailedLogOn", 
    "ElevationAction", 
    "ResourceAccess"
)
| where ActivityType !in ("NetworkActivity")  // Often noisy

APPROACH 5: PEER GROUP CONTEXT
// Only alert when user deviates significantly from peers
BehaviorAnalytics
| extend Insights = parse_json(UsersInsights)
| where Insights.PeerGroupDeviation == true
| where InvestigationPriority > 5</div>

                    <h4>Baseline Period Considerations</h4>
                    <div class="arch-diagram">BASELINE LEARNING PERIOD
═══════════════════════════════════════════════════════════════════

INITIAL PERIOD: 7-14 days minimum
├── UEBA learns normal patterns
├── More data = better baselines
└── Expect higher FPs during learning

FACTORS AFFECTING BASELINES:
├── Seasonal patterns (month-end, holidays)
├── Role changes (new responsibilities)
├── Location changes (travel, remote work)
├── Org changes (restructuring, M&A)
└── Technology changes (new apps, VPN)

BEST PRACTICE:
├── Wait 14+ days before enabling UEBA rules
├── Start with high threshold (>7) in rules
├── Gradually lower threshold as you tune
├── Review FPs weekly, adjust accordingly
└── Consider separate thresholds for privileged vs standard users

HANDLING BASELINE DISRUPTIONS:
// After major org change (M&A, reorg)
// Temporarily raise thresholds for 14 days
// Example: Production rule during transition
BehaviorAnalytics
| where TimeGenerated > ago(24h)
| where InvestigationPriority > 8  // Higher threshold during transition
| where ActivityType == "ElevationAction"  // Focus on highest risk only</div>
                </div>

                <!-- Common Failures -->
                <h2><i class="fas fa-exclamation-triangle"></i> What Enterprises Usually Miss</h2>
                <div class="config-section">
                    <div class="arch-diagram">COMMON UEBA FAILURES AND SOLUTIONS
═══════════════════════════════════════════════════════════════════

❌ FAILURE 1: Enabling UEBA Without Required Data Sources
   Problem: UEBA enabled but no Azure AD Sign-in logs
   Impact: No user behavior analytics, wasted feature
   Solution: Ensure AAD Sign-in and Audit logs are connected first

❌ FAILURE 2: Creating Rules Before Baseline Period
   Problem: Analytics rules enabled on day 1
   Impact: Massive false positives, alert fatigue
   Solution: Wait 14+ days for baseline, start with high thresholds

❌ FAILURE 3: Ignoring Investigation Priority Score
   Problem: Using UEBA table without filtering by score
   Impact: Alerting on low-priority normal variations
   Solution: Filter InvestigationPriority > 5 minimum

❌ FAILURE 4: Not Enriching with IdentityInfo
   Problem: UEBA alerts without user context
   Impact: Analyst can't prioritize (VIP vs contractor)
   Solution: Join with IdentityInfo for department, manager, role

❌ FAILURE 5: Treating UEBA as Standalone
   Problem: Using only UEBA signals for detection
   Impact: High FP rate, missed context
   Solution: Combine UEBA with rules, TI, and other signals

❌ FAILURE 6: Not Excluding Service Accounts
   Problem: Service accounts flagged for "unusual" behavior
   Impact: Noise from expected automated behavior
   Solution: Exclude known service accounts via watchlist

❌ FAILURE 7: Ignoring Entity Pages
   Problem: Investigating from raw BehaviorAnalytics table only
   Impact: Missing context, longer investigation time
   Solution: Use Entity Pages for visual timeline and insights

❌ FAILURE 8: No UEBA-Specific Workbook
   Problem: No visibility into UEBA health and trends
   Impact: Can't measure effectiveness, can't tune
   Solution: Build workbook for UEBA metrics (score distribution, top users)

❌ FAILURE 9: Not Training Analysts on UEBA
   Problem: Analysts don't understand investigation priority
   Impact: Misinterpretation of scores, wrong prioritization
   Solution: Train analysts on UEBA concepts, score interpretation

❌ FAILURE 10: Static Thresholds for All Users
   Problem: Same rules for executives and contractors
   Impact: Missing VIP threats, noise from low-risk users
   Solution: Lower thresholds for privileged/VIP users</div>
                </div>

                <!-- UEBA Analytics Rules -->
                <h2><i class="fas fa-bell"></i> UEBA-Based Analytics Rules</h2>
                <div class="config-section">
                    <div class="arch-diagram">SAMPLE UEBA ANALYTICS RULES
═══════════════════════════════════════════════════════════════════

RULE 1: HIGH PRIORITY USER ANOMALY
Severity: High
Query:
BehaviorAnalytics
| where TimeGenerated > ago(1h)
| where InvestigationPriority >= 8
| where ActivityType in ("LogOn", "FailedLogOn", "ElevationAction")
| project TimeGenerated, UserPrincipalName, ActivityType, 
          InvestigationPriority, SourceIPAddress
Entity mapping: Account = UserPrincipalName, IP = SourceIPAddress

RULE 2: VIP USER BEHAVIORAL ANOMALY
Severity: High
Query:
let VIPs = _GetWatchlist('VIP_Users');
BehaviorAnalytics
| where TimeGenerated > ago(1h)
| where UserPrincipalName in (VIPs)
| where InvestigationPriority >= 5  // Lower threshold for VIPs
| project TimeGenerated, UserPrincipalName, ActivityType, 
          InvestigationPriority, SourceIPAddress
Entity mapping: Account = UserPrincipalName, IP = SourceIPAddress

RULE 3: PRIVILEGED ACCOUNT FIRST-TIME ACTIVITY
Severity: Medium
Query:
let PrivUsers = IdentityInfo
    | where AssignedRoles has_any ("Global Administrator", "Privileged Role Administrator")
    | distinct AccountUPN;
BehaviorAnalytics
| where TimeGenerated > ago(1h)
| where UserPrincipalName in (PrivUsers)
| extend Insights = parse_json(ActivityInsights)
| where Insights.FirstTimeSeen == true
| where InvestigationPriority >= 4
Entity mapping: Account = UserPrincipalName

RULE 4: MULTIPLE HIGH-PRIORITY ANOMALIES (COMPOUND)
Severity: High
Query:
BehaviorAnalytics
| where TimeGenerated > ago(4h)
| where InvestigationPriority >= 5
| summarize 
    AnomalyCount = count(),
    MaxPriority = max(InvestigationPriority),
    Activities = make_set(ActivityType)
    by UserPrincipalName
| where AnomalyCount >= 5 or MaxPriority >= 9
Entity mapping: Account = UserPrincipalName</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What is UEBA and how does it differ from rule-based detection?</button>
                        <div class="qa-answer">
                            <p><strong>UEBA (User and Entity Behavior Analytics)</strong> uses machine learning to establish behavioral baselines for users, hosts, and IPs, then detects anomalies that deviate from those baselines.</p>
                            <p style="margin-top: 12px;"><strong>Key differences from rule-based detection:</strong></p>
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Aspect</th><th>Rule-Based</th><th>UEBA</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Detection method</td><td>Static thresholds</td><td>Dynamic per-entity baselines</td></tr>
                                    <tr><td>Example</td><td>"Alert if >10 failed logins"</td><td>"Alert if unusual for this user"</td></tr>
                                    <tr><td>Unknown attacks</td><td>Misses novel patterns</td><td>Can detect zero-days</td></tr>
                                    <tr><td>False positive rate</td><td>Lower, predictable</td><td>Higher, needs tuning</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;"><strong>Best practice:</strong> Use UEBA to complement rules, not replace them. Combine both for defense in depth.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What is the Investigation Priority Score and how do you use it?</button>
                        <div class="qa-answer">
                            <p><strong>Investigation Priority Score</strong> is a 0-10 scale assigned to each anomaly indicating how unusual and potentially risky the behavior is.</p>
                            <p style="margin-top: 12px;"><strong>Score interpretation:</strong></p>
                            <ul>
                                <li><strong>0-2:</strong> Minor deviation, likely normal variation</li>
                                <li><strong>3-4:</strong> Noticeable anomaly, monitor but low urgency</li>
                                <li><strong>5-6:</strong> Significant anomaly, investigate soon</li>
                                <li><strong>7-8:</strong> High priority, investigate immediately</li>
                                <li><strong>9-10:</strong> Critical, potential active compromise</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Factors that increase score:</strong> First-time activity, unusual location/time/device, privileged user, sensitive resource access, deviation from peer group.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you use UEBA to detect insider threats?</button>
                        <div class="qa-answer">
                            <p><strong>Insider threat detection approach:</strong></p>
                            <ol>
                                <li><strong>Baseline normal behavior:</strong> UEBA learns typical access patterns, working hours, resources accessed</li>
                                <li><strong>Detect deviations:</strong>
                                    <ul>
                                        <li>Accessing unusual file shares or databases</li>
                                        <li>Working at unusual hours (especially before resignation)</li>
                                        <li>Mass file downloads or email forwards</li>
                                        <li>Using unauthorized devices or IPs</li>
                                    </ul>
                                </li>
                                <li><strong>Combine with HR signals:</strong> Correlate with termination notices, performance issues</li>
                            </ol>
                            <div class="arch-diagram" style="margin: 10px 0;">// Insider threat hunting query
BehaviorAnalytics
| where TimeGenerated > ago(7d)
| where ActivityType == "DataAccess"
| where InvestigationPriority > 5
| extend Insights = parse_json(ActivityInsights)
| where Insights.FirstTimeSeen == true or Insights.VolumeAnomaly == true
| summarize AnomalyCount = count() by UserPrincipalName
| where AnomalyCount > 3</div>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What data sources are required for UEBA to work effectively?</button>
                        <div class="qa-answer">
                            <p><strong>Required data sources:</strong></p>
                            <ul>
                                <li><strong>Azure AD Sign-in logs:</strong> Essential for user authentication behavior (location, device, time patterns)</li>
                                <li><strong>Azure AD Audit logs:</strong> Captures privilege changes, group modifications</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Highly recommended:</strong></p>
                            <ul>
                                <li><strong>Security Events (Windows):</strong> Host-based user activity, logon events</li>
                                <li><strong>Microsoft 365:</strong> File access and sharing patterns</li>
                                <li><strong>Azure Activity:</strong> Cloud resource access patterns</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Note:</strong> Azure AD P1/P2 license provides richer sign-in context (conditional access results, risk levels). UEBA needs 7-14 days of data to build accurate baselines.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you reduce false positives from UEBA?</button>
                        <div class="qa-answer">
                            <p><strong>UEBA false positive reduction strategies:</strong></p>
                            <ol>
                                <li><strong>Set appropriate thresholds:</strong> Start with InvestigationPriority > 7, lower gradually</li>
                                <li><strong>Allow baseline period:</strong> Wait 14+ days before enabling rules</li>
                                <li><strong>Exclude service accounts:</strong> Use watchlist to exclude known automated accounts</li>
                                <li><strong>Focus on specific activities:</strong> Filter to LogOn, ElevationAction, exclude noisy NetworkActivity</li>
                                <li><strong>Combine with other signals:</strong> UEBA + threat intel match = higher confidence</li>
                                <li><strong>Use peer group context:</strong> Only alert when significant deviation from peers</li>
                                <li><strong>Differentiate by user type:</strong> Lower thresholds for VIPs/admins, higher for general users</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you investigate a high-priority UEBA alert?</button>
                        <div class="qa-answer">
                            <p><strong>UEBA investigation workflow:</strong></p>
                            <ol>
                                <li><strong>Check Entity Page:</strong> Navigate to user's entity page for full context, timeline, and insights</li>
                                <li><strong>Review Investigation Priority factors:</strong> Why was score high? First-time activity? Unusual location?</li>
                                <li><strong>Check peer comparison:</strong> Is this unusual for similar users in same department/role?</li>
                                <li><strong>Correlate with other data:</strong>
                                    <ul>
                                        <li>Sign-in logs for authentication context</li>
                                        <li>MDE for endpoint behavior</li>
                                        <li>Azure Activity for cloud actions</li>
                                    </ul>
                                </li>
                                <li><strong>Check user context:</strong> Query IdentityInfo for department, manager, role - is this expected for their job?</li>
                                <li><strong>Look for attack chain:</strong> Are there related anomalies from same user or related entities?</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
