<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Reference | Microsoft Sentinel</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Configuration Reference</span>
                </div>

                <h1><i class="fas fa-cog"></i> Configuration Reference</h1>
                <p class="lead">Complete low-level configuration guide for Microsoft Sentinel. Detailed decision trees, step-by-step procedures, and validation checklists for every configuration scenario.</p>

                <!-- Incident Tasks -->
                <h2><i class="fas fa-tasks"></i> Incident Tasks</h2>
                <div class="config-section">
                    <div class="arch-diagram">INCIDENT TASKS - STRUCTURED INVESTIGATION WORKFLOW
═══════════════════════════════════════════════════════════════════

WHAT ARE INCIDENT TASKS?
├── Checklist items attached to incidents
├── Guide analysts through investigation steps
├── Can be auto-created via automation rules
├── Track completion status per incident
└── Ensure consistent investigation process

TASK COMPONENTS:
├── Title: Short description of task
├── Description: Detailed instructions
├── Status: New, In Progress, Completed
└── Assigned To: Optional analyst assignment

ACCESSING TASKS:
Sentinel → Incidents → [Select incident] → Tasks tab

MANUAL TASK CREATION:
1. Open incident
2. Click "Tasks" tab
3. Click "+ Add task"
4. Enter title and description
5. Save

AUTO-CREATE TASKS VIA AUTOMATION RULE:
┌─────────────────────────────────────────────────────────────────┐
│ Trigger: When incident is created                                │
│ Condition: Severity = High AND Title contains "Ransomware"      │
│                                                                  │
│ Actions:                                                         │
│ ├── Add task: "Isolate affected endpoints"                      │
│ ├── Add task: "Preserve memory for forensics"                   │
│ ├── Add task: "Identify patient zero"                           │
│ ├── Add task: "Check for lateral movement"                      │
│ ├── Add task: "Notify incident commander"                       │
│ └── Add task: "Document timeline"                               │
└─────────────────────────────────────────────────────────────────┘</div>

                    <h4>Task Templates by Incident Type</h4>
                    <div class="arch-diagram">INCIDENT TASK TEMPLATES
═══════════════════════════════════════════════════════════════════

BEC (BUSINESS EMAIL COMPROMISE) TASKS:
□ Reset user password immediately
□ Revoke all refresh tokens (Azure AD)
□ Review and remove suspicious inbox rules
□ Check for OAuth app consents granted
□ Review sent folder for phishing emails
□ Check Azure AD audit logs for changes
□ Identify scope - other affected users?
□ Notify affected recipients if phishing sent
□ Document timeline and IOCs
□ Conduct user security awareness follow-up

MALWARE/RANSOMWARE TASKS:
□ Network isolate affected endpoint(s)
□ DO NOT power off (preserve memory)
□ Capture memory image if possible
□ Identify ransomware variant
□ Check for lateral movement indicators
□ Identify initial access vector
□ Scan environment for related IOCs
□ Verify backup integrity
□ Engage incident response team
□ Document for legal/insurance

COMPROMISED ACCOUNT TASKS:
□ Reset password immediately
□ Revoke all sessions
□ Review sign-in logs for suspicious activity
□ Check for persistence mechanisms
□ Review mailbox rules and delegates
□ Check for MFA changes
□ Identify source of compromise
□ Scan for related compromises
□ Re-enable with enhanced monitoring
□ User security training

AUTOMATION RULE FOR BEC TASKS:
Name: Add BEC Investigation Tasks
Trigger: When incident created
Conditions:
  - Tactics contains "InitialAccess" AND
  - Title contains any of ["inbox rule", "forwarding", "OAuth"]
Actions:
  - Add task: "Reset user password"
  - Add task: "Revoke refresh tokens"
  - Add task: "Check inbox rules"
  - Add task: "Review OAuth consents"
  - Change severity to High</div>

                    <h4>Query Incident Tasks</h4>
                    <div class="arch-diagram">QUERYING INCIDENT TASKS
═══════════════════════════════════════════════════════════════════

// Tasks are in SecurityIncident table as nested JSON
SecurityIncident
| where TimeGenerated > ago(7d)
| extend Tasks = todynamic(AdditionalData).tasks
| mv-expand Tasks
| extend TaskTitle = tostring(Tasks.title),
         TaskStatus = tostring(Tasks.status),
         TaskCreatedTime = todatetime(Tasks.createdTimeUtc)
| project IncidentNumber, Title, TaskTitle, TaskStatus, TaskCreatedTime

// Incomplete tasks for open incidents
SecurityIncident
| where Status != "Closed"
| extend Tasks = todynamic(AdditionalData).tasks
| mv-expand Tasks
| where tostring(Tasks.status) != "Completed"
| summarize IncompleteTasks = count() by IncidentNumber, Title
| order by IncompleteTasks desc

// Task completion rate
SecurityIncident
| where TimeGenerated > ago(30d)
| where Status == "Closed"
| extend Tasks = todynamic(AdditionalData).tasks
| mv-expand Tasks
| summarize 
    TotalTasks = count(),
    CompletedTasks = countif(tostring(Tasks.status) == "Completed")
| extend CompletionRate = round(CompletedTasks * 100.0 / TotalTasks, 1)</div>
                </div>

                <!-- Summary Rules -->
                <h2><i class="fas fa-compress-arrows-alt"></i> Summary Rules</h2>
                <div class="config-section">
                    <div class="arch-diagram">SUMMARY RULES - DATA AGGREGATION FOR COST OPTIMIZATION
═══════════════════════════════════════════════════════════════════

WHAT ARE SUMMARY RULES?
├── Pre-aggregate verbose data into summary tables
├── Reduce storage costs while retaining insights
├── Run on schedule to process raw data
├── Output to custom log table
└── Original data can be deleted/archived after summarization

USE CASES:
├── Network flow logs → Hourly connection summaries
├── Proxy logs → Daily URL category statistics
├── Authentication logs → User login patterns
├── Firewall logs → Traffic volume by source/destination
└── DNS logs → Query statistics by domain

SUMMARY RULE CONFIGURATION:
┌─────────────────────────────────────────────────────────────────┐
│ Sentinel → Configuration → Summary Rules → + Create            │
│                                                                  │
│ General:                                                         │
│ ├── Name: Firewall_Traffic_Hourly_Summary                       │
│ ├── Description: Aggregate firewall logs to hourly summary      │
│ └── Destination table: FirewallSummary_CL                       │
│                                                                  │
│ Query:                                                           │
│ CommonSecurityLog                                                │
│ | where TimeGenerated > ago(1h)                                 │
│ | where DeviceVendor == "Palo Alto Networks"                    │
│ | summarize                                                      │
│     TotalBytes = sum(SentBytes + ReceivedBytes),                │
│     ConnectionCount = count(),                                  │
│     UniqueSourceIPs = dcount(SourceIP),                         │
│     UniqueDestIPs = dcount(DestinationIP)                       │
│     by bin(TimeGenerated, 1h), DeviceAction, ApplicationProtocol│
│                                                                  │
│ Schedule:                                                        │
│ ├── Run every: 1 hour                                           │
│ └── Start time: Top of hour                                     │
└─────────────────────────────────────────────────────────────────┘

COST SAVINGS EXAMPLE:
┌──────────────────────────────────────────────────────────────────┐
│ BEFORE: 500 GB/day firewall logs × $2.76/GB = $1,380/day        │
│                                                                  │
│ AFTER SUMMARY RULE:                                              │
│ ├── Raw logs: 500 GB → Basic Logs tier ($0.50/GB) = $250/day   │
│ ├── Summary: 2 GB → Analytics tier ($2.76/GB) = $5.52/day      │
│ ├── Total: $255.52/day                                          │
│ └── SAVINGS: $1,124/day (81% reduction)                         │
└──────────────────────────────────────────────────────────────────┘</div>

                    <h4>Summary Rule Examples</h4>
                    <div class="arch-diagram">SUMMARY RULE QUERY EXAMPLES
═══════════════════════════════════════════════════════════════════

// NETWORK FLOW SUMMARY (Hourly)
AzureNetworkAnalytics_CL
| where TimeGenerated > ago(1h)
| summarize 
    TotalFlows = count(),
    TotalBytesIn = sum(InboundBytes_d),
    TotalBytesOut = sum(OutboundBytes_d),
    UniqueSourceIPs = dcount(SrcIP_s),
    UniqueDestIPs = dcount(DestIP_s),
    UniqueDestPorts = dcount(DestPort_d)
    by bin(TimeGenerated, 1h), 
       FlowDirection_s, 
       NSGRule_s,
       Subscription_s

// DNS QUERY SUMMARY (Hourly)
DnsEvents
| where TimeGenerated > ago(1h)
| summarize 
    QueryCount = count(),
    UniqueClients = dcount(ClientIP),
    UniqueQueries = dcount(Name),
    NXDomainCount = countif(ResultCode == 3),
    SuccessCount = countif(ResultCode == 0)
    by bin(TimeGenerated, 1h),
       QueryType,
       tostring(split(Name, ".")[-2]) // Top-level domain

// AUTHENTICATION SUMMARY (Daily)
SigninLogs
| where TimeGenerated > ago(1d)
| summarize 
    TotalSignins = count(),
    SuccessfulSignins = countif(ResultType == 0),
    FailedSignins = countif(ResultType != 0),
    UniqueUsers = dcount(UserPrincipalName),
    UniqueIPs = dcount(IPAddress),
    UniqueLocations = dcount(Location),
    RiskySignins = countif(RiskLevelDuringSignIn in ("high", "medium"))
    by bin(TimeGenerated, 1d),
       AppDisplayName,
       ConditionalAccessStatus

// PROXY LOG SUMMARY (Hourly)
CommonSecurityLog
| where DeviceVendor == "Zscaler" or DeviceVendor == "BlueCoat"
| where TimeGenerated > ago(1h)
| summarize 
    RequestCount = count(),
    TotalBytes = sum(SentBytes + ReceivedBytes),
    UniqueUsers = dcount(SourceUserName),
    BlockedRequests = countif(DeviceAction == "blocked")
    by bin(TimeGenerated, 1h),
       RequestURL_Category = extract(@"category=([^;]+)", 1, AdditionalExtensions),
       DeviceAction</div>
                </div>

                <!-- Log Source Decision Matrix -->
                <h2><i class="fas fa-sitemap"></i> Log Source Configuration Decision Matrix</h2>
                <div class="config-section">
                    <div class="arch-diagram">LOG SOURCE → CONNECTOR → TABLE DECISION MATRIX
═══════════════════════════════════════════════════════════════════

┌────────────────────┬─────────────────────┬─────────────────────┬─────────────────────┐
│    Log Source      │    Connector        │    Target Table     │    Considerations   │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Azure AD Sign-ins  │ Azure AD (native)   │ SigninLogs          │ Free ingestion      │
│ Azure AD Audit     │ Azure AD (native)   │ AuditLogs           │ Free ingestion      │
│ Azure AD Risky     │ Azure AD (native)   │ AADRiskyUsers       │ Requires AAD P2     │
│ Azure Activity     │ Azure Policy        │ AzureActivity       │ Per-subscription    │
│ Azure Diagnostics  │ Diagnostic Settings │ AzureDiagnostics    │ Resource-specific   │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Windows Security   │ AMA + DCR           │ SecurityEvent       │ Event ID filtering  │
│ Windows Events     │ AMA + DCR           │ Event               │ Custom event logs   │
│ Windows Firewall   │ AMA + DCR           │ WindowsFirewall     │ Enable FW logging   │
│ Windows DNS        │ AMA + DCR           │ DnsEvents           │ DNS debug logging   │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Linux Syslog       │ AMA + DCR           │ Syslog              │ Facility selection  │
│ Linux Auth         │ AMA + DCR           │ Syslog (auth.*)     │ auth, authpriv      │
│ Linux Audit        │ AMA + DCR           │ Syslog or Custom    │ auditd required     │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Palo Alto FW       │ CEF via AMA         │ CommonSecurityLog   │ CEF format config   │
│ Cisco ASA          │ CEF via AMA         │ CommonSecurityLog   │ CEF format config   │
│ Fortinet FW        │ CEF via AMA         │ CommonSecurityLog   │ CEF format config   │
│ Check Point        │ CEF via AMA         │ CommonSecurityLog   │ Log Exporter        │
│ F5 BIG-IP          │ CEF via AMA         │ CommonSecurityLog   │ iRule for CEF       │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ CrowdStrike        │ Data Connector      │ CrowdStrike_CL      │ API key required    │
│ Carbon Black       │ Data Connector      │ CarbonBlack_CL      │ API integration     │
│ Symantec EP        │ CEF via AMA         │ CommonSecurityLog   │ SEPM syslog export  │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ AWS CloudTrail     │ S3 + SQS            │ AWSCloudTrail       │ Cross-account IAM   │
│ AWS GuardDuty      │ S3 + SQS            │ AWSGuardDuty        │ Export to S3        │
│ AWS VPC Flow       │ S3 + SQS            │ AWSVPCFlow          │ Flow log enabled    │
│ GCP Audit          │ Pub/Sub             │ GCPAuditLogs        │ Log sink config     │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Okta               │ API Connector       │ Okta_CL             │ API token           │
│ Duo                │ API Connector       │ Duo_CL              │ Admin API access    │
│ Ping Identity      │ API/Syslog          │ Custom/Syslog       │ Varies by product   │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Microsoft 365      │ M365 Defender       │ Multiple tables     │ Unified portal      │
│ Exchange Online    │ Office 365          │ OfficeActivity      │ Audit log enabled   │
│ SharePoint Online  │ Office 365          │ OfficeActivity      │ Audit log enabled   │
│ Teams              │ Office 365          │ OfficeActivity      │ Audit log enabled   │
├────────────────────┼─────────────────────┼─────────────────────┼─────────────────────┤
│ Custom Application │ Custom Log (DCR)    │ CustomApp_CL        │ Log API/file        │
│ REST API Source    │ Logic App/Function  │ Custom_CL           │ Development needed  │
└────────────────────┴─────────────────────┴─────────────────────┴─────────────────────┘</div>
                </div>

                <!-- Windows Event Collection -->
                <h2><i class="fab fa-windows"></i> Windows Event Collection - Detailed Configuration</h2>
                <div class="config-section">
                    <div class="arch-diagram">WINDOWS EVENT COLLECTION DECISION TREE
═══════════════════════════════════════════════════════════════════

                    ┌─────────────────────────┐
                    │ Windows Event Required? │
                    └───────────┬─────────────┘
                                │
              ┌─────────────────┼─────────────────┐
              ▼                 ▼                 ▼
        ┌──────────┐     ┌──────────┐      ┌──────────┐
        │ Security │     │ System/  │      │ Custom   │
        │ Events   │     │ App Logs │      │ App Logs │
        └────┬─────┘     └────┬─────┘      └────┬─────┘
             │                │                 │
             ▼                ▼                 ▼
    ┌─────────────────┐  ┌─────────────┐  ┌─────────────┐
    │ Use predefined  │  │ Use Event   │  │ Use Custom  │
    │ security sets   │  │ channel     │  │ XPath query │
    │ (Common/Min)    │  │ selection   │  │ in DCR      │
    └─────────────────┘  └─────────────┘  └─────────────┘

SECURITY EVENT COLLECTION SETS:
┌──────────────────────────────────────────────────────────────────┐
│ SET: MINIMAL (Recommended for high-volume environments)          │
│ ~5% of events, critical security events only                     │
│                                                                  │
│ Event IDs:                                                       │
│ 1102 - Audit log cleared                                        │
│ 4624 - Successful logon (filtered to specific types)            │
│ 4625 - Failed logon                                             │
│ 4648 - Explicit credential logon                                │
│ 4657 - Registry value modified                                  │
│ 4663 - Object access attempt                                    │
│ 4672 - Special privileges assigned                              │
│ 4688 - Process creation                                         │
│ 4698 - Scheduled task created                                   │
│ 4720 - User account created                                     │
│ 4726 - User account deleted                                     │
│ 4740 - Account locked out                                       │
│ 4756 - Member added to security-enabled group                   │
│ 4767 - Account unlocked                                         │
│ 7045 - Service installed                                        │
├──────────────────────────────────────────────────────────────────┤
│ SET: COMMON (Balanced coverage)                                  │
│ ~35% of events, good detection coverage                         │
│                                                                  │
│ Includes Minimal + Additional:                                   │
│ 4634 - Logoff                                                   │
│ 4647 - User initiated logoff                                    │
│ 4674 - Operation attempted on privileged object                 │
│ 4700/4701 - Scheduled task enabled/disabled                     │
│ 4702 - Scheduled task updated                                   │
│ 4719 - System audit policy changed                              │
│ 4732 - Member added to local group                              │
│ 4738 - User account changed                                     │
│ 4776 - NTLM authentication                                      │
│ 5140 - Network share accessed                                   │
│ 5145 - Network share object checked                             │
├──────────────────────────────────────────────────────────────────┤
│ SET: ALL EVENTS (Forensic/compliance requirements)              │
│ 100% of events, highest cost                                    │
│ Use only when required by regulation                            │
└──────────────────────────────────────────────────────────────────┘

DCR CONFIGURATION FOR CUSTOM FILTERING:
{
  "dataFlows": [{
    "streams": ["Microsoft-SecurityEvent"],
    "destinations": ["sentinel-workspace"],
    "transformKql": "source | where EventID in (4624, 4625, 4688, 4720, 7045)"
  }]
}</div>

                    <h4>Windows Event Prerequisites</h4>
                    <div class="arch-diagram">WINDOWS AUDIT POLICY REQUIREMENTS
═══════════════════════════════════════════════════════════════════

REQUIRED GPO SETTINGS FOR FULL VISIBILITY:

Computer Configuration → Windows Settings → Security Settings → 
Advanced Audit Policy Configuration:

ACCOUNT LOGON:
├── Credential Validation: Success, Failure
├── Kerberos Authentication Service: Success, Failure
└── Kerberos Service Ticket Operations: Success, Failure

ACCOUNT MANAGEMENT:
├── Security Group Management: Success
├── User Account Management: Success, Failure
└── Computer Account Management: Success

LOGON/LOGOFF:
├── Logon: Success, Failure
├── Logoff: Success
├── Special Logon: Success
└── Other Logon/Logoff Events: Success, Failure

OBJECT ACCESS:
├── File System: Success, Failure (for specific paths)
├── Registry: Success, Failure (for specific keys)
├── SAM: Success
└── Certification Services: Success, Failure

POLICY CHANGE:
├── Audit Policy Change: Success
├── Authentication Policy Change: Success
└── Authorization Policy Change: Success

PRIVILEGE USE:
└── Sensitive Privilege Use: Success, Failure

SYSTEM:
├── Security State Change: Success
├── Security System Extension: Success
└── System Integrity: Success, Failure

PROCESS TRACKING:
└── Process Creation: Success
    └── ALSO ENABLE: Include command line in process creation events
        GPO: Administrative Templates → System → Audit Process Creation
        Setting: Include command line in process creation events = Enabled

VERIFY SETTINGS:
auditpol /get /category:*</div>
                </div>

                <!-- Firewall/CEF Configuration -->
                <h2><i class="fas fa-shield-alt"></i> Firewall/CEF Configuration - Vendor Specific</h2>
                <div class="config-section">
                    <div class="arch-diagram">FIREWALL CEF CONFIGURATION BY VENDOR
═══════════════════════════════════════════════════════════════════

PALO ALTO NETWORKS:
├── Configure syslog server profile:
│   Device → Server Profiles → Syslog
│   ├── Name: Sentinel-Forwarder
│   ├── Server: [Forwarder-IP]
│   ├── Port: 514
│   ├── Transport: UDP (or TCP for reliability)
│   └── Format: CEF
│
├── Configure log forwarding profile:
│   Objects → Log Forwarding → Add Profile
│   ├── Name: Sentinel-Profile
│   ├── Match filters as needed
│   └── Forward to: Sentinel-Forwarder
│
├── Apply to security rules:
│   Policies → Security → [Rule] → Actions → Log Forwarding
│
└── Key CEF fields populated:
    ├── deviceVendor: Palo Alto Networks
    ├── deviceProduct: PAN-OS
    ├── src, dst, spt, dpt
    ├── act (action: allow, deny, drop)
    └── app (application identified)

CISCO ASA:
├── Enable logging:
│   logging enable
│   logging timestamp
│   logging host [interface] [Forwarder-IP]
│   logging trap informational
│   logging facility 20
│
├── Configure CEF format (ASA 9.x+):
│   logging message [message-id] level [level] format cef
│   
├── Recommended message IDs for security:
│   106001-106023 (ACL deny)
│   302013-302018 (Connection events)
│   313001-313009 (ICMP)
│   400000-400050 (IPS events)
│   710001-710006 (Authentication)
│
└── Key fields:
    └── deviceVendor: Cisco, deviceProduct: ASA

FORTINET FORTIGATE:
├── Configure syslog:
│   config log syslogd setting
│     set status enable
│     set server [Forwarder-IP]
│     set format cef
│     set facility local7
│     set port 514
│   end
│
├── Configure log filters:
│   config log syslogd filter
│     set severity information
│     set forward-traffic enable
│     set local-traffic enable
│     set attack enable
│   end
│
└── Key fields:
    └── deviceVendor: Fortinet, deviceProduct: Fortigate

CHECK POINT:
├── Configure Log Exporter:
│   SmartConsole → Logs & Monitor → Log Exporter
│   ├── Add Target: Syslog
│   ├── Server: [Forwarder-IP]
│   ├── Port: 514
│   ├── Protocol: UDP/TCP
│   └── Format: CEF
│
├── Select log types:
│   ├── Security logs
│   ├── Audit logs
│   └── System logs
│
└── Key fields:
    └── deviceVendor: Check Point, deviceProduct: VPN-1 & FireWall-1</div>

                    <h4>CEF Forwarder Setup</h4>
                    <div class="arch-diagram">CEF FORWARDER VM CONFIGURATION
═══════════════════════════════════════════════════════════════════

VM SIZING:
├── Small (&lt;5 GB/day): Standard_D2s_v3 (2 vCPU, 8 GB RAM)
├── Medium (5-20 GB/day): Standard_D4s_v3 (4 vCPU, 16 GB RAM)
├── Large (20-50 GB/day): Standard_D8s_v3 (8 vCPU, 32 GB RAM)
└── Enterprise (&gt;50 GB/day): Multiple VMs behind load balancer

RSYSLOG CONFIGURATION (/etc/rsyslog.conf):
# Load modules
module(load="imudp")
input(type="imudp" port="514")
module(load="imtcp")
input(type="imtcp" port="514")

# CEF parsing template
$template CEFFormat,"%TIMESTAMP% %HOSTNAME% %syslogtag%%msg%\n"

# Forward to Azure Monitor Agent
*.* @@127.0.0.1:28330;CEFFormat

# Restart rsyslog
sudo systemctl restart rsyslog

AMA DCR FOR CEF:
{
  "dataSources": {
    "syslog": [{
      "name": "syslogDataSource",
      "streams": ["Microsoft-CommonSecurityLog"],
      "facilityNames": ["local0", "local1", "local2", "local3", "local4", "local5", "local6", "local7"],
      "logLevels": ["Debug", "Info", "Notice", "Warning", "Error", "Critical", "Alert", "Emergency"]
    }]
  },
  "dataFlows": [{
    "streams": ["Microsoft-CommonSecurityLog"],
    "destinations": ["sentinel-workspace"]
  }]
}

VERIFICATION STEPS:
1. Test syslog receipt: tcpdump -i any port 514
2. Check rsyslog: tail -f /var/log/syslog
3. Verify AMA: systemctl status azuremonitoragent
4. Query Sentinel: CommonSecurityLog | take 10</div>
                </div>

                <!-- Validation Checklists -->
                <h2><i class="fas fa-clipboard-check"></i> Configuration Validation Checklists</h2>
                <div class="config-section">
                    <div class="arch-diagram">DATA CONNECTOR VALIDATION CHECKLIST
═══════════════════════════════════════════════════════════════════

□ PREREQUISITES:
  □ Required permissions granted (Sentinel Contributor)
  □ Licenses in place (AAD P1/P2, M365, etc.)
  □ Network connectivity verified (firewall rules)
  □ Service accounts/API keys created

□ CONNECTOR CONFIGURATION:
  □ Connector shows "Connected" status
  □ All required log types selected
  □ DCR created and associated (for AMA)
  □ Diagnostic settings configured (for Azure resources)

□ DATA VALIDATION:
  □ Data appears in target table
  □ Query: [Table] | where TimeGenerated > ago(1h) | count
  □ Expected volume matches source
  □ All required fields populated
  □ Timestamps are correct (no time drift)
  □ No excessive duplicates

□ FIELD VALIDATION:
  □ Key fields extracted correctly
  □ IP addresses in correct format
  □ User names in expected format
  □ Enrichment fields populated (GeoIP, etc.)

□ ANALYTICS RULE VALIDATION:
  □ Existing rules match new data
  □ Test rule against historical data
  □ No unexpected false positives/negatives

□ DOCUMENTATION:
  □ Connector documented in runbook
  □ Contact for source system documented
  □ Troubleshooting steps documented</div>

                    <div class="arch-diagram">ANALYTICS RULE VALIDATION CHECKLIST
═══════════════════════════════════════════════════════════════════

□ QUERY VALIDATION:
  □ Query runs without errors
  □ Query returns expected results on test data
  □ Query performance &lt;30 seconds
  □ All required fields projected
  □ Time filter aligns with query period

□ CONFIGURATION VALIDATION:
  □ Severity appropriate for detection
  □ Query frequency ≤ query period
  □ MITRE tactics/techniques mapped
  □ Description is clear and actionable
  □ Entity mappings configured correctly

□ ENTITY MAPPING VERIFICATION:
  □ Account entity: UserPrincipalName or Account
  □ Host entity: Computer or DeviceName
  □ IP entity: SourceIP or IPAddress
  □ File entity: FileName + FilePath
  □ Process entity: ProcessName + CommandLine

□ ALERT ENRICHMENT:
  □ Alert name template uses relevant fields
  □ Alert description provides context
  □ Custom details include investigation data

□ TESTING:
  □ Test with known-good sample data
  □ Run against 30 days historical (FP check)
  □ Simulate true positive scenario
  □ Verify incident creation
  □ Verify entity population in incident

□ DOCUMENTATION:
  □ Rule purpose documented
  □ Expected alert volume documented
  □ Tuning guidance documented
  □ Runbook/response steps linked</div>

                    <div class="arch-diagram">PLAYBOOK VALIDATION CHECKLIST
═══════════════════════════════════════════════════════════════════

□ IDENTITY & PERMISSIONS:
  □ Managed identity enabled on Logic App
  □ Managed identity has required roles:
    □ Sentinel Responder (minimum)
    □ Resource-specific permissions (AAD, MDE, etc.)
  □ API connections authorized
  □ Key Vault access configured (for secrets)

□ TRIGGER VALIDATION:
  □ Correct trigger type (incident, alert, entity)
  □ Trigger conditions filter appropriately
  □ Frequency limits won't block execution

□ ACTION VALIDATION:
  □ Each action tested individually
  □ Error handling on each action (Configure run after)
  □ Timeout settings appropriate
  □ Rate limits considered

□ TESTING:
  □ Test with sample incident
  □ Verify all enrichment actions succeed
  □ Verify all response actions succeed
  □ Check incident is updated correctly
  □ Verify notifications sent

□ MONITORING:
  □ Run history shows successful executions
  □ Failure alerts configured
  □ Cost monitoring in place</div>
                </div>

                <!-- Industry-Specific Configurations -->
                <h2><i class="fas fa-industry"></i> Industry-Specific Configurations</h2>
                <div class="config-section">
                    <div class="arch-diagram">INDUSTRY CONFIGURATION MATRIX
═══════════════════════════════════════════════════════════════════

┌─────────────────┬────────────────────┬────────────────────┬─────────────────────┐
│   Industry      │   Key Data Sources │   Priority Rules   │   Compliance        │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ HEALTHCARE      │ EHR systems        │ PHI access         │ HIPAA               │
│                 │ Medical devices    │ Unauthorized views │ HITECH              │
│                 │ Badge systems      │ After-hours access │ State privacy laws  │
│                 │ Azure AD           │ Credential theft   │                     │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ FINANCIAL       │ Core banking       │ Fraud patterns     │ PCI-DSS             │
│                 │ Trading systems    │ Insider trading    │ SOX                 │
│                 │ Wire transfers     │ Account takeover   │ GLBA                │
│                 │ Card processing    │ Data exfiltration  │ FFIEC               │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ GOVERNMENT      │ Classified systems │ APT detection      │ FedRAMP             │
│                 │ Citizen data       │ Insider threat     │ FISMA               │
│                 │ Email (O365 GCC)   │ Spear phishing     │ NIST 800-53         │
│                 │ Endpoint (MDE)     │ Nation-state TTPs  │ CJIS (if law enf.)  │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ RETAIL          │ POS systems        │ Card skimming      │ PCI-DSS             │
│                 │ E-commerce         │ Account fraud      │ State privacy       │
│                 │ Inventory systems  │ Web attacks        │ CCPA                │
│                 │ Customer data      │ Credential stuffing│                     │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ MANUFACTURING   │ OT/SCADA systems   │ OT anomalies       │ NIST CSF            │
│                 │ IoT sensors        │ IT-OT crossover    │ IEC 62443           │
│                 │ MES/ERP            │ Insider sabotage   │ Industry-specific   │
│                 │ Badge/physical     │ IP theft           │                     │
├─────────────────┼────────────────────┼────────────────────┼─────────────────────┤
│ EDUCATION       │ Student info (SIS) │ FERPA violations   │ FERPA               │
│                 │ Research data      │ Research IP theft  │ State privacy       │
│                 │ Azure AD (EDU)     │ Account compromise │ COPPA (K-12)        │
│                 │ LMS systems        │ Ransomware         │ CIPA                │
└─────────────────┴────────────────────┴────────────────────┴─────────────────────┘</div>

                    <h4>Healthcare (HIPAA) Configuration</h4>
                    <div class="arch-diagram">HEALTHCARE SENTINEL CONFIGURATION
═══════════════════════════════════════════════════════════════════

CRITICAL DATA SOURCES:
├── EHR/EMR audit logs (Epic, Cerner, Meditech)
│   └── Custom connector via Logs Ingestion API
├── Azure AD (user authentication)
├── Microsoft 365 (email, collaboration)
├── Medical device logs (via syslog/CEF)
├── Badge/physical access systems
└── Network segmentation logs

HIPAA-SPECIFIC DETECTION RULES:
// PHI access outside business hours
let AfterHours = SigninLogs
| where TimeGenerated > ago(24h)
| extend Hour = datetime_part("hour", TimeGenerated)
| where Hour < 6 or Hour > 20
| where AppDisplayName has_any ("Epic", "Cerner", "EMR");

// Break-the-glass access monitoring
CustomLog_EHR_CL
| where AccessType == "Emergency" or AccessType == "Break-Glass"
| project TimeGenerated, User, Patient, Reason;

// VIP patient access alerting
let VIPPatients = _GetWatchlist('VIP_Patients');
CustomLog_EHR_CL
| where PatientID in (VIPPatients)
| summarize AccessCount = count() by User, Patient

RETENTION REQUIREMENTS:
├── HIPAA: 6 years minimum for audit logs
├── Use Archive tier for cost optimization
└── Enable legal hold for litigation

WORKBOOK: Healthcare Security Dashboard
├── PHI access trends
├── After-hours access heat map
├── Break-glass usage statistics
├── Provider access patterns</div>

                    <h4>Government (FedRAMP/FISMA) Configuration</h4>
                    <div class="arch-diagram">GOVERNMENT SENTINEL CONFIGURATION
═══════════════════════════════════════════════════════════════════

FEDRAMP/FISMA REQUIREMENTS:
├── Use Azure Government regions (USGov Virginia, USGov Arizona)
├── All data must remain in authorized boundary
├── Continuous monitoring required
├── NIST 800-53 control mapping

DEPLOYMENT OPTIONS:
├── Azure Government Cloud (FedRAMP High)
├── Office 365 GCC/GCC High
├── Microsoft Defender for GCC
└── Separate tenant for classified (IL4/IL5)

REQUIRED DATA SOURCES:
├── Azure AD (GCC tenant)
├── Office 365 (GCC or GCC High)
├── Microsoft Defender for Endpoint (GCC)
├── Azure Activity (all subscriptions)
├── Windows Security Events (all servers)
├── Network devices (firewalls, VPN)
└── Privileged access workstations

FISMA CONTROL MAPPINGS:
┌────────────────┬─────────────────────────────────────────────┐
│ Control        │ Sentinel Implementation                     │
├────────────────┼─────────────────────────────────────────────┤
│ AC-2 (Account) │ Azure AD connector, user lifecycle rules    │
│ AU-2 (Audit)   │ All connectors, comprehensive logging       │
│ AU-6 (Review)  │ SOC workbooks, scheduled reviews            │
│ IR-4 (Handling)│ Automation rules, playbooks                 │
│ SI-4 (Monitor) │ Analytics rules, UEBA                       │
└────────────────┴─────────────────────────────────────────────┘

APT/NATION-STATE DETECTION:
// Known APT infrastructure
let APT_IOCs = _GetWatchlist('APT_Indicators');
CommonSecurityLog
| where DestinationIP in (APT_IOCs) or SourceIP in (APT_IOCs);

// Spear phishing to government targets
EmailEvents
| where RecipientEmailAddress endswith ".gov"
| where SenderFromDomain !endswith ".gov"
| where ThreatTypes has "Phish"</div>

                    <h4>Financial Services (PCI-DSS) Configuration</h4>
                    <div class="arch-diagram">FINANCIAL SERVICES SENTINEL CONFIGURATION
═══════════════════════════════════════════════════════════════════

PCI-DSS REQUIREMENTS MAPPING:
├── Req 10.1: Audit trail for all access to cardholder data
├── Req 10.2: Automated audit trails for specific events
├── Req 10.3: Record specific audit trail entries
├── Req 10.5: Secure audit trails
├── Req 10.6: Review logs daily
├── Req 10.7: Retain audit history for 1 year

CRITICAL DATA SOURCES:
├── Payment application logs (custom connector)
├── Database audit logs (SQL, Oracle)
├── Firewall logs (PCI network segmentation)
├── Windows Security Events (CDE servers)
├── Azure AD (privileged access)
└── File integrity monitoring

PCI-SPECIFIC DETECTION RULES:
// Access to cardholder data environment
SecurityEvent
| where Computer in (CDE_Servers)
| where EventID in (4624, 4625, 4648)
| summarize LoginCount = count() by Account, Computer;

// Database query to card tables
AzureDiagnostics
| where Category == "SQLSecurityAuditEvents"
| where statement_s has_any ("card", "pan", "cvv", "expiry");

// Network segmentation violations
CommonSecurityLog
| where SourceIP in (NonCDE_Range) 
| where DestinationIP in (CDE_Range)
| where DeviceAction == "allow"  // Should be blocked!

RETENTION & COMPLIANCE:
├── 1 year online (Analytics tier)
├── Archive for additional years as needed
├── Daily log review workbook
├── Quarterly access review automation</div>
                </div>

                <!-- Third-Party Integrations -->
                <h2><i class="fas fa-plug"></i> Third-Party Integration Scenarios</h2>
                <div class="config-section">
                    <div class="arch-diagram">SENTINEL INTEGRATION PATTERNS
═══════════════════════════════════════════════════════════════════

TICKETING SYSTEMS:

SERVICENOW INTEGRATION:
┌─────────────────────────────────────────────────────────────────┐
│ Sentinel Incident ──▶ Logic App ──▶ ServiceNow REST API        │
│                                                                  │
│ Playbook Actions:                                               │
│ ├── Create incident in ServiceNow                               │
│ ├── Populate fields from Sentinel incident                      │
│ ├── Add work notes with investigation details                   │
│ ├── Update Sentinel with ServiceNow ticket number               │
│ └── Bi-directional sync (close in SNOW → close in Sentinel)    │
│                                                                  │
│ ServiceNow Fields Mapped:                                       │
│ ├── short_description ← Sentinel incident title                │
│ ├── description ← Sentinel incident description                │
│ ├── urgency ← Sentinel severity mapping                        │
│ ├── assignment_group ← Based on incident type                  │
│ └── custom fields ← Entities, MITRE tactics                    │
└─────────────────────────────────────────────────────────────────┘

JIRA INTEGRATION:
├── Use Jira REST API connector in Logic Apps
├── Create issues in security project
├── Link back to Sentinel incident
├── Sync status changes

PAGERDUTY INTEGRATION:
├── Trigger: High severity incident created
├── Action: Create PagerDuty incident via API
├── Include: Incident details, entities, severity
├── Escalation: Auto-escalate if not acknowledged

COMMUNICATION PLATFORMS:

MICROSOFT TEAMS:
├── Adaptive card with incident details
├── Action buttons (Assign, Close, Investigate)
├── SOC channel notifications
├── On-call rotation tagging

SLACK INTEGRATION:
├── Webhook to Slack channel
├── Rich message formatting
├── Interactive buttons via Slack API
└── Thread updates for incident progress

EMAIL NOTIFICATIONS:
├── Send via Office 365 connector
├── HTML formatted incident summary
├── Recipient based on severity/type
└── Include direct link to incident</div>

                    <h4>ServiceNow Playbook Example</h4>
                    <div class="arch-diagram">SERVICENOW PLAYBOOK CONFIGURATION
═══════════════════════════════════════════════════════════════════

LOGIC APP STEPS:

1. TRIGGER: When Azure Sentinel incident is created
   └── Condition: Severity = High

2. GET INCIDENT DETAILS
   └── Get all incident information and entities

3. CREATE SERVICENOW INCIDENT
   HTTP POST to: https://[instance].service-now.com/api/now/table/incident
   
   Headers:
   ├── Authorization: Basic [encoded credentials]
   └── Content-Type: application/json
   
   Body:
   {
     "short_description": "@{triggerBody()?['object']?['properties']?['title']}",
     "description": "@{triggerBody()?['object']?['properties']?['description']}",
     "urgency": "@{if(equals(triggerBody()?['object']?['properties']?['severity'],'High'),'1','2')}",
     "impact": "2",
     "category": "Security",
     "subcategory": "Incident Response",
     "assignment_group": "SOC Team",
     "caller_id": "sentinel.integration",
     "u_sentinel_id": "@{triggerBody()?['object']?['properties']?['incidentNumber']}"
   }

4. PARSE RESPONSE
   └── Extract sys_id and number from ServiceNow response

5. UPDATE SENTINEL INCIDENT
   └── Add comment with ServiceNow ticket number
   └── Add tag: "SNOW-[ticket_number]"

6. SEND TEAMS NOTIFICATION
   └── Post to SOC channel with both Sentinel and SNOW links

ERROR HANDLING:
├── Configure "Run After" for failed steps
├── Send alert on playbook failure
└── Log errors to custom table</div>
                </div>

                <!-- Complete Detection Scenario Library -->
                <h2><i class="fas fa-shield-alt"></i> Detection Scenario Library</h2>
                <div class="config-section">
                    <div class="arch-diagram">DETECTION SCENARIO QUICK REFERENCE
═══════════════════════════════════════════════════════════════════

IDENTITY THREATS:
┌────────────────────┬─────────────────────────────────────────────┐
│ Scenario           │ Key Query Logic                             │
├────────────────────┼─────────────────────────────────────────────┤
│ Password Spray     │ Multiple users, same IP, short window       │
│ Brute Force        │ Single user, many failures, then success    │
│ Credential Stuffing│ Many users, distributed IPs, leaked creds   │
│ Impossible Travel  │ Same user, different geos, short time       │
│ MFA Fatigue        │ Multiple MFA prompts, eventual approval     │
│ Token Theft        │ Sign-in from new location post-auth         │
│ Consent Phishing   │ OAuth app consent + suspicious activity     │
└────────────────────┴─────────────────────────────────────────────┘

// BRUTE FORCE FOLLOWED BY SUCCESS
let FailedLogins = SigninLogs
| where ResultType != 0
| summarize Failures = count() by UserPrincipalName, IPAddress, bin(TimeGenerated, 1h);
let SuccessfulLogins = SigninLogs
| where ResultType == 0;
FailedLogins
| where Failures > 10
| join kind=inner SuccessfulLogins on UserPrincipalName, IPAddress
| where TimeGenerated1 > TimeGenerated
| where datetime_diff('hour', TimeGenerated1, TimeGenerated) < 2

ENDPOINT THREATS:
┌────────────────────┬─────────────────────────────────────────────┐
│ Scenario           │ Key Indicators                              │
├────────────────────┼─────────────────────────────────────────────┤
│ Ransomware         │ Mass file encryption, shadow copy delete    │
│ Credential Dump    │ LSASS access, Mimikatz patterns             │
│ Persistence        │ Registry run keys, scheduled tasks, services│
│ Lateral Movement   │ PsExec, WMI, RDP from unexpected sources   │
│ Living off Land    │ PowerShell, certutil, bitsadmin abuse      │
│ Defense Evasion    │ AV disable, log clearing, timestomping     │
└────────────────────┴─────────────────────────────────────────────┘

// CREDENTIAL DUMPING - LSASS ACCESS
SecurityEvent
| where EventID == 4663
| where ObjectName has "lsass"
| where AccessMask has_any ("0x10", "0x1010", "0x1F0FFF")
| project TimeGenerated, Computer, SubjectUserName, ProcessName

// SUSPICIOUS SCHEDULED TASK
SecurityEvent
| where EventID == 4698
| extend TaskContent = tostring(parse_xml(EventData).EventData.Data)
| where TaskContent has_any ("powershell", "cmd", "http", "\\temp\\")

EMAIL/BEC THREATS:
┌────────────────────┬─────────────────────────────────────────────┐
│ Scenario           │ Key Indicators                              │
├────────────────────┼─────────────────────────────────────────────┤
│ BEC - Forwarding   │ Inbox rule to external, sign-in anomaly    │
│ BEC - Impersonation│ Lookalike domains, display name spoofing   │
│ Phishing Campaign  │ Multiple recipients, new sender domain     │
│ Malicious Attach   │ Macro-enabled files, password protected    │
│ Credential Harvest │ Links to fake login pages                  │
└────────────────────┴─────────────────────────────────────────────┘

// BEC - SUSPICIOUS INBOX RULE
OfficeActivity
| where Operation == "New-InboxRule"
| extend RuleParams = tostring(Parameters)
| where RuleParams has_any ("forward", "redirect", "delete")
       and RuleParams has_any ("@gmail", "@yahoo", "@outlook", "external")</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Walk me through configuring a new firewall to send logs to Sentinel.</button>
                        <div class="qa-answer">
                            <p><strong>Step-by-step firewall onboarding:</strong></p>
                            <ol>
                                <li><strong>Deploy forwarder VM:</strong> Linux VM with rsyslog, sized for expected volume</li>
                                <li><strong>Install AMA:</strong> Azure Monitor Agent with CEF DCR</li>
                                <li><strong>Configure rsyslog:</strong> Listen on 514 UDP/TCP, forward to AMA</li>
                                <li><strong>Configure firewall:</strong>
                                    <ul>
                                        <li>Create syslog server profile pointing to forwarder IP</li>
                                        <li>Select CEF format</li>
                                        <li>Configure log forwarding profile with desired log types</li>
                                        <li>Apply to security rules</li>
                                    </ul>
                                </li>
                                <li><strong>Validate:</strong> tcpdump on forwarder, query CommonSecurityLog</li>
                                <li><strong>Enable analytics:</strong> Deploy firewall content solution from Content Hub</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you decide which Windows Security Events to collect?</button>
                        <div class="qa-answer">
                            <p><strong>Decision framework:</strong></p>
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Requirement</th><th>Event Set</th><th>Volume</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Cost-conscious, basic detection</td><td>Minimal</td><td>~5%</td></tr>
                                    <tr><td>Balanced security/cost</td><td>Common</td><td>~35%</td></tr>
                                    <tr><td>Compliance/forensics</td><td>All Events</td><td>100%</td></tr>
                                    <tr><td>Custom requirements</td><td>Custom DCR filter</td><td>Variable</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;"><strong>Key events to always collect:</strong> 4624/4625 (logon), 4688 (process), 4720 (account created), 7045 (service installed), 1102 (audit cleared)</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What are Incident Tasks and how would you use them?</button>
                        <div class="qa-answer">
                            <p><strong>Incident Tasks</strong> are checklist items attached to incidents that guide analysts through investigation steps.</p>
                            <p style="margin-top: 12px;"><strong>Key uses:</strong></p>
                            <ul>
                                <li>Standardize investigation procedures across analysts</li>
                                <li>Ensure no steps are missed in critical incidents</li>
                                <li>Track progress on complex investigations</li>
                                <li>Auto-create via automation rules based on incident type</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Example:</strong> Automation rule that adds BEC investigation tasks (reset password, check inbox rules, review OAuth consents) when incident title contains "forwarding rule".</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Explain Summary Rules and when you'd use them.</button>
                        <div class="qa-answer">
                            <p><strong>Summary Rules</strong> pre-aggregate verbose data into summary tables to reduce storage costs while retaining analytical value.</p>
                            <p style="margin-top: 12px;"><strong>Use cases:</strong></p>
                            <ul>
                                <li><strong>Network flow logs:</strong> Aggregate to hourly connection summaries</li>
                                <li><strong>DNS logs:</strong> Aggregate to query statistics by domain</li>
                                <li><strong>Proxy logs:</strong> Aggregate to URL category statistics</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Cost savings example:</strong> 500 GB/day firewall logs → Basic Logs tier ($250) + 2 GB summary to Analytics ($5.50) = 81% cost reduction vs full Analytics tier.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you validate that a connector is working correctly?</button>
                        <div class="qa-answer">
                            <p><strong>Connector validation checklist:</strong></p>
                            <ol>
                                <li><strong>Status check:</strong> Connector shows "Connected" in portal</li>
                                <li><strong>Data arrival:</strong> <code>[Table] | where TimeGenerated > ago(1h) | count</code></li>
                                <li><strong>Volume validation:</strong> Compare EPS with source system stats</li>
                                <li><strong>Field validation:</strong> Check key fields populated (SourceIP, UserName, etc.)</li>
                                <li><strong>Format validation:</strong> Ensure data parses correctly (no raw unparsed data)</li>
                                <li><strong>Analytics test:</strong> Run existing rules against new data</li>
                                <li><strong>Latency check:</strong> <code>| extend Delay = ingestion_time() - TimeGenerated</code></li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What entity mappings are most important for incident investigation?</button>
                        <div class="qa-answer">
                            <p><strong>Critical entity mappings:</strong></p>
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Entity Type</th><th>Identifier</th><th>Common Fields</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Account</td><td>FullName, AadUserId, Sid</td><td>UserPrincipalName, Account, AccountName</td></tr>
                                    <tr><td>Host</td><td>HostName, AzureID, FQDN</td><td>Computer, DeviceName, Hostname</td></tr>
                                    <tr><td>IP</td><td>Address</td><td>SourceIP, IPAddress, ClientIP</td></tr>
                                    <tr><td>File</td><td>Name + Directory</td><td>FileName, FilePath, FolderPath</td></tr>
                                    <tr><td>Process</td><td>ProcessId + CommandLine</td><td>ProcessName, CommandLine, ProcessId</td></tr>
                                    <tr><td>URL</td><td>Url</td><td>Url, RequestURL, DestinationURL</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;"><strong>Why it matters:</strong> Proper entity mapping enables investigation graph, entity pages, entity timeline, and cross-incident correlation.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
        
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        });
    </script>
</body>
</html>
