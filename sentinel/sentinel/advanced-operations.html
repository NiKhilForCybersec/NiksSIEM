<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Operations | Microsoft Sentinel</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="app-container">
            <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link active"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="content-hub.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Content Hub</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-connectors.html" class="sidebar-nav-link"><i class="fas fa-plug"></i><span>Data Connectors</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="dcr-dce-guide.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>DCR & DCE Guide</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="event-hub.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Event Hub Integration</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-filter"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention & Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="kql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>KQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-intermediate.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>KQL Intermediate</span></a></li>
                    <li class="sidebar-nav-item"><a href="kql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>KQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="workbooks.html" class="sidebar-nav-link"><i class="fas fa-chart-bar"></i><span>Workbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="notebooks.html" class="sidebar-nav-link"><i class="fas fa-book-open"></i><span>Notebooks</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="analytics-rules.html" class="sidebar-nav-link"><i class="fas fa-shield-alt"></i><span>Analytics Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="watchlists.html" class="sidebar-nav-link"><i class="fas fa-list-check"></i><span>Watchlists</span></a></li>
                    <li class="sidebar-nav-item"><a href="ueba.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intelligence</span></a></li>
                    <li class="sidebar-nav-item"><a href="hunting.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Hunting</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Security Use Cases -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Security Use Cases</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="security-usecases.html" class="sidebar-nav-link"><i class="fas fa-crosshairs"></i><span>Detection Use Cases</span></a></li>
                    <li class="sidebar-nav-item"><a href="enterprise-scenarios.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise Scenarios</span></a></li>
                </ul>
            </div>
            
            <!-- Automation -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>Automation & Playbooks</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-operations.html" class="sidebar-nav-link"><i class="fas fa-headset"></i><span>SOC Operations</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>RBAC & Permissions</span></a></li>
                    <li class="sidebar-nav-item"><a href="config-reference.html" class="sidebar-nav-link"><i class="fas fa-cog"></i><span>Configuration Reference</span></a></li>
                    <li class="sidebar-nav-item"><a href="devops.html" class="sidebar-nav-link"><i class="fas fa-code-branch"></i><span>Sentinel as Code</span></a></li>
                    <li class="sidebar-nav-item"><a href="advanced-operations.html" class="sidebar-nav-link"><i class="fas fa-cogs"></i><span>Advanced Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Main Content Wrapper -->
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()" title="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Sentinel</a>
                    <span class="separator">/</span>
                    <span class="current">Advanced Operations</span>
                </div>

                <h1><i class="fas fa-cogs"></i> Advanced Operations</h1>
                <p class="lead">Master advanced Sentinel capabilities: Repositories, workspace migration, backup/DR, continuous export, search jobs, SAP integration, and IoT/OT security monitoring.</p>

                <!-- Sentinel Repositories -->
                <h2><i class="fas fa-code-branch"></i> Sentinel Repositories</h2>
                <div class="config-section">
                    <div class="arch-diagram">SENTINEL REPOSITORIES - NATIVE GIT INTEGRATION
═══════════════════════════════════════════════════════════════════

WHAT IS SENTINEL REPOSITORIES?
├── Native Git integration for Sentinel content
├── Sync analytics rules, playbooks, workbooks from GitHub/Azure DevOps
├── Version control without custom CI/CD pipelines
├── Bi-directional sync (export from portal, import from repo)
└── Part of Content Hub ecosystem

SUPPORTED CONTENT TYPES:
├── Analytics Rules (Scheduled, NRT, Fusion)
├── Automation Rules
├── Hunting Queries
├── Workbooks
├── Parsers
├── Playbooks (as ARM templates)
└── Watchlists

REPOSITORY STRUCTURE REQUIRED:
sentinel-repo/
├── AnalyticsRules/
│   ├── rule1.json
│   └── rule2.yaml
├── AutomationRules/
│   └── auto-rule1.json
├── HuntingQueries/
│   └── hunt1.yaml
├── Workbooks/
│   └── soc-dashboard.json
├── Parsers/
│   └── custom-parser.yaml
└── Playbooks/
    └── enrich-ip/
        └── azuredeploy.json

SETUP STEPS:
1. Sentinel → Configuration → Settings → Repositories
2. Click "Add new"
3. Select source: GitHub or Azure DevOps
4. Authorize connection (OAuth)
5. Select repository and branch
6. Configure sync settings:
   ├── Content types to sync
   ├── Sync direction (import/export/bidirectional)
   └── Sync frequency

DEPLOYMENT FLOW:
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│   GitHub/ADO Repo ──▶ Sentinel Repository Connector ──▶ Sentinel│
│        │                                                        │
│        │ Pull Request ──▶ Review ──▶ Merge ──▶ Auto-Sync       │
│        │                                                        │
│   Developer creates/modifies rule in repo                       │
│   PR reviewed by security team                                  │
│   Merged to main branch                                         │
│   Sentinel automatically deploys content                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘</div>

                    <h4>Repository vs Custom CI/CD Decision</h4>
                    <div class="arch-diagram">REPOSITORIES vs CUSTOM CI/CD DECISION TREE
═══════════════════════════════════════════════════════════════════

START: How do you want to manage Sentinel content?

├─► Simple version control, minimal customization?
│   └─► USE: Sentinel Repositories (Native)
│       ├── Pros: No pipeline to maintain, built-in
│       ├── Cons: Less flexibility, limited testing
│       └── Best for: Small teams, straightforward deployments
│
├─► Need custom testing/validation before deployment?
│   └─► USE: Custom CI/CD (Azure DevOps/GitHub Actions)
│       ├── Pros: Full control, custom testing, multi-stage
│       ├── Cons: Pipeline maintenance overhead
│       └── Best for: Large enterprises, strict change control
│
├─► Need to deploy across multiple workspaces?
│   └─► USE: Custom CI/CD with parameterized templates
│       ├── Single source, multiple deployments
│       └── Environment-specific configurations
│
└─► Hybrid approach?
    └─► USE: Repositories for content, CI/CD for infrastructure
        ├── Rules/queries via Repositories
        └── Workspace config via Terraform/Bicep

REPOSITORY CONFIGURATION:
{
  "properties": {
    "displayName": "Security-Rules-Repo",
    "repoType": "Github",
    "branch": "main",
    "contentTypes": [
      "AnalyticRule",
      "AutomationRule",
      "HuntingQuery"
    ],
    "repository": {
      "url": "https://github.com/org/sentinel-content"
    }
  }
}</div>
                </div>

                <!-- Workspace Migration -->
                <h2><i class="fas fa-exchange-alt"></i> Workspace Migration</h2>
                <div class="config-section">
                    <div class="arch-diagram">WORKSPACE MIGRATION SCENARIOS
═══════════════════════════════════════════════════════════════════

COMMON MIGRATION SCENARIOS:
├── Tenant-to-tenant (M&A, divestiture)
├── Region-to-region (data residency changes)
├── Consolidation (multiple workspaces to one)
├── Separation (single workspace to multiple)
└── Environment promotion (dev → prod)

MIGRATION DECISION TREE:
START: What are you migrating?

├─► Same tenant, different region?
│   └─► Create new workspace in target region
│       ├── Export content via API/Repositories
│       ├── Reconfigure data connectors
│       └── Historical data: Export via Data Export or ADX
│
├─► Different tenant (M&A)?
│   └─► More complex:
│       ├── Export all content to ARM/Bicep
│       ├── Create new workspace in target tenant
│       ├── Import content
│       ├── Reconfigure all connectors (new permissions)
│       └── Historical data may not be portable
│
└─► Consolidating multiple workspaces?
    └─► Design new unified architecture
        ├── Plan data segregation (resource-context RBAC)
        ├── Merge content (deduplicate rules)
        ├── Redirect data sources
        └── Decommission old workspaces

WHAT CAN BE MIGRATED:
┌─────────────────────┬──────────────┬────────────────────────────┐
│ Component           │ Portable?    │ Method                     │
├─────────────────────┼──────────────┼────────────────────────────┤
│ Analytics Rules     │ Yes          │ ARM export, API, Repos     │
│ Automation Rules    │ Yes          │ ARM export, API            │
│ Playbooks           │ Partial      │ ARM (may need reconfig)    │
│ Workbooks           │ Yes          │ JSON export                │
│ Watchlists          │ Yes          │ CSV export/import          │
│ Hunting Queries     │ Yes          │ YAML/JSON export           │
│ Parsers             │ Yes          │ KQL export                 │
│ Historical Data     │ Partial      │ Data Export, ADX           │
│ Incidents           │ No           │ Cannot migrate incidents   │
│ Bookmarks           │ No           │ Manual recreation          │
│ Entity Timeline     │ No           │ Not portable               │
└─────────────────────┴──────────────┴────────────────────────────┘</div>

                    <h4>Migration Procedure</h4>
                    <div class="arch-diagram">WORKSPACE MIGRATION STEP-BY-STEP
═══════════════════════════════════════════════════════════════════

PHASE 1: INVENTORY (Week 1)
□ List all data connectors and sources
□ Export all analytics rules (ARM/API)
□ Export all automation rules
□ Export playbooks (ARM templates)
□ Export workbooks (JSON)
□ Export watchlists (CSV)
□ Export hunting queries
□ Document custom parsers/functions
□ Note any custom tables (DCR configurations)

PHASE 2: PREPARE TARGET (Week 2)
□ Create new Log Analytics workspace
□ Enable Sentinel on workspace
□ Configure RBAC (may differ from source)
□ Import playbooks first (dependencies)
□ Configure managed identity permissions
□ Set up data export if needed (for historical)

PHASE 3: CONTENT MIGRATION (Week 3)
□ Import analytics rules (disabled initially)
□ Import automation rules
□ Import workbooks
□ Import watchlists
□ Import hunting queries
□ Create/import custom parsers
□ Test sample rules manually

PHASE 4: DATA SOURCE CUTOVER (Week 4)
□ Redirect Azure AD diagnostic settings
□ Reconfigure M365 connectors
□ Update AMA DCR associations
□ Redirect syslog forwarders
□ Update API connector configurations
□ Verify data flowing to new workspace

PHASE 5: VALIDATION (Week 5)
□ Verify all data sources reporting
□ Enable analytics rules incrementally
□ Test playbook execution
□ Validate workbook data
□ Confirm alerting working
□ Performance baseline new workspace

PHASE 6: CUTOVER (Week 6)
□ Disable rules in old workspace
□ Update SOC procedures to new workspace
□ Monitor parallel for 1 week
□ Decommission old workspace

EXPORT COMMANDS:
# Export all analytics rules
az sentinel alert-rule list \
  --resource-group $RG \
  --workspace-name $WS \
  --query "[].{name:name, kind:kind}" -o json > rules.json

# Export specific rule as ARM
az sentinel alert-rule show \
  --resource-group $RG \
  --workspace-name $WS \
  --rule-name "rule-name" > rule-arm.json</div>
                </div>

                <!-- Backup & Disaster Recovery -->
                <h2><i class="fas fa-shield-alt"></i> Backup & Disaster Recovery</h2>
                <div class="config-section">
                    <div class="arch-diagram">SENTINEL BACKUP & DR STRATEGY
═══════════════════════════════════════════════════════════════════

WHAT NEEDS BACKUP?

CONFIGURATION (Critical - Must backup):
├── Analytics Rules
├── Automation Rules
├── Playbooks (Logic Apps)
├── Workbooks
├── Watchlists
├── Hunting Queries
├── Parsers/Functions
├── Data Connectors settings
└── RBAC assignments

DATA (Based on requirements):
├── Log data (automatic via retention)
├── Incidents (consider export for compliance)
├── Bookmarks (manual, low volume)
└── Comments/notes

BACKUP STRATEGIES:

STRATEGY 1: GIT-BASED (Recommended)
┌─────────────────────────────────────────────────────────────────┐
│ Sentinel Repositories ──▶ GitHub/Azure DevOps ──▶ Backup       │
│                                                                  │
│ • All content synced to Git automatically                       │
│ • Git provides version history                                  │
│ • Can restore any point in time                                 │
│ • DR: Deploy from Git to new workspace                         │
└─────────────────────────────────────────────────────────────────┘

STRATEGY 2: SCHEDULED API EXPORT
┌─────────────────────────────────────────────────────────────────┐
│ Logic App (Daily) ──▶ Export all content via API ──▶ Storage   │
│                                                                  │
│ • Scheduled Logic App runs daily                                │
│ • Exports all rules/content to Blob Storage                    │
│ • Versioned with date stamps                                    │
│ • Good for compliance/audit requirements                        │
└─────────────────────────────────────────────────────────────────┘

STRATEGY 3: ARM TEMPLATE EXPORT
┌─────────────────────────────────────────────────────────────────┐
│ Manual/Scheduled ARM export ──▶ Storage ──▶ Git                │
│                                                                  │
│ az sentinel alert-rule list... > backup-$(date).json           │
│                                                                  │
│ • Simple scripted approach                                      │
│ • Can run in Azure Automation                                   │
└─────────────────────────────────────────────────────────────────┘

DR RECOVERY PROCEDURES:

SCENARIO: Complete workspace loss
1. Create new Log Analytics workspace
2. Enable Sentinel
3. Deploy content from Git/backup
4. Reconfigure data connectors
5. Verify data flowing
6. Enable analytics rules
7. Restore watchlists from backup
Recovery Time Objective (RTO): 4-8 hours

SCENARIO: Accidental rule deletion
1. Identify deleted rule from Git history
2. Revert commit or restore specific file
3. Sync via Repositories or manual import
RTO: Minutes

SCENARIO: Corrupted automation rule
1. Disable affected rule
2. Restore from Git/backup
3. Redeploy
4. Test execution
RTO: 15-30 minutes</div>

                    <h4>Backup Automation Script</h4>
                    <div class="arch-diagram">AUTOMATED BACKUP SCRIPT (PowerShell)
═══════════════════════════════════════════════════════════════════

# Sentinel-Backup.ps1 - Run daily via Azure Automation

param(
    [string]$ResourceGroup = "sentinel-rg",
    [string]$WorkspaceName = "sentinel-workspace",
    [string]$StorageAccount = "sentinelbackup",
    [string]$Container = "backups"
)

$date = Get-Date -Format "yyyy-MM-dd"
$backupPath = "sentinel-backup-$date"

# Connect to Azure
Connect-AzAccount -Identity

# Export Analytics Rules
$rules = Get-AzSentinelAlertRule -ResourceGroupName $ResourceGroup `
         -WorkspaceName $WorkspaceName
$rules | ConvertTo-Json -Depth 10 | Out-File "$backupPath/analytics-rules.json"

# Export Automation Rules
$autoRules = Get-AzSentinelAutomationRule -ResourceGroupName $ResourceGroup `
             -WorkspaceName $WorkspaceName
$autoRules | ConvertTo-Json -Depth 10 | Out-File "$backupPath/automation-rules.json"

# Export Watchlists
$watchlists = Get-AzSentinelWatchlist -ResourceGroupName $ResourceGroup `
              -WorkspaceName $WorkspaceName
foreach ($wl in $watchlists) {
    $items = Get-AzSentinelWatchlistItem -ResourceGroupName $ResourceGroup `
             -WorkspaceName $WorkspaceName -WatchlistAlias $wl.Name
    $items | Export-Csv "$backupPath/watchlist-$($wl.Name).csv" -NoTypeInformation
}

# Export Hunting Queries (saved searches)
$queries = Get-AzOperationalInsightsSavedSearch -ResourceGroupName $ResourceGroup `
           -WorkspaceName $WorkspaceName
$queries | ConvertTo-Json -Depth 10 | Out-File "$backupPath/hunting-queries.json"

# Upload to Blob Storage
$context = (Get-AzStorageAccount -ResourceGroupName $ResourceGroup `
            -Name $StorageAccount).Context
Get-ChildItem $backupPath | ForEach-Object {
    Set-AzStorageBlobContent -File $_.FullName -Container $Container `
    -Blob "$backupPath/$($_.Name)" -Context $context
}

Write-Output "Backup completed: $backupPath"</div>
                </div>

                <!-- Continuous Export & Data Export -->
                <h2><i class="fas fa-file-export"></i> Data Export & Continuous Export</h2>
                <div class="config-section">
                    <div class="arch-diagram">DATA EXPORT OPTIONS
═══════════════════════════════════════════════════════════════════

OPTION 1: DATA EXPORT RULES (Log Analytics)
├── Purpose: Stream data to external destinations
├── Destinations: Storage Account, Event Hub
├── Use cases: Long-term archive, external SIEM, compliance
├── Limitations: 
│   ├── Not all tables supported
│   ├── Near real-time (minutes delay)
│   └── Cannot export to different tenant directly

CONFIGURATION:
Workspace → Settings → Data Export → + New export rule

Export Rule Settings:
├── Name: archive-security-events
├── Tables: SecurityEvent, SigninLogs, AuditLogs
├── Destination: Storage Account or Event Hub
├── Enable: Yes

SUPPORTED TABLES FOR EXPORT:
├── SecurityEvent
├── Syslog
├── CommonSecurityLog
├── AzureActivity
├── SigninLogs
├── AuditLogs
├── AzureDiagnostics
├── Heartbeat
├── Perf
└── (Custom tables with _CL suffix)

NOT SUPPORTED:
├── SecurityIncident
├── SecurityAlert
├── BehaviorAnalytics
├── IdentityInfo
└── Most Sentinel-specific tables

OPTION 2: CONTINUOUS EXPORT (Security Center/Defender)
├── Purpose: Export security recommendations and alerts
├── Destination: Log Analytics, Event Hub
├── Configuration: Defender for Cloud → Environment settings

OPTION 3: LOGIC APP EXPORT
├── Purpose: Export specific data on schedule
├── Flexibility: Can export any data, any format
├── Use case: Incident export for compliance

LOGIC APP INCIDENT EXPORT:
Trigger: Recurrence (daily)
Actions:
1. Run KQL query: SecurityIncident | where TimeGenerated > ago(1d)
2. Create CSV
3. Upload to Storage Account
4. Send email notification</div>

                    <h4>Data Export Decision Tree</h4>
                    <div class="arch-diagram">DATA EXPORT DECISION TREE
═══════════════════════════════════════════════════════════════════

START: Why do you need to export data?

├─► Long-term archive (compliance)?
│   ├─► Supported table?
│   │   └─► YES → Use Data Export to Storage Account
│   │       └─► Configure lifecycle policy for tiering
│   └─► NO (SecurityIncident, etc.)?
│       └─► Use Logic App scheduled export
│
├─► Stream to external SIEM?
│   └─► Use Data Export to Event Hub
│       └─► External SIEM consumes from Event Hub
│
├─► Feed to data lake for analytics?
│   └─► Use Data Export to Storage Account (ADLS Gen2)
│       └─► Query via Synapse/Databricks
│
├─► Real-time integration with external system?
│   └─► Use Event Hub export
│       └─► Consumer processes events in real-time
│
└─► Ad-hoc export for investigation?
    └─► Use KQL query → Export to CSV
        └─► Or use API to extract specific data

STORAGE ACCOUNT STRUCTURE FOR ARCHIVE:
container/
├── WorkspaceResourceId=/subscriptions/.../workspaces/ws1/
│   ├── y=2024/m=01/d=15/h=10/m=00/
│   │   └── PT1H.json (hourly export file)
│   └── ...

COST CONSIDERATIONS:
├── Storage costs for exported data
├── Event Hub costs if streaming
├── No additional Sentinel costs for export
└── Consider Archive tier for long-term storage</div>
                </div>

                <!-- Search Jobs -->
                <h2><i class="fas fa-search"></i> Search Jobs & Restore</h2>
                <div class="config-section">
                    <div class="arch-diagram">SEARCH JOBS - QUERY ARCHIVED DATA
═══════════════════════════════════════════════════════════════════

WHAT ARE SEARCH JOBS?
├── Query data in Archive tier without restoring
├── Query data beyond interactive retention
├── Asynchronous execution (runs in background)
├── Results saved to new table for analysis
└── Cost-effective for occasional historical queries

WHEN TO USE:
├── Investigating historical incidents
├── Compliance audits requiring old data
├── Threat hunting across extended timeframes
├── Forensic analysis of past events
└── Validating detection rules against historical data

SEARCH JOB CONFIGURATION:
Sentinel → Logs → Search job mode

Parameters:
├── Table: SecurityEvent
├── Time range: Last 2 years (beyond retention)
├── Query: | where EventID == 4625 | where Account == "target-user"
├── Result table: SearchJob_SecurityEvent_20240115
└── Expiration: 30 days (results table lifetime)

EXECUTION:
1. Submit search job
2. Job runs asynchronously
3. Progress shown in portal
4. Results written to result table
5. Query result table interactively

KQL FOR SEARCH JOBS:
// Submit search job (via API or portal)
// Results appear in: SearchJob_[TableName]_[JobId]

// Query search job results
SearchJob_SecurityEvent_abc123
| summarize FailedLogins = count() by Account
| order by FailedLogins desc

LIMITATIONS:
├── Maximum 24-hour query window per job
├── Results table expires (default 30 days)
├── Additional cost per GB scanned
├── Slower than interactive queries
└── Not suitable for real-time dashboards</div>

                    <h4>Restore Archived Data</h4>
                    <div class="arch-diagram">DATA RESTORE FROM ARCHIVE
═══════════════════════════════════════════════════════════════════

RESTORE vs SEARCH JOB:
┌─────────────────────────────────────────────────────────────────┐
│        Search Job               │          Restore              │
├─────────────────────────────────┼───────────────────────────────┤
│ Query specific data             │ Restore entire time range     │
│ Results in new table            │ Data back in original table   │
│ Pay per query                   │ Pay for restored data/day     │
│ Ad-hoc investigations          │ Extended analysis period      │
│ Minutes to hours                │ Hours to start                │
└─────────────────────────────────┴───────────────────────────────┘

RESTORE PROCEDURE:
1. Sentinel → Settings → Restore
2. Select table to restore
3. Specify time range
4. Submit restore request
5. Wait for restore completion
6. Query normally during restore window
7. Data returns to archive after window

RESTORE PARAMETERS:
├── Table: Select archived table
├── Start time: Beginning of restore window
├── End time: End of restore window
├── Duration: How long to keep restored (2-30 days)
└── Cost: Calculated based on data volume

COST OPTIMIZATION:
├── Use search jobs for specific queries (cheaper)
├── Use restore for extended investigation periods
├── Minimize restore window to reduce costs
└── Consider Basic Logs for semi-frequent access needs

DECISION TREE:
├─► Need specific records/aggregations?
│   └─► Use Search Job
├─► Need to browse/explore historical data?
│   └─► Use Restore
├─► Need data for dashboard/workbook?
│   └─► Use Restore (search job results not live)
└─► Compliance audit requiring full dataset?
    └─► Use Restore for audit period</div>
                </div>

                <!-- SAP Integration -->
                <h2><i class="fas fa-industry"></i> SAP Integration</h2>
                <div class="config-section">
                    <div class="arch-diagram">MICROSOFT SENTINEL FOR SAP
═══════════════════════════════════════════════════════════════════

SAP SOLUTION OVERVIEW:
├── Certified SAP integration
├── Collects SAP security audit logs
├── Built-in analytics rules for SAP threats
├── Workbooks for SAP security monitoring
└── Detect threats across SAP landscape

ARCHITECTURE:
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│   SAP System(s) ──▶ Data Connector Agent ──▶ Sentinel          │
│   (S/4HANA, ECC)    (Container on Linux)     (Workspace)       │
│                                                                  │
│   Logs collected:                                                │
│   ├── Security Audit Log (SM21)                                 │
│   ├── Change Documents                                          │
│   ├── ABAP Syslog                                               │
│   ├── ABAP Job Log                                              │
│   ├── HANA Audit Trail                                          │
│   └── SAP NetWeaver Gateway                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

DEPLOYMENT STEPS:
1. Prerequisites:
   □ SAP system with Security Audit Log enabled
   □ SAP user with required authorizations (ABAP role)
   □ Linux VM for connector agent
   □ Network connectivity SAP → Agent → Azure

2. Deploy SAP Solution from Content Hub:
   Sentinel → Content Hub → "Microsoft Sentinel for SAP"
   └── Installs: Data connector, rules, workbooks, watchlists

3. Deploy Data Connector Agent:
   □ Create Azure Key Vault for SAP credentials
   □ Deploy Docker container on Linux VM
   □ Configure connection to SAP system(s)
   □ Verify data in SAPAuditLog table

4. Configure Analytics Rules:
   □ Enable built-in SAP rules
   □ Tune for your environment
   □ Add custom rules as needed

SAP TABLES IN SENTINEL:
├── SAPAuditLog: Security audit events
├── SAPChangeDocument: Change tracking
├── SAPSpoolLog: Print/spool events
├── SAPJobLog: Background job logs
├── SAPTableDataLog: Table data changes
└── SAPHANAAuditTrail: HANA database audit

BUILT-IN DETECTION RULES:
├── Sensitive privilege use
├── User created or changed
├── Transaction executed by unauthorized user
├── Debug activity detection
├── RFC function module execution
├── SAP HANA SQL injection attempt
├── Sensitive table access
├── Download of sensitive report
└── ... 70+ rules available</div>

                    <h4>SAP Threat Scenarios</h4>
                    <div class="arch-diagram">SAP SECURITY SCENARIOS
═══════════════════════════════════════════════════════════════════

SCENARIO 1: PRIVILEGED TRANSACTION ABUSE
Detect: User executing SAP_ALL transactions unexpectedly
Rule: SAPAuditLog
      | where TransactionCode in ("SM49", "SE38", "SU01")
      | where User !in (authorized_admin_list)

SCENARIO 2: UNAUTHORIZED DATA EXPORT
Detect: Mass download of sensitive tables (customers, financials)
Rule: SAPTableDataLog
      | where TableName in ("KNA1", "LFA1", "BSEG", "VBAK")
      | summarize Records = sum(RecordCount) by User, TableName
      | where Records > 10000

SCENARIO 3: DEBUG MODE ABUSE
Detect: User enabling debug mode (bypass authorization)
Rule: SAPAuditLog
      | where MessageClass == "DU"
      | where MessageType == "DEBUG"

SCENARIO 4: CREDENTIAL STUFFING
Detect: Multiple failed logins to SAP
Rule: SAPAuditLog
      | where Event == "AUB"  // Failed logon
      | summarize Failures = count() by ClientIP, bin(TimeGenerated, 1h)
      | where Failures > 10

SCENARIO 5: HANA INJECTION ATTEMPT
Detect: SQL injection patterns in HANA queries
Rule: SAPHANAAuditTrail
      | where Statement has_any ("--", "/*", "UNION SELECT", "1=1")

INTEGRATION WITH BROADER SOC:
├── Correlate SAP events with Azure AD (same user)
├── Link SAP alerts to endpoint activity (MDE)
├── Enrich SAP users from HR systems (watchlist)
└── Automated response (disable SAP user via playbook)</div>
                </div>

                <!-- IoT/OT Security -->
                <h2><i class="fas fa-microchip"></i> IoT/OT Security Monitoring</h2>
                <div class="config-section">
                    <div class="arch-diagram">IoT/OT SECURITY WITH SENTINEL
═══════════════════════════════════════════════════════════════════

MICROSOFT DEFENDER FOR IoT INTEGRATION:
├── Agentless monitoring of OT/ICS networks
├── Asset discovery and inventory
├── Vulnerability management
├── Threat detection for industrial protocols
└── Alerts stream to Sentinel

ARCHITECTURE:
┌─────────────────────────────────────────────────────────────────┐
│  OT Network                    │  IT Network                    │
│  ┌─────────┐                   │                                │
│  │   PLC   │──┐                │                                │
│  └─────────┘  │                │                                │
│  ┌─────────┐  │  ┌──────────┐  │  ┌──────────┐   ┌──────────┐ │
│  │  HMI    │──┼──│ Defender │──┼──│  Azure   │───│ Sentinel │ │
│  └─────────┘  │  │ for IoT  │  │  │ IoT Hub  │   │          │ │
│  ┌─────────┐  │  │ Sensor   │  │  └──────────┘   └──────────┘ │
│  │ SCADA   │──┘  └──────────┘  │                                │
│  └─────────┘                   │                                │
└─────────────────────────────────────────────────────────────────┘

DATA SOURCES:
├── SecurityAlert (IoT alerts)
├── SecurityIoTRawEvent (raw network events)
├── DeviceInfo (IoT asset inventory)
├── DeviceNetworkInfo (network connections)
└── ioTRawNetworkActivity (protocol-level data)

DEPLOYMENT OPTIONS:

OPTION 1: Cloud-connected sensor
├── Sensor connects to Azure IoT Hub
├── Full cloud management
├── Real-time alert streaming to Sentinel
└── Best for: Sites with reliable connectivity

OPTION 2: Locally-managed sensor (Air-gapped)
├── No cloud connectivity
├── On-premises management console
├── Manual alert export (via API)
└── Best for: High-security OT environments

OT-SPECIFIC THREAT DETECTION:
├── Unauthorized PLC programming
├── Firmware changes detected
├── New device on OT network
├── Protocol anomalies (Modbus, DNP3, S7)
├── Engineering workstation compromise
├── SCADA command injection
├── Unauthorized remote access
└── Lateral movement IT → OT

CORRELATION SCENARIOS:
// Correlate IT phishing with OT access
let PhishedUsers = SecurityAlert
    | where AlertName contains "phishing"
    | extend User = tostring(Entities[0].Name);
SecurityIoTRawEvent
| where EventType == "RemoteAccess"
| where SourceUserName in (PhishedUsers)
// Detect compromised user accessing OT

// Detect IT malware spreading to OT
let CompromisedHosts = SecurityAlert
    | where AlertName contains "malware"
    | extend Host = tostring(Entities[0].HostName);
DeviceNetworkInfo
| where SourceDeviceName in (CompromisedHosts)
| where DestinationDeviceType == "PLC" or DestinationDeviceType == "HMI"</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you migrate a Sentinel workspace to a different region?</button>
                        <div class="qa-answer">
                            <p><strong>Workspace migration procedure:</strong></p>
                            <ol>
                                <li><strong>Inventory:</strong> Export all content (rules, playbooks, workbooks, watchlists) via API or Repositories</li>
                                <li><strong>Create target:</strong> New workspace in target region, enable Sentinel</li>
                                <li><strong>Import content:</strong> Deploy all exported content to new workspace</li>
                                <li><strong>Reconfigure connectors:</strong> Update diagnostic settings, AMA associations, API connectors</li>
                                <li><strong>Validate:</strong> Verify data flowing, test rules, confirm playbooks working</li>
                                <li><strong>Cutover:</strong> Disable old workspace rules, redirect SOC to new workspace</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Note:</strong> Historical data and incidents cannot be migrated. Use Data Export for compliance archive if needed.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you query data that's in Archive tier?</button>
                        <div class="qa-answer">
                            <p><strong>Two options for archived data:</strong></p>
                            <ol>
                                <li><strong>Search Jobs:</strong> Query specific data asynchronously
                                    <ul>
                                        <li>Best for: Specific queries, investigations</li>
                                        <li>Results saved to new table</li>
                                        <li>Pay per GB scanned</li>
                                    </ul>
                                </li>
                                <li><strong>Restore:</strong> Temporarily restore data to Analytics tier
                                    <ul>
                                        <li>Best for: Extended analysis, browsing data</li>
                                        <li>Data available for 2-30 days</li>
                                        <li>Pay per GB restored per day</li>
                                    </ul>
                                </li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Decision:</strong> Use Search Job for targeted queries, Restore for exploration/dashboards.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between Sentinel Repositories and custom CI/CD?</button>
                        <div class="qa-answer">
                            <p><strong>Sentinel Repositories (Native):</strong></p>
                            <ul>
                                <li>Built-in Git integration</li>
                                <li>No pipeline to maintain</li>
                                <li>Limited testing capabilities</li>
                                <li>Best for: Simple deployments, small teams</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Custom CI/CD (Azure DevOps/GitHub Actions):</strong></p>
                            <ul>
                                <li>Full control over deployment process</li>
                                <li>Custom testing/validation stages</li>
                                <li>Multi-environment deployments</li>
                                <li>Best for: Large enterprises, strict change control</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you implement backup/DR for Sentinel?</button>
                        <div class="qa-answer">
                            <p><strong>Recommended backup strategy:</strong></p>
                            <ol>
                                <li><strong>Configuration backup:</strong>
                                    <ul>
                                        <li>Use Sentinel Repositories to sync all content to Git</li>
                                        <li>Git provides version history and recovery point</li>
                                    </ul>
                                </li>
                                <li><strong>Additional automation:</strong>
                                    <ul>
                                        <li>Scheduled PowerShell/Logic App export to Storage Account</li>
                                        <li>Daily backup of rules, watchlists, automation rules</li>
                                    </ul>
                                </li>
                                <li><strong>Data backup:</strong>
                                    <ul>
                                        <li>Use Data Export for long-term archive</li>
                                        <li>Configure retention policies appropriately</li>
                                    </ul>
                                </li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>DR recovery:</strong> Deploy new workspace, import from Git/backup, reconfigure connectors. RTO: 4-8 hours.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you integrate SAP with Sentinel?</button>
                        <div class="qa-answer">
                            <p><strong>SAP integration steps:</strong></p>
                            <ol>
                                <li><strong>Prerequisites:</strong> SAP Security Audit Log enabled, Linux VM for agent</li>
                                <li><strong>Deploy solution:</strong> Content Hub → "Microsoft Sentinel for SAP"</li>
                                <li><strong>Deploy agent:</strong> Docker container connecting to SAP systems</li>
                                <li><strong>Configure credentials:</strong> SAP user with audit authorization, stored in Key Vault</li>
                                <li><strong>Enable rules:</strong> 70+ built-in rules for SAP threats</li>
                            </ol>
                            <p style="margin-top: 12px;"><strong>Key detections:</strong> Privileged transaction abuse, unauthorized data export, debug mode abuse, credential attacks.</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainWrapper.classList.toggle('expanded');
            }
        }
        
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
    </script>
</body>
</html>
