<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPL Advanced | Splunk | Nik's SIEM Compendium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Splunk Platform</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                    <a href="es-overview.html" class="nav-link"><i class="fas fa-shield-alt"></i> Enterprise Security</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Data Ingestion</a>
                    <a href="forwarders.html" class="nav-link"><i class="fas fa-share"></i> Forwarders</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing & Indexing</a>
                    <a href="apps-tas.html" class="nav-link"><i class="fas fa-puzzle-piece"></i> Apps & TAs</a>
                    <a href="data-models.html" class="nav-link"><i class="fas fa-cubes"></i> Data Models (CIM)</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">SPL Query Language</div>
                    <a href="spl-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> SPL Fundamentals</a>
                    <a href="spl-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> SPL Intermediate</a>
                    <a href="spl-advanced.html" class="nav-link active"><i class="fas fa-code"></i> SPL Advanced</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">ES Detection</div>
                    <a href="correlation-searches.html" class="nav-link"><i class="fas fa-project-diagram"></i> Correlation Searches</a>
                    <a href="notable-events.html" class="nav-link"><i class="fas fa-exclamation-triangle"></i> Notable Events</a>
                    <a href="risk-based-alerting.html" class="nav-link"><i class="fas fa-chart-line"></i> Risk-Based Alerting</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-skull-crossbones"></i> Threat Intelligence</a>
                    <a href="soar.html" class="nav-link"><i class="fas fa-robot"></i> SOAR Integration</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="dashboards.html" class="nav-link"><i class="fas fa-chart-bar"></i> Dashboards</a>
                    <a href="retention-tiers.html" class="nav-link"><i class="fas fa-archive"></i> Retention & Storage</a>
                    <a href="troubleshooting.html" class="nav-link"><i class="fas fa-wrench"></i> Troubleshooting</a>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">Splunk</a><span class="separator">/</span>
                    <span class="current">SPL Advanced</span>
                </div>
            </header>
            <main class="main-content">
                <h1><i class="fas fa-code"></i> SPL Advanced Techniques</h1>
                <p class="lead">Master advanced SPL techniques for complex security analysis including subsearches, joins, transactions, macros, and performance optimization.</p>

                <!-- SUBSEARCHES -->
                <h2><i class="fas fa-search-plus"></i> Subsearches</h2>
                
                <div class="info-box">
                    <h4><i class="fas fa-lightbulb"></i> What are Subsearches?</h4>
                    <p>Subsearches are searches within searches, enclosed in square brackets <code>[ ]</code>. The inner search runs first, and its results are used to filter the outer search.</p>
                </div>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Subsearch Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Basic subsearch - Find events from users who had failed logins</span>
<span style="color: #79c0ff;">index</span>=security <span style="color: #79c0ff;">sourcetype</span>=WinEventLog:Security EventCode=4624
[<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=security EventCode=4625 earliest=-1h
 | <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> user
 | <span style="color: #f97583;">where</span> count > 5
 | <span style="color: #f97583;">fields</span> user]

<span style="color: #8b949e;">// Subsearch with return command - more efficient</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4624
[<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=security EventCode=4625 earliest=-1h
 | <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> user
 | <span style="color: #f97583;">where</span> count > 5
 | <span style="color: #f97583;">return</span> 100 user]

<span style="color: #8b949e;">// Subsearch to find IPs with failed logins, then find all activity</span>
<span style="color: #79c0ff;">index</span>=network
[<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=security EventCode=4625
 | <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> src_ip
 | <span style="color: #f97583;">where</span> count > 10
 | <span style="color: #f97583;">rename</span> src_ip <span style="color: #f97583;">as</span> src
 | <span style="color: #f97583;">fields</span> src]

<span style="color: #8b949e;">// Format subsearch for IN clause</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4624
[<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=threat_intel
 | <span style="color: #f97583;">fields</span> bad_ip
 | <span style="color: #f97583;">rename</span> bad_ip <span style="color: #f97583;">as</span> src_ip
 | <span style="color: #f97583;">format</span>]
</pre>
                </div>

                <div class="info-box" style="border-color: #d29922;">
                    <h4><i class="fas fa-exclamation-triangle" style="color: #d29922;"></i> Subsearch Limitations</h4>
                    <ul>
                        <li><strong>Time limit:</strong> 60 seconds by default</li>
                        <li><strong>Result limit:</strong> 10,000 results by default</li>
                        <li><strong>Memory:</strong> Limited memory allocation</li>
                        <li><strong>Performance:</strong> Runs before outer search completes</li>
                    </ul>
                    <p>For large datasets, consider using <code>join</code> or <code>lookup</code> instead.</p>
                </div>

                <!-- JOINS -->
                <h2><i class="fas fa-link"></i> Join Operations</h2>

                <div class="decision-tree">
                    <div class="decision-node">
                        <div class="decision-node-question">Which join type do you need?</div>
                    </div>
                    <div class="decision-paths">
                        <div class="decision-path">
                            <div class="decision-path-label yes">Match Required in Both</div>
                            <div class="decision-path-content">
                                <p style="color: #3fb950; font-weight: 600;">→ inner join (default)</p>
                                <p style="color: #8b949e; font-size: 0.85rem;">Only returns rows where key exists in both datasets.</p>
                            </div>
                        </div>
                        <div class="decision-path">
                            <div class="decision-path-label no">Keep All from Left</div>
                            <div class="decision-path-content">
                                <p style="color: #d29922; font-weight: 600;">→ left join</p>
                                <p style="color: #8b949e; font-size: 0.85rem;">Keep all rows from left, match from right where possible.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Join Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Inner join - combine security events with asset info</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">as</span> FailedLogins <span style="color: #f97583;">by</span> dest
| <span style="color: #f97583;">join</span> type=inner dest
    [<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=assets
     | <span style="color: #f97583;">table</span> dest, owner, criticality, department]
| <span style="color: #f97583;">table</span> dest, FailedLogins, owner, criticality, department

<span style="color: #8b949e;">// Left join - keep all events, enrich where possible</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4624
| <span style="color: #f97583;">join</span> type=left user
    [<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=identity
     | <span style="color: #f97583;">table</span> user, department, manager, vip_status]
| <span style="color: #f97583;">fillnull</span> value=<span style="color: #a5d6ff;">"Unknown"</span> department

<span style="color: #8b949e;">// Outer join - all records from both sides</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> src_ip
| <span style="color: #f97583;">join</span> type=outer src_ip
    [<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=threat_intel
     | <span style="color: #f97583;">table</span> src_ip, threat_category, confidence]

<span style="color: #8b949e;">// Join with max results</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #f97583;">join</span> type=inner max=0 src_ip
    [<span style="color: #f97583;">search</span> <span style="color: #79c0ff;">index</span>=network
     | <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">sum</span>(bytes) <span style="color: #f97583;">as</span> total_bytes <span style="color: #f97583;">by</span> src_ip]
</pre>
                </div>

                <div class="styled-table">
                    <table>
                        <thead>
                            <tr><th>Join Type</th><th>Description</th><th>Use Case</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>inner</strong></td><td>Only matching rows</td><td>Correlate events that must exist in both</td></tr>
                            <tr><td><strong>left</strong></td><td>All left + matching right</td><td>Enrich events with optional context</td></tr>
                            <tr><td><strong>outer</strong></td><td>All rows from both sides</td><td>Full picture of both datasets</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- LOOKUPS -->
                <h2><i class="fas fa-book"></i> Lookups</h2>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Lookup Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Basic lookup - enrich with static data</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #f97583;">lookup</span> user_info.csv user <span style="color: #f97583;">OUTPUT</span> department, manager, vip_status
| <span style="color: #f97583;">table</span> _time, user, src_ip, department, manager, vip_status

<span style="color: #8b949e;">// Lookup with case-insensitive matching</span>
<span style="color: #79c0ff;">index</span>=security
| <span style="color: #f97583;">lookup</span> case(false) user_info.csv user <span style="color: #f97583;">OUTPUT</span> department

<span style="color: #8b949e;">// Lookup for threat intelligence</span>
<span style="color: #79c0ff;">index</span>=network
| <span style="color: #f97583;">lookup</span> threat_ips.csv src_ip <span style="color: #f97583;">OUTPUTNEW</span> threat_category, confidence
| <span style="color: #f97583;">where</span> <span style="color: #79c0ff;">isnotnull</span>(threat_category)
| <span style="color: #f97583;">table</span> _time, src_ip, dest_ip, threat_category, confidence

<span style="color: #8b949e;">// Automatic lookup (defined in transforms.conf)</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
<span style="color: #8b949e;">// asset_lookup automatically adds asset_criticality field</span>
| <span style="color: #f97583;">table</span> _time, user, dest, asset_criticality

<span style="color: #8b949e;">// Input lookup - use lookup as data source</span>
| <span style="color: #f97583;">inputlookup</span> threat_ips.csv
| <span style="color: #f97583;">where</span> confidence > 80
| <span style="color: #f97583;">table</span> src_ip, threat_category

<span style="color: #8b949e;">// Output lookup - save results to lookup file</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> src_ip
| <span style="color: #f97583;">where</span> count > 100
| <span style="color: #f97583;">outputlookup</span> suspicious_ips.csv
</pre>
                </div>

                <!-- TRANSACTIONS -->
                <h2><i class="fas fa-exchange-alt"></i> Transactions</h2>

                <div class="info-box">
                    <h4><i class="fas fa-lightbulb"></i> When to Use Transaction</h4>
                    <p>Use <code>transaction</code> when you need to:</p>
                    <ul>
                        <li>Group events that share a common field value</li>
                        <li>Track session start/end events</li>
                        <li>Calculate duration between related events</li>
                        <li>Identify event sequences</li>
                    </ul>
                </div>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Transaction Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Basic transaction - group by session ID</span>
<span style="color: #79c0ff;">index</span>=web
| <span style="color: #f97583;">transaction</span> session_id
| <span style="color: #f97583;">table</span> session_id, duration, eventcount

<span style="color: #8b949e;">// Transaction with start/end conditions</span>
<span style="color: #79c0ff;">index</span>=security <span style="color: #79c0ff;">sourcetype</span>=WinEventLog:Security
| <span style="color: #f97583;">transaction</span> user startswith=<span style="color: #a5d6ff;">"EventCode=4624"</span> endswith=<span style="color: #a5d6ff;">"EventCode=4634"</span>
| <span style="color: #f97583;">eval</span> session_duration_minutes = duration / 60
| <span style="color: #f97583;">table</span> user, Computer, session_duration_minutes, eventcount

<span style="color: #8b949e;">// Transaction with max span (timeout)</span>
<span style="color: #79c0ff;">index</span>=security EventCode <span style="color: #f97583;">IN</span> (4624, 4625)
| <span style="color: #f97583;">transaction</span> user maxspan=30m maxpause=5m
| <span style="color: #f97583;">search</span> eventcount > 10
| <span style="color: #f97583;">table</span> user, eventcount, duration

<span style="color: #8b949e;">// Transaction for attack chain detection</span>
<span style="color: #79c0ff;">index</span>=security
| <span style="color: #f97583;">transaction</span> Computer maxspan=1h
    startswith=(<span style="color: #a5d6ff;">"EventCode=4625"</span>)
    endswith=(<span style="color: #a5d6ff;">"EventCode=4672"</span>)
| <span style="color: #f97583;">where</span> eventcount > 1
| <span style="color: #f97583;">eval</span> attack_chain = <span style="color: #79c0ff;">if</span>(<span style="color: #79c0ff;">match</span>(_raw, <span style="color: #a5d6ff;">"4625.*4624.*4672"</span>), <span style="color: #a5d6ff;">"Brute Force -> Priv Esc"</span>, <span style="color: #a5d6ff;">"Unknown"</span>)
| <span style="color: #f97583;">table</span> Computer, user, attack_chain, duration, eventcount

<span style="color: #8b949e;">// Transaction with multiple fields</span>
<span style="color: #79c0ff;">index</span>=network
| <span style="color: #f97583;">transaction</span> src_ip, dest_ip maxspan=10m
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">sum</span>(bytes) <span style="color: #f97583;">as</span> total_bytes, <span style="color: #79c0ff;">avg</span>(duration) <span style="color: #f97583;">as</span> avg_session
  <span style="color: #f97583;">by</span> src_ip, dest_ip
</pre>
                </div>

                <div class="info-box" style="border-color: #d29922;">
                    <h4><i class="fas fa-exclamation-triangle" style="color: #d29922;"></i> Transaction Performance Warning</h4>
                    <p><code>transaction</code> is memory-intensive. For better performance:</p>
                    <ul>
                        <li>Use <code>stats</code> with <code>earliest()</code> and <code>latest()</code> when possible</li>
                        <li>Always specify <code>maxspan</code> and <code>maxpause</code></li>
                        <li>Filter data before using transaction</li>
                    </ul>
                </div>

                <!-- TSTATS -->
                <h2><i class="fas fa-tachometer-alt"></i> tstats - Accelerated Data Model Queries</h2>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> tstats Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Basic tstats - count authentication events</span>
| <span style="color: #f97583;">tstats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">from</span> datamodel=Authentication
  <span style="color: #f97583;">where</span> Authentication.action=failure
  <span style="color: #f97583;">by</span> Authentication.src, Authentication.user

<span style="color: #8b949e;">// tstats with time binning</span>
| <span style="color: #f97583;">tstats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">from</span> datamodel=Authentication
  <span style="color: #f97583;">where</span> Authentication.action=failure
  <span style="color: #f97583;">by</span> _time, Authentication.src
  span=1h

<span style="color: #8b949e;">// tstats with prestats for chart</span>
| <span style="color: #f97583;">tstats</span> prestats=t <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">from</span> datamodel=Authentication
  <span style="color: #f97583;">by</span> _time, Authentication.action
  span=1d
| <span style="color: #f97583;">timechart</span> span=1d <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> Authentication.action

<span style="color: #8b949e;">// tstats on Network Traffic model</span>
| <span style="color: #f97583;">tstats</span> <span style="color: #79c0ff;">sum</span>(All_Traffic.bytes) <span style="color: #f97583;">as</span> total_bytes
  <span style="color: #f97583;">from</span> datamodel=Network_Traffic.All_Traffic
  <span style="color: #f97583;">where</span> All_Traffic.dest_port=443
  <span style="color: #f97583;">by</span> All_Traffic.src, All_Traffic.dest

<span style="color: #8b949e;">// tstats on Endpoint model</span>
| <span style="color: #f97583;">tstats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">from</span> datamodel=Endpoint.Processes
  <span style="color: #f97583;">where</span> Processes.process_name=<span style="color: #a5d6ff;">"powershell.exe"</span>
  <span style="color: #f97583;">by</span> Processes.dest, Processes.user, Processes.parent_process_name

<span style="color: #8b949e;">// Converting tstats results (rename fields)</span>
| <span style="color: #f97583;">tstats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">from</span> datamodel=Authentication
  <span style="color: #f97583;">where</span> Authentication.action=failure
  <span style="color: #f97583;">by</span> Authentication.src, Authentication.user
| <span style="color: #f97583;">rename</span> Authentication.* <span style="color: #f97583;">as</span> *
| <span style="color: #f97583;">where</span> count > 10
</pre>
                </div>

                <div class="comparison-grid">
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <div class="comparison-item-icon" style="background: #1a4d2e; color: #3fb950;"><i class="fas fa-check"></i></div>
                            <div class="comparison-item-title">tstats Advantages</div>
                        </div>
                        <ul class="comparison-item-list">
                            <li><i class="fas fa-bolt"></i> 10-100x faster than raw search</li>
                            <li><i class="fas fa-bolt"></i> Uses pre-computed summaries</li>
                            <li><i class="fas fa-bolt"></i> Great for dashboards</li>
                            <li><i class="fas fa-bolt"></i> Works on indexed fields</li>
                        </ul>
                    </div>
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <div class="comparison-item-icon" style="background: #4d1a1a; color: #f85149;"><i class="fas fa-times"></i></div>
                            <div class="comparison-item-title">tstats Limitations</div>
                        </div>
                        <ul class="comparison-item-list">
                            <li><i class="fas fa-times"></i> Requires accelerated data models</li>
                            <li><i class="fas fa-times"></i> Only indexed/accelerated fields</li>
                            <li><i class="fas fa-times"></i> Limited aggregation functions</li>
                            <li><i class="fas fa-times"></i> Cannot access raw events</li>
                        </ul>
                    </div>
                </div>

                <!-- MACROS -->
                <h2><i class="fas fa-code-branch"></i> Search Macros</h2>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Macro Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Using a macro (backticks)</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4625
| <span style="color: #79c0ff;">`drop_dm_object_name("Authentication")`</span>
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> src, user

<span style="color: #8b949e;">// Macro with arguments</span>
<span style="color: #79c0ff;">`security_events(4625)`</span>
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">by</span> src_ip

<span style="color: #8b949e;">// Common ES macros</span>
<span style="color: #79c0ff;">`notable`</span>                          <span style="color: #8b949e;">// Notable events index</span>
<span style="color: #79c0ff;">`risk_index`</span>                       <span style="color: #8b949e;">// Risk events index</span>
<span style="color: #79c0ff;">`datamodel("Authentication", "Authentication")`</span>
<span style="color: #79c0ff;">`cim_Network_Traffic_indexes`</span>      <span style="color: #8b949e;">// Network traffic indexes</span>

<span style="color: #8b949e;">// Creating macro in macros.conf:</span>
<span style="color: #8b949e;">// [security_events(1)]</span>
<span style="color: #8b949e;">// args = eventcode</span>
<span style="color: #8b949e;">// definition = index=security sourcetype=WinEventLog:Security EventCode=$eventcode$</span>

<span style="color: #8b949e;">// [failed_logins]</span>
<span style="color: #8b949e;">// definition = index=security EventCode=4625</span>
</pre>
                </div>

                <!-- EVAL FUNCTIONS -->
                <h2><i class="fas fa-calculator"></i> Advanced eval Functions</h2>

                <div class="code-block">
                    <div class="code-header"><i class="fas fa-code"></i> Advanced eval Examples</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Coalesce - first non-null value</span>
| <span style="color: #f97583;">eval</span> user = <span style="color: #79c0ff;">coalesce</span>(user, Account_Name, src_user, <span style="color: #a5d6ff;">"Unknown"</span>)

<span style="color: #8b949e;">// Null handling</span>
| <span style="color: #f97583;">eval</span> has_user = <span style="color: #79c0ff;">if</span>(<span style="color: #79c0ff;">isnull</span>(user), <span style="color: #a5d6ff;">"No"</span>, <span style="color: #a5d6ff;">"Yes"</span>)
| <span style="color: #f97583;">eval</span> user = <span style="color: #79c0ff;">if</span>(<span style="color: #79c0ff;">isnotnull</span>(user), user, <span style="color: #a5d6ff;">"N/A"</span>)

<span style="color: #8b949e;">// Multi-value field operations</span>
| <span style="color: #f97583;">eval</span> domain = <span style="color: #79c0ff;">mvindex</span>(<span style="color: #79c0ff;">split</span>(user, <span style="color: #a5d6ff;">"\\"</span>), 0)
| <span style="color: #f97583;">eval</span> username = <span style="color: #79c0ff;">mvindex</span>(<span style="color: #79c0ff;">split</span>(user, <span style="color: #a5d6ff;">"\\"</span>), 1)
| <span style="color: #f97583;">eval</span> ip_count = <span style="color: #79c0ff;">mvcount</span>(ip_list)
| <span style="color: #f97583;">eval</span> all_ips = <span style="color: #79c0ff;">mvjoin</span>(ip_list, <span style="color: #a5d6ff;">", "</span>)

<span style="color: #8b949e;">// JSON parsing</span>
| <span style="color: #f97583;">eval</span> json_data = <span style="color: #79c0ff;">spath</span>(_raw, <span style="color: #a5d6ff;">"user.name"</span>)
| <span style="color: #f97583;">eval</span> all_fields = <span style="color: #79c0ff;">json_extract</span>(_raw, <span style="color: #a5d6ff;">"$.data"</span>)

<span style="color: #8b949e;">// CIDR matching</span>
| <span style="color: #f97583;">eval</span> is_internal = <span style="color: #79c0ff;">if</span>(<span style="color: #79c0ff;">cidrmatch</span>(<span style="color: #a5d6ff;">"10.0.0.0/8"</span>, src_ip) OR <span style="color: #79c0ff;">cidrmatch</span>(<span style="color: #a5d6ff;">"172.16.0.0/12"</span>, src_ip), <span style="color: #a5d6ff;">"Yes"</span>, <span style="color: #a5d6ff;">"No"</span>)

<span style="color: #8b949e;">// Time calculations</span>
| <span style="color: #f97583;">eval</span> hour = <span style="color: #79c0ff;">strftime</span>(_time, <span style="color: #a5d6ff;">"%H"</span>)
| <span style="color: #f97583;">eval</span> day_of_week = <span style="color: #79c0ff;">strftime</span>(_time, <span style="color: #a5d6ff;">"%A"</span>)
| <span style="color: #f97583;">eval</span> is_business_hours = <span style="color: #79c0ff;">if</span>(hour >= 9 AND hour < 17 AND <span style="color: #79c0ff;">NOT match</span>(day_of_week, <span style="color: #a5d6ff;">"Saturday|Sunday"</span>), <span style="color: #a5d6ff;">"Yes"</span>, <span style="color: #a5d6ff;">"No"</span>)
| <span style="color: #f97583;">eval</span> epoch = <span style="color: #79c0ff;">strptime</span>(date_field, <span style="color: #a5d6ff;">"%Y-%m-%d %H:%M:%S"</span>)

<span style="color: #8b949e;">// Regex operations</span>
| <span style="color: #f97583;">eval</span> is_admin = <span style="color: #79c0ff;">if</span>(<span style="color: #79c0ff;">match</span>(user, <span style="color: #a5d6ff;">"(?i)admin|root|system"</span>), 1, 0)
| <span style="color: #f97583;">rex</span> field=_raw <span style="color: #a5d6ff;">"user=(?<extracted_user>\w+)"</span>

<span style="color: #8b949e;">// Mathematical functions</span>
| <span style="color: #f97583;">eval</span> log_bytes = <span style="color: #79c0ff;">log</span>(bytes, 10)
| <span style="color: #f97583;">eval</span> rounded = <span style="color: #79c0ff;">round</span>(percentage, 2)
| <span style="color: #f97583;">eval</span> absolute = <span style="color: #79c0ff;">abs</span>(value)

<span style="color: #8b949e;">// Type conversion</span>
| <span style="color: #f97583;">eval</span> numeric_value = <span style="color: #79c0ff;">tonumber</span>(string_value)
| <span style="color: #f97583;">eval</span> string_value = <span style="color: #79c0ff;">tostring</span>(numeric_value, <span style="color: #a5d6ff;">"commas"</span>)
</pre>
                </div>

                <!-- SECURITY USE CASES -->
                <h2><i class="fas fa-shield-alt"></i> Advanced Security Use Cases</h2>

                <h3>Use Case 1: Attack Chain Detection</h3>
                <div class="code-block">
                    <div class="code-header"><i class="fas fa-link"></i> Multi-Stage Attack Detection</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Detect: Failed Logins -> Success -> Privilege Escalation</span>
<span style="color: #79c0ff;">index</span>=security <span style="color: #79c0ff;">sourcetype</span>=WinEventLog:Security
    EventCode <span style="color: #f97583;">IN</span> (4625, 4624, 4672, 4673)
| <span style="color: #f97583;">eval</span> event_type = <span style="color: #79c0ff;">case</span>(
    EventCode==4625, <span style="color: #a5d6ff;">"1_FailedLogin"</span>,
    EventCode==4624, <span style="color: #a5d6ff;">"2_SuccessLogin"</span>,
    EventCode==4672, <span style="color: #a5d6ff;">"3_SpecialPriv"</span>,
    EventCode==4673, <span style="color: #a5d6ff;">"4_PrivilegeUse"</span>
)
| <span style="color: #f97583;">transaction</span> Computer, Account_Name maxspan=1h
| <span style="color: #f97583;">where</span> eventcount >= 3
| <span style="color: #f97583;">search</span> <span style="color: #a5d6ff;">"1_FailedLogin"</span> AND <span style="color: #a5d6ff;">"2_SuccessLogin"</span> AND (<span style="color: #a5d6ff;">"3_SpecialPriv"</span> OR <span style="color: #a5d6ff;">"4_PrivilegeUse"</span>)
| <span style="color: #f97583;">eval</span> attack_chain = <span style="color: #a5d6ff;">"Brute Force -> Compromise -> Privilege Escalation"</span>
| <span style="color: #f97583;">table</span> Computer, Account_Name, attack_chain, duration, eventcount
| <span style="color: #f97583;">sort</span> - eventcount
</pre>
                </div>

                <h3>Use Case 2: Lateral Movement Detection</h3>
                <div class="code-block">
                    <div class="code-header"><i class="fas fa-network-wired"></i> Lateral Movement Patterns</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Detect users logging into multiple systems in short time</span>
<span style="color: #79c0ff;">index</span>=security EventCode=4624 Logon_Type <span style="color: #f97583;">IN</span> (3, 10)
| <span style="color: #f97583;">bucket</span> _time span=30m
| <span style="color: #f97583;">stats</span> 
    dc(Computer) <span style="color: #f97583;">as</span> unique_hosts,
    values(Computer) <span style="color: #f97583;">as</span> hosts_accessed,
    earliest(_time) <span style="color: #f97583;">as</span> first_login,
    latest(_time) <span style="color: #f97583;">as</span> last_login
  <span style="color: #f97583;">by</span> Account_Name, _time, Source_Network_Address
| <span style="color: #f97583;">where</span> unique_hosts > 5
| <span style="color: #f97583;">eval</span> risk_score = unique_hosts * 10
| <span style="color: #f97583;">eval</span> risk_level = <span style="color: #79c0ff;">case</span>(
    unique_hosts >= 20, <span style="color: #a5d6ff;">"Critical"</span>,
    unique_hosts >= 10, <span style="color: #a5d6ff;">"High"</span>,
    unique_hosts >= 5, <span style="color: #a5d6ff;">"Medium"</span>,
    <span style="color: #79c0ff;">true</span>(), <span style="color: #a5d6ff;">"Low"</span>
)
| <span style="color: #f97583;">table</span> Account_Name, Source_Network_Address, unique_hosts, 
       hosts_accessed, risk_level, risk_score
| <span style="color: #f97583;">sort</span> - unique_hosts
</pre>
                </div>

                <h3>Use Case 3: DNS Exfiltration Detection</h3>
                <div class="code-block">
                    <div class="code-header"><i class="fas fa-globe"></i> DNS Tunneling Detection</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Detect DNS tunneling via unusual query patterns</span>
<span style="color: #79c0ff;">index</span>=dns
| <span style="color: #f97583;">eval</span> query_length = <span style="color: #79c0ff;">len</span>(query)
| <span style="color: #f97583;">eval</span> subdomain_count = <span style="color: #79c0ff;">mvcount</span>(<span style="color: #79c0ff;">split</span>(query, <span style="color: #a5d6ff;">"."</span>))
| <span style="color: #f97583;">eval</span> entropy = <span style="color: #79c0ff;">mvcount</span>(<span style="color: #79c0ff;">split</span>(query, <span style="color: #a5d6ff;">""</span>)) / query_length
| <span style="color: #f97583;">stats</span> 
    <span style="color: #79c0ff;">count</span> <span style="color: #f97583;">as</span> query_count,
    <span style="color: #79c0ff;">avg</span>(query_length) <span style="color: #f97583;">as</span> avg_query_length,
    <span style="color: #79c0ff;">max</span>(query_length) <span style="color: #f97583;">as</span> max_query_length,
    dc(query) <span style="color: #f97583;">as</span> unique_queries,
    values(query) <span style="color: #f97583;">as</span> sample_queries
  <span style="color: #f97583;">by</span> src_ip, query_type
| <span style="color: #f97583;">where</span> avg_query_length > 50 OR query_count > 1000
| <span style="color: #f97583;">eval</span> suspicion_score = (avg_query_length / 10) + (query_count / 100)
| <span style="color: #f97583;">eval</span> is_suspicious = <span style="color: #79c0ff;">if</span>(suspicion_score > 20, <span style="color: #a5d6ff;">"Yes"</span>, <span style="color: #a5d6ff;">"No"</span>)
| <span style="color: #f97583;">where</span> is_suspicious = <span style="color: #a5d6ff;">"Yes"</span>
| <span style="color: #f97583;">table</span> src_ip, query_count, avg_query_length, unique_queries, 
       sample_queries, suspicion_score
</pre>
                </div>

                <h3>Use Case 4: Anomaly Detection with Stats</h3>
                <div class="code-block">
                    <div class="code-header"><i class="fas fa-chart-line"></i> Statistical Anomaly Detection</div>
<pre style="color: #f0f6fc; background: #0d1117; padding: 16px; border-radius: 8px; overflow-x: auto;">
<span style="color: #8b949e;">// Detect users with unusual data transfer volumes</span>
<span style="color: #79c0ff;">index</span>=network
| <span style="color: #f97583;">stats</span> <span style="color: #79c0ff;">sum</span>(bytes_out) <span style="color: #f97583;">as</span> total_bytes <span style="color: #f97583;">by</span> user
| <span style="color: #f97583;">eventstats</span> 
    <span style="color: #79c0ff;">avg</span>(total_bytes) <span style="color: #f97583;">as</span> avg_bytes,
    <span style="color: #79c0ff;">stdev</span>(total_bytes) <span style="color: #f97583;">as</span> stdev_bytes
| <span style="color: #f97583;">eval</span> z_score = (total_bytes - avg_bytes) / stdev_bytes
| <span style="color: #f97583;">eval</span> is_anomaly = <span style="color: #79c0ff;">if</span>(z_score > 3, <span style="color: #a5d6ff;">"Yes"</span>, <span style="color: #a5d6ff;">"No"</span>)
| <span style="color: #f97583;">where</span> is_anomaly = <span style="color: #a5d6ff;">"Yes"</span>
| <span style="color: #f97583;">eval</span> total_GB = <span style="color: #79c0ff;">round</span>(total_bytes / 1073741824, 2)
| <span style="color: #f97583;">eval</span> deviation = <span style="color: #79c0ff;">round</span>(z_score, 2) . <span style="color: #a5d6ff;">" standard deviations above mean"</span>
| <span style="color: #f97583;">table</span> user, total_GB, z_score, deviation
| <span style="color: #f97583;">sort</span> - z_score
</pre>
                </div>

                <!-- PERFORMANCE OPTIMIZATION -->
                <h2><i class="fas fa-tachometer-alt"></i> Performance Optimization</h2>
                
                <div class="comparison-grid">
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <div class="comparison-item-icon" style="background: #1a4d2e; color: #3fb950;"><i class="fas fa-check"></i></div>
                            <div class="comparison-item-title">Do This</div>
                        </div>
                        <ul class="comparison-item-list">
                            <li><i class="fas fa-check"></i> Specify index and sourcetype</li>
                            <li><i class="fas fa-check"></i> Use time range early</li>
                            <li><i class="fas fa-check"></i> Filter before stats/join</li>
                            <li><i class="fas fa-check"></i> Use tstats for data models</li>
                            <li><i class="fas fa-check"></i> Limit fields with | fields</li>
                            <li><i class="fas fa-check"></i> Use indexed fields in filters</li>
                        </ul>
                    </div>
                    <div class="comparison-item">
                        <div class="comparison-item-header">
                            <div class="comparison-item-icon" style="background: #4d1a1a; color: #f85149;"><i class="fas fa-times"></i></div>
                            <div class="comparison-item-title">Avoid This</div>
                        </div>
                        <ul class="comparison-item-list">
                            <li><i class="fas fa-times"></i> index=* searches</li>
                            <li><i class="fas fa-times"></i> Leading wildcards (*value)</li>
                            <li><i class="fas fa-times"></i> Large transactions without limits</li>
                            <li><i class="fas fa-times"></i> Unnecessary subsearches</li>
                            <li><i class="fas fa-times"></i> Multiple regex on same field</li>
                            <li><i class="fas fa-times"></i> Searching all time</li>
                        </ul>
                    </div>
                </div>

                <!-- ENTERPRISE EXAMPLE -->
                <div class="enterprise-example">
                    <div class="enterprise-example-header">
                        <i class="fas fa-building"></i>
                        <div class="enterprise-example-title">Enterprise Example: Advanced Threat Detection Dashboard</div>
                    </div>
                    <div class="enterprise-example-scenario">
                        <strong>Scenario:</strong> Building a real-time threat detection dashboard processing 500GB/day across 20,000 endpoints.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                        <div style="background: #0d1117; border-radius: 8px; padding: 16px;">
                            <h4 style="color: #3fb950; margin-top: 0;">Optimized Query Pattern</h4>
<pre style="color: #8b949e; font-size: 0.85rem; margin: 0;">
| tstats count from datamodel=Authentication
  where Authentication.action=failure
  by Authentication.src, Authentication.user
| rename Authentication.* as *
| where count > threshold
| lookup user_info.csv user OUTPUT department
| eval risk = count * 10</pre>
                        </div>
                        <div style="background: #0d1117; border-radius: 8px; padding: 16px;">
                            <h4 style="color: #58a6ff; margin-top: 0;">Performance Results</h4>
                            <p style="color: #8b949e; font-size: 0.85rem;">
                                <strong>Query Time:</strong> 2-5 seconds<br>
                                <strong>Data Scanned:</strong> Accelerated summaries only<br>
                                <strong>Refresh:</strong> Every 5 minutes<br>
                                <strong>Memory:</strong> Minimal with tstats
                            </p>
                        </div>
                    </div>
                </div>

                <!-- INTERVIEW QUESTIONS -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question">Q: When would you use join vs subsearch vs lookup?</button>
                        <div class="qa-answer">
                            <p><strong>Subsearch:</strong></p>
                            <ul>
                                <li>Quick filtering based on another search</li>
                                <li>Small result sets (&lt;10,000 results)</li>
                                <li>Simple OR conditions</li>
                            </ul>
                            <p><strong>Join:</strong></p>
                            <ul>
                                <li>Combining two datasets on common key</li>
                                <li>Need multiple fields from second dataset</li>
                                <li>More control over join type (inner/left/outer)</li>
                            </ul>
                            <p><strong>Lookup:</strong></p>
                            <ul>
                                <li>Enriching with static/reference data</li>
                                <li>Fastest option for small files</li>
                                <li>Can be automatic (auto-lookup)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question">Q: How do you optimize a slow Splunk search?</button>
                        <div class="qa-answer">
                            <p><strong>Step-by-step optimization:</strong></p>
                            <ol>
                                <li><strong>Check the Job Inspector:</strong> Identify slow components</li>
                                <li><strong>Add index/sourcetype:</strong> Always specify these</li>
                                <li><strong>Reduce time range:</strong> Smallest range needed</li>
                                <li><strong>Move filters early:</strong> WHERE before STATS</li>
                                <li><strong>Use tstats:</strong> If using data models</li>
                                <li><strong>Avoid wildcards:</strong> Especially leading wildcards</li>
                                <li><strong>Limit fields:</strong> Use | fields to reduce data</li>
                                <li><strong>Consider summary indexing:</strong> For repeated queries</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question">Q: Explain the difference between stats and eventstats</button>
                        <div class="qa-answer">
                            <p><strong>stats:</strong></p>
                            <ul>
                                <li>Aggregates and collapses rows</li>
                                <li>Output is one row per group</li>
                                <li>Removes original events</li>
                            </ul>
                            <p><strong>eventstats:</strong></p>
                            <ul>
                                <li>Adds aggregation as new field</li>
                                <li>Keeps all original events</li>
                                <li>Useful for comparing events to averages</li>
                            </ul>
                            <p><strong>Example:</strong></p>
                            <pre style="background: #0d1117; padding: 8px; border-radius: 4px; color: #f0f6fc;">// Add user's total to each event
| eventstats sum(bytes) as user_total by user
| eval percent_of_total = (bytes / user_total) * 100</pre>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question">Q: What are data models and why are they important for ES?</button>
                        <div class="qa-answer">
                            <p><strong>Data Models:</strong></p>
                            <ul>
                                <li>Normalized schemas for different data types</li>
                                <li>CIM (Common Information Model) standard</li>
                                <li>Enable vendor-agnostic searches</li>
                            </ul>
                            <p><strong>Importance for ES:</strong></p>
                            <ul>
                                <li>Correlation searches use data models</li>
                                <li>Accelerated for fast dashboards</li>
                                <li>OOTB content depends on proper mapping</li>
                                <li>tstats only works on accelerated models</li>
                            </ul>
                            <p><strong>Key Data Models:</strong> Authentication, Network_Traffic, Endpoint, Malware, Web</p>
                        </div>
                    </div>
                </div>

            </main>
            <footer class="main-footer">
                <div class="footer-content">
                    <p>Nik's SIEM Compendium</p>
                </div>
            </footer>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) {
                    answer.style.display = 'block';
                    btn.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
<!-- Additional content was truncated - file already created -->
