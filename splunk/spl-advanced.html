<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="splunk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPL Advanced | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>

            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk active"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Pipeline</div>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Data Ingestion</a>
                    <a href="forwarders.html" class="nav-link"><i class="fas fa-share"></i> Forwarders Deep Dive</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                    <a href="data-models.html" class="nav-link"><i class="fas fa-cubes"></i> Data Models & CIM</a>
                    <a href="retention-tiers.html" class="nav-link"><i class="fas fa-archive"></i> Retention & Buckets</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">SPL Query Language</div>
                    <a href="spl-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> SPL Fundamentals</a>
                    <a href="spl-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> SPL Intermediate</a>
                    <a href="spl-advanced.html" class="nav-link active"><i class="fas fa-code"></i> Advanced SPL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Enterprise Security</div>
                    <a href="es-overview.html" class="nav-link"><i class="fas fa-shield-alt"></i> ES Overview</a>
                    <a href="correlation-searches.html" class="nav-link"><i class="fas fa-search-plus"></i> Correlation Searches</a>
                    <a href="notable-events.html" class="nav-link"><i class="fas fa-exclamation-triangle"></i> Notable Events</a>
                    <a href="risk-based-alerting.html" class="nav-link"><i class="fas fa-chart-line"></i> Risk-Based Alerting</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">TI & Automation</div>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                    <a href="soar.html" class="nav-link"><i class="fas fa-robot"></i> Splunk SOAR</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="dashboards.html" class="nav-link"><i class="fas fa-chart-bar"></i> Dashboards</a>
                    <a href="apps-tas.html" class="nav-link"><i class="fas fa-puzzle-piece"></i> Apps & TAs</a>
                    <a href="troubleshooting.html" class="nav-link"><i class="fas fa-wrench"></i> Troubleshooting</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Splunk</a>
                    <span class="separator">/</span>
                    <span class="current">SPL Advanced</span>
                </div>
                <div class="top-actions">
                    <button class="top-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <main class="main-content">
                <section class="content-section">


                <h2>Statistical Analysis Commands</h2>

                <h3>eventstats - Add Statistics Without Grouping</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Unlike stats, eventstats keeps all events and adds calculated fields</span>

<span style="color: #6aa3f7;">// Add total to each event for percentage calculation</span>
index=firewall
| eventstats count as total_events
| stats count as action_count by action
| eval percentage = round((action_count/total_events)*100, 2)

<span style="color: #6aa3f7;">// Add user's typical login count per event</span>
index=windows EventCode=4624
| eventstats avg(eval(1)) as avg_logins by TargetUserName
| eventstats count as user_logins by TargetUserName
| where user_logins > (avg_logins * 3)  <span style="color: #6aa3f7;">// 3x above average</span>

<span style="color: #6aa3f7;">// Security: Find outliers from normal behavior</span>
index=proxy
| stats sum(bytes) as user_bytes by user
| eventstats avg(user_bytes) as avg_bytes, stdev(user_bytes) as stdev_bytes
| eval zscore = (user_bytes - avg_bytes) / stdev_bytes
| where zscore > 3  <span style="color: #6aa3f7;">// More than 3 standard deviations</span></pre>
                </div>

                <h3>streamstats - Running Statistics</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Running count (accumulating)</span>
index=firewall
| sort _time
| streamstats count as running_count

<span style="color: #6aa3f7;">// Window-based stats (last N events)</span>
index=firewall action=blocked
| sort _time
| streamstats count as last_5min_blocks window=300 time_window=5m

<span style="color: #6aa3f7;">// Security: Detect rapid succession of events</span>
index=windows EventCode=4625
| sort _time
| streamstats count as attempts window=5 by TargetUserName
| where attempts >= 5  <span style="color: #6aa3f7;">// 5 failures in quick succession</span>

<span style="color: #6aa3f7;">// Running average for anomaly detection</span>
index=firewall
| timechart span=5m count as events
| streamstats avg(events) as running_avg window=12  <span style="color: #6aa3f7;">// Last hour</span>
| eval deviation = events / running_avg
| where deviation > 3</pre>
                </div>

                <h3>anomalydetection - Built-in ML</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Detect anomalies using machine learning</span>
index=firewall
| timechart span=1h count as events
| anomalydetection events

<span style="color: #6aa3f7;">// Returns: isAnomaly (0/1), anomalyScore, expectedValue, etc.</span>

<span style="color: #6aa3f7;">// Filter to only anomalies</span>
| where isAnomaly=1

<span style="color: #6aa3f7;">// Multivariate anomaly detection</span>
index=firewall
| timechart span=1h count as connections, sum(bytes) as total_bytes
| anomalydetection connections total_bytes</pre>
                </div>

                <h2>Multi-Value Field Operations</h2>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Create multi-value field</span>
| makemv delim="," src_ips

<span style="color: #6aa3f7;">// Expand multi-value to separate events</span>
| mvexpand src_ips

<span style="color: #6aa3f7;">// Combine values into multi-value</span>
| stats values(src_ip) as all_sources by user

<span style="color: #6aa3f7;">// Count multi-value items</span>
| eval ip_count = mvcount(all_sources)

<span style="color: #6aa3f7;">// Get specific index</span>
| eval first_ip = mvindex(all_sources, 0)
| eval last_ip = mvindex(all_sources, -1)

<span style="color: #6aa3f7;">// Filter multi-value</span>
| eval internal_ips = mvfilter(cidrmatch("10.0.0.0/8", all_sources))

<span style="color: #6aa3f7;">// Sort multi-value</span>
| eval sorted_ips = mvsort(all_sources)

<span style="color: #6aa3f7;">// Security: Find users with multiple source IPs</span>
index=windows EventCode=4624
| stats values(IpAddress) as source_ips, dc(IpAddress) as unique_ips by TargetUserName
| where unique_ips > 5</pre>
                </div>

                <h2>Advanced Correlation Techniques</h2>

                <h3>Chained Searches with append/appendcols</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// append - Add rows from another search</span>
index=windows EventCode=4625
| stats count as failed by src_ip
| append [
    search index=windows EventCode=4624
    | stats count as success by src_ip
]
| stats sum(failed) as failed, sum(success) as success by src_ip

<span style="color: #6aa3f7;">// appendcols - Add columns from another search</span>
index=firewall earliest=-1h
| stats count as current_hour
| appendcols [
    search index=firewall earliest=-25h latest=-24h
    | stats count as same_hour_yesterday
]
| eval change_pct = round(((current_hour - same_hour_yesterday) / same_hour_yesterday) * 100, 2)</pre>
                </div>

                <h3>map - Iterate Over Results</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// For each suspicious IP, get all related activity</span>
index=firewall action=blocked
| stats count by src_ip
| where count > 100
| head 10
| map search="search index=* src_ip=$src_ip$ | stats count by index, sourcetype"

<span style="color: #6aa3f7;">// Careful: map has performance implications for large result sets</span></pre>
                </div>

                <h2>Datamodel Acceleration</h2>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Use accelerated datamodels for faster searches</span>

<span style="color: #6aa3f7;">// Network Traffic datamodel</span>
| from datamodel:"Network_Traffic"."All_Traffic"
| stats sum(bytes) as total_bytes by src_ip

<span style="color: #6aa3f7;">// Authentication datamodel</span>
| from datamodel:"Authentication"."Authentication"
| where action="failure"
| stats count by user, src

<span style="color: #6aa3f7;">// tstats - Much faster than regular search on datamodels</span>
| tstats count from datamodel=Authentication where Authentication.action=failure by Authentication.user

<span style="color: #6aa3f7;">// tstats with summariesonly (only accelerated data, fastest)</span>
| tstats summariesonly=true count from datamodel=Network_Traffic by All_Traffic.src_ip</pre>
                </div>

                <h2>Security Detection Examples</h2>

                <h3>Lateral Movement Detection</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Detect user accessing many hosts rapidly</span>
index=windows EventCode=4624 LogonType IN (3, 10)  <span style="color: #6aa3f7;">// Network & RemoteInteractive</span>
| bin _time span=1h
| stats dc(ComputerName) as unique_hosts, values(ComputerName) as hosts by TargetUserName, _time
| where unique_hosts > 10
| sort -unique_hosts

<span style="color: #6aa3f7;">// RDP lateral movement</span>
index=windows EventCode=4624 LogonType=10
| transaction TargetUserName maxspan=1h
| where eventcount > 5
| table _time, TargetUserName, eventcount, duration</pre>
                </div>

                <h3>Data Exfiltration Detection</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Large outbound transfers</span>
index=firewall direction=outbound
| stats sum(bytes) as total_bytes by src_ip, dest_ip
| where total_bytes > 1073741824  <span style="color: #6aa3f7;">// > 1GB</span>
| eval total_gb = round(total_bytes/1024/1024/1024, 2)
| sort -total_gb

<span style="color: #6aa3f7;">// Unusual upload destinations</span>
index=proxy http_method=POST
| stats sum(bytes_out) as uploaded by dest, user
| eventstats avg(uploaded) as avg_upload, stdev(uploaded) as stdev_upload
| eval zscore = (uploaded - avg_upload) / stdev_upload
| where zscore > 2
| sort -zscore</pre>
                </div>

                <h3>Beaconing Detection (C2)</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Find regular interval connections (potential C2 beaconing)</span>
index=firewall
| sort _time
| streamstats current=f last(_time) as prev_time by src_ip, dest_ip
| eval interval = _time - prev_time
| stats count, avg(interval) as avg_interval, stdev(interval) as stdev_interval by src_ip, dest_ip
| where count > 20 AND stdev_interval < 10  <span style="color: #6aa3f7;">// Low variance = regular interval</span>
| sort stdev_interval

<span style="color: #6aa3f7;">// Alternative: Use coefficient of variation</span>
| eval cv = stdev_interval / avg_interval
| where cv < 0.1  <span style="color: #6aa3f7;">// Less than 10% variation = very regular</span></pre>
                </div>

                <h3>Account Compromise Detection</h3>
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #6aa3f7;">// Impossible travel detection</span>
index=azure_ad SigninLogs
| sort _time
| streamstats current=f last(Location) as prev_location, last(_time) as prev_time by UserPrincipalName
| iplocation IpAddress
| eval time_diff_hours = (_time - prev_time) / 3600
| eval locations_different = if(Location != prev_location AND isnotnull(prev_location), 1, 0)
| where locations_different=1 AND time_diff_hours < 2  <span style="color: #6aa3f7;">// Different location within 2 hours</span>
| table _time, UserPrincipalName, Location, prev_location, time_diff_hours

<span style="color: #6aa3f7;">// First-time login from new location</span>
index=azure_ad SigninLogs ResultType=0  <span style="color: #6aa3f7;">// Successful</span>
| iplocation IpAddress
| stats earliest(_time) as first_login, count by UserPrincipalName, Country
| where first_login > relative_time(now(), "-24h")  <span style="color: #6aa3f7;">// New in last 24h</span></pre>
                </div>

                <h2>Performance Optimization</h2>
                <table>
                    <thead><tr><th>Technique</th><th>Impact</th><th>Example</th></tr></thead>
                    <tbody>
                        <tr>
                            <td><strong>Filter early</strong></td>
                            <td>Major</td>
                            <td>Put restrictive filters before expensive commands</td>
                        </tr>
                        <tr>
                            <td><strong>Use indexed fields</strong></td>
                            <td>Major</td>
                            <td><code>index=X source=Y</code> before <code>| search field=value</code></td>
                        </tr>
                        <tr>
                            <td><strong>Limit time range</strong></td>
                            <td>Major</td>
                            <td>Use <code>earliest</code> and <code>latest</code></td>
                        </tr>
                        <tr>
                            <td><strong>Use tstats</strong></td>
                            <td>Major</td>
                            <td>Query accelerated datamodels</td>
                        </tr>
                        <tr>
                            <td><strong>Avoid wildcards in middle</strong></td>
                            <td>Moderate</td>
                            <td><code>user=admin*</code> better than <code>user=*admin*</code></td>
                        </tr>
                        <tr>
                            <td><strong>Use fields command</strong></td>
                            <td>Moderate</td>
                            <td>Drop unnecessary fields early: <code>| fields src_ip, user</code></td>
                        </tr>
                    </tbody>
                </table>

                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.75rem;">
<pre style="margin: 0;"><span style="color: #f07070;">// BAD: Expensive search</span>
| search *password*
| stats count by user

<span style="color: #5ce0c4;">// GOOD: Optimized search</span>
index=windows EventCode=4625 earliest=-1h
| fields TargetUserName, IpAddress
| stats count by TargetUserName

<span style="color: #6aa3f7;">// Use Job Inspector to analyze performance</span>
<span style="color: #6aa3f7;">// Look for: scanCount, eventCount, execution time</span></pre>
                </div>

            
                </section>
            
                <section class="content-section">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>
                    
                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>How would you optimize a slow SPL search?</span>
                        </div>
                        <div class="interview-answer">
                            <p>Search optimization is critical for performance. Key strategies:</p>
                            <p><strong>1. Filter early:</strong> Put the most restrictive filters at the beginning. <code>index=firewall action=blocked</code> is much faster than searching all firewall logs then filtering.</p>
                            <p><strong>2. Use indexed fields:</strong> Search on fields that are indexed (like index, sourcetype, host, source) before non-indexed fields. <code>index=main host=webserver01</code> uses the index efficiently.</p>
                            <p><strong>3. Avoid wildcards at the start:</strong> <code>*error</code> is slow because it can't use the index. <code>error*</code> is fine.</p>
                            <p><strong>4. Limit time range:</strong> Shorter time ranges = less data to scan. Use the smallest range that meets your needs.</p>
                            <p><strong>5. Use tstats for data model searches:</strong> <code>| tstats count from datamodel=Network_Traffic</code> is dramatically faster than raw searches against accelerated data models.</p>
                            <p><strong>6. Use summary indexes:</strong> For frequently-run reports, pre-aggregate data into summary indexes.</p>
                            <p>Use Job Inspector to see where time is spent - is it disk I/O, field extraction, or command processing?</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Splunk Enterprise Security Guide</p>
                    <p>Personal Reference Guide</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>