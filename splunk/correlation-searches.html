<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="splunk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlation Searches - Detection Engineering in Splunk ES | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>
            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="index.html" class="platform-tab splunk active"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
                        <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Pipeline</div>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Data Ingestion</a>
                    <a href="forwarders.html" class="nav-link"><i class="fas fa-share"></i> Forwarders Deep Dive</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                    <a href="data-models.html" class="nav-link"><i class="fas fa-cubes"></i> Data Models & CIM</a>
                    <a href="retention-tiers.html" class="nav-link"><i class="fas fa-archive"></i> Retention & Buckets</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">SPL Query Language</div>
                    <a href="spl-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> SPL Fundamentals</a>
                    <a href="spl-intermediate.html" class="nav-link"><i class="fas fa-layer-group"></i> SPL Intermediate</a>
                    <a href="spl-advanced.html" class="nav-link"><i class="fas fa-code"></i> Advanced SPL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Enterprise Security</div>
                    <a href="es-overview.html" class="nav-link"><i class="fas fa-shield-alt"></i> ES Overview</a>
                    <a href="correlation-searches.html" class="nav-link active"><i class="fas fa-search-plus"></i> Correlation Searches</a>
                    <a href="notable-events.html" class="nav-link"><i class="fas fa-exclamation-triangle"></i> Notable Events</a>
                    <a href="risk-based-alerting.html" class="nav-link"><i class="fas fa-chart-line"></i> Risk-Based Alerting</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">TI & Automation</div>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intelligence</a>
                    <a href="soar.html" class="nav-link"><i class="fas fa-robot"></i> Splunk SOAR</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="enterprise-scenarios.html" class="nav-link"><i class="fas fa-building"></i> Enterprise Scenarios</a>
                    <a href="dashboards.html" class="nav-link"><i class="fas fa-chart-bar"></i> Dashboards</a>
                    <a href="apps-tas.html" class="nav-link"><i class="fas fa-puzzle-piece"></i> Apps & TAs</a>
                    <a href="troubleshooting.html" class="nav-link"><i class="fas fa-wrench"></i> Troubleshooting</a>
                </div>
            </nav>
        </aside>
        
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">Splunk</a>
                    <span class="separator">/</span>
                    <span class="current">Correlation Searches</span>
                </div>
            </header>
            
            <main class="main-content">
                <div class="page-header">
                    <h1><i class="fas fa-search-plus"></i> Correlation Searches</h1>
                    <p class="lead">Scheduled searches that detect threats and create Notable Events - the core of Splunk ES detection engineering</p>
                </div>

                <!-- How Correlation Searches Work -->
                <section class="content-section">
                    <h2><i class="fas fa-cogs"></i> How Correlation Searches Work</h2>

                    <div class="architecture-diagram" style="background: var(--card-bg); padding: 1.5rem; border-radius: 8px; font-family: monospace; font-size: 0.7rem;">
<pre>
┌─────────────────────────────────────────────────────────────────────────────┐
│                     CORRELATION SEARCH LIFECYCLE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. SCHEDULE             2. SEARCH               3. THRESHOLD               │
│  ─────────               ────────                ─────────                  │
│  Runs on cron            Query data              Check results              │
│  e.g., */5 * * * *       model or index          against conditions         │
│                                                                              │
│        │                      │                        │                     │
│        ▼                      ▼                        ▼                     │
│  ┌──────────┐          ┌──────────┐            ┌──────────────┐             │
│  │ Scheduler│─────────▶│  SPL     │───────────▶│ Results > 0? │             │
│  │ (5 min)  │          │  Query   │            │              │             │
│  └──────────┘          └──────────┘            └──────┬───────┘             │
│                                                       │                      │
│                                                       │ YES                  │
│                                                       ▼                      │
│  4. CREATE NOTABLE       5. ADAPTIVE RESPONSE        6. THROTTLE            │
│  ──────────────          ─────────────────           ────────               │
│  Generate alert          Execute actions             Suppress duplicates    │
│                                                                              │
│  ┌──────────────┐       ┌──────────────┐        ┌──────────────┐            │
│  │ Notable      │──────▶│ Run Playbook │        │ 1 per src/hr │            │
│  │ Event        │       │ Enrich IOCs  │        │              │            │
│  │ Created      │       │ Send Alert   │        │              │            │
│  └──────────────┘       └──────────────┘        └──────────────┘            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
</pre>
                    </div>
                </section>

                <!-- Creating Correlation Searches -->
                <section class="content-section">
                    <h2><i class="fas fa-plus-circle"></i> Creating Correlation Searches</h2>

                    <h3>Method 1: ES Content Management</h3>
                    <p>Configure → Content → Content Management → Create New Content → Correlation Search</p>

                    <h3>Method 2: savedsearches.conf</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">conf</span>
                            <span class="code-title">savedsearches.conf - Correlation Search</span>
                        </div>
                        <pre><code>[Brute Force Access Behavior Detected]
# Basic settings
action.correlationsearch.enabled = 1
action.correlationsearch.label = Brute Force Access Behavior Detected
description = Detects multiple failed authentication attempts from single source

# Schedule
cron_schedule = */5 * * * *
enableSched = 1
schedule_window = 5

# Search
search = | tstats `summariesonly` count from datamodel=Authentication \
    where Authentication.action=failure \
    by Authentication.src, Authentication.user, Authentication.dest \
    | rename Authentication.* as * \
    | where count >= 10

# Notable event creation
action.notable = 1
action.notable.param.security_domain = access
action.notable.param.severity = medium
action.notable.param.rule_title = Brute Force Access Behavior Detected
action.notable.param.rule_description = Multiple failed authentication attempts detected from $src$ targeting $user$
action.notable.param.drilldown_name = View failed logins
action.notable.param.drilldown_search = index=* sourcetype=*security* action=failure src=$src$ user=$user$

# Risk scoring (optional)
action.risk = 1
action.risk.param._risk_object = user
action.risk.param._risk_object_type = user
action.risk.param._risk_score = 40

# MITRE ATT&CK mapping
action.notable.param.mitre_attack = T1110,T1110.001

# Throttling
alert.suppress = 1
alert.suppress.fields = src,user
alert.suppress.period = 1h</code></pre>
                    </div>
                </section>

                <!-- Example Correlation Searches -->
                <section class="content-section">
                    <h2><i class="fas fa-clipboard-list"></i> Example Correlation Searches</h2>

                    <h3>1. Excessive Failed Logins</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">SPL</span>
                            <span class="code-title">Authentication - Brute Force</span>
                        </div>
                        <pre><code>| tstats `summariesonly` count from datamodel=Authentication 
    where Authentication.action=failure 
    by _time span=5m, Authentication.src, Authentication.user, Authentication.dest
| rename Authentication.* as *
| where count >= 10
| `drop_dm_object_name("Authentication")`</code></pre>
                    </div>

                    <h3>2. Suspicious PowerShell Execution</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">SPL</span>
                            <span class="code-title">Endpoint - Encoded PowerShell</span>
                        </div>
                        <pre><code>| tstats `summariesonly` count from datamodel=Endpoint.Processes 
    where Processes.process_name="powershell.exe" 
    AND (Processes.process="*-enc*" OR Processes.process="*-encoded*" OR Processes.process="*FromBase64*")
    by Processes.dest, Processes.user, Processes.process, Processes.parent_process
| rename Processes.* as *
| `drop_dm_object_name("Processes")`</code></pre>
                    </div>

                    <h3>3. Large Data Exfiltration</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">SPL</span>
                            <span class="code-title">Network - Data Exfil Detection</span>
                        </div>
                        <pre><code>| tstats `summariesonly` sum(All_Traffic.bytes_out) as bytes_out 
    from datamodel=Network_Traffic 
    by All_Traffic.src, All_Traffic.dest
| rename All_Traffic.* as *
| eval MB = round(bytes_out/1024/1024, 2)
| where MB > 500
| lookup asset_lookup ip as src OUTPUT category as src_category
| where src_category = "workstation"
| `drop_dm_object_name("All_Traffic")`</code></pre>
                    </div>

                    <h3>4. Known Malware Hash Detected</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">SPL</span>
                            <span class="code-title">Malware - TI Hash Match</span>
                        </div>
                        <pre><code>| tstats `summariesonly` count from datamodel=Endpoint.Filesystem 
    by Filesystem.file_hash, Filesystem.file_path, Filesystem.dest, Filesystem.user
| rename Filesystem.* as *
| lookup threatintel_by_hash file_hash OUTPUT threat_category, threat_description
| where isnotnull(threat_category)
| `drop_dm_object_name("Filesystem")`</code></pre>
                    </div>

                    <h3>5. Impossible Travel</h3>
                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">SPL</span>
                            <span class="code-title">Access - Impossible Travel</span>
                        </div>
                        <pre><code>| tstats `summariesonly` earliest(_time) as first_time, latest(_time) as last_time, values(Authentication.src) as locations 
    from datamodel=Authentication 
    where Authentication.action=success 
    by Authentication.user
| rename Authentication.* as *
| mvexpand locations
| iplocation locations
| stats earliest(first_time) as time1, latest(last_time) as time2, 
    earliest(City) as city1, latest(City) as city2,
    earliest(lat) as lat1, latest(lat) as lat2,
    earliest(lon) as lon1, latest(lon) as lon2
    by user
| where city1 != city2
| eval distance_km = 6371 * acos(sin(lat1*3.14159/180)*sin(lat2*3.14159/180) + cos(lat1*3.14159/180)*cos(lat2*3.14159/180)*cos((lon2-lon1)*3.14159/180))
| eval time_diff_hours = (time2 - time1) / 3600
| eval required_speed_kmh = distance_km / time_diff_hours
| where required_speed_kmh > 800  // Faster than commercial flight</code></pre>
                    </div>
                </section>

                <!-- Throttling -->
                <section class="content-section">
                    <h2><i class="fas fa-tachometer-alt"></i> Throttling & Suppression</h2>

                    <p>Prevent alert fatigue by suppressing duplicate notables:</p>

                    <div class="code-block">
                        <div class="code-header">
                            <span class="code-lang">conf</span>
                            <span class="code-title">Throttling Configuration</span>
                        </div>
                        <pre><code># In savedsearches.conf or via UI

# Suppress duplicates based on field combination
alert.suppress = 1
alert.suppress.fields = src, user
alert.suppress.period = 1h

# This means: Only 1 notable per unique (src, user) combination per hour</code></pre>
                    </div>

                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Scenario</th>
                                <th>Suppress Fields</th>
                                <th>Suppress Period</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Brute force per source</td>
                                <td>src</td>
                                <td>1h</td>
                            </tr>
                            <tr>
                                <td>Malware per host</td>
                                <td>dest</td>
                                <td>24h</td>
                            </tr>
                            <tr>
                                <td>User anomaly</td>
                                <td>user</td>
                                <td>4h</td>
                            </tr>
                            <tr>
                                <td>IOC match per indicator</td>
                                <td>ioc_value</td>
                                <td>12h</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Adaptive Response -->
                <section class="content-section">
                    <h2><i class="fas fa-bolt"></i> Adaptive Response Actions</h2>

                    <p>Automated actions triggered when correlation search fires:</p>

                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Description</th>
                                <th>Use Case</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Create Notable</strong></td>
                                <td>Generate Notable Event in Incident Review</td>
                                <td>Default for most searches</td>
                            </tr>
                            <tr>
                                <td><strong>Add Risk</strong></td>
                                <td>Increase risk score on asset/identity</td>
                                <td>RBA strategy</td>
                            </tr>
                            <tr>
                                <td><strong>Send Email</strong></td>
                                <td>Email alert to team</td>
                                <td>Critical alerts</td>
                            </tr>
                            <tr>
                                <td><strong>Run Script</strong></td>
                                <td>Execute custom script</td>
                                <td>Custom integrations</td>
                            </tr>
                            <tr>
                                <td><strong>Send to SOAR</strong></td>
                                <td>Create case in Splunk SOAR</td>
                                <td>Automated playbooks</td>
                            </tr>
                            <tr>
                                <td><strong>Slack/Teams</strong></td>
                                <td>Post to chat channel</td>
                                <td>Team notifications</td>
                            </tr>
                        </tbody>
                    </table>
                </section>

                <!-- Best Practices -->
                <section class="content-section">
                    <h2><i class="fas fa-lightbulb"></i> Best Practices</h2>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3>✅ Do</h3>
                            <ul>
                                <li>Use tstats for accelerated data models</li>
                                <li>Set appropriate throttling</li>
                                <li>Map to MITRE ATT&CK</li>
                                <li>Include drilldown searches</li>
                                <li>Test in dev before production</li>
                                <li>Document detection logic</li>
                                <li>Review false positive rate regularly</li>
                            </ul>
                        </div>
                        <div>
                            <h3>❌ Don't</h3>
                            <ul>
                                <li>Search raw data when DM available</li>
                                <li>Create notables for informational events</li>
                                <li>Ignore throttling (causes alert fatigue)</li>
                                <li>Use wildcards at start of search</li>
                                <li>Set severity too high for low-fidelity</li>
                                <li>Skip testing with production data volume</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Interview Section -->
                <section class="content-section interview-section" style="background: linear-gradient(135deg, rgba(101,166,55,0.1), rgba(101,166,55,0.2)); border-radius: 12px; padding: 2rem;">
                    <h2><i class="fas fa-user-tie"></i> Interview Preparation</h2>

                    <div class="interview-box">
                        <div class="interview-question">
                            <i class="fas fa-question-circle"></i>
                            <span>Walk me through creating a correlation search to detect lateral movement.</span>
                        </div>
                        <div class="interview-answer">
                            <p>I'd create a correlation search focused on detecting RDP or SMB lateral movement patterns:</p>
                            <p><strong>1. Define the detection logic:</strong></p>
                            <p>Look for a single source IP connecting to multiple internal destinations on RDP (3389) or SMB (445) within a short timeframe. Legitimate admin activity typically targets known management IPs, while lateral movement scans many hosts.</p>
                            <p><strong>2. Write the SPL:</strong></p>
                            <pre style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 4px; font-size: 0.8rem;">| tstats count dc(All_Traffic.dest) as unique_targets from datamodel=Network_Traffic 
    where (All_Traffic.dest_port=3389 OR All_Traffic.dest_port=445) 
    AND All_Traffic.action=allowed
    by All_Traffic.src, _time span=1h
| where unique_targets >= 10
| lookup asset_lookup ip as src OUTPUT category
| where category != "scanner" AND category != "admin_workstation"</pre>
                            <p><strong>3. Configure notable event:</strong></p>
                            <p>Set severity to high, security domain to network, include MITRE mapping (T1021 - Remote Services), and add a drilldown search showing all connections from the source IP.</p>
                            <p><strong>4. Set throttling:</strong></p>
                            <p>Suppress on src for 4 hours - once we alert on lateral movement from an IP, we don't need repeated alerts until investigated.</p>
                            <p><strong>5. Tune and test:</strong></p>
                            <p>Run the search manually, check false positives from IT tools, add exclusions to the asset lookup or the search itself.</p>
                        </div>
                    </div>
                </section>

            </main>
            
            <footer class="content-footer">
                <div class="footer-content">
                    <p>Nik's SIEM - Correlation Searches</p>
                    <p>Personal Reference</p>
                </div>
            </footer>
        </div>
    </div>
    
    <script src="../assets/js/main.js"></script>
</body>
</html>
