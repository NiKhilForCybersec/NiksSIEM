<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Containment Procedures | SOC Compendium</title>
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">SOC Compendium</a>
            <div class="nav-links">
                <a href="../sentinel/index.html">Sentinel</a>
                <a href="../splunk/index.html">Splunk</a>
                <a href="../xsiam/index.html">XSIAM</a>
                <a href="../mde/index.html">Defender</a>
                <a href="../cortex/index.html">Cortex</a>
                <a href="../crowdstrike/index.html">CrowdStrike</a>
                <a href="../operations/index.html" class="active">Operations</a>
            </div>
        </div>
    </nav>

    <main class="content-wrapper">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>SOC Operations</h3>
                <ul>
                    <li><a href="index.html">Operations Home</a></li>
                    <li><a href="triage-handbook.html">Triage Handbook</a></li>
                    <li><a href="playbook-library.html">Playbook Library</a></li>
                    <li><a href="escalation-matrix.html">Escalation Matrix</a></li>
                    <li><a href="shift-handoff.html">Shift Handoff</a></li>
                    <li><a href="soc-metrics.html">SOC Metrics</a></li>
                    <li><a href="detection-engineering.html">Detection Engineering</a></li>
                    <li><a href="tuning-optimization.html">Tuning & Optimization</a></li>
                    <li><a href="containment-procedures.html" class="active">Containment Procedures</a></li>
                </ul>
            </div>
        </aside>

        <article class="main-content">
            <header class="content-header">
                <h1>Containment Procedures</h1>
                <p class="subtitle">Rapid containment strategies to limit threat spread and impact</p>
            </header>

            <section class="content-section">
                <h2>Containment Decision Framework</h2>
                <p>Containment actions must balance the need to stop threat propagation with business continuity requirements. The severity and type of threat determines the appropriate containment level.</p>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Threat Type</th>
                            <th>Severity</th>
                            <th>Primary Action</th>
                            <th>Decision Authority</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Active Ransomware</td>
                            <td class="status-critical">Critical</td>
                            <td>Immediate network isolation</td>
                            <td>SOC L1 (pre-authorized)</td>
                        </tr>
                        <tr>
                            <td>Data Exfiltration</td>
                            <td class="status-critical">Critical</td>
                            <td>Network isolation + block external IPs</td>
                            <td>SOC L2</td>
                        </tr>
                        <tr>
                            <td>Active C2 Communication</td>
                            <td class="status-warning">High</td>
                            <td>Block C2 domain/IP + endpoint isolation</td>
                            <td>SOC L2</td>
                        </tr>
                        <tr>
                            <td>Lateral Movement</td>
                            <td class="status-warning">High</td>
                            <td>Segment affected systems + disable accounts</td>
                            <td>SOC L2 + IT</td>
                        </tr>
                        <tr>
                            <td>Credential Compromise</td>
                            <td class="status-warning">High</td>
                            <td>Disable/reset accounts + force reauthentication</td>
                            <td>SOC L2 + IAM</td>
                        </tr>
                        <tr>
                            <td>Malware (Non-Spreading)</td>
                            <td>Medium</td>
                            <td>Quarantine file + endpoint isolation if spreading</td>
                            <td>SOC L1</td>
                        </tr>
                        <tr>
                            <td>Phishing Success</td>
                            <td>Medium</td>
                            <td>Reset credentials + review mail rules</td>
                            <td>SOC L1</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <section class="content-section">
                <h2>Endpoint Containment</h2>

                <h3>Network Isolation</h3>
                <p>Completely disconnect endpoint from network while maintaining EDR connectivity.</p>

                <div class="code-block">
                    <pre><code># Microsoft Defender for Endpoint
POST https://api.securitycenter.microsoft.com/api/machines/{id}/isolate
{ "Comment": "Incident #12345 - Active ransomware", "IsolationType": "Full" }

# CrowdStrike Falcon
POST /devices/entities/devices-actions/v2?action_name=contain
{ "ids": ["device_id"] }

# Cortex XDR
POST /public_api/v1/endpoints/isolate
{ "request_data": { "endpoint_id_list": ["endpoint_id"] } }

# Manual (if EDR unavailable)
# Windows Firewall - Block all except EDR
netsh advfirewall set allprofiles firewallpolicy blockinbound,blockoutbound
netsh advfirewall firewall add rule name="Allow EDR" dir=out action=allow program="C:\Program Files\EDR\agent.exe"</code></pre>
                </div>

                <h3>Process Termination</h3>
                <div class="code-block">
                    <pre><code># Kill malicious process by name
taskkill /F /IM malware.exe /T

# Kill by PID
taskkill /F /PID 1234

# Via PowerShell with logging
$proc = Get-Process -Name "suspicious" -ErrorAction SilentlyContinue
if ($proc) {
    $proc | Stop-Process -Force
    Write-EventLog -LogName Application -Source "SOC" -EventId 1001 -Message "Terminated process: $($proc.Name) PID: $($proc.Id)"
}</code></pre>
                </div>

                <h3>File Quarantine</h3>
                <div class="code-block">
                    <pre><code># MDE - Stop and Quarantine
POST /api/machines/{id}/StopAndQuarantineFile
{ "Comment": "Quarantine ransomware", "Sha1": "abc123..." }

# Manual quarantine with hash preservation
$file = "C:\temp\malware.exe"
$hash = (Get-FileHash $file -Algorithm SHA256).Hash
$quarantine = "C:\Quarantine\$hash"
Move-Item $file $quarantine
Set-ItemProperty $quarantine -Name Attributes -Value ([System.IO.FileAttributes]::Hidden)
Write-Output "Quarantined: $file -> $quarantine (SHA256: $hash)"</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Network Containment</h2>

                <h3>Block External IOCs</h3>
                <div class="code-block">
                    <pre><code># Firewall - Block IP
# Palo Alto
set address C2-Server ip-netmask 192.0.2.100/32
set security policies rules Block-C2 from any to untrust destination C2-Server action deny

# Cisco ASA
access-list BLOCK_C2 extended deny ip any host 192.0.2.100
access-group BLOCK_C2 in interface outside

# Windows Firewall (endpoint level)
netsh advfirewall firewall add rule name="Block C2" dir=out action=block remoteip=192.0.2.100

# DNS Sinkhole (Infoblox/AD DNS)
# Add malicious domain to sinkhole zone
dnscmd /RecordAdd sinkhole.local malicious-domain.com A 0.0.0.0</code></pre>
                </div>

                <h3>Segment Affected Systems</h3>
                <div class="code-block">
                    <pre><code># VLAN Quarantine (Cisco)
interface GigabitEthernet0/1
 description Quarantined-Host
 switchport access vlan 999
 switchport mode access

# SDN/NSX Micro-segmentation
# Apply emergency quarantine policy to VM
# Block all east-west traffic, allow management

# NAC (ISE) Quarantine
# Apply quarantine authorization policy
# Move to restricted VLAN with only AV/patch access</code></pre>
                </div>

                <h3>Network Flow Blocking</h3>
                <div class="code-block">
                    <pre><code># Block lateral movement protocols from infected segment
# SMB (445), RPC (135), WinRM (5985/5986), RDP (3389)

# Palo Alto - Inter-zone blocking
set security policies rules Block-Lateral from infected-zone to any application smb action deny
set security policies rules Block-Lateral application ms-rpc action deny
set security policies rules Block-Lateral application ms-rdp action deny

# Segment isolation ACL
access-list QUARANTINE deny tcp 10.10.10.0 0.0.0.255 any eq 445
access-list QUARANTINE deny tcp 10.10.10.0 0.0.0.255 any eq 135
access-list QUARANTINE deny tcp 10.10.10.0 0.0.0.255 any eq 3389
access-list QUARANTINE permit ip 10.10.10.0 0.0.0.255 host 10.0.0.5  # Allow to SIEM
access-list QUARANTINE deny ip 10.10.10.0 0.0.0.255 any</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Identity Containment</h2>

                <h3>Account Disable/Lockout</h3>
                <div class="code-block">
                    <pre><code># Active Directory - Disable Account
Disable-ADAccount -Identity "compromised_user"

# Force password change at next logon
Set-ADUser -Identity "compromised_user" -ChangePasswordAtLogon $true

# Azure AD - Block Sign-in
Set-AzureADUser -ObjectId user@domain.com -AccountEnabled $false

# Revoke all sessions (Azure AD)
Revoke-AzureADUserAllRefreshToken -ObjectId user@domain.com

# Microsoft 365 - Sign out all sessions
Connect-MgGraph -Scopes "User.ReadWrite.All"
Revoke-MgUserSignInSession -UserId user@domain.com</code></pre>
                </div>

                <h3>Service Account Containment</h3>
                <div class="code-block">
                    <pre><code># Identify services using the account
Get-WmiObject Win32_Service | Where-Object { $_.StartName -like "*svc_compromised*" }

# Stop dependent services first, then disable account
Stop-Service -Name "DependentService" -Force
Disable-ADAccount -Identity "svc_compromised"

# Rotate service account credentials
$newPassword = [System.Web.Security.Membership]::GeneratePassword(24,4)
Set-ADAccountPassword -Identity "svc_compromised" -Reset -NewPassword (ConvertTo-SecureString $newPassword -AsPlainText -Force)

# Update service credentials (after incident)
sc.exe config "ServiceName" obj= "domain\svc_new" password= "newpassword"</code></pre>
                </div>

                <h3>MFA Reset / Conditional Access</h3>
                <div class="code-block">
                    <pre><code># Reset MFA registration
Remove-MsolUser -UserPrincipalName user@domain.com -RemoveFromRecycleBin

# Force MFA re-registration via Azure AD
Set-MsolUser -UserPrincipalName user@domain.com -StrongAuthenticationMethods @()

# Apply Conditional Access - Require compliant device
# Azure Portal: Azure AD → Security → Conditional Access
# Create policy requiring device compliance for compromised user</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Email Containment</h2>

                <h3>Purge Malicious Emails</h3>
                <div class="code-block">
                    <pre><code># Microsoft 365 - Content Search and Purge
New-ComplianceSearch -Name "Malicious Campaign" -ExchangeLocation All `
    -ContentMatchQuery 'subject:"Invoice" AND from:attacker@evil.com AND received>=2024-01-01'

Start-ComplianceSearch -Identity "Malicious Campaign"

# Soft Delete (recoverable)
New-ComplianceSearchAction -SearchName "Malicious Campaign" -Purge -PurgeType SoftDelete

# Hard Delete (permanent)
New-ComplianceSearchAction -SearchName "Malicious Campaign" -Purge -PurgeType HardDelete

# Check purge status
Get-ComplianceSearchAction -Identity "Malicious Campaign_Purge" | FL</code></pre>
                </div>

                <h3>Block Sender/Domain</h3>
                <div class="code-block">
                    <pre><code># Exchange Online - Block Sender
Set-HostedContentFilterPolicy -Identity Default -BlockedSenders @{Add="attacker@evil.com"}

# Block Domain
Set-HostedContentFilterPolicy -Identity Default -BlockedSenderDomains @{Add="evil.com"}

# Transport Rule - Block with notification
New-TransportRule -Name "Block Evil Campaign" `
    -FromAddressMatchesPatterns ".*@evil\.com" `
    -DeleteMessage $true `
    -GenerateIncidentReport "security@company.com" `
    -IncidentReportContent Sender,Subject,Recipients</code></pre>
                </div>

                <h3>Review Mail Rules</h3>
                <div class="code-block">
                    <pre><code># Check for suspicious forwarding rules
Get-InboxRule -Mailbox user@domain.com | Where-Object { 
    $_.ForwardTo -or $_.ForwardAsAttachmentTo -or $_.RedirectTo 
} | Format-List Name, ForwardTo, RedirectTo, Enabled

# Remove malicious rules
Remove-InboxRule -Mailbox user@domain.com -Identity "Suspicious Rule"

# Check all mailboxes for suspicious rules (large orgs)
$mailboxes = Get-Mailbox -ResultSize Unlimited
foreach ($mbx in $mailboxes) {
    Get-InboxRule -Mailbox $mbx.UserPrincipalName | Where-Object { 
        $_.ForwardTo -or $_.RedirectTo 
    }
}</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Cloud Containment</h2>

                <h3>AWS</h3>
                <div class="code-block">
                    <pre><code># Isolate EC2 Instance - Apply restrictive security group
aws ec2 modify-instance-attribute \
    --instance-id i-1234567890abcdef0 \
    --groups sg-quarantine

# Create quarantine security group (if not exists)
aws ec2 create-security-group \
    --group-name quarantine-sg \
    --description "Incident quarantine - no inbound/outbound"

# Revoke IAM User Access
aws iam delete-login-profile --user-name compromised-user
aws iam list-access-keys --user-name compromised-user | \
    jq -r '.AccessKeyMetadata[].AccessKeyId' | \
    xargs -I {} aws iam delete-access-key --user-name compromised-user --access-key-id {}

# Snapshot for forensics
aws ec2 create-snapshot --volume-id vol-1234567890abcdef0 --description "Incident snapshot"</code></pre>
                </div>

                <h3>Azure</h3>
                <div class="code-block">
                    <pre><code># Isolate VM - Apply NSG blocking all traffic
$nsg = New-AzNetworkSecurityGroup -ResourceGroupName "RG" -Name "Quarantine-NSG" -Location "eastus"
$nsg | Add-AzNetworkSecurityRuleConfig -Name "DenyAll" -Priority 100 -Direction Inbound `
    -Access Deny -Protocol * -SourcePortRange * -DestinationPortRange * `
    -SourceAddressPrefix * -DestinationAddressPrefix *

$nic = Get-AzNetworkInterface -Name "vm-nic"
$nic.NetworkSecurityGroup = $nsg
$nic | Set-AzNetworkInterface

# Snapshot disk for forensics
$vm = Get-AzVM -Name "compromised-vm"
$disk = Get-AzDisk -ResourceGroupName $vm.ResourceGroupName -DiskName $vm.StorageProfile.OsDisk.Name
$snapshotConfig = New-AzSnapshotConfig -SourceUri $disk.Id -Location $disk.Location -CreateOption Copy
New-AzSnapshot -Snapshot $snapshotConfig -SnapshotName "forensic-snapshot" -ResourceGroupName $vm.ResourceGroupName</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Containment Checklist</h2>
                <div class="code-block">
                    <pre><code>## Immediate Actions (First 15 minutes)
[ ] Assess threat type and severity
[ ] Determine containment level required
[ ] Obtain authorization if needed
[ ] Execute primary containment action
[ ] Document time and action taken

## Secondary Actions (15-60 minutes)
[ ] Identify all affected systems
[ ] Apply containment to additional systems
[ ] Block known IOCs at network level
[ ] Disable compromised accounts
[ ] Preserve evidence before changes

## Validation
[ ] Verify containment is effective
[ ] Confirm no ongoing malicious activity
[ ] Check for spread to other systems
[ ] Document containment scope

## Communication
[ ] Notify incident manager
[ ] Update ticket with containment details
[ ] Inform affected business units
[ ] Schedule containment release review</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Interview Q&A</h2>

                <div class="qa-section">
                    <h3>Q: You detect active ransomware encryption on a server. Walk me through your containment steps.</h3>
                    <div class="answer">
                        <p><strong>A:</strong> My ransomware containment approach:</p>
                        <ol>
                            <li><strong>Immediate isolation (0-2 min):</strong> Network isolate the server via EDR or network switch. Don't wait for approvals - ransomware spreads fast</li>
                            <li><strong>Stop encryption (2-5 min):</strong> If possible, kill the encryption process. Note the process name/PID for forensics</li>
                            <li><strong>Prevent lateral spread:</strong> Block SMB/445 from the affected subnet at the firewall, identify any systems that communicated with the infected server</li>
                            <li><strong>Account containment:</strong> Disable the account that ran the encryption. If it's a service account, identify all systems it has access to</li>
                            <li><strong>Network IOC blocking:</strong> Add any C2 IPs/domains to block lists across firewalls and proxies</li>
                            <li><strong>Scope assessment:</strong> Query SIEM for the ransomware indicators across all endpoints to identify other infections</li>
                            <li><strong>Evidence preservation:</strong> Take memory dump and disk snapshot before any remediation</li>
                        </ol>
                        <p>The key is speed - every minute of delay means more encrypted files.</p>
                    </div>
                </div>

                <div class="qa-section">
                    <h3>Q: How do you handle containment for a critical production server?</h3>
                    <div class="answer">
                        <p><strong>A:</strong> Critical server containment requires balancing security with business impact:</p>
                        <ul>
                            <li><strong>Selective isolation:</strong> Instead of full isolation, apply micro-segmentation to allow only essential traffic (backup agents, monitoring, specific application flows)</li>
                            <li><strong>Rapid escalation:</strong> Immediately engage the server owner and incident manager - they need to know about the threat AND the containment impact</li>
                            <li><strong>Alternative containment:</strong> If the server can't be isolated, focus on blocking the specific threat (C2 IPs, malicious processes) while monitoring closely</li>
                            <li><strong>Failover consideration:</strong> If HA exists, consider failing over to standby before isolating the primary</li>
                            <li><strong>Documentation:</strong> Record the business justification for any deviation from standard containment procedures</li>
                        </ul>
                        <p>The decision ultimately depends on: Is the threat actively spreading? Is data being exfiltrated? Can we contain the threat without full isolation?</p>
                    </div>
                </div>
            </section>
        </article>
    </main>

    <script src="../assets/js/main.js"></script>
</body>
</html>
