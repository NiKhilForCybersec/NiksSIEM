<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detection Engineering | Nik's SIEM Compendium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">SOC Operations</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="soc-operations.html" class="nav-link"><i class="fas fa-users"></i> SOC Structure</a>
                    <a href="shift-handoff.html" class="nav-link"><i class="fas fa-exchange-alt"></i> Shift Handoff</a>
                    <a href="escalation-matrix.html" class="nav-link"><i class="fas fa-level-up-alt"></i> Escalation Matrix</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Incident Response</div>
                    <a href="triage-methodology.html" class="nav-link"><i class="fas fa-clipboard-check"></i> Triage Methodology</a>
                    <a href="triage-handbook.html" class="nav-link"><i class="fas fa-book"></i> Triage Handbook</a>
                    <a href="incident-classification.html" class="nav-link"><i class="fas fa-tags"></i> Incident Classification</a>
                    <a href="containment-procedures.html" class="nav-link"><i class="fas fa-shield-alt"></i> Containment</a>
                    <a href="playbook-library.html" class="nav-link"><i class="fas fa-book-open"></i> Playbook Library</a>
                    <a href="ir-integration.html" class="nav-link"><i class="fas fa-link"></i> IR Integration</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection Engineering</div>
                    <a href="detection-engineering.html" class="nav-link active"><i class="fas fa-cogs"></i> Detection Engineering</a>
                    <a href="use-case-lifecycle.html" class="nav-link"><i class="fas fa-recycle"></i> Use Case Lifecycle</a>
                    <a href="tuning-optimization.html" class="nav-link"><i class="fas fa-sliders-h"></i> Tuning & Optimization</a>
                    <a href="mitre-mapping.html" class="nav-link"><i class="fas fa-map"></i> MITRE Mapping</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Metrics & Compliance</div>
                    <a href="metrics-kpis.html" class="nav-link"><i class="fas fa-chart-line"></i> Metrics & KPIs</a>
                    <a href="soc-metrics.html" class="nav-link"><i class="fas fa-tachometer-alt"></i> SOC Metrics</a>
                    <a href="compliance-mapping.html" class="nav-link"><i class="fas fa-check-double"></i> Compliance Mapping</a>
                    <a href="audit-preparation.html" class="nav-link"><i class="fas fa-clipboard-list"></i> Audit Preparation</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Planning & Design</div>
                    <a href="siem-project-planning.html" class="nav-link"><i class="fas fa-project-diagram"></i> SIEM Project Planning</a>
                    <a href="data-source-priority.html" class="nav-link"><i class="fas fa-sort-amount-down"></i> Data Source Priority</a>
                    <a href="sizing-calculator.html" class="nav-link"><i class="fas fa-calculator"></i> Sizing Calculator</a>
                    <a href="rbac-design.html" class="nav-link"><i class="fas fa-user-lock"></i> RBAC Design</a>
                    <a href="migration-guide.html" class="nav-link"><i class="fas fa-truck-moving"></i> Migration Guide</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <span class="current">Detection Engineering</span>
                </div>
            </header>
            <main class="main-content">
<h1>Detection Engineering</h1>
                <p class="subtitle">Building and maintaining effective detection capabilities across the security stack</p>
            </header>
            <section class="content-section">
                <h2>Detection Engineering Lifecycle</h2>
                <p>Detection engineering is the practice of designing, building, testing, and maintaining detections that identify malicious activity. Effective detection engineering bridges threat intelligence with operational security monitoring.</p>
                <div class="workflow-diagram">
                    <div class="workflow-step">
                        <span class="step-number">1</span>
                        <h4>Threat Research</h4>
                        <p>Analyze threat landscape, review intel, study attack techniques</p>
                    </div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">
                        <span class="step-number">2</span>
                        <h4>Data Assessment</h4>
                        <p>Identify required data sources, validate availability</p>
                    </div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">
                        <span class="step-number">3</span>
                        <h4>Detection Design</h4>
                        <p>Define logic, set thresholds, map to MITRE ATT&CK</p>
                    </div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">
                        <span class="step-number">4</span>
                        <h4>Development</h4>
                        <p>Write queries, build correlation rules, create playbooks</p>
                    </div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">
                        <span class="step-number">5</span>
                        <h4>Testing</h4>
                        <p>Validate against known attacks, check for FPs</p>
                    </div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">
                        <span class="step-number">6</span>
                        <h4>Deployment</h4>
                        <p>Roll out gradually, monitor performance</p>
                    </div>
                </div>
            </section>
            <section class="content-section">
                <h2>Detection Types</h2>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Advantages</th>
                            <th>Limitations</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Signature-Based</td>
                            <td>Match against known IOCs (hashes, IPs, domains)</td>
                            <td>Low FP rate, fast, simple</td>
                            <td>No zero-day detection, easy to evade</td>
                        </tr>
                        <tr>
                            <td>Behavioral</td>
                            <td>Detect patterns of malicious behavior</td>
                            <td>Catches variants, harder to evade</td>
                            <td>Higher FP rate, requires tuning</td>
                        </tr>
                        <tr>
                            <td>Anomaly-Based</td>
                            <td>Identify deviations from baseline</td>
                            <td>Catches unknown threats</td>
                            <td>Requires training, baseline shifts</td>
                        </tr>
                        <tr>
                            <td>Correlation</td>
                            <td>Combine multiple weak signals</td>
                            <td>High confidence, context-rich</td>
                            <td>Complex, data dependencies</td>
                        </tr>
                        <tr>
                            <td>Heuristic</td>
                            <td>Rule-based with scoring/thresholds</td>
                            <td>Flexible, adjustable sensitivity</td>
                            <td>Requires ongoing calibration</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section class="content-section">
                <h2>Detection Development Framework</h2>
                <h3>Detection Specification Template</h3>
                <div class="code-block">
                    <pre><code># Detection Specification
## Metadata
- **Name**: Encoded PowerShell Execution
- **ID**: DET-2024-0042
- **Author**: Security Engineering Team
- **Created**: 2024-01-15
- **Last Updated**: 2024-03-20
- **Status**: Production
## Threat Context
- **MITRE ATT&CK**: T1059.001 (PowerShell)
- **Kill Chain Phase**: Execution
- **Threat Actor Groups**: APT29, FIN7, Various
- **Description**: Detects execution of base64-encoded PowerShell commands, 
  commonly used by attackers to obfuscate malicious scripts.
## Detection Logic
- **Data Sources**: Process Creation Events (Windows Security 4688, Sysmon 1)
- **Query Platform**: Splunk/Sentinel/XDR
### Splunk Query
```spl
index=windows sourcetype=WinEventLog:Security EventCode=4688
| where process_name="powershell.exe" OR process_name="pwsh.exe"
| where match(CommandLine, "(?i)(-enc|-encodedcommand|-e\s+[A-Za-z0-9+/=]{20,})")
| eval decoded=base64decode(mvindex(split(CommandLine," "),2))
| table _time, host, user, CommandLine, decoded
```
### Sentinel KQL
```kql
SecurityEvent
| where EventID == 4688
| where Process endswith "powershell.exe" or Process endswith "pwsh.exe"
| where CommandLine matches regex @"(?i)(-enc|-encodedcommand|-e\s+[A-Za-z0-9+/=]{20,})"
| project TimeGenerated, Computer, Account, CommandLine
```
## Tuning Guidance
- **Known False Positives**: SCCM scripts, GPO deployments, legitimate admin tools
- **Exclusions**: 
  - Parent process: ConfigMgr\bin\ccm\*
  - User: svc_sccm, svc_intune
  - Encoded prefix: SQBmACAAKAAo (known SCCM pattern)
## Response Playbook
- Link: PB-2024-015 (Suspicious PowerShell Execution)
- Severity: Medium (default), High (if download cradle detected)
- Auto-Actions: Enrich with user context, check process tree
## Testing
- **Atomic Red Team**: T1059.001-1, T1059.001-2
- **Manual Test**: `powershell -enc [base64-encoded whoami]`
- **Expected Result**: Alert triggers within 5 minutes
- **Last Validated**: 2024-03-15</code></pre>
                </div>
            </section>
            <section class="content-section">
                <h2>MITRE ATT&CK-Driven Detection</h2>
                <h3>Coverage Assessment</h3>
                <p>Map existing detections to ATT&CK techniques to identify gaps:</p>
                <div class="code-block">
                    <pre><code>// Detection Coverage Matrix (simplified)
| Technique | Sub-Tech | Detection Name | Platform | Confidence |
|-----------|----------|----------------|----------|------------|
| T1059.001 | -        | Encoded PS     | All      | High       |
| T1059.001 | -        | PS Download    | All      | High       |
| T1003.001 | LSASS    | LSASS Access   | EDR      | High       |
| T1003.001 | LSASS    | Mimikatz Hash  | All      | Medium     |
| T1547.001 | Run Keys | Registry Mod   | EDR/SIEM | Medium     |
| T1021.002 | SMB      | Lateral SMB    | NDR/SIEM | Medium     |
| T1021.001 | RDP      | Unusual RDP    | SIEM     | Low        |
// Gap Analysis Priority
| Tactic          | Coverage | Priority | Notes                    |
|-----------------|----------|----------|--------------------------|
| Initial Access  | 45%      | High     | Need email gateway int.  |
| Execution       | 78%      | Medium   | Strong PowerShell cov.   |
| Persistence     | 62%      | High     | Missing WMI, Services    |
| Priv Escalation | 55%      | Medium   | Need token manipulation  |
| Defense Evasion | 40%      | High     | Process injection gaps   |
| Credential Acc. | 72%      | Medium   | Good LSASS coverage      |
| Discovery       | 35%      | Low      | High FP potential        |
| Lat. Movement   | 58%      | High     | Missing WinRM, DCOM      |
| Collection      | 25%      | Medium   | Data staging needed      |
| Exfiltration    | 42%      | High     | Cloud storage gaps       |
| C2              | 48%      | High     | DNS tunneling needed     |</code></pre>
                </div>
                <h3>Detection Priority Matrix</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Factor</th>
                            <th>Weight</th>
                            <th>Scoring Criteria</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Threat Prevalence</td>
                            <td>25%</td>
                            <td>How often is this technique used by threats relevant to us?</td>
                        </tr>
                        <tr>
                            <td>Asset Exposure</td>
                            <td>20%</td>
                            <td>Which critical assets are vulnerable to this technique?</td>
                        </tr>
                        <tr>
                            <td>Detection Feasibility</td>
                            <td>20%</td>
                            <td>Do we have the data sources? Can we build reliable detection?</td>
                        </tr>
                        <tr>
                            <td>Coverage Gap</td>
                            <td>20%</td>
                            <td>Is this technique currently detectable by other means?</td>
                        </tr>
                        <tr>
                            <td>Business Impact</td>
                            <td>15%</td>
                            <td>What's the potential damage if this technique succeeds?</td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section class="content-section">
                <h2>Testing Detections</h2>
                <h3>Testing Methodologies</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Method</th>
                            <th>Description</th>
                            <th>Tools</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Atomic Tests</td>
                            <td>Individual technique simulation</td>
                            <td>Atomic Red Team, MITRE Caldera</td>
                        </tr>
                        <tr>
                            <td>Attack Chains</td>
                            <td>Multi-stage attack simulation</td>
                            <td>MITRE ATT&CK Evaluations, Purple Team</td>
                        </tr>
                        <tr>
                            <td>Replay Testing</td>
                            <td>Replay historical attack data</td>
                            <td>Custom scripts, log replay</td>
                        </tr>
                        <tr>
                            <td>Red Team</td>
                            <td>Adversary simulation</td>
                            <td>Internal/external red team</td>
                        </tr>
                        <tr>
                            <td>Unit Testing</td>
                            <td>Query logic validation</td>
                            <td>Sample datasets, test suites</td>
                        </tr>
                    </tbody>
                </table>
                <h3>Detection Testing Checklist</h3>
                <div class="code-block">
                    <pre><code>## Pre-Deployment Testing
### Functional Testing
[ ] Detection triggers on known-malicious samples
[ ] Detection triggers on Atomic Red Team test
[ ] Detection does NOT trigger on normal activity baseline
[ ] All required data sources are available
[ ] Query performance is acceptable (<30 seconds)
### Quality Assurance
[ ] MITRE ATT&CK mapping is accurate
[ ] Severity rating is appropriate
[ ] Playbook is linked and current
[ ] Documentation is complete
[ ] Peer review completed
### Operational Readiness
[ ] Alert routing configured correctly
[ ] Enrichment sources configured
[ ] Auto-response actions tested (if applicable)
[ ] SOC team briefed on new detection
[ ] Runbook updated with response steps
## Post-Deployment Monitoring
[ ] Monitor FP rate for first 7 days
[ ] Track alert volume vs. prediction
[ ] Collect analyst feedback
[ ] Document tuning adjustments
[ ] Validate continued detection of test cases</code></pre>
                </div>
            </section>
            <section class="content-section">
                <h2>Detection-as-Code</h2>
                <p>Treating detections as code enables version control, peer review, automated testing, and consistent deployment.</p>
                <h3>Sigma Rule Example</h3>
                <div class="code-block">
                    <pre><code>title: Encoded PowerShell Command Execution
id: 8d8c7a06-9e62-4c8b-8e19-8a8f8b8c8d8e
status: production
description: Detects execution of base64-encoded PowerShell commands
author: Security Engineering
date: 2024/01/15
modified: 2024/03/20
references:
    - https://attack.mitre.org/techniques/T1059/001/
tags:
    - attack.execution
    - attack.t1059.001
logsource:
    category: process_creation
    product: windows
detection:
    selection:
        Image|endswith:
            - '\powershell.exe'
            - '\pwsh.exe'
        CommandLine|contains:
            - '-enc'
            - '-encodedcommand'
            - '-e '
    filter_sccm:
        ParentImage|contains: '\ccm\'
        User|startswith: 'svc_'
    filter_intune:
        ParentImage|contains: 'IntuneManagementExtension'
    condition: selection and not (filter_sccm or filter_intune)
falsepositives:
    - Legitimate administrative scripts
    - Configuration management tools
level: medium</code></pre>
                </div>
                <h3>CI/CD Pipeline for Detections</h3>
                <div class="code-block">
                    <pre><code># .github/workflows/detection-deploy.yml
name: Detection Deployment Pipeline
on:
  push:
    paths:
      - 'detections/**/*.yml'
  pull_request:
    paths:
      - 'detections/**/*.yml'
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate Sigma Rules
        run: |
          pip install sigma-cli
          sigma check detections/
      - name: Run Unit Tests
        run: |
          python -m pytest tests/detection_tests.py
  test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Convert to Platform Format
        run: |
          sigma convert -t splunk detections/ -o output/splunk/
          sigma convert -t microsoft365defender detections/ -o output/mde/
      - name: Test Against Sample Data
        run: |
          python scripts/test_detections.py --samples tests/samples/
  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to SIEM
        run: |
          python scripts/deploy_detections.py --platform splunk
          python scripts/deploy_detections.py --platform sentinel
      - name: Notify SOC
        run: |
          python scripts/notify_soc.py --channel detection-updates</code></pre>
                </div>
            </section>
            <section class="content-section">
                <h2>Interview Q&A</h2>
                <div class="qa-section">
                    <h3>Q: How do you approach building a new detection from scratch?</h3>
                    <div class="answer">
                        <p><strong>A:</strong> My detection development process:</p>
                        <ol>
                            <li><strong>Understand the threat:</strong> Research the technique deeply - read threat intel, review malware analysis, understand variations</li>
                            <li><strong>Identify data sources:</strong> Determine what telemetry is needed and validate it's available in our environment</li>
                            <li><strong>Define the behavior:</strong> Identify the unique/suspicious aspects that distinguish malicious from legitimate use</li>
                            <li><strong>Draft initial logic:</strong> Write a broad detection first, run against historical data to understand the landscape</li>
                            <li><strong>Tune iteratively:</strong> Analyze results, add exclusions for known-good patterns, refine conditions</li>
                            <li><strong>Test with red team:</strong> Validate detection triggers on actual attack simulation</li>
                            <li><strong>Document thoroughly:</strong> Include threat context, tuning guidance, and response procedures</li>
                            <li><strong>Deploy gradually:</strong> Roll out to subset first, monitor for a week before full deployment</li>
                        </ol>
                    </div>
                </div>
                <div class="qa-section">
                    <h3>Q: How do you measure detection effectiveness?</h3>
                    <div class="answer">
                        <p><strong>A:</strong> Key metrics for measuring detection effectiveness:</p>
                        <ul>
                            <li><strong>True Positive Rate:</strong> Percentage of alerts that represent actual threats</li>
                            <li><strong>False Positive Rate:</strong> Percentage that are benign - target <20% for actionable alerts</li>
                            <li><strong>Detection Latency:</strong> Time from attack execution to alert - target <5 minutes</li>
                            <li><strong>Coverage Score:</strong> Percentage of relevant ATT&CK techniques with active detections</li>
                            <li><strong>Alert-to-Incident Ratio:</strong> How many alerts lead to actual incidents</li>
                            <li><strong>Red Team Detection Rate:</strong> Percentage of purple team exercises that trigger detections</li>
                            <li><strong>MTTD (Mean Time to Detect):</strong> Average time to detect confirmed incidents</li>
                        </ul>
                        <p>I track these in dashboards and review monthly to identify detections needing improvement.</p>
                    </div>
                </div>
            </section>
        </article>
    </main>
            </main>
            <footer class="main-footer">
                <div class="footer-content">
                    <p>Nik's SIEM Compendium - Security Operations Reference</p>
                </div>
            </footer>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) {
                    answer.style.display = 'block';
                    btn.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>