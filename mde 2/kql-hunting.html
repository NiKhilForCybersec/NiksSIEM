<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KQL Hunting | Microsoft Defender for Endpoint</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <a href="../index.html" class="back-home"><i class="fas fa-arrow-left"></i> Nik's SIEM</a>
            
            <div class="breadcrumb">
                <a href="../index.html">Home</a>
                <span class="separator">/</span>
                <a href="index.html">Defender for Endpoint</a>
                <span class="separator">/</span>
                <span class="current">KQL Hunting</span>
            </div>

<h1><i class="fas fa-crosshairs"></i> MDE KQL Hunting</h1>
                <p class="lead">Master threat hunting in Microsoft Defender for Endpoint using KQL. Learn advanced hunting queries, MDE-specific tables, hunting techniques by MITRE ATT&CK tactic, and custom detection creation.</p>

                <!-- Advanced Hunting Overview -->
                <h2><i class="fas fa-info-circle"></i> Advanced Hunting Overview</h2>
                <div class="config-section">
                    <p><span class="console-path">security.microsoft.com → Hunting → Advanced hunting</span></p>

                    <h4>Advanced Hunting Capabilities</h4>
                    <div class="code-block">Advanced Hunting Features:

CAPABILITIES:
├── Query up to 30 days of data
├── 10,000 result limit per query
├── Save and share queries
├── Create custom detection rules
├── Schedule query execution
├── Export results to CSV
└── Integrate with incidents

DATA RETENTION:
├── Raw data: 30 days
├── Alert data: 180 days
├── Incident data: 180 days
└── Custom detections: Based on rule

QUERY LIMITS:
├── Timeout: 10 minutes
├── Results: 10,000 rows
├── CPU: Fair-share across tenants
└── Memory: Optimized for security queries

BEST PRACTICES:
├── Start with time filter (ago)
├── Use specific tables when possible
├── Filter early, aggregate late
├── Use project to limit columns
├── Test on smaller time ranges first
└── Save successful queries</div>

                    <h4>Key Tables</h4>
                    <div class="code-block">MDE Advanced Hunting Tables:

DEVICE TABLES:
├── DeviceInfo
│   └── Device inventory, OS, health status
├── DeviceNetworkInfo
│   └── Network adapters, IPs, MACs
├── DeviceProcessEvents
│   └── Process creation/termination
├── DeviceNetworkEvents
│   └── Network connections
├── DeviceFileEvents
│   └── File creation/modification/deletion
├── DeviceRegistryEvents
│   └── Registry changes
├── DeviceLogonEvents
│   └── Interactive and network logons
├── DeviceImageLoadEvents
│   └── DLL and driver loading
├── DeviceEvents
│   └── Other security events (ASR, etc.)
└── DeviceFileCertificateInfo
    └── Certificate information for files

ALERT TABLES:
├── AlertInfo
│   └── Alert details, severity, status
├── AlertEvidence
│   └── Files, processes, IPs linked to alerts
└── DeviceAlertEvents
    └── Alerts associated with devices

IDENTITY TABLES (with MDI):
├── IdentityLogonEvents
├── IdentityQueryEvents
├── IdentityDirectoryEvents
└── IdentityInfo</div>
                </div>

                <!-- Process Hunting -->
                <h2><i class="fas fa-cogs"></i> Process Hunting</h2>
                <div class="config-section">
                    <h4>DeviceProcessEvents</h4>
                    <div class="code-block">// Basic process execution query
DeviceProcessEvents
| where Timestamp > ago(24h)
| where FileName == "powershell.exe"
| project Timestamp, DeviceName, AccountName, 
          FileName, ProcessCommandLine,
          InitiatingProcessFileName
| take 100

// Key fields in DeviceProcessEvents:
// - Timestamp: Event time
// - DeviceName: Computer name
// - ActionType: ProcessCreated, ProcessTerminated
// - FileName: Process name (e.g., powershell.exe)
// - FolderPath: Full path to executable
// - SHA256: File hash
// - ProcessId: PID
// - ProcessCommandLine: Full command line
// - AccountName: User who ran process
// - AccountDomain: User domain
// - InitiatingProcessFileName: Parent process
// - InitiatingProcessCommandLine: Parent command
// - InitiatingProcessId: Parent PID</div>

                    <h4>Suspicious Process Patterns</h4>
                    <div class="code-block">// PowerShell with encoded commands
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any ("-enc", "-encodedcommand", 
        "-e ", "frombase64string")
| project Timestamp, DeviceName, AccountName, 
          ProcessCommandLine, InitiatingProcessFileName

// Office spawning suspicious children
DeviceProcessEvents
| where Timestamp > ago(7d)
| where InitiatingProcessFileName has_any 
        ("winword.exe", "excel.exe", "outlook.exe", "powerpnt.exe")
| where FileName has_any 
        ("powershell.exe", "cmd.exe", "wscript.exe", "mshta.exe", 
         "certutil.exe", "regsvr32.exe", "rundll32.exe")
| project Timestamp, DeviceName, InitiatingProcessFileName, 
          FileName, ProcessCommandLine

// LOLBAS - Living Off the Land Binaries
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("certutil.exe", "mshta.exe", "regsvr32.exe",
        "rundll32.exe", "msiexec.exe", "installutil.exe",
        "bitsadmin.exe", "wmic.exe", "cscript.exe", "wscript.exe")
| where ProcessCommandLine has_any ("http", "ftp", "/i:", "-decode",
        "-urlcache", "javascript:", "vbscript:")
| project Timestamp, DeviceName, FileName, ProcessCommandLine

// Suspicious process from temp/downloads
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FolderPath has_any ("\\Temp\\", "\\Downloads\\", 
        "\\AppData\\Local\\", "\\ProgramData\\")
| where FileName endswith ".exe"
| summarize ExecutionCount = count(), 
            Devices = dcount(DeviceName),
            Users = make_set(AccountName, 5)
  by FileName, FolderPath, SHA256
| where Devices < 3
| order by ExecutionCount desc</div>
                </div>

                <!-- Network Hunting -->
                <h2><i class="fas fa-network-wired"></i> Network Hunting</h2>
                <div class="config-section">
                    <h4>DeviceNetworkEvents</h4>
                    <div class="code-block">// External connections by process
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where RemoteIPType == "Public"
| where ActionType == "ConnectionSuccess"
| summarize ConnectionCount = count(),
            UniqueIPs = dcount(RemoteIP),
            Ports = make_set(RemotePort, 10)
  by DeviceName, InitiatingProcessFileName
| order by ConnectionCount desc

// Key fields in DeviceNetworkEvents:
// - RemoteIP: Destination IP
// - RemotePort: Destination port
// - RemoteUrl: If applicable
// - LocalIP: Source IP
// - LocalPort: Source port
// - Protocol: tcp, udp
// - ActionType: ConnectionSuccess, ConnectionFailed
// - InitiatingProcessFileName: Process making connection
// - RemoteIPType: Public, Private

// Connections to rare external IPs
let CommonIPs = DeviceNetworkEvents
| where Timestamp > ago(30d)
| where RemoteIPType == "Public"
| summarize Devices = dcount(DeviceName) by RemoteIP
| where Devices > 10
| project RemoteIP;
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemoteIPType == "Public"
| where RemoteIP !in (CommonIPs)
| summarize ConnectionCount = count(), 
            Processes = make_set(InitiatingProcessFileName, 5)
  by RemoteIP, DeviceName
| order by ConnectionCount desc</div>

                    <h4>C2 and Beaconing Detection</h4>
                    <div class="code-block">// Potential beaconing (regular intervals)
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where RemoteIPType == "Public"
| where ActionType == "ConnectionSuccess"
| summarize 
    ConnectionTimes = make_list(Timestamp, 100),
    ConnectionCount = count()
  by DeviceName, RemoteIP, InitiatingProcessFileName
| where ConnectionCount > 20
| extend Intervals = series_diff(ConnectionTimes, 1, false)
| mv-expand Intervals to typeof(timespan)
| summarize 
    AvgInterval = avg(Intervals),
    StdDevInterval = stdev(Intervals),
    Count = count()
  by DeviceName, RemoteIP, InitiatingProcessFileName
| where StdDevInterval < 60s  // Low variance = regular intervals
| where Count > 10

// Non-standard port usage
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemoteIPType == "Public"
| where RemotePort !in (80, 443, 8080, 8443, 53, 25, 587)
| where ActionType == "ConnectionSuccess"
| summarize ConnectionCount = count() 
  by RemoteIP, RemotePort, InitiatingProcessFileName
| order by ConnectionCount desc

// PowerShell making network connections
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where InitiatingProcessFileName in~ ("powershell.exe", "pwsh.exe")
| where RemoteIPType == "Public"
| project Timestamp, DeviceName, RemoteIP, RemotePort, RemoteUrl
| summarize count() by DeviceName, RemoteIP, RemotePort</div>
                </div>

                <!-- File Hunting -->
                <h2><i class="fas fa-file"></i> File Hunting</h2>
                <div class="config-section">
                    <h4>DeviceFileEvents</h4>
                    <div class="code-block">// New executables in sensitive locations
DeviceFileEvents
| where Timestamp > ago(24h)
| where ActionType == "FileCreated"
| where FolderPath has_any ("\\System32\\", "\\SysWOW64\\", 
        "\\Windows\\", "\\ProgramData\\")
| where FileName endswith ".exe" or FileName endswith ".dll"
| project Timestamp, DeviceName, FileName, FolderPath, 
          SHA256, InitiatingProcessFileName

// Key fields in DeviceFileEvents:
// - ActionType: FileCreated, FileModified, FileDeleted, FileRenamed
// - FileName: File name
// - FolderPath: Full path
// - SHA256: File hash
// - FileSize: Size in bytes
// - InitiatingProcessFileName: Process that created file

// Script files created in temp directories
DeviceFileEvents
| where Timestamp > ago(7d)
| where ActionType == "FileCreated"
| where FolderPath has_any ("\\Temp\\", "\\tmp\\")
| where FileName endswith_any (".ps1", ".bat", ".cmd", ".vbs", 
        ".js", ".hta")
| project Timestamp, DeviceName, FileName, FolderPath,
          InitiatingProcessFileName, InitiatingProcessCommandLine

// Files with double extensions
DeviceFileEvents
| where Timestamp > ago(7d)
| where ActionType == "FileCreated"
| where FileName matches regex @".*\.(pdf|doc|xls|jpg|png)\.(exe|scr|bat|cmd)$"
| project Timestamp, DeviceName, FileName, FolderPath,
          InitiatingProcessFileName</div>

                    <h4>Ransomware Indicators</h4>
                    <div class="code-block">// Mass file modifications (potential ransomware)
DeviceFileEvents
| where Timestamp > ago(1h)
| where ActionType in ("FileModified", "FileRenamed")
| summarize ModifiedFiles = count(),
            Extensions = make_set(tostring(split(FileName, ".")[-1]), 10)
  by DeviceName, bin(Timestamp, 5m)
| where ModifiedFiles > 100
| order by ModifiedFiles desc

// Suspicious file extensions (ransomware)
let RansomwareExtensions = dynamic([".encrypted", ".locked", ".crypto",
    ".crypt", ".locky", ".wcry", ".wncry", ".wncryt"]);
DeviceFileEvents
| where Timestamp > ago(24h)
| where ActionType == "FileCreated" or ActionType == "FileRenamed"
| where FileName has_any (RansomwareExtensions)
| project Timestamp, DeviceName, FileName, FolderPath,
          InitiatingProcessFileName

// Shadow copy deletion
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("vssadmin.exe", "wmic.exe", "wbadmin.exe")
| where ProcessCommandLine has_any ("delete", "shadowcopy", 
        "shadow", "resize shadowstorage")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine</div>
                </div>

                <!-- Registry Hunting -->
                <h2><i class="fas fa-key"></i> Registry Hunting</h2>
                <div class="config-section">
                    <div class="code-block">// Persistence via Run keys
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any 
        ("\\CurrentVersion\\Run", "\\CurrentVersion\\RunOnce",
         "\\CurrentVersion\\RunServices")
| project Timestamp, DeviceName, RegistryKey, RegistryValueName,
          RegistryValueData, InitiatingProcessFileName

// Key fields in DeviceRegistryEvents:
// - ActionType: RegistryValueSet, RegistryKeyCreated, RegistryKeyDeleted
// - RegistryKey: Full key path
// - RegistryValueName: Value name
// - RegistryValueData: Value data
// - RegistryValueType: REG_SZ, REG_DWORD, etc.

// Scheduled tasks via registry
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where RegistryKey has "\\Schedule\\TaskCache\\Tasks\\"
| where ActionType in ("RegistryKeyCreated", "RegistryValueSet")
| project Timestamp, DeviceName, RegistryKey, RegistryValueData,
          InitiatingProcessFileName

// Services created
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where RegistryKey has "\\Services\\"
| where RegistryValueName == "ImagePath"
| where ActionType == "RegistryValueSet"
| project Timestamp, DeviceName, RegistryKey, RegistryValueData,
          InitiatingProcessFileName

// Disabled security features
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where RegistryKey has_any 
        ("\\Windows Defender\\", "\\DisableAntiSpyware",
         "\\DisableRealtimeMonitoring", "\\DisableBehaviorMonitoring")
| project Timestamp, DeviceName, RegistryKey, RegistryValueName,
          RegistryValueData, InitiatingProcessFileName</div>
                </div>

                <!-- Identity Hunting -->
                <h2><i class="fas fa-user-shield"></i> Identity & Logon Hunting</h2>
                <div class="config-section">
                    <div class="code-block">// Failed logons followed by success (brute force)
let FailedLogons = DeviceLogonEvents
| where Timestamp > ago(24h)
| where ActionType == "LogonFailed"
| summarize FailedCount = count() by AccountName, DeviceName;
let SuccessfulLogons = DeviceLogonEvents
| where Timestamp > ago(24h)
| where ActionType == "LogonSuccess"
| summarize SuccessTime = max(Timestamp) by AccountName, DeviceName;
FailedLogons
| join SuccessfulLogons on AccountName, DeviceName
| where FailedCount > 5
| project AccountName, DeviceName, FailedCount, SuccessTime

// Lateral movement - remote logons
DeviceLogonEvents
| where Timestamp > ago(24h)
| where LogonType in ("RemoteInteractive", "Network")
| where IsLocalAdmin == true
| summarize 
    LogonCount = count(),
    Devices = make_set(DeviceName, 10)
  by AccountName
| where LogonCount > 3
| order by LogonCount desc

// Pass-the-Hash detection
DeviceLogonEvents
| where Timestamp > ago(7d)
| where LogonType == "Network"
| where Protocol == "NTLM"
| where AccountName !endswith "$"  // Exclude machine accounts
| summarize 
    LogonCount = count(),
    UniqueDevices = dcount(DeviceName),
    Devices = make_set(DeviceName, 10)
  by AccountName, RemoteIP
| where UniqueDevices > 3

// Service account abuse
DeviceLogonEvents
| where Timestamp > ago(7d)
| where AccountName startswith "svc_" or AccountName startswith "service"
| where LogonType in ("Interactive", "RemoteInteractive")
| project Timestamp, DeviceName, AccountName, LogonType, RemoteIP</div>
                </div>

                <!-- MITRE ATT&CK Hunts -->
                <h2><i class="fas fa-crosshairs"></i> MITRE ATT&CK Hunting Queries</h2>
                <div class="config-section">
                    <h4>Execution (TA0002)</h4>
                    <div class="code-block">// T1059.001 - PowerShell
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any 
        ("downloadstring", "downloadfile", "invoke-expression",
         "iex", "-enc", "bypass", "hidden")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine

// T1059.003 - Windows Command Shell
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "cmd.exe"
| where ProcessCommandLine has_any 
        ("/c", "&&", "|")
| where InitiatingProcessFileName !in ("explorer.exe", "services.exe")
| project Timestamp, DeviceName, ProcessCommandLine, 
          InitiatingProcessFileName

// T1047 - WMI Execution
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("wmic.exe", "wmiprvse.exe")
| where ProcessCommandLine has_any 
        ("process call create", "os get", "shadowcopy")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine</div>

                    <h4>Persistence (TA0003)</h4>
                    <div class="code-block">// T1053.005 - Scheduled Tasks
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("schtasks.exe", "at.exe")
| where ProcessCommandLine has "/create"
| project Timestamp, DeviceName, AccountName, ProcessCommandLine,
          InitiatingProcessFileName

// T1543.003 - Windows Service
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName == "sc.exe"
| where ProcessCommandLine has_any ("create", "config")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine

// T1547.001 - Registry Run Keys
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where RegistryKey has "\\CurrentVersion\\Run"
| where ActionType == "RegistryValueSet"
| project Timestamp, DeviceName, RegistryKey, RegistryValueData,
          InitiatingProcessFileName</div>

                    <h4>Credential Access (TA0006)</h4>
                    <div class="code-block">// T1003.001 - LSASS Memory Dump
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ ("procdump.exe", "procdump64.exe", 
        "mimikatz.exe", "dumpert.exe")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine

// LSASS access via other tools
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "SensitiveFileRead"
| where FileName == "lsass.exe"
| project Timestamp, DeviceName, InitiatingProcessFileName,
          InitiatingProcessCommandLine

// T1003.002 - SAM Database
DeviceProcessEvents
| where Timestamp > ago(7d)
| where ProcessCommandLine has_any 
        ("\\SAM", "\\SYSTEM", "\\SECURITY")
| where FileName in~ ("reg.exe", "regedit.exe")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine</div>
                </div>

                <!-- Custom Detections -->
                <h2><i class="fas fa-bell"></i> Creating Custom Detections</h2>
                <div class="config-section">
                    <p><span class="console-path">security.microsoft.com → Hunting → Custom detection rules</span></p>

                    <div class="code-block">Custom Detection Rule Creation:

STEPS:
1. Create and test hunting query
2. Click "Create detection rule"
3. Configure rule settings:
   ├── Name: Descriptive rule name
   ├── Frequency: Every hour/day/etc.
   ├── Alert title: Dynamic with variables
   ├── Severity: High/Medium/Low/Informational
   ├── Category: MITRE tactic
   ├── MITRE techniques: Map to framework
   ├── Description: What it detects
   └── Recommended actions: Response guidance

REQUIRED COLUMNS:
├── Timestamp
├── ReportId (unique event ID)
├── DeviceId or DeviceName
└── Additional context columns

EXAMPLE RULE:
// Detect encoded PowerShell execution
DeviceProcessEvents
| where Timestamp > ago(1h)
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any ("-enc", "-encodedcommand")
| project Timestamp, ReportId, DeviceId, DeviceName,
          AccountName, ProcessCommandLine,
          InitiatingProcessFileName

ALERT VARIABLES:
├── {{DeviceName}} - Affected device
├── {{AccountName}} - User account
├── {{FileName}} - Process name
└── Use in alert title/description

BEST PRACTICES:
├── Test query thoroughly before enabling
├── Start with informational severity
├── Monitor for false positives
├── Include context columns for triage
├── Set appropriate frequency
└── Document detection logic</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: What are the key tables for threat hunting in MDE?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>DeviceProcessEvents:</strong> Process execution, command lines, parent processes</li>
                                <li><strong>DeviceNetworkEvents:</strong> Network connections, IPs, ports</li>
                                <li><strong>DeviceFileEvents:</strong> File creation, modification, deletion</li>
                                <li><strong>DeviceRegistryEvents:</strong> Registry changes (persistence)</li>
                                <li><strong>DeviceLogonEvents:</strong> Authentication, lateral movement</li>
                                <li><strong>DeviceEvents:</strong> Other security events (ASR, exploit protection)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you detect encoded PowerShell?</button>
                        <div class="qa-answer">
                            <div class="code-block">DeviceProcessEvents
| where FileName in~ ("powershell.exe", "pwsh.exe")
| where ProcessCommandLine has_any 
        ("-enc", "-encodedcommand", "-e ", "frombase64string")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine</div>
                            <p>Look for -enc, -encodedcommand flags, or base64 decoding functions.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How would you hunt for lateral movement?</button>
                        <div class="qa-answer">
                            <p>Use DeviceLogonEvents to find:</p>
                            <ul>
                                <li>Remote logons (LogonType: RemoteInteractive, Network)</li>
                                <li>Admin accounts logging into multiple devices</li>
                                <li>NTLM authentication from unexpected sources</li>
                                <li>Service accounts with interactive logons</li>
                            </ul>
                            <p>Correlate with DeviceProcessEvents for PsExec, WMI, or remote PowerShell.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you create a custom detection rule from a hunting query?</button>
                        <div class="qa-answer">
                            <ol>
                                <li>Write and test hunting query</li>
                                <li>Ensure query includes: Timestamp, ReportId, DeviceId</li>
                                <li>Click "Create detection rule"</li>
                                <li>Configure: Name, frequency, severity, MITRE mapping</li>
                                <li>Define alert title (can use variables)</li>
                                <li>Set recommended actions</li>
                                <li>Enable and monitor for false positives</li>
                            </ol>
                        </div>
                    </div>
                </div>

        </main>
    </div>
    <script>
        // Q&A toggle functionality
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) { answer.style.display = 'block'; }
            });
        });
    </script>
</body>
</html>