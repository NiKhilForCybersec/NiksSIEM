<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XSOAR Automation | XSIAM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <style>
        .config-section { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; margin: 16px 0; }
        .code-block { background: #0d1117; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; font-family: 'Fira Code', monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre; }
        .console-path { background: #0d1117; padding: 8px 12px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; color: #f97316; margin: 8px 0; display: inline-block; }
    </style>
</head>
<body>
    <div class="app-container">
                                                                <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">XSIAM Platform</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                    <a href="comparison.html" class="nav-link"><i class="fas fa-balance-scale"></i> vs Competitors</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Collection</div>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion Methods</a>
                    <a href="custom-log-onboarding.html" class="nav-link"><i class="fas fa-file-import"></i> Custom Log Onboarding</a>
                    <a href="broker-vm.html" class="nav-link"><i class="fas fa-server"></i> Broker VM</a>
                    <a href="agents.html" class="nav-link"><i class="fas fa-desktop"></i> Cortex Agents</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing & XDM</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">XQL Query Language</div>
                    <a href="xql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> XQL Fundamentals</a>
                    <a href="xql-advanced.html" class="nav-link"><i class="fas fa-code"></i> XQL Advanced</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="correlation-rules.html" class="nav-link"><i class="fas fa-project-diagram"></i> Correlation Rules</a>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-skull-crossbones"></i> Threat Intelligence</a>
                    <a href="xsoar-automation.html" class="nav-link active"><i class="fas fa-robot"></i> XSOAR Automation</a>
                    <a href="xdr-overview.html" class="nav-link"><i class="fas fa-crosshairs"></i> XDR Capabilities</a>
                    <a href="recon-asm.html" class="nav-link"><i class="fas fa-globe"></i> ASM / Xpanse</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <a href="dashboards.html" class="nav-link"><i class="fas fa-chart-bar"></i> Dashboards</a>
                    <a href="retention-tiers.html" class="nav-link"><i class="fas fa-archive"></i> Retention & Storage</a>
                    <a href="marketplace.html" class="nav-link"><i class="fas fa-store"></i> Marketplace</a>
                    <a href="enterprise-soc.html" class="nav-link"><i class="fas fa-building"></i> Enterprise SOC</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">XSIAM</a><span class="separator">/</span>
                    <span class="current">XSOAR Automation</span>
                </div>
            </header>
            <main class="main-content">
                <h1><i class="fas fa-robot"></i> XSOAR Automation</h1>
                <p class="lead">XSIAM includes embedded XSOAR for security orchestration, automation, and response. Create playbooks to automate alert handling, enrichment, and response actions.</p>

                <!-- XSOAR Overview -->
                <h2><i class="fas fa-info-circle"></i> XSOAR in XSIAM</h2>
                <div class="config-section">
                    <p>XSOAR (Cortex XSOAR) is embedded within XSIAM to provide:</p>
                    <ul style="color: #8b949e;">
                        <li><strong>Playbooks:</strong> Automated workflows for alert handling</li>
                        <li><strong>Integrations:</strong> Connect to 700+ security tools</li>
                        <li><strong>Case Management:</strong> Track and manage incidents</li>
                        <li><strong>War Room:</strong> Collaborative investigation workspace</li>
                        <li><strong>Automation Scripts:</strong> Custom Python/JavaScript automation</li>
                    </ul>
                    
                    <p><span class="console-path">XSIAM → Response → Automation</span></p>
                </div>

                <!-- Playbook Fundamentals -->
                <h2><i class="fas fa-project-diagram"></i> Playbook Fundamentals</h2>
                <div class="config-section">
                    <h4>Playbook Components</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Component</th><th>Description</th><th>Example</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Trigger</strong></td>
                                <td>What starts the playbook</td>
                                <td>New incident, manual run, scheduled</td>
                            </tr>
                            <tr>
                                <td><strong>Task</strong></td>
                                <td>Individual automation step</td>
                                <td>Run command, execute script</td>
                            </tr>
                            <tr>
                                <td><strong>Conditional</strong></td>
                                <td>Decision point based on data</td>
                                <td>If malicious, then isolate</td>
                            </tr>
                            <tr>
                                <td><strong>Sub-playbook</strong></td>
                                <td>Reusable playbook module</td>
                                <td>IP enrichment playbook</td>
                            </tr>
                            <tr>
                                <td><strong>Manual Task</strong></td>
                                <td>Requires analyst action</td>
                                <td>Approve containment</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Playbook Types</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Main Playbooks:</strong> Entry point, triggered by incidents</li>
                        <li><strong>Sub-playbooks:</strong> Reusable modules called by main playbooks</li>
                        <li><strong>On-Demand:</strong> Run manually for specific tasks</li>
                    </ul>
                </div>

                <!-- Creating Playbooks -->
                <h2><i class="fas fa-plus-circle"></i> Creating Playbooks</h2>
                <div class="config-section">
                    <p><span class="console-path">Automation → Playbooks → New Playbook</span></p>

                    <h4>Playbook Design Steps</h4>
                    <ol style="color: #8b949e;">
                        <li>Define the use case (what alert/incident type?)</li>
                        <li>Map the manual process you want to automate</li>
                        <li>Identify required integrations and data</li>
                        <li>Design the workflow with tasks and conditions</li>
                        <li>Add error handling and edge cases</li>
                        <li>Test with sample incidents</li>
                    </ol>

                    <h4>Basic Playbook Structure</h4>
                    <div class="code-block">Phishing Alert Playbook:

┌──────────────────────────────────────────┐
│           Playbook Triggered             │
│         (New Phishing Alert)             │
└───────────────┬──────────────────────────┘
                │
┌───────────────▼──────────────────────────┐
│         Extract Indicators               │
│   (URLs, IPs, Hashes, Email addresses)   │
└───────────────┬──────────────────────────┘
                │
┌───────────────▼──────────────────────────┐
│          Enrich Indicators               │
│   (VirusTotal, URLhaus, MISP, etc.)      │
└───────────────┬──────────────────────────┘
                │
┌───────────────▼──────────────────────────┐
│         Check Reputation                 │
│      Is any indicator malicious?         │
└───────┬───────────────────────┬──────────┘
        │ Yes                   │ No
┌───────▼───────────┐   ┌───────▼───────────┐
│  Escalate to L2   │   │  Close as FP      │
│  Block IOCs       │   │  Update Filters   │
│  Notify User      │   │                   │
└───────────────────┘   └───────────────────┘</div>
                </div>

                <!-- Common Tasks -->
                <h2><i class="fas fa-tasks"></i> Common Automation Tasks</h2>
                <div class="config-section">
                    <h4>Enrichment Tasks</h4>
                    <div class="code-block">// IP Enrichment
!ip ip=8.8.8.8
// Returns: Geolocation, ASN, reputation

// Hash Reputation
!file file=<sha256_hash>
// Returns: VirusTotal results, threat intel hits

// Domain Reputation  
!domain domain=suspicious.com
// Returns: WHOIS, DNS, reputation scores

// URL Analysis
!url url=http://malicious.com/payload
// Returns: Screenshot, category, threat analysis

// Email Header Analysis
!ParseEmailFiles entryid=<entry_id>
// Returns: Parsed headers, attachments, indicators</div>

                    <h4>Response Tasks</h4>
                    <div class="code-block">// Isolate Endpoint (Cortex XDR)
!xdr-isolate-endpoint endpoint_id=<endpoint_id>

// Block IP (Firewall)
!pan-os-block-ip ip=1.2.3.4 log_forwarding_profile="block-log"

// Disable User (Active Directory)
!ad-disable-account username=compromised_user

// Block Hash (EDR)
!xdr-blacklist-files hash_list=<sha256_hash>

// Send Email Notification
!send-mail to="security@company.com" subject="Alert" body="Details..."

// Create Ticket (ServiceNow)
!servicenow-create-ticket short_description="Security Incident" priority=2</div>
                </div>

                <!-- Context and Outputs -->
                <h2><i class="fas fa-database"></i> Context and Data Flow</h2>
                <div class="config-section">
                    <h4>Understanding Context</h4>
                    <p style="color: #8b949e;">Context is the data storage for playbook execution. Tasks read from and write to context.</p>
                    
                    <div class="code-block">Context Structure:
{
  "incident": {
    "id": "123",
    "name": "Phishing Alert",
    "severity": 3
  },
  "IP": {
    "Address": "1.2.3.4",
    "Geo": {"Country": "US"},
    "Malicious": {"Vendor": "VirusTotal"}
  },
  "File": {
    "SHA256": "abc123...",
    "Malicious": true
  }
}</div>

                    <h4>Accessing Context in Tasks</h4>
                    <div class="code-block">// Access incident data
${incident.name}
${incident.severity}

// Access enrichment results
${IP.Address}
${IP.Geo.Country}
${File.SHA256}

// Check if malicious
${IP.Malicious}
${DBotScore.Score}  // 0=Unknown, 1=Good, 2=Suspicious, 3=Bad

// Lists
${IP.[0].Address}  // First IP in list
${.=val.IP.filter(ip => ip.Malicious)}  // Filter malicious IPs</div>

                    <h4>Task Outputs</h4>
                    <div class="code-block">Task Configuration:
- Command: !ip ip=${inputs.ip_address}
- Outputs:
  - IP.Address
  - IP.Geo.Country
  - IP.Geo.City
  - DBotScore.Score
  - DBotScore.Vendor

Using Outputs in Next Task:
- Condition: ${DBotScore.Score} == 3
- Branch: "Malicious" or "Clean"</div>
                </div>

                <!-- Conditional Logic -->
                <h2><i class="fas fa-code-branch"></i> Conditional Logic</h2>
                <div class="config-section">
                    <h4>Condition Types</h4>
                    <div class="code-block">// Check if value exists
${IP.Address}  // True if IP exists

// Compare values
${DBotScore.Score} >= 2  // Suspicious or worse

// String matching
${incident.type} == "Phishing"

// Contains check
${"malware" in incident.labels}

// Multiple conditions (AND/OR)
${DBotScore.Score} >= 3 AND ${IP.Geo.Country} != "US"

// Check list length
${IP.length} > 0</div>

                    <h4>Conditional Task Example</h4>
                    <div class="code-block">Task: Check if IP is Malicious
Type: Conditional
Conditions:
  - "yes" branch: ${DBotScore.Score} == 3
  - "suspicious" branch: ${DBotScore.Score} == 2
  - "no" branch: else (default)

Yes Branch → Block IP, Create Incident
Suspicious Branch → Escalate to Analyst
No Branch → Close Alert</div>
                </div>

                <!-- Common Playbook Patterns -->
                <h2><i class="fas fa-puzzle-piece"></i> Common Playbook Patterns</h2>
                <div class="config-section">
                    <h4>Pattern 1: Enrichment Pipeline</h4>
                    <div class="code-block">// Extract → Enrich → Analyze → Decide

1. Extract Indicators
   Task: Extract indicators from incident
   Output: IPs, Domains, Hashes, URLs

2. Enrich Each Type (parallel)
   ├─ IP Enrichment (VirusTotal, AbuseIPDB)
   ├─ Domain Enrichment (WHOIS, DNS)
   ├─ Hash Enrichment (VirusTotal, Hybrid Analysis)
   └─ URL Enrichment (URLhaus, PhishTank)

3. Calculate Risk Score
   Task: Custom script combining all scores

4. Route Based on Risk
   - High Risk → Auto-contain, escalate
   - Medium Risk → Analyst review
   - Low Risk → Auto-close</div>

                    <h4>Pattern 2: Human-in-the-Loop</h4>
                    <div class="code-block">// Auto-enrich but require human approval for action

1. Auto-Enrichment
   - Gather all context automatically

2. Present to Analyst
   Task: Create manual task with summary
   Include: All enrichment results, recommended action

3. Wait for Decision
   Task: Manual task - Analyst chooses action
   Options: "Contain", "Investigate More", "Close as FP"

4. Execute Decision
   Conditional based on analyst choice
   ├─ Contain → Isolate host, block IOCs
   ├─ Investigate → Assign to L2, gather more data
   └─ Close → Update alert, document findings</div>

                    <h4>Pattern 3: Parallel Processing</h4>
                    <div class="code-block">// Process multiple items simultaneously

1. Extract all IPs from incident
   Output: List of IPs

2. For Each IP (parallel):
   ├─ Check VirusTotal
   ├─ Check AbuseIPDB
   ├─ Check Internal Threat Intel
   └─ Check Geo Location

3. Aggregate Results
   Task: Combine all enrichment into summary

4. Single Decision Point
   Based on aggregated results</div>

                    <h4>Pattern 4: Tiered Response</h4>
                    <div class="code-block">// Different response based on severity/confidence

1. Initial Assessment
   - Check alert severity
   - Check affected asset criticality
   - Check confidence level

2. Route by Priority:
   
   Critical + High Confidence:
   ├─ Auto-isolate endpoint
   ├─ Notify SOC lead immediately
   ├─ Create P1 incident
   └─ Engage IR team
   
   High + Medium Confidence:
   ├─ Enrich thoroughly
   ├─ Analyst review required
   └─ Create P2 incident
   
   Medium/Low:
   ├─ Basic enrichment
   ├─ Queue for analyst
   └─ Standard SLA</div>
                </div>

                <!-- Integrations -->
                <h2><i class="fas fa-plug"></i> Key Integrations</h2>
                <div class="config-section">
                    <table class="styled-table">
                        <thead>
                            <tr><th>Category</th><th>Integrations</th><th>Common Commands</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Threat Intel</strong></td>
                                <td>VirusTotal, MISP, OTX, ThreatConnect</td>
                                <td>!ip, !file, !domain, !url</td>
                            </tr>
                            <tr>
                                <td><strong>EDR</strong></td>
                                <td>Cortex XDR, CrowdStrike, Carbon Black</td>
                                <td>!xdr-isolate, !cs-contain-host</td>
                            </tr>
                            <tr>
                                <td><strong>Firewall</strong></td>
                                <td>Palo Alto, Cisco, Fortinet</td>
                                <td>!pan-os-block-ip, !pan-os-block-url</td>
                            </tr>
                            <tr>
                                <td><strong>Email</strong></td>
                                <td>Microsoft 365, Google Workspace</td>
                                <td>!msgraph-mail-delete, !gmail-search</td>
                            </tr>
                            <tr>
                                <td><strong>Directory</strong></td>
                                <td>Active Directory, Azure AD, Okta</td>
                                <td>!ad-disable-account, !okta-deactivate-user</td>
                            </tr>
                            <tr>
                                <td><strong>Ticketing</strong></td>
                                <td>ServiceNow, Jira, PagerDuty</td>
                                <td>!servicenow-create-ticket, !jira-create-issue</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Error Handling -->
                <h2><i class="fas fa-exclamation-triangle"></i> Error Handling</h2>
                <div class="config-section">
                    <h4>Task Error Handling Options</h4>
                    <div class="code-block">Task Settings:
- On Error: 
  - Stop playbook (default)
  - Continue to next task
  - Go to specific task
  
- Retry:
  - Retry count: 3
  - Retry interval: 30 seconds
  
- Timeout:
  - Task timeout: 300 seconds</div>

                    <h4>Error Handling Pattern</h4>
                    <div class="code-block">1. Main Task (may fail)
   └─ On Error: Go to "Handle Error" task

2. Handle Error Task
   - Log the error
   - Set error flag in context
   - Optionally notify analyst
   
3. Check Error Flag
   Condition: ${error_occurred} == true
   ├─ Yes: Skip remaining automation, manual review
   └─ No: Continue normal flow</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Describe a playbook you would build for phishing alerts.</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Trigger:</strong> New phishing alert from email gateway</li>
                                <li><strong>Extract indicators:</strong> URLs, attachments, sender info</li>
                                <li><strong>Enrichment:</strong>
                                    <ul>
                                        <li>URL reputation (VirusTotal, URLhaus)</li>
                                        <li>Attachment hash check</li>
                                        <li>Sender domain reputation</li>
                                    </ul>
                                </li>
                                <li><strong>Decision:</strong> Based on enrichment scores</li>
                                <li><strong>Response:</strong>
                                    <ul>
                                        <li>If malicious: Block URLs/hashes, remove from mailboxes, notify user</li>
                                        <li>If suspicious: Escalate to analyst</li>
                                        <li>If clean: Close with notes</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you handle rate limiting in playbooks?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>Use sub-playbooks:</strong> Process items in batches</li>
                                <li><strong>Add delays:</strong> Sleep task between API calls</li>
                                <li><strong>Check quotas:</strong> Query remaining API quota before batch</li>
                                <li><strong>Prioritize:</strong> Only enrich high-priority indicators</li>
                                <li><strong>Cache results:</strong> Store previous lookups, reuse within timeframe</li>
                                <li><strong>Error handling:</strong> Retry with backoff on rate limit errors</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: When should automation stop and involve a human?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>High-impact actions:</strong> Host isolation, account disable</li>
                                <li><strong>Ambiguous results:</strong> Medium confidence scores</li>
                                <li><strong>VIP assets:</strong> Executive devices, critical servers</li>
                                <li><strong>Novel threats:</strong> Unknown malware, new TTPs</li>
                                <li><strong>Business context:</strong> May impact operations</li>
                                <li><strong>Legal/compliance:</strong> Data handling, evidence preservation</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Rule:</strong> Automate enrichment aggressively, automate response cautiously.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>

                <!-- Custom Scripts -->
                <h2><i class="fas fa-code"></i> Custom Automation Scripts</h2>
                <div class="config-section">
                    <p>Write custom Python or JavaScript scripts for specialized automation.</p>
                    <p><span class="console-path">Automation → Scripts → New Script</span></p>

                    <h4>Python Script Structure</h4>
                    <div class="code-block">import demistomock as demisto
from CommonServerPython import *

def main():
    try:
        # Get arguments passed to script
        args = demisto.args()
        ip_address = args.get('ip')
        
        # Your logic here
        result = check_ip_reputation(ip_address)
        
        # Return results to context
        return_results(CommandResults(
            outputs_prefix='CustomEnrichment',
            outputs_key_field='ip',
            outputs={
                'ip': ip_address,
                'score': result['score'],
                'malicious': result['score'] >= 80
            },
            readable_output=tableToMarkdown('IP Enrichment', result)
        ))
        
    except Exception as e:
        return_error(f'Failed to execute: {str(e)}')

if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()</div>

                    <h4>Common Script Functions</h4>
                    <div class="code-block"># Get incident data
incident = demisto.incident()
incident_id = incident.get('id')
severity = incident.get('severity')

# Get context data
context = demisto.context()
ips = context.get('IP', [])

# Execute another command
result = demisto.executeCommand('ip', {'ip': '8.8.8.8'})

# Set context data
demisto.setContext('CustomField', 'value')

# Create human-readable output
table = tableToMarkdown('Results', data, headers=['IP', 'Score'])

# Return error
return_error('Something went wrong')

# Return warning
return_warning('Partial results returned')</div>

                    <h4>Example: Calculate Risk Score</h4>
                    <div class="code-block">import demistomock as demisto
from CommonServerPython import *

def calculate_risk_score():
    """Calculate composite risk score from multiple enrichment sources"""
    
    context = demisto.context()
    
    # Get DBotScores from context
    dbot_scores = context.get('DBotScore', [])
    if not isinstance(dbot_scores, list):
        dbot_scores = [dbot_scores]
    
    # Calculate weighted score
    total_score = 0
    weight_sum = 0
    
    vendor_weights = {
        'VirusTotal': 3,
        'AbuseIPDB': 2,
        'AlienVault OTX': 2,
        'Internal TI': 4
    }
    
    for score in dbot_scores:
        vendor = score.get('Vendor', 'Unknown')
        weight = vendor_weights.get(vendor, 1)
        total_score += score.get('Score', 0) * weight
        weight_sum += weight
    
    if weight_sum > 0:
        final_score = (total_score / weight_sum) * 33.33  # Normalize to 100
    else:
        final_score = 0
    
    # Determine risk level
    if final_score >= 80:
        risk_level = 'Critical'
    elif final_score >= 60:
        risk_level = 'High'
    elif final_score >= 40:
        risk_level = 'Medium'
    else:
        risk_level = 'Low'
    
    return_results(CommandResults(
        outputs_prefix='RiskAssessment',
        outputs={
            'Score': round(final_score, 2),
            'Level': risk_level,
            'SourceCount': len(dbot_scores)
        }
    ))

if __name__ in ('__main__', '__builtin__', 'builtins'):
    calculate_risk_score()</div>
                </div>

                <!-- Lists and Indicators -->
                <h2><i class="fas fa-list"></i> Indicator Management</h2>
                <div class="config-section">
                    <h4>Working with Indicators</h4>
                    <div class="code-block"># Create indicator
!createNewIndicator type=IP value=1.2.3.4 source="Playbook" 
    reputation=Bad tags="blocklist,malware-c2"

# Search indicators
!findIndicators query="type:IP and reputation:Bad" size=100

# Update indicator
!setIndicator value=1.2.3.4 reputation=Good comment="False positive"

# Add to exclusion list
!createNewIndicator type=IP value=8.8.8.8 reputation=Good 
    tags="known-good,dns" source="Allowlist"

# Get indicator timeline
!indicatorTimeline value=1.2.3.4</div>

                    <h4>Indicator Lifecycle</h4>
                    <div class="code-block">Indicator Flow:
1. Extraction: Indicators extracted from alerts/incidents
2. Deduplication: Check if indicator already exists
3. Enrichment: Automatic enrichment based on type
4. Scoring: Calculate reputation score
5. Expiration: Auto-expire after configured time

Expiration Settings:
- IP addresses: 30 days
- Domains: 90 days
- File hashes: 180 days
- URLs: 14 days</div>
                </div>

                <!-- Incident Types and Layouts -->
                <h2><i class="fas fa-th-large"></i> Incident Types and Layouts</h2>
                <div class="config-section">
                    <h4>Custom Incident Types</h4>
                    <div class="code-block">Incident Type Configuration:
- Name: Phishing
- Default Playbook: Phishing Investigation
- Default Severity: Medium
- SLA: 4 hours
- Pre-processing Rules:
  - Extract email indicators
  - Set initial severity based on VIP list
  - Auto-assign to phishing queue

Custom Fields:
- Reported By (user)
- Email Subject (text)
- Attachment Count (number)
- Links Clicked (boolean)
- User Department (dropdown)
- Remediation Status (dropdown)</div>

                    <h4>Layout Customization</h4>
                    <div class="code-block">Incident Layout Sections:
1. Summary Card
   - Key metrics at a glance
   - Severity, status, assignee, SLA

2. Investigation Tab
   - Indicators extracted
   - Enrichment results
   - Timeline of events

3. Response Tab
   - Actions taken
   - Containment status
   - Communication log

4. Related Items Tab
   - Similar incidents
   - Related indicators
   - Affected assets

5. Evidence Tab
   - Attached files
   - Screenshots
   - Analyst notes</div>
                </div>

                <!-- Pre/Post Processing -->
                <h2><i class="fas fa-filter"></i> Pre and Post Processing</h2>
                <div class="config-section">
                    <h4>Pre-Processing Rules</h4>
                    <div class="code-block">Pre-Processing runs BEFORE incident creation:

Rule: Auto-Close Known FP
Condition: source_ip IN ${lists.known_scanners}
Action: Drop (don't create incident)

Rule: Set VIP Severity
Condition: affected_user IN ${lists.vip_users}
Action: Set severity = Critical

Rule: Route by Type
Condition: alert_type == "Malware"
Action: Set incident_type = "Malware Investigation"
        Set playbook = "Malware Triage"

Rule: Deduplicate
Condition: Same source_ip + dest_ip in last 5 minutes
Action: Link to existing incident</div>

                    <h4>Post-Processing Rules</h4>
                    <div class="code-block">Post-Processing runs AFTER playbook completes:

Rule: Create Ticket on Escalation
Condition: severity == "Critical" AND status == "Escalated"
Action: Run command !servicenow-create-ticket

Rule: Update Threat Intel
Condition: disposition == "True Positive"
Action: Add indicators to blocklist

Rule: Metrics Collection
Condition: status == "Closed"
Action: Log MTTR, resolution type to metrics</div>
                </div>

                <!-- Best Practices -->
                <h2><i class="fas fa-check-double"></i> Automation Best Practices</h2>
                <div class="config-section">
                    <h4>Playbook Design</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Modular design:</strong> Use sub-playbooks for reusable components</li>
                        <li><strong>Error handling:</strong> Always handle failures gracefully</li>
                        <li><strong>Documentation:</strong> Add descriptions to tasks</li>
                        <li><strong>Testing:</strong> Test with real incidents before production</li>
                        <li><strong>Version control:</strong> Export playbooks to Git</li>
                    </ul>

                    <h4>Performance Optimization</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Parallel execution:</strong> Run independent tasks simultaneously</li>
                        <li><strong>Minimize API calls:</strong> Batch requests when possible</li>
                        <li><strong>Use filters:</strong> Only process relevant indicators</li>
                        <li><strong>Set timeouts:</strong> Prevent runaway tasks</li>
                        <li><strong>Cache results:</strong> Reuse recent enrichment data</li>
                    </ul>

                    <h4>Security Considerations</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Credential management:</strong> Use integration credentials, not hardcoded</li>
                        <li><strong>Least privilege:</strong> Only grant necessary permissions</li>
                        <li><strong>Audit logging:</strong> Log all automated actions</li>
                        <li><strong>Approval gates:</strong> Require approval for destructive actions</li>
                        <li><strong>Input validation:</strong> Sanitize inputs in custom scripts</li>
                    </ul>
                </div>

                <!-- Metrics and Reporting -->
                <h2><i class="fas fa-chart-pie"></i> Automation Metrics</h2>
                <div class="config-section">
                    <h4>Key Metrics to Track</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Metric</th><th>Description</th><th>Target</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Automation Rate</td>
                                <td>% incidents fully automated</td>
                                <td>> 60%</td>
                            </tr>
                            <tr>
                                <td>MTTR Reduction</td>
                                <td>Time saved vs manual process</td>
                                <td>> 50%</td>
                            </tr>
                            <tr>
                                <td>Playbook Success Rate</td>
                                <td>% runs completing without error</td>
                                <td>> 95%</td>
                            </tr>
                            <tr>
                                <td>Enrichment Coverage</td>
                                <td>% indicators auto-enriched</td>
                                <td>> 90%</td>
                            </tr>
                            <tr>
                                <td>False Positive Auto-Close</td>
                                <td>% FPs closed without analyst</td>
                                <td>> 70%</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Dashboard Widgets</h4>
                    <div class="code-block">Recommended XSOAR Dashboard:
1. Incidents by Status (pie chart)
2. MTTR Trend (line chart)
3. Playbook Execution Summary (bar chart)
4. Top Failed Tasks (table)
5. Analyst Workload (stacked bar)
6. Automation Savings (number widget)</div>
                </div>

                <!-- Example Playbooks -->
                <h2><i class="fas fa-clipboard-list"></i> Example Playbook: Malware Alert</h2>
                <div class="config-section">
                    <div class="code-block">Playbook: Malware Alert Response
Trigger: New malware detection alert

┌─────────────────────────────────────────────────────┐
│  1. Extract File Hash                               │
│     Task: ExtractIndicatorsFromIncident             │
│     Output: File.SHA256                             │
└────────────────────────┬────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────┐
│  2. Enrich File Hash (Parallel)                     │
│     ├─ VirusTotal: !file file=${File.SHA256}        │
│     ├─ Hybrid Analysis: !hybrid-analysis-search     │
│     └─ Internal TI: !search-indicators              │
└────────────────────────┬────────────────────────────┘
                         │
┌────────────────────────▼────────────────────────────┐
│  3. Check Detection Count                           │
│     Condition: ${VirusTotal.Detection} > 5          │
└───────────┬─────────────────────────────┬───────────┘
            │ Yes (Malicious)             │ No
┌───────────▼───────────┐     ┌───────────▼───────────┐
│  4a. Get Endpoint      │     │  4b. Close as FP      │
│      Context           │     │      Document reason  │
│  !xdr-get-endpoints    │     └───────────────────────┘
└───────────┬───────────┘
            │
┌───────────▼───────────────────────────────────────┐
│  5. Check if Executed                              │
│     Task: Analyze XDR alerts for execution         │
│     Condition: ${executed} == true                 │
└───────────┬─────────────────────────────┬─────────┘
            │ Executed                     │ Not Executed
┌───────────▼───────────┐     ┌───────────▼───────────┐
│  6a. Isolate Endpoint │     │  6b. Block Hash Only  │
│  !xdr-isolate-endpoint│     │  !xdr-blocklist-file  │
│  Notify SOC Lead      │     │  Remove file          │
└───────────┬───────────┘     └───────────┬───────────┘
            │                             │
┌───────────▼─────────────────────────────▼─────────┐
│  7. Search for Same Hash Across Environment       │
│     !xdr-get-incidents query="file_hash:${hash}"  │
└───────────────────────────┬───────────────────────┘
                            │
┌───────────────────────────▼───────────────────────┐
│  8. Generate Report                               │
│     Include: Timeline, affected hosts, actions    │
│     Notify: SOC team, affected user's manager     │
└───────────────────────────────────────────────────┘</div>
                </div>

                <!-- More Interview Questions -->
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you measure the success of automation?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>Time savings:</strong> Compare MTTR before/after automation</li>
                                <li><strong>Volume handled:</strong> Incidents processed without human intervention</li>
                                <li><strong>Error rate:</strong> Playbook failures and exceptions</li>
                                <li><strong>Analyst satisfaction:</strong> Reduction in repetitive tasks</li>
                                <li><strong>Coverage:</strong> % of alert types with automated response</li>
                                <li><strong>Accuracy:</strong> False positive rate of automated decisions</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between XSOAR and a SIEM?</button>
                        <div class="qa-answer">
                            <table class="styled-table">
                                <thead>
                                    <tr><th>Aspect</th><th>SIEM</th><th>SOAR (XSOAR)</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Primary Purpose</td><td>Log collection, detection</td><td>Automation, orchestration</td></tr>
                                    <tr><td>Data</td><td>Stores and searches logs</td><td>Orchestrates actions</td></tr>
                                    <tr><td>Output</td><td>Alerts</td><td>Automated responses</td></tr>
                                    <tr><td>Integration Focus</td><td>Data sources</td><td>Response tools</td></tr>
                                    <tr><td>Case Management</td><td>Basic</td><td>Full workflow</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 12px;">XSIAM combines both: SIEM detection + SOAR response in one platform.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>

                <!-- Custom Scripts -->
                <h2><i class="fas fa-code"></i> Custom Automation Scripts</h2>
                <div class="config-section">
                    <p>Write custom scripts in Python or JavaScript for complex automation logic.</p>
                    <p><span class="console-path">Automation → Scripts → New Script</span></p>

                    <h4>Python Script Structure</h4>
                    <div class="code-block">import demistomock as demisto
from CommonServerPython import *

def main():
    try:
        # Get arguments passed to script
        args = demisto.args()
        ip_address = args.get('ip')
        
        # Your logic here
        result = analyze_ip(ip_address)
        
        # Return results to playbook
        return_results(CommandResults(
            outputs_prefix='CustomAnalysis',
            outputs_key_field='ip',
            outputs={
                'ip': ip_address,
                'risk_score': result['score'],
                'verdict': result['verdict']
            },
            readable_output=f"Analysis for {ip_address}: {result['verdict']}"
        ))
        
    except Exception as e:
        return_error(f'Error: {str(e)}')

if __name__ in ('__main__', '__builtin__', 'builtins'):
    main()</div>

                    <h4>Common Script Use Cases</h4>
                    <div class="code-block"># Calculate composite risk score
def calculate_risk_score():
    indicators = demisto.context.get('IP', [])
    if not isinstance(indicators, list):
        indicators = [indicators]
    
    total_score = 0
    for ip in indicators:
        vt_score = ip.get('VirusTotal', {}).get('score', 0)
        abuse_score = ip.get('AbuseIPDB', {}).get('score', 0)
        total_score += (vt_score * 0.6) + (abuse_score * 0.4)
    
    return total_score / len(indicators) if indicators else 0

# Deduplicate indicators
def dedupe_indicators():
    ips = demisto.context.get('ExtractedIPs', [])
    unique_ips = list(set(ips))
    return unique_ips

# Format for blocking
def format_block_list():
    malicious_ips = demisto.context.get('MaliciousIPs', [])
    # Format for firewall import
    formatted = '\n'.join([f"deny ip any host {ip}" for ip in malicious_ips])
    return formatted</div>

                    <h4>Working with Context</h4>
                    <div class="code-block"># Read from context
incident = demisto.incident()
incident_id = incident.get('id')
severity = incident.get('severity')

# Read specific context path
ips = demisto.context.get('IP')
dbot_scores = demisto.context.get('DBotScore')

# Write to context
demisto.setContext('CustomField', 'value')

# Execute command from script
result = demisto.executeCommand('ip', {'ip': '8.8.8.8'})

# Get results from command
if result and not isError(result[0]):
    contents = result[0].get('Contents', {})
    ip_data = contents.get('Address')</div>
                </div>

                <!-- Playbook Examples -->
                <h2><i class="fas fa-book"></i> Complete Playbook Examples</h2>
                <div class="config-section">
                    <h4>Malware Alert Response Playbook</h4>
                    <div class="code-block">Playbook: Malware Alert Auto-Response
Trigger: Incident Type = "Malware"

Tasks:
1. Extract Hash (Built-in)
   └─ Get file hash from alert

2. Check Hash Reputation (Parallel)
   ├─ !file file=${File.SHA256} using=VirusTotal
   ├─ !file file=${File.SHA256} using=HybridAnalysis
   └─ !xdr-file-quarantine-status file_hash=${File.SHA256}

3. Conditional: Is Malicious?
   Condition: ${DBotScore.Score} == 3
   
   YES Branch:
   4a. Get Affected Endpoints
       !xdr-get-endpoints hash=${File.SHA256}
   
   5a. Isolate Endpoints (Loop)
       For each endpoint:
       !xdr-isolate-endpoint endpoint_id=${endpoint.id}
   
   6a. Block Hash Globally
       !xdr-blacklist-files hash=${File.SHA256}
   
   7a. Create High Priority Incident
       Set severity = Critical
       Assign to IR team
   
   NO Branch:
   4b. Check if Suspicious
       Condition: ${DBotScore.Score} == 2
       
       YES: Escalate to analyst for review
       NO: Close as false positive

8. Generate Report
   Create investigation summary with all findings</div>

                    <h4>User Account Compromise Playbook</h4>
                    <div class="code-block">Playbook: Account Compromise Response
Trigger: Alert contains "Impossible Travel" OR "Compromised Credentials"

Tasks:
1. Get User Details
   !ad-get-user username=${incident.user}
   Output: User info, groups, last login

2. Check User Risk (Parallel)
   ├─ !azure-ad-get-user-risk user=${incident.user}
   ├─ Recent login history
   └─ Recent MFA challenges

3. Conditional: Confirmed Compromise?
   Based on: Multiple indicators, high confidence

   CONFIRMED Branch:
   4a. Disable Account
       !ad-disable-account username=${incident.user}
   
   5a. Revoke Sessions
       !azure-ad-revoke-user-sessions user=${incident.user}
   
   6a. Reset Password (Generate temp)
       !ad-reset-password username=${incident.user}
   
   7a. Notify User's Manager
       !send-mail to=${user.manager.email}
       Subject: "Account Security Action Required"
   
   8a. Block Source IP
       !pan-os-block-ip ip=${incident.src_ip}
   
   UNCONFIRMED Branch:
   4b. Request MFA Verification
       Send challenge to user
   
   5b. Wait for Response (Manual task)
       Analyst reviews user response
   
   6b. Take action based on response

9. Document Actions
   Update incident with all response actions taken

10. Schedule Follow-up
    Create task for password reset follow-up in 24h</div>
                </div>

                <!-- Sub-Playbooks -->
                <h2><i class="fas fa-cubes"></i> Reusable Sub-Playbooks</h2>
                <div class="config-section">
                    <h4>IP Enrichment Sub-Playbook</h4>
                    <div class="code-block">Sub-Playbook: Enrich IP Address
Inputs: IP (required)
Outputs: IP.Enriched, IP.Verdict

Tasks:
1. Validate IP Format
   Skip if not valid IP

2. Enrichment (Parallel - continue on error)
   ├─ VirusTotal: !ip ip=${inputs.IP}
   ├─ AbuseIPDB: !abuseipdb-check-ip ip=${inputs.IP}
   ├─ GreyNoise: !greynoise-ip ip=${inputs.IP}
   ├─ Shodan: !shodan-ip ip=${inputs.IP}
   └─ Internal TI: !misp-search value=${inputs.IP}

3. Calculate Verdict
   Script: Calculate composite score from all sources
   Output: IP.Verdict (Malicious/Suspicious/Clean)

4. Set Outputs
   IP.Enriched = Full enrichment data
   IP.Verdict = Calculated verdict</div>

                    <h4>Domain Enrichment Sub-Playbook</h4>
                    <div class="code-block">Sub-Playbook: Enrich Domain
Inputs: Domain (required)
Outputs: Domain.Enriched, Domain.Verdict

Tasks:
1. Validate Domain Format

2. WHOIS Lookup
   !whois domain=${inputs.Domain}
   Check: Registration date, registrar

3. DNS Resolution
   !dns domain=${inputs.Domain}
   Get: A, MX, NS, TXT records

4. Reputation Check (Parallel)
   ├─ VirusTotal
   ├─ URLhaus
   ├─ PhishTank
   └─ Internal blocklist

5. Calculate Age
   Script: Days since registration
   Flag if < 30 days (newly registered)

6. Determine Verdict
   Based on: Reputation + Age + DNS patterns</div>

                    <h4>File Analysis Sub-Playbook</h4>
                    <div class="code-block">Sub-Playbook: Analyze File
Inputs: FileHash (SHA256), FileName (optional)
Outputs: File.Analysis, File.Verdict

Tasks:
1. Hash Reputation (Parallel)
   ├─ VirusTotal
   ├─ Hybrid Analysis
   └─ Internal malware DB

2. Conditional: Known Malicious?
   If DBotScore == 3: Set verdict, skip sandbox
   
3. Sandbox Detonation (if unknown)
   !wildfire-upload upload=${inputs.FileHash}
   Wait for analysis (timeout: 10 min)

4. Parse Sandbox Results
   Extract: Behaviors, network IOCs, dropped files

5. Aggregate Findings
   Combine static and dynamic analysis

6. Set Final Verdict
   Malicious / Suspicious / Clean</div>
                </div>

                <!-- Metrics and Optimization -->
                <h2><i class="fas fa-chart-line"></i> Automation Metrics</h2>
                <div class="config-section">
                    <h4>Key Metrics to Track</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Metric</th><th>Target</th><th>Why It Matters</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Auto-Close Rate</td>
                                <td>30-50%</td>
                                <td>Measures effective FP filtering</td>
                            </tr>
                            <tr>
                                <td>Mean Time to Enrich</td>
                                <td>< 2 min</td>
                                <td>Speed of context gathering</td>
                            </tr>
                            <tr>
                                <td>Playbook Success Rate</td>
                                <td>> 95%</td>
                                <td>Reliability of automation</td>
                            </tr>
                            <tr>
                                <td>Auto-Remediation Rate</td>
                                <td>10-30%</td>
                                <td>Full automation capability</td>
                            </tr>
                            <tr>
                                <td>Analyst Time Saved</td>
                                <td>Track hours/week</td>
                                <td>ROI of automation</td>
                            </tr>
                        </tbody>
                    </table>

                    <h4>Optimization Strategies</h4>
                    <ul style="color: #8b949e;">
                        <li><strong>Reduce API calls:</strong> Cache results, batch requests</li>
                        <li><strong>Parallel execution:</strong> Run independent tasks simultaneously</li>
                        <li><strong>Early termination:</strong> Exit early if verdict is clear</li>
                        <li><strong>Error handling:</strong> Continue on non-critical failures</li>
                        <li><strong>Timeout management:</strong> Set appropriate timeouts per task</li>
                    </ul>
                </div>

                <!-- Best Practices -->
                <h2><i class="fas fa-star"></i> Automation Best Practices</h2>
                <div class="config-section">
                    <div class="code-block">1. START SMALL
   - Automate enrichment first (low risk)
   - Add response actions gradually
   - Require approval for high-impact actions initially

2. TEST THOROUGHLY
   - Use test incidents before production
   - Test all conditional branches
   - Verify error handling works

3. DOCUMENT EVERYTHING
   - Add descriptions to all tasks
   - Document inputs/outputs
   - Explain conditional logic

4. MONITOR AND ITERATE
   - Track playbook execution stats
   - Review failures regularly
   - Optimize based on performance data

5. MAINTAIN HUMAN OVERSIGHT
   - Critical actions need approval
   - Provide easy override options
   - Alert on automation failures

6. VERSION CONTROL
   - Export playbooks regularly
   - Track changes
   - Test before promoting to production</div>
                </div>

                <!-- Additional Interview Questions -->
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you measure the success of security automation?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>Time savings:</strong> Analyst hours saved per week</li>
                                <li><strong>Coverage:</strong> % of alerts with automated enrichment</li>
                                <li><strong>Speed:</strong> Reduction in MTTD and MTTR</li>
                                <li><strong>Quality:</strong> Consistent enrichment, fewer missed detections</li>
                                <li><strong>Volume:</strong> Ability to handle more alerts without adding staff</li>
                                <li><strong>Reliability:</strong> Playbook success rate, uptime</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What are common automation failures and how do you handle them?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>API rate limits:</strong> Implement backoff, caching, prioritization</li>
                                <li><strong>Integration timeouts:</strong> Set appropriate timeouts, retry logic</li>
                                <li><strong>Data format changes:</strong> Validate inputs, handle missing fields</li>
                                <li><strong>Authentication failures:</strong> Monitor credential expiration, alert on auth errors</li>
                                <li><strong>Context overflow:</strong> Clean up context, limit data stored</li>
                            </ul>
                            <p style="margin-top: 12px;"><strong>Key:</strong> Always have fallback to manual process when automation fails.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>
