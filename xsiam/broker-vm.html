<!DOCTYPE html>
<html lang="en" data-theme="dark" data-platform="xsiam">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker VM Setup & Configuration | XSIAM | Nik's SIEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">SIEM Reference Guide</span>
                    </div>
                </a>
            </div>
            <div class="platform-selector">
                <div class="platform-tabs">
                    <a href="../xsiam/index.html" class="platform-tab xsiam active"><i class="fas fa-fire"></i> XSIAM</a>
                    <a href="../sentinel/index.html" class="platform-tab sentinel"><i class="fas fa-shield-alt"></i> Sentinel</a>
                    <a href="../splunk/index.html" class="platform-tab splunk"><i class="fas fa-search"></i> Splunk</a>
                    <a href="../mde/index.html" class="platform-tab mde"><i class="fas fa-desktop"></i> MDE</a>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Getting Started</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="architecture.html" class="nav-link"><i class="fas fa-sitemap"></i> Architecture</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Data Ingestion</div>
                    <a href="data-ingestion.html" class="nav-link"><i class="fas fa-database"></i> Ingestion Methods</a>
                    <a href="parsing-flows.html" class="nav-link"><i class="fas fa-stream"></i> Parsing Flows</a>
                    <a href="retention-tiers.html" class="nav-link"><i class="fas fa-archive"></i> Retention Tiers</a>
                    <a href="broker-vm.html" class="nav-link active"><i class="fas fa-server"></i> Broker VM Setup</a>
                    <a href="marketplace.html" class="nav-link"><i class="fas fa-store"></i> Marketplace</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">XQL Query Language</div>
                    <a href="xql-fundamentals.html" class="nav-link"><i class="fas fa-terminal"></i> XQL Fundamentals</a>
                    <a href="xql-advanced.html" class="nav-link"><i class="fas fa-code"></i> Advanced XQL</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Response</div>
                    <a href="xdr-overview.html" class="nav-link"><i class="fas fa-shield-virus"></i> XDR Detection</a>
                    <a href="correlation-rules.html" class="nav-link"><i class="fas fa-project-diagram"></i> Correlation Rules</a>
                    <a href="xsoar-automation.html" class="nav-link"><i class="fas fa-robot"></i> XSOAR Automation</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Threat Intelligence</div>
                    <a href="threat-intel.html" class="nav-link"><i class="fas fa-crosshairs"></i> Threat Intel</a>
                    <a href="recon-asm.html" class="nav-link"><i class="fas fa-globe"></i> Recon & ASM</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reference</div>
                    <a href="comparison.html" class="nav-link"><i class="fas fa-balance-scale"></i> Platform Comparison</a>
                    <a href="dashboards.html" class="nav-link"><i class="fas fa-chart-line"></i> Dashboards</a>
                </div>
            </nav>
        </aside>
        
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a>
                    <span class="separator">/</span>
                    <a href="index.html">XSIAM</a>
                    <span class="separator">/</span>
                    <span class="current">Broker VM Setup</span>
                </div>
            </header>
            
            <main class="main-content">
                <h1><i class="fas fa-server"></i> Broker VM Setup & Configuration</h1>
                <p class="lead">The Broker VM is XSIAM's on-premises data collector that bridges your internal network with the cloud platform, enabling syslog collection, database queries, and local data aggregation.</p>
                
                <div class="concept-box">
                    <h3><i class="fas fa-question-circle"></i> What is a Broker VM?</h3>
                    <p>A <strong>Broker VM</strong> is a Linux virtual machine deployed in your environment that:</p>
                    <ul>
                        <li>Receives syslog and other log data from on-premises sources</li>
                        <li>Establishes secure outbound connections to XSIAM cloud</li>
                        <li>Performs local buffering during network outages</li>
                        <li>Executes database queries for log collection</li>
                        <li>Handles file-based log ingestion</li>
                    </ul>
                    <div class="memory-trick">
                        <h4><i class="fas fa-brain"></i> Memory Trick: "Broker = Bridge + Buffer"</h4>
                        <p>The Broker VM acts as a bridge between your internal network and XSIAM cloud, while also buffering data during connectivity issues.</p>
                    </div>
                </div>
                
                <h2><i class="fas fa-sitemap"></i> Architecture Overview</h2>
                
                <div class="diagram-box">
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          BROKER VM ARCHITECTURE                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ON-PREMISES NETWORK                          XSIAM CLOUD                      │
│   ─────────────────────                        ────────────                      │
│                                                                                  │
│   ┌─────────────────┐                         ┌─────────────────┐               │
│   │   Firewalls     │                         │                 │               │
│   │   (Syslog)      │──┐                      │    XSIAM        │               │
│   └─────────────────┘  │                      │    Data Lake    │               │
│                        │    ┌────────────┐    │                 │               │
│   ┌─────────────────┐  │    │            │    │                 │               │
│   │   Servers       │──┼───▶│  BROKER VM │═══▶│    Parsing      │               │
│   │   (Syslog)      │  │    │            │    │    Engine       │               │
│   └─────────────────┘  │    │  - Syslog  │    │                 │               │
│                        │    │  - DB Query│    │    Analytics    │               │
│   ┌─────────────────┐  │    │  - Files   │    │    Engine       │               │
│   │   Databases     │──┘    │  - Buffer  │    │                 │               │
│   │   (JDBC/ODBC)   │       │            │    └─────────────────┘               │
│   └─────────────────┘       └────────────┘                                      │
│                                    │                                             │
│                             HTTPS Port 443                                       │
│                           (Outbound Only)                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                </div>
                
                <h2><i class="fas fa-cogs"></i> System Requirements</h2>
                
                <h3>Hardware Requirements</h3>
                <div class="styled-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Deployment Size</th>
                                <th>vCPU</th>
                                <th>RAM</th>
                                <th>Storage</th>
                                <th>EPS Capacity</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Small</strong></td>
                                <td>4 cores</td>
                                <td>16 GB</td>
                                <td>500 GB SSD</td>
                                <td>Up to 5,000 EPS</td>
                            </tr>
                            <tr>
                                <td><strong>Medium</strong></td>
                                <td>8 cores</td>
                                <td>32 GB</td>
                                <td>1 TB SSD</td>
                                <td>Up to 15,000 EPS</td>
                            </tr>
                            <tr>
                                <td><strong>Large</strong></td>
                                <td>16 cores</td>
                                <td>64 GB</td>
                                <td>2 TB SSD</td>
                                <td>Up to 50,000 EPS</td>
                            </tr>
                            <tr>
                                <td><strong>Enterprise</strong></td>
                                <td>32 cores</td>
                                <td>128 GB</td>
                                <td>4 TB SSD</td>
                                <td>Up to 100,000+ EPS</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h3>Software Requirements</h3>
                <div class="info-box">
                    <ul>
                        <li><strong>Operating System:</strong> Ubuntu 20.04 LTS or 22.04 LTS (recommended), RHEL 8.x, CentOS 8.x</li>
                        <li><strong>Docker:</strong> Version 20.10+ (required for containerized services)</li>
                        <li><strong>Python:</strong> Version 3.8+ (for custom collectors)</li>
                        <li><strong>Network:</strong> Static IP, DNS resolution, NTP synchronization</li>
                    </ul>
                </div>
                
                <h2><i class="fas fa-download"></i> Installation Process</h2>
                
                <h3>Step 1: Generate Installation Token</h3>
                <div class="code-block">
                    <div class="code-header">XSIAM Console</div>
                    <pre>1. Navigate to: Settings → Data Sources → Broker VM
2. Click "Add Broker VM"
3. Enter a descriptive name (e.g., "DC-NYC-Broker-01")
4. Select region closest to deployment location
5. Copy the generated installation token</pre>
                </div>
                
                <h3>Step 2: Prepare the VM</h3>
                <div class="code-block">
                    <div class="code-header">Ubuntu VM Preparation</div>
                    <pre># Update system packages
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Install required packages
sudo apt install -y curl wget net-tools ntp

# Configure NTP
sudo systemctl enable ntp
sudo systemctl start ntp

# Verify time sync
ntpq -p

# Configure firewall (if enabled)
sudo ufw allow 514/udp    # Syslog UDP
sudo ufw allow 514/tcp    # Syslog TCP
sudo ufw allow 6514/tcp   # Syslog TLS
sudo ufw allow out 443/tcp # HTTPS outbound</pre>
                </div>
                
                <h3>Step 3: Install Broker VM</h3>
                <div class="code-block">
                    <div class="code-header">Broker VM Installation</div>
                    <pre># Download installer
curl -O https://downloads.paloaltonetworks.com/broker/broker-vm-installer.sh

# Make executable
chmod +x broker-vm-installer.sh

# Run installer with token from Step 1
sudo ./broker-vm-installer.sh --token "YOUR_INSTALLATION_TOKEN"

# Verify installation
sudo docker ps | grep broker

# Check broker status
sudo /opt/broker/bin/broker-ctl status</pre>
                </div>
                
                <h3>Step 4: Verify Connectivity</h3>
                <div class="code-block">
                    <div class="code-header">Connectivity Verification</div>
                    <pre># Test connection to XSIAM cloud
sudo /opt/broker/bin/broker-ctl test-connection

# View broker logs
sudo docker logs broker-core -f

# Check data flow
sudo /opt/broker/bin/broker-ctl stats

# Expected output:
# Connection Status: Connected
# Uptime: 00:15:32
# Events Received: 12,456
# Events Forwarded: 12,450
# Buffer Usage: 2%</pre>
                </div>
                
                <h2><i class="fas fa-plug"></i> Configuring Data Sources</h2>
                
                <h3>Syslog Collector Configuration</h3>
                <div class="code-block">
                    <div class="code-header">syslog-config.yaml</div>
                    <pre># /opt/broker/config/syslog-config.yaml

listeners:
  - name: "firewall-syslog"
    protocol: udp
    port: 514
    vendor: "palo_alto"
    product: "ngfw"
    
  - name: "secure-syslog"
    protocol: tcp
    port: 6514
    tls:
      enabled: true
      cert: "/opt/broker/certs/server.crt"
      key: "/opt/broker/certs/server.key"
    vendor: "generic"
    
  - name: "linux-servers"
    protocol: udp
    port: 1514
    vendor: "linux"
    product: "syslog"

# Message size limits
max_message_size: 65536

# Buffer settings
buffer:
  max_size_mb: 5000
  flush_interval_sec: 10</pre>
                </div>
                
                <h3>Database Collector Configuration</h3>
                <div class="code-block">
                    <div class="code-header">db-collector-config.yaml</div>
                    <pre># /opt/broker/config/db-collector.yaml

collectors:
  - name: "sql-audit-logs"
    type: "mssql"
    connection:
      host: "sql-server.internal"
      port: 1433
      database: "master"
      username: "xsiam_reader"
      password_env: "MSSQL_PASSWORD"  # Set via environment
    query: |
      SELECT 
        event_time, server_principal_name, 
        database_name, action_id, succeeded
      FROM sys.fn_get_audit_file('/var/sqlaudit/*.sqlaudit', DEFAULT, DEFAULT)
      WHERE event_time > ?
    schedule: "*/5 * * * *"  # Every 5 minutes
    timestamp_column: "event_time"
    vendor: "microsoft"
    product: "sql_server"
    
  - name: "oracle-audit"
    type: "oracle"
    connection:
      host: "oracle-db.internal"
      port: 1521
      service_name: "ORCL"
      username: "audit_reader"
    query: |
      SELECT * FROM DBA_AUDIT_TRAIL 
      WHERE TIMESTAMP > :last_run
    schedule: "*/10 * * * *"</pre>
                </div>
                
                <h3>File Collector Configuration</h3>
                <div class="code-block">
                    <div class="code-header">file-collector-config.yaml</div>
                    <pre># /opt/broker/config/file-collector.yaml

collectors:
  - name: "application-logs"
    type: "file"
    paths:
      - "/var/log/myapp/*.log"
      - "/opt/application/logs/*.json"
    multiline:
      pattern: "^\\d{4}-\\d{2}-\\d{2}"
      negate: true
      match: "after"
    vendor: "custom"
    product: "myapp"
    
  - name: "windows-evtx"
    type: "file"
    paths:
      - "/mnt/windows-share/logs/*.evtx"
    parser: "evtx"
    vendor: "microsoft"
    product: "windows"
    
  - name: "csv-logs"
    type: "file"
    paths:
      - "/data/exports/*.csv"
    delimiter: ","
    has_header: true
    vendor: "custom"
    product: "export_data"</pre>
                </div>
                
                <h2><i class="fas fa-shield-alt"></i> Security Hardening</h2>
                
                <div class="warning-box">
                    <strong>⚠️ Security Best Practices</strong>
                    <ul>
                        <li>Place Broker VM in a dedicated management VLAN</li>
                        <li>Restrict inbound access to only required syslog ports</li>
                        <li>Enable TLS for all syslog connections where possible</li>
                        <li>Use service accounts with minimum required privileges for database collectors</li>
                        <li>Regularly update the Broker VM and underlying OS</li>
                        <li>Monitor Broker VM health and resource utilization</li>
                    </ul>
                </div>
                
                <div class="code-block">
                    <div class="code-header">Firewall Rules (iptables)</div>
                    <pre># Allow syslog from internal network only
sudo iptables -A INPUT -p udp --dport 514 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 514 -s 10.0.0.0/8 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 6514 -s 10.0.0.0/8 -j ACCEPT

# Allow management access
sudo iptables -A INPUT -p tcp --dport 22 -s 10.0.100.0/24 -j ACCEPT

# Allow outbound HTTPS to XSIAM cloud
sudo iptables -A OUTPUT -p tcp --dport 443 -j ACCEPT

# Drop all other inbound
sudo iptables -A INPUT -j DROP

# Save rules
sudo iptables-save > /etc/iptables/rules.v4</pre>
                </div>
                
                <h2><i class="fas fa-chart-line"></i> Monitoring & Troubleshooting</h2>
                
                <h3>Health Monitoring Commands</h3>
                <div class="code-block">
                    <div class="code-header">Broker VM Health Checks</div>
                    <pre># Overall status
sudo /opt/broker/bin/broker-ctl status

# Detailed statistics
sudo /opt/broker/bin/broker-ctl stats --detailed

# Connection health
sudo /opt/broker/bin/broker-ctl test-connection

# View real-time logs
sudo docker logs -f broker-core

# Check resource usage
sudo docker stats broker-core

# Disk space for buffer
df -h /opt/broker/buffer</pre>
                </div>
                
                <h3>Common Issues & Solutions</h3>
                <div class="styled-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Issue</th>
                                <th>Symptoms</th>
                                <th>Resolution</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Connection failed</td>
                                <td>Events not appearing in XSIAM</td>
                                <td>Check firewall rules for outbound 443, verify DNS resolution</td>
                            </tr>
                            <tr>
                                <td>Buffer filling up</td>
                                <td>High buffer usage percentage</td>
                                <td>Check network bandwidth, increase buffer size, verify cloud connectivity</td>
                            </tr>
                            <tr>
                                <td>Missing events</td>
                                <td>Source devices show sending, XSIAM shows fewer</td>
                                <td>Check UDP vs TCP, increase message size limits, verify parser</td>
                            </tr>
                            <tr>
                                <td>High CPU usage</td>
                                <td>Slow parsing, delayed forwarding</td>
                                <td>Scale to larger VM, add additional Broker VMs for load balancing</td>
                            </tr>
                            <tr>
                                <td>TLS handshake failures</td>
                                <td>Secure syslog not connecting</td>
                                <td>Verify certificate validity, check cipher compatibility</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <h2><i class="fas fa-expand-arrows-alt"></i> Scaling & High Availability</h2>
                
                <div class="info-box">
                    <h4>Multi-Broker Deployment</h4>
                    <p>For high availability and load distribution:</p>
                    <ul>
                        <li><strong>Geographic Distribution:</strong> Deploy Broker VMs in each datacenter/region</li>
                        <li><strong>Load Balancing:</strong> Use DNS round-robin or hardware LB for syslog distribution</li>
                        <li><strong>Active-Active:</strong> Multiple Brokers can receive the same log sources</li>
                        <li><strong>Failover:</strong> XSIAM deduplicates if same event received from multiple Brokers</li>
                    </ul>
                </div>
                
                <div class="interview-box">
                    <h4><i class="fas fa-user-tie"></i> Interview Answer: "What is a Broker VM and when would you deploy one?"</h4>
                    <p>"A Broker VM is an on-premises Linux virtual machine that acts as a data collector for XSIAM. I deploy Broker VMs when I need to collect syslog data from devices that can't send directly to the cloud - things like firewalls, switches, and legacy applications. The Broker receives logs locally, buffers them during any connectivity issues, and forwards them to XSIAM over HTTPS port 443. Beyond syslog, Broker VMs can also run database queries to pull logs from SQL Server or Oracle, and collect file-based logs. For sizing, a medium Broker with 8 vCPUs and 32GB RAM can handle about 15,000 EPS. In enterprise deployments, I typically deploy multiple Broker VMs - one per datacenter for geographic redundancy and load distribution."</p>
                </div>
                
                <div class="interview-box">
                    <h4><i class="fas fa-user-tie"></i> Interview Answer: "How do you troubleshoot a Broker VM that's not forwarding data?"</h4>
                    <p>"I follow a systematic approach. First, I check if the Broker VM itself is healthy using 'broker-ctl status' and verify Docker containers are running. Then I test outbound connectivity to XSIAM cloud using 'broker-ctl test-connection' - this validates DNS resolution and HTTPS access. If that fails, I check firewall rules for outbound port 443. If connectivity is fine, I verify data is actually arriving at the Broker by checking listener stats - the 'stats' command shows events received versus forwarded. A growing buffer indicates network issues; flat stats with no received events means the source devices aren't sending. I also check disk space since a full disk stops buffering. For syslog specifically, I verify the source is configured to send to the correct IP and port, and test with netcat or tcpdump to see if packets are arriving."</p>
                </div>
                
            </main>
            
            <footer class="main-footer">
                <div class="footer-content">
                    <div class="footer-links">
                        <a href="../index.html">Home</a>
                        <a href="index.html">XSIAM</a>
                        <a href="data-ingestion.html">Data Ingestion</a>
                        <a href="marketplace.html">Marketplace</a>
                    </div>
                    <div class="footer-copy">Nik's SIEM - Security Operations Knowledge Base</div>
                </div>
            </footer>
        </div>
    </div>
    
    <button class="sidebar-toggle"><i class="fas fa-bars"></i></button>
    <script src="../assets/js/main.js"></script>
</body>
</html>
