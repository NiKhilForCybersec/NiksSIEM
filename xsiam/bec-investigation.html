<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BEC Investigation Workflow | XSIAM Incident Response</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
            <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="sidebar-brand">
                <i class="fas fa-shield-alt"></i>
                <span>Nik's SIEM</span>
            </a>
            <button class="sidebar-toggle" onclick="toggleSidebar()" title="Collapse sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Platforms Section -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Platforms</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="../xsiam/index.html" class="sidebar-nav-link active" data-platform="xsiam"><span class="platform-dot"></span><span>XSIAM</span></a></li>
                    <li class="sidebar-nav-item"><a href="../splunk/index.html" class="sidebar-nav-link" data-platform="splunk"><span class="platform-dot"></span><span>Splunk</span></a></li>
                    <li class="sidebar-nav-item"><a href="../sentinel/index.html" class="sidebar-nav-link" data-platform="sentinel"><span class="platform-dot"></span><span>Sentinel</span></a></li>
                    <li class="sidebar-nav-item"><a href="../crowdstrike/index.html" class="sidebar-nav-link" data-platform="crowdstrike"><span class="platform-dot"></span><span>CrowdStrike</span></a></li>
                    <li class="sidebar-nav-item"><a href="../cortex/index.html" class="sidebar-nav-link" data-platform="cortex"><span class="platform-dot"></span><span>Cortex XDR</span></a></li>
                    <li class="sidebar-nav-item"><a href="../mde/index.html" class="sidebar-nav-link" data-platform="mde"><span class="platform-dot"></span><span>Defender for Endpoint</span></a></li>
                    <li class="sidebar-nav-item"><a href="../operations/index.html" class="sidebar-nav-link" data-platform="operations"><span class="platform-dot"></span><span>SOC Operations</span></a></li>
                </ul>
            </div>

            <div class="sidebar-divider"></div>
            
            <!-- Getting Started -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Getting Started</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="index.html" class="sidebar-nav-link"><i class="fas fa-home"></i><span>Overview</span></a></li>
                    <li class="sidebar-nav-item"><a href="architecture.html" class="sidebar-nav-link"><i class="fas fa-sitemap"></i><span>Architecture</span></a></li>
                    <li class="sidebar-nav-item"><a href="comparison.html" class="sidebar-nav-link"><i class="fas fa-balance-scale"></i><span>Platform Comparison</span></a></li>
                </ul>
            </div>
            
            <!-- Data Collection -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Data Collection</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="data-ingestion.html" class="sidebar-nav-link"><i class="fas fa-database"></i><span>Data Ingestion</span></a></li>
                    <li class="sidebar-nav-item"><a href="broker-vm.html" class="sidebar-nav-link"><i class="fas fa-server"></i><span>Broker VM</span></a></li>
                    <li class="sidebar-nav-item"><a href="agents.html" class="sidebar-nav-link"><i class="fas fa-microchip"></i><span>Agents</span></a></li>
                    <li class="sidebar-nav-item"><a href="parsing-flows.html" class="sidebar-nav-link"><i class="fas fa-stream"></i><span>Parsing & Flows</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-log-onboarding.html" class="sidebar-nav-link"><i class="fas fa-plus-circle"></i><span>Custom Log Onboarding</span></a></li>
                    <li class="sidebar-nav-item"><a href="retention-tiers.html" class="sidebar-nav-link"><i class="fas fa-archive"></i><span>Retention Tiers</span></a></li>
                </ul>
            </div>
            
            <!-- Query & Analysis -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Query & Analysis</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="xql-fundamentals.html" class="sidebar-nav-link"><i class="fas fa-terminal"></i><span>XQL Fundamentals</span></a></li>
                    <li class="sidebar-nav-item"><a href="xql-advanced.html" class="sidebar-nav-link"><i class="fas fa-rocket"></i><span>XQL Advanced</span></a></li>
                    <li class="sidebar-nav-item"><a href="dashboards.html" class="sidebar-nav-link"><i class="fas fa-chart-line"></i><span>Dashboards</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-hunting.html" class="sidebar-nav-link"><i class="fas fa-search"></i><span>Threat Hunting</span></a></li>
                </ul>
            </div>
            
            <!-- Detection & Response -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Detection & Response</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="xdr-overview.html" class="sidebar-nav-link"><i class="fas fa-shield-virus"></i><span>XDR & Detection</span></a></li>
                    <li class="sidebar-nav-item"><a href="correlation-rules.html" class="sidebar-nav-link"><i class="fas fa-project-diagram"></i><span>Correlation Rules</span></a></li>
                    <li class="sidebar-nav-item"><a href="ml-ueba.html" class="sidebar-nav-link"><i class="fas fa-brain"></i><span>ML & UEBA</span></a></li>
                    <li class="sidebar-nav-item"><a href="identity-analytics.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>Identity Analytics</span></a></li>
                    <li class="sidebar-nav-item"><a href="alert-management.html" class="sidebar-nav-link"><i class="fas fa-bell"></i><span>Alert Management</span></a></li>
                    <li class="sidebar-nav-item"><a href="incident-response.html" class="sidebar-nav-link"><i class="fas fa-ambulance"></i><span>Incident Response</span></a></li>
                </ul>
            </div>
            
            <!-- Incident Playbooks (NEW) -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Incident Playbooks</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="ransomware-response.html" class="sidebar-nav-link"><i class="fas fa-lock"></i><span>Ransomware Response</span></a></li>
                    <li class="sidebar-nav-item"><a href="bec-investigation.html" class="sidebar-nav-link active"><i class="fas fa-envelope"></i><span>BEC Investigation</span></a></li>
                    <li class="sidebar-nav-item"><a href="insider-threat.html" class="sidebar-nav-link"><i class="fas fa-user-secret"></i><span>Insider Threat</span></a></li>
                </ul>
            </div>
            
            <!-- Automation & Intel -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Automation & Intel</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="xsoar-automation.html" class="sidebar-nav-link"><i class="fas fa-robot"></i><span>XSOAR Automation</span></a></li>
                    <li class="sidebar-nav-item"><a href="threat-intel.html" class="sidebar-nav-link"><i class="fas fa-skull-crossbones"></i><span>Threat Intel</span></a></li>
                    <li class="sidebar-nav-item"><a href="recon-asm.html" class="sidebar-nav-link"><i class="fas fa-globe"></i><span>Recon & ASM</span></a></li>
                </ul>
            </div>
            
            <!-- Integrations -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Integrations</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="cloud-integrations.html" class="sidebar-nav-link"><i class="fas fa-cloud"></i><span>Cloud (AWS/Azure/GCP)</span></a></li>
                    <li class="sidebar-nav-item"><a href="identity-integrations.html" class="sidebar-nav-link"><i class="fas fa-id-card"></i><span>Identity (Okta/AD)</span></a></li>
                    <li class="sidebar-nav-item"><a href="custom-integrations.html" class="sidebar-nav-link"><i class="fas fa-puzzle-piece"></i><span>Custom Integrations</span></a></li>
                    <li class="sidebar-nav-item"><a href="marketplace.html" class="sidebar-nav-link"><i class="fas fa-store"></i><span>Marketplace</span></a></li>
                </ul>
            </div>
            
            <!-- Operations (NEW) -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Operations</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="troubleshooting.html" class="sidebar-nav-link"><i class="fas fa-wrench"></i><span>Troubleshooting</span></a></li>
                    <li class="sidebar-nav-item"><a href="day2-operations.html" class="sidebar-nav-link"><i class="fas fa-tasks"></i><span>Day-2 Operations</span></a></li>
                    <li class="sidebar-nav-item"><a href="alert-tuning.html" class="sidebar-nav-link"><i class="fas fa-sliders-h"></i><span>Alert Tuning</span></a></li>
                    <li class="sidebar-nav-item"><a href="cost-optimization.html" class="sidebar-nav-link"><i class="fas fa-dollar-sign"></i><span>Cost Optimization</span></a></li>
                </ul>
            </div>
            
            <!-- Administration -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Administration</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="rbac-access-control.html" class="sidebar-nav-link"><i class="fas fa-users-cog"></i><span>RBAC & Access</span></a></li>
                    <li class="sidebar-nav-item"><a href="health-monitoring.html" class="sidebar-nav-link"><i class="fas fa-heartbeat"></i><span>Health Monitoring</span></a></li>
                    <li class="sidebar-nav-item"><a href="backup-recovery.html" class="sidebar-nav-link"><i class="fas fa-undo"></i><span>Backup & Recovery</span></a></li>
                    <li class="sidebar-nav-item"><a href="api-administration.html" class="sidebar-nav-link"><i class="fas fa-code"></i><span>API Administration</span></a></li>
                </ul>
            </div>
            
            <!-- Architecture & Planning -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Architecture & Planning</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="capacity-planning.html" class="sidebar-nav-link"><i class="fas fa-calculator"></i><span>Capacity Planning</span></a></li>
                    <li class="sidebar-nav-item"><a href="network-requirements.html" class="sidebar-nav-link"><i class="fas fa-network-wired"></i><span>Network Requirements</span></a></li>
                    <li class="sidebar-nav-item"><a href="multi-tenant.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Multi-Tenant</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-residency.html" class="sidebar-nav-link"><i class="fas fa-map-marked-alt"></i><span>Data Residency</span></a></li>
                    <li class="sidebar-nav-item"><a href="migration-guide.html" class="sidebar-nav-link"><i class="fas fa-exchange-alt"></i><span>Migration Guide</span></a></li>
                </ul>
            </div>
            
            <!-- Compliance & Governance -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Compliance & Governance</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="compliance-frameworks.html" class="sidebar-nav-link"><i class="fas fa-clipboard-check"></i><span>Compliance Frameworks</span></a></li>
                    <li class="sidebar-nav-item"><a href="audit-reporting.html" class="sidebar-nav-link"><i class="fas fa-file-alt"></i><span>Audit & Reporting</span></a></li>
                    <li class="sidebar-nav-item"><a href="data-privacy.html" class="sidebar-nav-link"><i class="fas fa-user-shield"></i><span>Data Privacy</span></a></li>
                    <li class="sidebar-nav-item"><a href="soc-metrics.html" class="sidebar-nav-link"><i class="fas fa-tachometer-alt"></i><span>SOC Metrics & KPIs</span></a></li>
                </ul>
            </div>
            
            <!-- Enterprise -->
            <div class="sidebar-section">
                <div class="sidebar-section-title">Enterprise</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="enterprise-soc.html" class="sidebar-nav-link"><i class="fas fa-building"></i><span>Enterprise SOC</span></a></li>
                </ul>
            </div>
        </div>
    </aside>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>


        
        <div class="main-wrapper" id="mainWrapper">
            <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            
            <main class="main-content">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">XSIAM</a><span class="separator">/</span>
                    <span class="current">BEC Investigation</span>
                </div>

                <h1><i class="fas fa-envelope"></i> Business Email Compromise Investigation</h1>
                <p class="lead">Investigation procedures for Business Email Compromise (BEC) and email account takeover incidents using XSIAM and integrated identity logs. Covers detection, scope assessment, and remediation.</p>

                <div class="info-box" style="border-color: #d29922; background: rgba(210, 153, 34, 0.1);">
                    <h4><i class="fas fa-info-circle"></i> BEC Overview</h4>
                    <p>BEC attacks typically don't involve malware - attackers compromise email accounts through phishing/credential theft, then use legitimate access to send fraudulent emails requesting wire transfers, gift cards, or sensitive data. Average loss per incident: $125,000+.</p>
                </div>

                <!-- BEC Attack Types -->
                <h2><i class="fas fa-exclamation-triangle"></i> BEC Attack Types</h2>
                
                <table class="styled-table">
                    <thead>
                        <tr>
                            <th>Attack Type</th>
                            <th>Description</th>
                            <th>Indicators</th>
                            <th>Typical Target</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong style="color: #f85149;">Account Takeover</strong></td>
                            <td>Attacker gains access to legitimate email account</td>
                            <td>Impossible travel, new mail rules, password changes</td>
                            <td>Any employee, especially finance/exec</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #d29922;">CEO Fraud</strong></td>
                            <td>Impersonate executive to request wire transfer</td>
                            <td>Spoofed/lookalike domain, urgent language</td>
                            <td>Finance, accounting, AP</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #58a6ff;">Vendor Impersonation</strong></td>
                            <td>Impersonate vendor to redirect payments</td>
                            <td>Changed bank details, invoice manipulation</td>
                            <td>Accounts payable</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #a371f7;">Payroll Diversion</strong></td>
                            <td>Request direct deposit change to attacker account</td>
                            <td>HR/payroll requests for banking changes</td>
                            <td>HR, payroll</td>
                        </tr>
                        <tr>
                            <td><strong style="color: #3fb950;">Data Theft</strong></td>
                            <td>Request sensitive data (W-2s, employee info)</td>
                            <td>Unusual data export requests</td>
                            <td>HR, IT, finance</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Detection Decision Tree -->
                <h2><i class="fas fa-code-branch"></i> BEC Detection Decision Tree</h2>
                
                <div class="decision-tree">
                    <div class="decision-node question">
                        <strong>How was potential BEC detected?</strong>
                    </div>
                    <div class="decision-branch" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                        <div>
                            <div class="decision-node" style="background: #4d1a1a; border-color: #f85149;">
                                <strong style="color: #f85149;">User Reported</strong>
                                <div style="color: #8b949e; font-size: 0.8rem;">"I got a suspicious email from myself"<br>"I didn't send those emails"<br>→ Likely account compromised</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-node" style="background: #4d3a0d; border-color: #d29922;">
                                <strong style="color: #d29922;">Suspicious Login Alert</strong>
                                <div style="color: #8b949e; font-size: 0.8rem;">Impossible travel<br>New device/location<br>→ Investigate login activity</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-node" style="background: #1c3a5e; border-color: #58a6ff;">
                                <strong style="color: #58a6ff;">Mail Rule Alert</strong>
                                <div style="color: #8b949e; font-size: 0.8rem;">Forwarding rule created<br>Delete/hide rules<br>→ Check account activity</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phase 1: Initial Assessment -->
                <h2><i class="fas fa-search"></i> Phase 1: Initial Assessment</h2>
                
                <div class="config-section">
                    <h4>Identity Log Investigation Queries</h4>
                    <div class="arch-diagram"># BEC Investigation - Identity Logs
# ═══════════════════════════════════════════════════════════════

# Check Recent Sign-ins for Compromised Account
dataset = azure_ad_signin_raw
| filter _time > now() - 30d
| filter user_principal_name = "suspect_user@company.com"
| fields _time, user_principal_name, ip_address, location_city, 
         location_country, device_detail, client_app, status
| sort _time desc

# ═══════════════════════════════════════════════════════════════

# Detect Impossible Travel
dataset = azure_ad_signin_raw
| filter _time > now() - 7d
| filter user_principal_name = "suspect_user@company.com"
| filter status = "Success"
| sort _time asc
| alter prev_time = prev(_time), prev_city = prev(location_city), 
        prev_country = prev(location_country)
| alter time_diff_hours = timestamp_diff(_time, prev_time, "HOUR")
| filter time_diff_hours < 4 AND location_city != prev_city
| fields _time, location_city, location_country, prev_city, 
         prev_country, time_diff_hours, ip_address

# ═══════════════════════════════════════════════════════════════

# Failed Login Attempts (Credential Stuffing/Brute Force)
dataset = azure_ad_signin_raw
| filter _time > now() - 7d
| filter user_principal_name = "suspect_user@company.com"
| filter status = "Failure"
| comp count() as failed_attempts by error_code, ip_address
| sort failed_attempts desc

# ═══════════════════════════════════════════════════════════════

# Check for New Device/Application Access
dataset = azure_ad_signin_raw
| filter _time > now() - 30d
| filter user_principal_name = "suspect_user@company.com"
| filter status = "Success"
| comp min(_time) as first_seen, count() as logins 
  by device_detail, client_app
| sort first_seen desc
| filter first_seen > now() - 7d  // New in last 7 days

# ═══════════════════════════════════════════════════════════════

# Okta - Suspicious Sign-in Activity
dataset = okta_raw
| filter _time > now() - 30d
| filter actor_alternateId = "suspect_user@company.com"
| filter eventType contains "user.session.start"
| fields _time, actor_alternateId, client_ipAddress, 
         client_geographicalContext_city, client_userAgent
| sort _time desc</div>
                </div>

                <div class="config-section">
                    <h4>Email Activity Investigation</h4>
                    <div class="arch-diagram"># Email Activity Queries (O365/Exchange Logs)
# ═══════════════════════════════════════════════════════════════

# Check for Inbox Rules Created (Common BEC Technique)
dataset = microsoft_365_audit_raw
| filter _time > now() - 30d
| filter user_id = "suspect_user@company.com"
| filter operation in ("New-InboxRule", "Set-InboxRule", "Enable-InboxRule")
| fields _time, operation, parameters, client_ip
| sort _time desc

# ═══════════════════════════════════════════════════════════════

# Check for Mail Forwarding Rules
dataset = microsoft_365_audit_raw
| filter _time > now() - 30d
| filter user_id = "suspect_user@company.com"
| filter operation = "Set-Mailbox"
| filter parameters contains "ForwardingSmtpAddress" OR 
         parameters contains "ForwardingAddress"
| fields _time, parameters, client_ip

# ═══════════════════════════════════════════════════════════════

# Emails Sent During Suspected Compromise Window
dataset = microsoft_365_audit_raw
| filter _time > "[COMPROMISE_START]" AND _time < "[COMPROMISE_END]"
| filter user_id = "suspect_user@company.com"
| filter operation = "Send"
| fields _time, item_subject, recipients, client_ip
| sort _time asc

# ═══════════════════════════════════════════════════════════════

# Large Email Exports/Downloads (Data Exfil)
dataset = microsoft_365_audit_raw
| filter _time > now() - 7d
| filter user_id = "suspect_user@company.com"
| filter operation in ("MailItemsAccessed", "SearchExported", 
         "MailboxLogin", "HardDelete")
| comp count() as operations by operation, client_ip
| sort operations desc

# ═══════════════════════════════════════════════════════════════

# Check Delegate/Permission Changes
dataset = microsoft_365_audit_raw
| filter _time > now() - 30d
| filter affected_user = "suspect_user@company.com" OR 
         user_id = "suspect_user@company.com"
| filter operation in ("Add-MailboxPermission", "Add-RecipientPermission",
         "Set-Mailbox", "Add-MailboxFolderPermission")
| fields _time, operation, user_id, parameters
| sort _time desc</div>
                </div>

                <!-- Phase 2: Scope Assessment -->
                <h2><i class="fas fa-expand-arrows-alt"></i> Phase 2: Scope Assessment</h2>
                
                <div class="decision-tree">
                    <div class="decision-node question">
                        <strong>What is the scope of compromise?</strong>
                    </div>
                    <div class="decision-branch">
                        <div>
                            <div class="decision-arrow">↓ Single Account</div>
                            <div class="decision-node" style="background: #1a4d2e; border-color: #3fb950;">
                                <strong style="color: #3fb950;">Contained Incident</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Reset password immediately<br>2. Revoke sessions<br>3. Review sent emails<br>4. Remove malicious rules</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-arrow">↓ Multiple Accounts</div>
                            <div class="decision-node" style="background: #4d3a0d; border-color: #d29922;">
                                <strong style="color: #d29922;">Phishing Campaign</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Identify all victims<br>2. Mass password reset<br>3. Block phishing source<br>4. User notification</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-arrow">↓ Admin Account</div>
                            <div class="decision-node" style="background: #4d1a1a; border-color: #f85149;">
                                <strong style="color: #f85149;">CRITICAL - Full Review</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Assume full tenant access<br>2. Review all admin actions<br>3. Check for persistence<br>4. Engage Microsoft support</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Find Other Compromised Accounts</h4>
                    <div class="arch-diagram"># Hunt for Additional Compromised Accounts
# ═══════════════════════════════════════════════════════════════

# Users Who Logged in from Same Malicious IP
dataset = azure_ad_signin_raw
| filter _time > now() - 30d
| filter ip_address = "[ATTACKER_IP]"
| filter status = "Success"
| comp count() as logins, min(_time) as first_seen 
  by user_principal_name
| sort first_seen asc

# ═══════════════════════════════════════════════════════════════

# Users with Similar Inbox Rules Created
dataset = microsoft_365_audit_raw
| filter _time > now() - 30d
| filter operation = "New-InboxRule"
| filter parameters contains "DeleteMessage" OR 
         parameters contains "ForwardTo" OR
         parameters contains "RedirectTo"
| comp count() as rules by user_id
| filter rules > 0

# ═══════════════════════════════════════════════════════════════

# Users Who Clicked Same Phishing Link
dataset = microsoft_defender_email_raw
| filter _time > now() - 7d
| filter url = "[PHISHING_URL]"
| filter action = "clicked"
| comp count() by user_email
| sort count desc

# ═══════════════════════════════════════════════════════════════

# Password Changes (May Indicate Compromise or Remediation)
dataset = azure_ad_audit_raw
| filter _time > now() - 7d
| filter activity_display_name contains "password"
| fields _time, target_user, initiated_by, activity_display_name
| sort _time desc</div>
                </div>

                <!-- Phase 3: Containment & Remediation -->
                <h2><i class="fas fa-shield-alt"></i> Phase 3: Containment & Remediation</h2>
                
                <div class="config-section">
                    <h4>Immediate Containment Actions</h4>
                    <div class="arch-diagram"># BEC Containment Checklist
# ═══════════════════════════════════════════════════════════════

## IMMEDIATE ACTIONS (Within 15 minutes)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. RESET PASSWORD
   Azure AD: Users → Select User → Reset Password
   Force password change at next login
   
2. REVOKE ALL SESSIONS
   Azure AD: Users → Select User → Revoke Sessions
   PowerShell: Revoke-AzureADUserAllRefreshToken -ObjectId [USER_ID]
   
3. DISABLE ACCOUNT (if active attack)
   Azure AD: Users → Select User → Block Sign-in
   
4. REVIEW AND REMOVE MALICIOUS MAIL RULES
   Exchange Admin: Recipients → Mailboxes → Select User → 
   Manage Mail Flow Settings → Inbox Rules
   
   PowerShell:
   Get-InboxRule -Mailbox "user@company.com" | 
   Where-Object {$_.ForwardTo -ne $null -or $_.RedirectTo -ne $null}
   
   Remove-InboxRule -Mailbox "user@company.com" -Identity "[RULE_NAME]"

5. CHECK MAIL FORWARDING
   PowerShell:
   Get-Mailbox -Identity "user@company.com" | 
   Select ForwardingSmtpAddress, ForwardingAddress, DeliverToMailboxAndForward
   
   Remove forwarding:
   Set-Mailbox -Identity "user@company.com" -ForwardingSmtpAddress $null

6. REVIEW DELEGATE ACCESS
   Get-MailboxPermission -Identity "user@company.com"
   Remove-MailboxPermission -Identity "user@company.com" -User "attacker@external.com" -AccessRights FullAccess

## POST-CONTAINMENT
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
□ Enable MFA on account
□ Review and update recovery email/phone
□ Check for OAuth app consents
□ Review Azure AD audit logs for admin changes
□ Check for registered devices

# ═══════════════════════════════════════════════════════════════</div>
                </div>

                <div class="config-section">
                    <h4>PowerShell Remediation Commands</h4>
                    <div class="arch-diagram"># PowerShell Commands for BEC Remediation
# ═══════════════════════════════════════════════════════════════

# Connect to Exchange Online
Connect-ExchangeOnline -UserPrincipalName admin@company.com

# Connect to Azure AD
Connect-AzureAD

# ═══════════════════════════════════════════════════════════════
# MAILBOX INVESTIGATION
# ═══════════════════════════════════════════════════════════════

# Get all inbox rules
Get-InboxRule -Mailbox "user@company.com" | Format-List Name, Description, 
    Enabled, Priority, ForwardTo, ForwardAsAttachmentTo, RedirectTo, 
    DeleteMessage, MarkAsRead, MoveToFolder

# Get mailbox forwarding settings
Get-Mailbox -Identity "user@company.com" | Format-List Name, 
    ForwardingSmtpAddress, ForwardingAddress, DeliverToMailboxAndForward

# Get mailbox permissions
Get-MailboxPermission -Identity "user@company.com" | 
    Where-Object {$_.User -ne "NT AUTHORITY\SELF"}

# Get folder permissions
Get-MailboxFolderPermission -Identity "user@company.com:\Inbox"

# ═══════════════════════════════════════════════════════════════
# REMEDIATION COMMANDS
# ═══════════════════════════════════════════════════════════════

# Remove all inbox rules (CAUTION - removes ALL rules)
Get-InboxRule -Mailbox "user@company.com" | Remove-InboxRule -Confirm:$false

# Remove specific malicious rule
Remove-InboxRule -Mailbox "user@company.com" -Identity "Auto-Forward"

# Remove mailbox forwarding
Set-Mailbox -Identity "user@company.com" -ForwardingSmtpAddress $null `
    -ForwardingAddress $null -DeliverToMailboxAndForward $false

# Remove delegate access
Remove-MailboxPermission -Identity "user@company.com" `
    -User "attacker@external.com" -AccessRights FullAccess -Confirm:$false

# Block sign-in
Set-AzureADUser -ObjectId "user@company.com" -AccountEnabled $false

# Revoke sessions
Revoke-AzureADUserAllRefreshToken -ObjectId "[USER_OBJECT_ID]"

# Reset password
Set-AzureADUserPassword -ObjectId "[USER_OBJECT_ID]" `
    -Password (ConvertTo-SecureString "TempP@ssw0rd123!" -AsPlainText -Force) `
    -ForceChangePasswordNextLogin $true

# ═══════════════════════════════════════════════════════════════
# CHECK FOR OAUTH APPS (Persistence)
# ═══════════════════════════════════════════════════════════════

# List user's OAuth consents
Get-AzureADUserOAuth2PermissionGrant -ObjectId "[USER_OBJECT_ID]" | 
    Format-List ClientId, ConsentType, Scope

# Remove suspicious OAuth consent
Remove-AzureADOAuth2PermissionGrant -ObjectId "[GRANT_ID]"

# ═══════════════════════════════════════════════════════════════</div>
                </div>

                <!-- Phase 4: Business Impact Assessment -->
                <h2><i class="fas fa-dollar-sign"></i> Phase 4: Business Impact Assessment</h2>
                
                <div class="decision-tree">
                    <div class="decision-node question">
                        <strong>Was fraudulent activity conducted?</strong>
                    </div>
                    <div class="decision-branch">
                        <div>
                            <div class="decision-arrow">↓ Wire Transfer Requested</div>
                            <div class="decision-node" style="background: #4d1a1a; border-color: #f85149;">
                                <strong style="color: #f85149;">URGENT - Contact Finance/Bank</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Stop payment if possible<br>2. Contact receiving bank<br>3. File FBI IC3 report<br>4. Notify cyber insurance</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-arrow">↓ Gift Cards/Crypto</div>
                            <div class="decision-node" style="background: #4d3a0d; border-color: #d29922;">
                                <strong style="color: #d29922;">Likely Unrecoverable</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Document loss amount<br>2. File IC3 report<br>3. Employee awareness training<br>4. Policy review</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-arrow">↓ Data Exfiltrated</div>
                            <div class="decision-node" style="background: #1c3a5e; border-color: #58a6ff;">
                                <strong style="color: #58a6ff;">Assess Data Exposure</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Identify accessed data<br>2. Determine if PII/PHI<br>3. Breach notification review<br>4. Legal consultation</div>
                            </div>
                        </div>
                        <div>
                            <div class="decision-arrow">↓ No Financial Impact</div>
                            <div class="decision-node" style="background: #1a4d2e; border-color: #3fb950;">
                                <strong style="color: #3fb950;">Complete Remediation</strong>
                                <div style="color: #8b949e; font-size: 0.85rem;">1. Document timeline<br>2. Update detection rules<br>3. User education<br>4. Close incident</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Sent Email Review</h4>
                    <div class="arch-diagram"># Review Emails Sent During Compromise
# ═══════════════════════════════════════════════════════════════

# All Emails Sent During Compromise Window
dataset = microsoft_365_audit_raw
| filter _time > "[START_TIME]" AND _time < "[END_TIME]"
| filter user_id = "suspect_user@company.com"
| filter operation = "Send" OR operation = "SendAs" OR operation = "SendOnBehalf"
| fields _time, operation, item_subject, recipients, client_ip
| sort _time asc

# ═══════════════════════════════════════════════════════════════

# Emails with Financial Keywords
dataset = microsoft_365_audit_raw
| filter _time > now() - 30d
| filter user_id = "suspect_user@company.com"
| filter operation = "Send"
| filter item_subject contains_any ("wire", "transfer", "payment", "invoice",
         "bank", "account", "urgent", "confidential", "W-2", "tax")
| fields _time, item_subject, recipients
| sort _time desc

# ═══════════════════════════════════════════════════════════════

# External Recipients (Data Exfil Risk)
dataset = microsoft_365_audit_raw
| filter _time > "[START_TIME]" AND _time < "[END_TIME]"
| filter user_id = "suspect_user@company.com"
| filter operation = "Send"
| filter recipients not contains "@company.com"
| fields _time, item_subject, recipients
| sort _time desc

# ═══════════════════════════════════════════════════════════════</div>
                </div>

                <!-- Detection Rules -->
                <h2><i class="fas fa-bell"></i> BEC Detection Rules</h2>
                
                <div class="config-section">
                    <h4>XSIAM Correlation Rules for BEC</h4>
                    <div class="arch-diagram"># BEC Detection Rules
# ═══════════════════════════════════════════════════════════════

## RULE 1: Inbox Rule with Forwarding/Delete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: "Suspicious Inbox Rule Created"
Severity: High

dataset = microsoft_365_audit_raw
| filter operation = "New-InboxRule"
| filter parameters contains_any ("ForwardTo", "RedirectTo", 
         "DeleteMessage", "MarkAsRead")
| alter alert_name = "Suspicious inbox rule created"

## RULE 2: Impossible Travel
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: "Impossible Travel Detected"
Severity: Medium

# See ML-UEBA page for detailed impossible travel detection

## RULE 3: Mail Forwarding Enabled
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: "Email Forwarding to External Address"
Severity: High

dataset = microsoft_365_audit_raw
| filter operation = "Set-Mailbox"
| filter parameters contains "ForwardingSmtpAddress"
| filter parameters not contains "@company.com"
| alter alert_name = "External email forwarding enabled"

## RULE 4: Multiple Failed Logins then Success
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: "Credential Stuffing Success"
Severity: High

dataset = azure_ad_signin_raw
| filter _time > now() - 1h
| comp countif(status = "Failure") as failures,
        countif(status = "Success") as successes
  by user_principal_name, ip_address
| filter failures > 5 AND successes > 0

## RULE 5: OAuth App Consent from New Location
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Name: "Suspicious OAuth App Consent"
Severity: Medium

dataset = azure_ad_audit_raw
| filter activity_display_name = "Consent to application"
| filter initiated_by_ip not in ("[KNOWN_OFFICE_IPS]")

# ═══════════════════════════════════════════════════════════════</div>
                </div>

                <!-- Prevention -->
                <h2><i class="fas fa-shield-virus"></i> BEC Prevention Recommendations</h2>
                
                <div class="config-section">
                    <h4>Security Controls Checklist</h4>
                    <div style="background: #21262d; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #3fb950; margin-top: 0;">Identity & Access</h4>
                        <div style="display: grid; gap: 8px;">
                            <label style="color: #c9d1d9;"><input type="checkbox"> MFA enabled for all users (hardware keys for admins)</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Conditional Access policies (block legacy auth)</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Risk-based sign-in policies enabled</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Privileged Identity Management for admin roles</label>
                        </div>
                        
                        <h4 style="color: #58a6ff; margin-top: 16px;">Email Security</h4>
                        <div style="display: grid; gap: 8px;">
                            <label style="color: #c9d1d9;"><input type="checkbox"> DMARC/DKIM/SPF configured (reject policy)</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> External email banners enabled</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Anti-phishing policies configured</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Safe Links and Safe Attachments enabled</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Mail flow rules to flag lookalike domains</label>
                        </div>
                        
                        <h4 style="color: #d29922; margin-top: 16px;">Detection & Monitoring</h4>
                        <div style="display: grid; gap: 8px;">
                            <label style="color: #c9d1d9;"><input type="checkbox"> Mailbox audit logging enabled</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Sign-in logs forwarded to XSIAM</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Alerts for inbox rule creation</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Alerts for mail forwarding changes</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Impossible travel detection enabled</label>
                        </div>
                        
                        <h4 style="color: #a371f7; margin-top: 16px;">Business Process</h4>
                        <div style="display: grid; gap: 8px;">
                            <label style="color: #c9d1d9;"><input type="checkbox"> Verbal verification for wire transfers</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Dual approval for large payments</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Regular phishing awareness training</label>
                            <label style="color: #c9d1d9;"><input type="checkbox"> Simulated phishing exercises</label>
                        </div>
                    </div>
                </div>

                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: A user reports they didn't send emails that appear in their sent folder. How do you investigate?</button>
                        <div class="qa-answer">
                            <p>This is a classic indicator of account compromise. My investigation focuses on confirming the compromise, understanding what the attacker did, and determining the scope of impact.</p>
                            
                            <p><strong>First, I verify the compromise:</strong> I check Azure AD sign-in logs for the user. I'm looking for logins from unusual locations, new devices, or suspicious IP addresses. The timestamps of suspicious logins should correlate with when the unauthorized emails were sent.</p>
                            
                            <p><strong>Second, I review email activity:</strong> Using Exchange audit logs, I examine what emails were sent, to whom, and with what content. I also check for inbox rules - attackers almost always create rules to forward emails or delete evidence. I look for rules that forward to external addresses, mark messages as read, or move them to hidden folders.</p>
                            
                            <p><strong>Third, I assess persistence:</strong> Did the attacker set up ways to maintain access? This includes OAuth app consents, delegate permissions, mail forwarding settings, and registered devices. All of these need to be reviewed and cleaned up.</p>
                            
                            <p><strong>Immediate containment:</strong> Reset the password, revoke all sessions, and remove any malicious rules or forwarding. I enable MFA if not already active. Depending on what was sent, I may need to notify recipients that the emails were fraudulent.</p>
                            
                            <p><strong>Finally, I document:</strong> When did compromise occur? How did they get in (phishing, credential stuffing)? What did they access? Were other accounts targeted? This informs both the incident report and improvements to prevent recurrence.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How would you detect and prevent BEC attacks proactively using XSIAM?</button>
                        <div class="qa-answer">
                            <p>BEC prevention requires a layered approach combining identity monitoring, email security analytics, and behavioral detection.</p>
                            
                            <p><strong>Identity monitoring:</strong> I configure XSIAM to ingest Azure AD and Okta sign-in logs. I create correlation rules for impossible travel, new device/location combinations, and failed login spikes followed by success. These catch the initial account compromise before attackers can act.</p>
                            
                            <p><strong>Email activity monitoring:</strong> Inbox rule creation is a key indicator. I alert on any rule that forwards to external addresses, deletes messages matching certain criteria, or moves emails to unusual folders. Mail forwarding setting changes also trigger alerts.</p>
                            
                            <p><strong>Behavioral analytics:</strong> Using XSIAM's ML/UEBA capabilities, I baseline normal email patterns for users. Sudden changes like sending to many new external recipients, accessing email at unusual hours, or bulk exports get flagged for review.</p>
                            
                            <p><strong>Integration with email security:</strong> If using Microsoft Defender or similar, those alerts feed into XSIAM. Phishing detections, suspicious link clicks, and malicious attachment attempts all become part of the correlation picture.</p>
                            
                            <p><strong>Response automation:</strong> For high-confidence detections, I configure XSOAR playbooks to automatically revoke sessions and require re-authentication. This buys time while analysts investigate, limiting attacker dwell time even if detection isn't immediate.</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainWrapper = document.getElementById('mainWrapper');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) { sidebar.classList.toggle('open'); overlay.classList.toggle('active'); }
            else { sidebar.classList.toggle('collapsed'); mainWrapper.classList.toggle('expanded'); }
        }
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) answer.style.display = 'block';
            });
        });
    </script>
</body>
</html>
