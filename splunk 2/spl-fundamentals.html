<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPL Fundamentals | Splunk</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <main class="main-content">
            <a href="../index.html" class="back-home"><i class="fas fa-arrow-left"></i> Nik's SIEM</a>
            
            <div class="breadcrumb">
                <a href="../index.html">Home</a>
                <span class="separator">/</span>
                <a href="index.html">Splunk</a>
                <span class="separator">/</span>
                <span class="current">SPL Fundamentals</span>
            </div>

<h1><i class="fas fa-search"></i> SPL Fundamentals</h1>
                <p class="lead">Master the Search Processing Language (SPL) - Splunk's powerful query language for searching, transforming, and visualizing machine data.</p>

                <!-- SPL Pipeline Concept -->
                <h2><i class="fas fa-stream"></i> The SPL Pipeline</h2>
                <div class="config-section">
                    <p>SPL operates as a <strong>pipeline</strong> where data flows through commands separated by pipes (<code>|</code>). Each command transforms the data before passing it to the next.</p>
                    
                    <div class="code-block">index=security sourcetype=linux_secure failed
| stats count by src_ip
| sort - count
| head 10</div>

                    <p style="color: #8b949e; margin-top: 16px;"><strong>Pipeline breakdown:</strong></p>
                    <ol style="color: #8b949e;">
                        <li><strong>Search:</strong> <code>index=security sourcetype=linux_secure failed</code> - retrieves raw events</li>
                        <li><strong>Transform:</strong> <code>stats count by src_ip</code> - aggregates events</li>
                        <li><strong>Sort:</strong> <code>sort - count</code> - orders results descending</li>
                        <li><strong>Limit:</strong> <code>head 10</code> - returns top 10 results</li>
                    </ol>
                </div>

                <!-- Basic Search -->
                <h2><i class="fas fa-search"></i> Basic Search Syntax</h2>
                <div class="config-section">
                    <h4>Index and Sourcetype</h4>
                    <div class="code-block"># Always specify index for better performance
index=main

# Specify sourcetype to narrow results
index=security sourcetype=WinEventLog:Security

# Multiple indexes
index=security OR index=network

# Wildcard in index name
index=sec*</div>

                    <h4>Time Range</h4>
                    <div class="code-block"># Relative time (most common)
index=security earliest=-24h          # Last 24 hours
index=security earliest=-7d latest=-1d  # 7 days ago to 1 day ago
index=security earliest=-1h@h         # Last hour, snap to hour

# Absolute time
index=security earliest="01/15/2024:00:00:00" latest="01/15/2024:23:59:59"

# Real-time (streaming)
index=security earliest=rt-5m latest=rt  # Real-time last 5 minutes</div>

                    <h4>Keywords and Phrases</h4>
                    <div class="code-block"># Simple keyword (case-insensitive)
index=security failed

# Exact phrase (use quotes)
index=security "authentication failure"

# Multiple keywords (implicit AND)
index=security failed password

# Boolean operators
index=security (failed OR failure) AND password
index=security failed NOT admin</div>

                    <h4>Field Searches</h4>
                    <div class="code-block"># Exact field value
index=security src_ip=192.168.1.100

# Field with wildcard
index=security user=admin*

# Field not equal
index=security action!=allowed

# Field exists
index=security src_ip=*

# Field does not exist
index=security NOT src_ip=*

# Numeric comparison
index=security bytes>1000000
index=security status>=400 status<500</div>
                </div>

                <!-- Essential Commands -->
                <h2><i class="fas fa-terminal"></i> Essential Commands</h2>

                <!-- stats -->
                <div class="cmd-card">
                    <span class="cmd-name">stats</span> - Aggregate statistics
                    <span class="cmd-syntax">stats &lt;function&gt;(field) [as alias] [by field1, field2]</span>
                    <div class="code-block"># Count events
index=security | stats count

# Count by field
index=security | stats count by src_ip

# Multiple aggregations
index=security | stats count, avg(duration), max(bytes) by user

# Distinct count
index=security | stats dc(src_ip) as unique_ips by user

# Common functions: count, sum, avg, min, max, dc (distinct count), 
# values, list, first, last, earliest, latest</div>
                </div>

                <!-- table -->
                <div class="cmd-card">
                    <span class="cmd-name">table</span> - Display specific fields as columns
                    <span class="cmd-syntax">table field1, field2, field3</span>
                    <div class="code-block"># Select specific fields
index=security | table _time, src_ip, user, action

# Rename while displaying (use 'as')
index=security | table _time, src_ip as "Source IP", user as "Username"</div>
                </div>

                <!-- fields -->
                <div class="cmd-card">
                    <span class="cmd-name">fields</span> - Include or exclude fields (for performance)
                    <span class="cmd-syntax">fields [+|-] field1, field2</span>
                    <div class="code-block"># Keep only these fields (improves performance)
index=security | fields _time, src_ip, user, action

# Remove specific fields
index=security | fields - _raw, _indextime, punct

# Include fields (explicit)
index=security | fields + src_ip, dst_ip</div>
                </div>

                <!-- eval -->
                <div class="cmd-card">
                    <span class="cmd-name">eval</span> - Create or modify fields with expressions
                    <span class="cmd-syntax">eval field_name = expression</span>
                    <div class="code-block"># Create new field
index=network | eval MB = bytes / 1048576

# Conditional logic
index=security | eval severity = if(status>=500, "high", "low")

# Multiple conditions with case
index=security | eval risk = case(
    status>=500, "critical",
    status>=400, "high",
    status>=300, "medium",
    1=1, "low"
)

# String manipulation
index=security | eval domain = lower(domain)
index=security | eval short_user = substr(user, 1, 10)

# Combine fields
index=security | eval full_path = src_ip . ":" . src_port

# Null coalescing
index=security | eval user = coalesce(user, src_user, "unknown")</div>
                </div>

                <!-- where -->
                <div class="cmd-card">
                    <span class="cmd-name">where</span> - Filter results using eval expressions
                    <span class="cmd-syntax">where &lt;eval-expression&gt;</span>
                    <div class="code-block"># Numeric comparison
index=security | stats count by src_ip | where count > 100

# String functions
index=security | where like(user, "admin%")
index=security | where match(user, "^svc_")

# Null checks
index=security | where isnotnull(src_ip)

# Multiple conditions
index=security | where count > 100 AND user != "system"

# cidrmatch for IP ranges
index=security | where cidrmatch("10.0.0.0/8", src_ip)</div>
                </div>

                <!-- sort -->
                <div class="cmd-card">
                    <span class="cmd-name">sort</span> - Order results
                    <span class="cmd-syntax">sort [+|-] field1, [+|-] field2</span>
                    <div class="code-block"># Ascending (default)
index=security | stats count by user | sort count

# Descending (use -)
index=security | stats count by user | sort - count

# Multiple fields
index=security | stats count by user, src_ip | sort - count, user

# Limit results
index=security | stats count by user | sort - count limit=10</div>
                </div>

                <!-- rex -->
                <div class="cmd-card">
                    <span class="cmd-name">rex</span> - Extract fields using regex
                    <span class="cmd-syntax">rex field=source_field "(?&lt;new_field&gt;pattern)"</span>
                    <div class="code-block"># Extract from _raw (default)
index=security | rex "user=(?<username>\w+)"

# Extract from specific field
index=security | rex field=url "\/(?<endpoint>[^\/\?]+)"

# Extract multiple fields
index=security | rex "src=(?<src_ip>\d+\.\d+\.\d+\.\d+).*dst=(?<dst_ip>\d+\.\d+\.\d+\.\d+)"

# Mode=sed for substitution
index=security | rex mode=sed field=user "s/DOMAIN\\///"</div>
                </div>

                <!-- rename -->
                <div class="cmd-card">
                    <span class="cmd-name">rename</span> - Rename fields
                    <span class="cmd-syntax">rename old_field as new_field</span>
                    <div class="code-block"># Single rename
index=security | rename src_ip as "Source IP"

# Multiple renames
index=security | rename src_ip as source, dst_ip as destination

# Rename with wildcard
index=security | rename *_ip as *_address</div>
                </div>

                <!-- dedup -->
                <div class="cmd-card">
                    <span class="cmd-name">dedup</span> - Remove duplicate events
                    <span class="cmd-syntax">dedup [count] field1, field2</span>
                    <div class="code-block"># Remove duplicates by single field
index=security | dedup src_ip

# Keep first N occurrences
index=security | dedup 5 user

# Multiple fields
index=security | dedup src_ip, dst_ip, dst_port

# Sort before dedup to control which event is kept
index=security | sort - _time | dedup user</div>
                </div>

                <!-- Security-Specific Examples -->
                <h2><i class="fas fa-shield-alt"></i> Security Analysis Examples</h2>
                <div class="config-section">
                    <h4>Failed Login Analysis</h4>
                    <div class="code-block">index=security sourcetype=WinEventLog:Security EventCode=4625
| stats count by src_ip, user, Failure_Reason
| where count > 5
| sort - count
| table src_ip, user, count, Failure_Reason</div>

                    <h4>Successful Logins After Failed Attempts</h4>
                    <div class="code-block">index=security sourcetype=WinEventLog:Security EventCode IN (4625, 4624)
| stats 
    count(eval(EventCode=4625)) as failed,
    count(eval(EventCode=4624)) as success,
    earliest(_time) as first_attempt,
    latest(_time) as last_attempt
    by src_ip, user
| where failed > 3 AND success > 0
| eval duration = round((last_attempt - first_attempt) / 60, 2)
| table src_ip, user, failed, success, duration</div>

                    <h4>Outbound Traffic Analysis</h4>
                    <div class="code-block">index=firewall direction=outbound
| stats sum(bytes_out) as total_bytes, dc(dst_ip) as unique_dests by src_ip
| eval MB = round(total_bytes/1048576, 2)
| where MB > 100 OR unique_dests > 50
| sort - MB
| table src_ip, MB, unique_dests</div>

                    <h4>Process Execution Timeline</h4>
                    <div class="code-block">index=endpoint sourcetype=sysmon EventCode=1
| search host="SUSPICIOUS-HOST"
| table _time, ParentImage, Image, CommandLine, User
| sort _time</div>

                    <h4>DNS Query Analysis</h4>
                    <div class="code-block">index=dns
| stats count by query, query_type
| where count < 5  // Rare queries
| sort - count
| rex field=query "\.(?<tld>[^\.]+)$"
| table query, tld, query_type, count</div>
                </div>

                <!-- Time Functions -->
                <h2><i class="fas fa-clock"></i> Time Functions</h2>
                <div class="config-section">
                    <div class="code-block"># Format time for display
| eval formatted_time = strftime(_time, "%Y-%m-%d %H:%M:%S")

# Extract time components
| eval hour = strftime(_time, "%H")
| eval day_of_week = strftime(_time, "%A")
| eval month = strftime(_time, "%B")

# Parse time from string
| eval event_time = strptime(timestamp_field, "%Y-%m-%dT%H:%M:%S")

# Time math
| eval time_diff = now() - _time
| eval hours_ago = round(time_diff / 3600, 2)

# Bucket time for grouping
| bucket _time span=1h
| stats count by _time</div>
                </div>

                <!-- String Functions -->
                <h2><i class="fas fa-font"></i> String Functions</h2>
                <div class="config-section">
                    <div class="code-block"># Case conversion
| eval lower_user = lower(user)
| eval upper_user = upper(user)

# Substring
| eval first_char = substr(user, 1, 1)
| eval domain = substr(email, indexOf(email, "@") + 1)

# Length
| eval name_length = len(user)

# Trim whitespace
| eval clean_user = trim(user)
| eval clean_user = ltrim(rtrim(user))

# Replace
| eval clean_path = replace(file_path, "\\", "/")

# Split and index
| eval domain_parts = split(domain, ".")
| eval tld = mvindex(domain_parts, -1)

# Concatenation
| eval full_name = first_name . " " . last_name
| eval log_entry = src_ip . " -> " . dst_ip . ":" . dst_port</div>
                </div>

                <!-- Multivalue Functions -->
                <h2><i class="fas fa-list"></i> Multivalue Functions</h2>
                <div class="config-section">
                    <div class="code-block"># Create multivalue field
| stats values(src_ip) as all_ips by user

# Count multivalue items
| eval ip_count = mvcount(all_ips)

# Get specific index (0-based)
| eval first_ip = mvindex(all_ips, 0)
| eval last_ip = mvindex(all_ips, -1)

# Join multivalue to string
| eval ip_list = mvjoin(all_ips, ", ")

# Filter multivalue
| eval internal_ips = mvfilter(match(all_ips, "^10\."))

# Expand multivalue to separate events
| mvexpand all_ips

# Deduplicate multivalue
| eval unique_ips = mvdedup(all_ips)

# Sort multivalue
| eval sorted_ips = mvsort(all_ips)</div>
                </div>

                <!-- Lookup -->
                <h2><i class="fas fa-table"></i> Lookups</h2>
                <div class="config-section">
                    <h4>Using Lookups</h4>
                    <div class="code-block"># Basic lookup (automatic field matching)
index=security | lookup user_info user OUTPUT department, manager

# Explicit field mapping
index=security | lookup asset_db ip as src_ip OUTPUT hostname, owner, criticality

# Inputlookup (search a lookup directly)
| inputlookup threat_intel.csv | where threat_type="malware"

# Outputlookup (save results to lookup)
index=security | stats count by src_ip | outputlookup ip_counts.csv</div>

                    <h4>Subsearch with Lookup</h4>
                    <div class="code-block"># Filter using lookup values
index=firewall src_ip IN [| inputlookup blocked_ips.csv | fields ip]

# Add context from another search
index=security 
| join src_ip [search index=assets | fields ip, hostname, owner]</div>
                </div>

                <!-- Common Patterns -->
                <h2><i class="fas fa-puzzle-piece"></i> Common SOC Patterns</h2>
                <div class="config-section">
                    <h4>Top N Analysis</h4>
                    <div class="code-block">index=firewall | top 10 src_ip by action
index=security | rare user  // Opposite of top</div>

                    <h4>Timechart for Trends</h4>
                    <div class="code-block">index=security EventCode=4625 
| timechart span=1h count by src_ip</div>

                    <h4>Percentage Calculation</h4>
                    <div class="code-block">index=firewall 
| stats count as total, count(eval(action="blocked")) as blocked
| eval block_rate = round(blocked*100/total, 2) . "%"</div>

                    <h4>First/Last Seen</h4>
                    <div class="code-block">index=security 
| stats earliest(_time) as first_seen, latest(_time) as last_seen by src_ip
| eval first_seen = strftime(first_seen, "%Y-%m-%d %H:%M")
| eval last_seen = strftime(last_seen, "%Y-%m-%d %H:%M")</div>
                </div>

                <!-- Performance Tips -->
                <h2><i class="fas fa-tachometer-alt"></i> Performance Optimization</h2>
                <div class="config-section">
                    <table class="styled-table">
                        <thead>
                            <tr><th>Tip</th><th>Why</th><th>Example</th></tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Always specify index</td>
                                <td>Limits data scanned</td>
                                <td><code>index=security</code> not <code>index=*</code></td>
                            </tr>
                            <tr>
                                <td>Use shortest time range</td>
                                <td>Less data to process</td>
                                <td><code>earliest=-1h</code> vs <code>earliest=-7d</code></td>
                            </tr>
                            <tr>
                                <td>Filter early</td>
                                <td>Reduces pipeline volume</td>
                                <td>Put specific filters before stats</td>
                            </tr>
                            <tr>
                                <td>Use fields command</td>
                                <td>Reduces data transfer</td>
                                <td><code>| fields src_ip, user</code></td>
                            </tr>
                            <tr>
                                <td>Avoid wildcards at start</td>
                                <td>Can't use index</td>
                                <td><code>user=admin*</code> not <code>user=*admin</code></td>
                            </tr>
                            <tr>
                                <td>Use tstats for indexed fields</td>
                                <td>10-100x faster</td>
                                <td><code>| tstats count where index=security</code></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Interview Q&A -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Explain how the SPL pipeline works.</button>
                        <div class="qa-answer">
                            <p>SPL uses a <strong>pipeline architecture</strong> where:</p>
                            <ol>
                                <li>The search command retrieves raw events from indexes</li>
                                <li>Each subsequent command (separated by <code>|</code>) transforms the data</li>
                                <li>Output from one command becomes input to the next</li>
                                <li>Commands are categorized as:
                                    <ul>
                                        <li><strong>Streaming:</strong> Process events one at a time (eval, rex, where)</li>
                                        <li><strong>Transforming:</strong> Process all events together (stats, timechart)</li>
                                        <li><strong>Generating:</strong> Create events (inputlookup, makeresults)</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: What's the difference between stats and eventstats?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>stats:</strong> Aggregates events into summary rows, reducing result count
                                    <div class="code-block">| stats count by user  // Returns one row per user</div>
                                </li>
                                <li><strong>eventstats:</strong> Adds aggregated values to each event without reducing rows
                                    <div class="code-block">| eventstats count as total by user  // All events retained, total added</div>
                                </li>
                            </ul>
                            <p>Use eventstats when you need to compare individual events to group statistics.</p>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: How do you optimize a slow Splunk search?</button>
                        <div class="qa-answer">
                            <ol>
                                <li><strong>Check Job Inspector:</strong> Identify where time is spent</li>
                                <li><strong>Specify index:</strong> Never use <code>index=*</code></li>
                                <li><strong>Narrow time range:</strong> Shortest range possible</li>
                                <li><strong>Filter early:</strong> Most restrictive conditions first</li>
                                <li><strong>Use fields command:</strong> Limit fields in pipeline</li>
                                <li><strong>Use tstats:</strong> For accelerated data models</li>
                                <li><strong>Avoid leading wildcards:</strong> <code>*admin</code> is slow</li>
                                <li><strong>Consider summary indexing:</strong> For repeated searches</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb" style="color: #d29922;"></i> Q: Write a search to find brute force attacks.</button>
                        <div class="qa-answer">
                            <div class="code-block">index=security sourcetype=WinEventLog:Security EventCode=4625
| bucket _time span=10m
| stats count as failed_logins by _time, src_ip, user
| where failed_logins > 5
| sort - failed_logins
| table _time, src_ip, user, failed_logins</div>
                            <p style="margin-top: 12px;">This search:</p>
                            <ul>
                                <li>Finds failed logins (4625) from Windows Security logs</li>
                                <li>Groups into 10-minute buckets</li>
                                <li>Counts failures per source IP and user</li>
                                <li>Filters for more than 5 failures (threshold)</li>
                            </ul>
                        </div>
                    </div>
                </div>

        </main>
    </div>
    <script>
        // Q&A toggle functionality
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                if (!isOpen) { answer.style.display = 'block'; }
            });
        });
    </script>
</body>
</html>