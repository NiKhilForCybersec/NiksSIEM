<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>MDE Response Actions | SOC Compendium</title>
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <nav class="top-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo">SOC Compendium</a>
            <div class="nav-links">
                <a href="../sentinel/index.html">Sentinel</a>
                <a href="../splunk/index.html">Splunk</a>
                <a href="../xsiam/index.html">XSIAM</a>
                <a href="../mde/index.html" class="active">Defender</a>
                <a href="../cortex/index.html">Cortex</a>
                <a href="../crowdstrike/index.html">CrowdStrike</a>
                <a href="../operations/index.html">Operations</a>
            </div>
        </div>
    </nav>

    <main class="content-wrapper">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Microsoft Defender</h3>
                <ul>
                    <li><a href="index.html">Overview</a></li>
                    <li><a href="onboarding-windows.html">Windows Onboarding</a></li>
                    <li><a href="onboarding-macos.html">macOS Onboarding</a></li>
                    <li><a href="onboarding-linux.html">Linux Onboarding</a></li>
                    <li><a href="kql-hunting.html">KQL Threat Hunting</a></li>
                    <li><a href="response-actions.html" class="active">Response Actions</a></li>
                    <li><a href="alert-tuning.html">Alert Tuning</a></li>
                    <li><a href="troubleshooting.html">Troubleshooting</a></li>
                </ul>
            </div>
        </aside>

        <article class="main-content">
            <header class="content-header">
                <h1>MDE Response Actions</h1>
                <p class="subtitle">Containment, investigation, and remediation capabilities in Microsoft Defender for Endpoint</p>
            </header>

            <section class="content-section">
                <h2>Response Action Categories</h2>
                <p>Microsoft Defender for Endpoint provides comprehensive response capabilities across containment, investigation, and remediation phases. Response actions can be executed through the Security Portal, APIs, or automated via Logic Apps and Power Automate.</p>

                <div class="info-box">
                    <h4>Response Action Overview</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Actions</th>
                                <th>Permissions Required</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Containment</td>
                                <td>Isolate device, Contain user, Network containment</td>
                                <td>Active remediation actions</td>
                            </tr>
                            <tr>
                                <td>Investigation</td>
                                <td>Collect investigation package, Live Response, Initiate investigation</td>
                                <td>View data, Active remediation (Live Response)</td>
                            </tr>
                            <tr>
                                <td>Remediation</td>
                                <td>Stop and quarantine file, Restrict app execution, Run antivirus scan</td>
                                <td>Active remediation actions</td>
                            </tr>
                            <tr>
                                <td>Recovery</td>
                                <td>Release from isolation, Restore file from quarantine, Remove restrictions</td>
                                <td>Active remediation actions</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section class="content-section">
                <h2>Device Isolation</h2>
                <p>Device isolation is the most critical containment action, disconnecting the endpoint from the network while maintaining MDE cloud connectivity for management.</p>

                <h3>Isolation Behavior</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Connection Type</th>
                            <th>Status When Isolated</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>MDE Cloud Services</td>
                            <td class="status-healthy">Allowed</td>
                            <td>Command and telemetry continues</td>
                        </tr>
                        <tr>
                            <td>Internal Network</td>
                            <td class="status-critical">Blocked</td>
                            <td>Prevents lateral movement</td>
                        </tr>
                        <tr>
                            <td>Internet Access</td>
                            <td class="status-critical">Blocked</td>
                            <td>Prevents C2 communication</td>
                        </tr>
                        <tr>
                            <td>DNS Resolution</td>
                            <td class="status-warning">Limited</td>
                            <td>MDE-related only</td>
                        </tr>
                        <tr>
                            <td>Local Loopback</td>
                            <td class="status-healthy">Allowed</td>
                            <td>127.0.0.1 accessible</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Selective Isolation</h3>
                <p>You can allow specific IP addresses during isolation for critical business processes:</p>
                <div class="code-block">
                    <pre><code># Via PowerShell (on endpoint)
# Note: Requires local admin rights

# Add allowed IP during isolation
Add-MpPreference -ExclusionIpAddress "10.0.0.50"

# View current exclusions
Get-MpPreference | Select-Object -ExpandProperty ExclusionIpAddress</code></pre>
                </div>

                <h3>API-Based Isolation</h3>
                <div class="code-block">
                    <pre><code># Isolate Device via API
POST https://api.securitycenter.microsoft.com/api/machines/{machineId}/isolate
Content-Type: application/json
Authorization: Bearer {token}

{
    "Comment": "Isolated due to active ransomware infection - Incident #12345",
    "IsolationType": "Full"
}

# Release from Isolation
POST https://api.securitycenter.microsoft.com/api/machines/{machineId}/unisolate
Content-Type: application/json
Authorization: Bearer {token}

{
    "Comment": "Investigation complete, malware remediated - Incident #12345"
}</code></pre>
                </div>

                <div class="warning-box">
                    <h4>‚ö†Ô∏è Isolation Considerations</h4>
                    <ul>
                        <li>Always document the reason before isolating a device</li>
                        <li>Notify the user if possible before isolation</li>
                        <li>Critical servers may require selective isolation instead of full</li>
                        <li>VDI environments may have unique isolation requirements</li>
                        <li>Some isolation scenarios may persist across reboots</li>
                    </ul>
                </div>
            </section>

            <section class="content-section">
                <h2>Live Response</h2>
                <p>Live Response provides remote shell access to endpoints for interactive investigation and remediation. It supports both basic and advanced command sets.</p>

                <h3>Live Response Permission Levels</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Capabilities</th>
                            <th>Example Commands</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Basic</td>
                            <td>Read-only investigation</td>
                            <td>dir, cd, processes, connections, fileinfo</td>
                        </tr>
                        <tr>
                            <td>Advanced</td>
                            <td>File operations, script execution</td>
                            <td>getfile, putfile, run, remediate</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Essential Live Response Commands</h3>
                <div class="code-block">
                    <pre><code># Navigation and File System
dir                         # List directory contents
cd C:\Users                 # Change directory
findfile malware.exe        # Search for file
fileinfo C:\temp\sus.exe    # Get file metadata

# Process Information
processes                   # List running processes
scheduledtasks              # List scheduled tasks
services                    # List services

# Network Information
connections                 # Show network connections
ipconfig                    # Network configuration
netstat                     # Network statistics

# Registry (Advanced)
registry query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

# File Operations (Advanced)
getfile C:\temp\malware.exe         # Download file for analysis
putfile remediation.ps1             # Upload file to endpoint
run remediation.ps1                 # Execute uploaded script

# Remediation (Advanced)
remediate file C:\temp\malware.exe  # Quarantine specific file
undo file C:\temp\malware.exe       # Restore quarantined file</code></pre>
                </div>

                <h3>Investigation Scripts</h3>
                <p>Custom scripts can be uploaded to the Live Response library for reuse:</p>
                <div class="code-block">
                    <pre><code># Persistence Check Script (persistence_check.ps1)
$output = @()

# Registry Run Keys
$runKeys = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce",
    "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
    "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce"
)

foreach ($key in $runKeys) {
    if (Test-Path $key) {
        $items = Get-ItemProperty $key -ErrorAction SilentlyContinue
        $output += "=== $key ===" 
        $items.PSObject.Properties | Where-Object { $_.Name -notlike "PS*" } | 
            ForEach-Object { $output += "$($_.Name): $($_.Value)" }
    }
}

# Scheduled Tasks
$output += "`n=== Scheduled Tasks ==="
Get-ScheduledTask | Where-Object {$_.State -ne "Disabled"} | 
    Select-Object TaskName, TaskPath, State | Format-Table | Out-String | 
    ForEach-Object { $output += $_ }

# Services (Non-Microsoft)
$output += "`n=== Non-Microsoft Services ==="
Get-WmiObject Win32_Service | Where-Object { $_.PathName -notlike "*Microsoft*" -and $_.PathName -notlike "*Windows*" } |
    Select-Object Name, State, PathName | Format-Table | Out-String |
    ForEach-Object { $output += $_ }

$output | Out-File -FilePath "C:\temp\persistence_report.txt"
Write-Output "Report saved to C:\temp\persistence_report.txt"</code></pre>
                </div>

                <h3>Memory Collection Script</h3>
                <div class="code-block">
                    <pre><code># Collect Process Memory Dump (process_dump.ps1)
param (
    [Parameter(Mandatory=$true)]
    [int]$ProcessId
)

$process = Get-Process -Id $ProcessId -ErrorAction Stop
$dumpPath = "C:\temp\$($process.ProcessName)_$ProcessId.dmp"

# Use procdump if available, otherwise use comsvcs.dll
$procdump = "C:\tools\procdump64.exe"
if (Test-Path $procdump) {
    & $procdump -accepteula -ma $ProcessId $dumpPath
} else {
    # Fallback to comsvcs.dll method
    rundll32.exe C:\windows\system32\comsvcs.dll, MiniDump $ProcessId $dumpPath full
}

if (Test-Path $dumpPath) {
    Write-Output "Memory dump created: $dumpPath"
    Get-FileHash $dumpPath -Algorithm SHA256
} else {
    Write-Error "Failed to create memory dump"
}</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>File Remediation</h2>

                <h3>Stop and Quarantine File</h3>
                <p>This action terminates processes associated with a file and quarantines it:</p>
                <div class="code-block">
                    <pre><code># Via API - Stop and Quarantine
POST https://api.securitycenter.microsoft.com/api/machines/{machineId}/StopAndQuarantineFile
Content-Type: application/json
Authorization: Bearer {token}

{
    "Comment": "Quarantining ransomware executable - Incident #12345",
    "Sha1": "da39a3ee5e6b4b0d3255bfef95601890afd80709"
}</code></pre>
                </div>

                <h3>Restore File from Quarantine</h3>
                <div class="code-block">
                    <pre><code># View Quarantine (PowerShell on endpoint)
Get-MpThreatDetection | Select-Object ThreatID, Resources, InitialDetectionTime

# Restore specific threat
Remove-MpThreat -ThreatID {threatId}

# Via MDE API - Get quarantined files
GET https://api.securitycenter.microsoft.com/api/machines/{machineId}/files
Authorization: Bearer {token}</code></pre>
                </div>

                <h3>Block File Globally</h3>
                <p>Add file indicators to block across all protected endpoints:</p>
                <div class="code-block">
                    <pre><code># Create File Indicator (Block and Remediate)
POST https://api.securitycenter.microsoft.com/api/indicators
Content-Type: application/json
Authorization: Bearer {token}

{
    "indicatorValue": "da39a3ee5e6b4b0d3255bfef95601890afd80709",
    "indicatorType": "FileSha1",
    "action": "AlertAndBlock",
    "title": "Block ransomware variant",
    "description": "SHA1 hash of ransomware identified in Incident #12345",
    "severity": "High",
    "recommendedActions": "Isolate affected systems and investigate for lateral movement",
    "rbacGroupNames": [],
    "generateAlert": true
}</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Investigation Package</h2>
                <p>The investigation package collects forensic artifacts from the endpoint for offline analysis.</p>

                <h3>Package Contents</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Artifact</th>
                            <th>Description</th>
                            <th>Location in Package</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Autoruns</td>
                            <td>Persistence mechanisms</td>
                            <td>/Autoruns/</td>
                        </tr>
                        <tr>
                            <td>Installed Programs</td>
                            <td>Software inventory</td>
                            <td>/InstalledPrograms/</td>
                        </tr>
                        <tr>
                            <td>Network Connections</td>
                            <td>Active connections at collection time</td>
                            <td>/NetworkConnections/</td>
                        </tr>
                        <tr>
                            <td>Prefetch Files</td>
                            <td>Program execution history</td>
                            <td>/Prefetch/</td>
                        </tr>
                        <tr>
                            <td>Running Processes</td>
                            <td>Process list with details</td>
                            <td>/Processes/</td>
                        </tr>
                        <tr>
                            <td>Scheduled Tasks</td>
                            <td>Task scheduler entries</td>
                            <td>/ScheduledTasks/</td>
                        </tr>
                        <tr>
                            <td>Security Event Log</td>
                            <td>Windows Security events</td>
                            <td>/SecurityEventLog/</td>
                        </tr>
                        <tr>
                            <td>Services</td>
                            <td>Windows services configuration</td>
                            <td>/Services/</td>
                        </tr>
                        <tr>
                            <td>SMB Sessions</td>
                            <td>Active file sharing sessions</td>
                            <td>/SMB/</td>
                        </tr>
                        <tr>
                            <td>Temp Folders</td>
                            <td>Contents of temp directories</td>
                            <td>/TempFolders/</td>
                        </tr>
                        <tr>
                            <td>Users and Groups</td>
                            <td>Local account information</td>
                            <td>/UsersAndGroups/</td>
                        </tr>
                        <tr>
                            <td>WdSupport Logs</td>
                            <td>Defender diagnostic logs</td>
                            <td>/WdSupportLogs/</td>
                        </tr>
                        <tr>
                            <td>CollectionSummaryReport</td>
                            <td>Summary of collection</td>
                            <td>/CollectionSummaryReport.xls</td>
                        </tr>
                    </tbody>
                </table>

                <h3>Collect via API</h3>
                <div class="code-block">
                    <pre><code># Initiate Investigation Package Collection
POST https://api.securitycenter.microsoft.com/api/machines/{machineId}/collectInvestigationPackage
Content-Type: application/json
Authorization: Bearer {token}

{
    "Comment": "Collecting investigation package for incident analysis - Incident #12345"
}

# Check Collection Status
GET https://api.securitycenter.microsoft.com/api/machineactions/{actionId}
Authorization: Bearer {token}

# Download Package (after status = Succeeded)
GET https://api.securitycenter.microsoft.com/api/machineactions/{actionId}/getPackageUri
Authorization: Bearer {token}</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Automated Response with Logic Apps</h2>

                <h3>Auto-Isolate High-Severity Alerts</h3>
                <div class="code-block">
                    <pre><code>// Logic App - Trigger on MDE Alert
{
    "definition": {
        "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
        "triggers": {
            "When_a_Microsoft_Defender_for_Endpoint_alert_is_created": {
                "type": "ApiConnection",
                "inputs": {
                    "host": {
                        "connection": {
                            "name": "@parameters('$connections')['wdatp']['connectionId']"
                        }
                    },
                    "method": "get",
                    "path": "/trigger/alerts"
                }
            }
        },
        "actions": {
            "Condition_-_High_Severity": {
                "type": "If",
                "expression": {
                    "and": [
                        {
                            "equals": ["@triggerBody()?['severity']", "High"]
                        },
                        {
                            "contains": [
                                "@triggerBody()?['category']",
                                "Ransomware"
                            ]
                        }
                    ]
                },
                "actions": {
                    "Isolate_machine": {
                        "type": "ApiConnection",
                        "inputs": {
                            "host": {
                                "connection": {
                                    "name": "@parameters('$connections')['wdatp']['connectionId']"
                                }
                            },
                            "method": "post",
                            "path": "/api/machines/@{triggerBody()?['machineId']}/isolate",
                            "body": {
                                "Comment": "Auto-isolated due to high-severity ransomware alert",
                                "IsolationType": "Full"
                            }
                        }
                    },
                    "Send_Teams_notification": {
                        "type": "ApiConnection",
                        "inputs": {
                            "host": {
                                "connection": {
                                    "name": "@parameters('$connections')['teams']['connectionId']"
                                }
                            },
                            "method": "post",
                            "path": "/v1.0/teams/@{parameters('TeamId')}/channels/@{parameters('ChannelId')}/messages",
                            "body": {
                                "body": {
                                    "content": "üö® Device @{triggerBody()?['computerDnsName']} auto-isolated due to ransomware detection"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}</code></pre>
                </div>
            </section>

            <section class="content-section">
                <h2>Response Workflow</h2>

                <div class="workflow-diagram">
                    <div class="workflow-step">
                        <span class="step-number">1</span>
                        <h4>Alert Triage</h4>
                        <p>Review alert details, affected device, user context</p>
                    </div>
                    <div class="workflow-arrow">‚Üí</div>
                    <div class="workflow-step">
                        <span class="step-number">2</span>
                        <h4>Severity Assessment</h4>
                        <p>Determine scope and impact, check for spread</p>
                    </div>
                    <div class="workflow-arrow">‚Üí</div>
                    <div class="workflow-step">
                        <span class="step-number">3</span>
                        <h4>Containment</h4>
                        <p>Isolate if active threat, block IOCs globally</p>
                    </div>
                    <div class="workflow-arrow">‚Üí</div>
                    <div class="workflow-step">
                        <span class="step-number">4</span>
                        <h4>Evidence Collection</h4>
                        <p>Collect investigation package, use Live Response</p>
                    </div>
                    <div class="workflow-arrow">‚Üí</div>
                    <div class="workflow-step">
                        <span class="step-number">5</span>
                        <h4>Remediation</h4>
                        <p>Remove malware, restore files, patch vulnerabilities</p>
                    </div>
                    <div class="workflow-arrow">‚Üí</div>
                    <div class="workflow-step">
                        <span class="step-number">6</span>
                        <h4>Recovery</h4>
                        <p>Release isolation, verify normal operation</p>
                    </div>
                </div>
            </section>

            <section class="content-section">
                <h2>Interview Q&A</h2>

                <div class="qa-section">
                    <h3>Q: Walk me through your response to an active ransomware alert in MDE.</h3>
                    <div class="answer">
                        <p><strong>A:</strong> My ransomware response workflow in MDE:</p>
                        <ol>
                            <li><strong>Immediate containment:</strong> Isolate the affected device immediately via the portal or API. Don't wait for full investigation - ransomware spreads quickly</li>
                            <li><strong>Scope assessment:</strong> Use Advanced Hunting to find other devices with the same file hash or behavior patterns. Look for lateral movement indicators in DeviceNetworkEvents and DeviceLogonEvents</li>
                            <li><strong>Block IOCs:</strong> Add the file hash as an indicator with "Block and Remediate" action to stop it across all endpoints</li>
                            <li><strong>Evidence collection:</strong> Initiate investigation package collection on all affected devices for forensic analysis</li>
                            <li><strong>Live Response investigation:</strong> Connect via Live Response to understand the attack chain - check persistence mechanisms, recent file modifications, and network connections</li>
                            <li><strong>Remediation:</strong> Use Stop and Quarantine for identified malware, run full AV scan, remove persistence mechanisms identified</li>
                            <li><strong>Recovery:</strong> After confirming remediation, release isolation, restore from backup if needed, verify normal operation</li>
                            <li><strong>Documentation:</strong> Document timeline, IOCs, and lessons learned for future reference</li>
                        </ol>
                    </div>
                </div>

                <div class="qa-section">
                    <h3>Q: How do you decide between full isolation and selective isolation?</h3>
                    <div class="answer">
                        <p><strong>A:</strong> The isolation decision depends on several factors:</p>
                        <ul>
                            <li><strong>Full isolation</strong> is appropriate when: The threat is actively spreading (ransomware, worm), the device shows signs of command-and-control communication, or you need maximum containment while investigating</li>
                            <li><strong>Selective isolation</strong> (allowing specific IPs) is appropriate when: The system is business-critical and must maintain specific connections, you need to allow backup/monitoring tools to continue, or the device is a server requiring limited access for investigation</li>
                            <li><strong>Key considerations:</strong> Can the business tolerate complete disconnection? Is the threat actively communicating externally? What's the blast radius if we don't fully isolate?</li>
                        </ul>
                        <p>Generally, I err on the side of full isolation for workstations and selective isolation for critical servers, always documenting the justification.</p>
                    </div>
                </div>

                <div class="qa-section">
                    <h3>Q: What are the limitations of MDE Live Response?</h3>
                    <div class="answer">
                        <p><strong>A:</strong> Key Live Response limitations to be aware of:</p>
                        <ul>
                            <li><strong>File size limits:</strong> 3GB for file downloads (getfile), script execution timeout of 10 minutes for basic, 4 hours for advanced</li>
                            <li><strong>Concurrency:</strong> Only one Live Response session per device at a time, maximum 25 concurrent sessions per tenant</li>
                            <li><strong>Script library:</strong> Scripts must be uploaded to the library before use, unsigned scripts require explicit approval</li>
                            <li><strong>Network dependency:</strong> Requires endpoint to have connectivity to MDE cloud services</li>
                            <li><strong>Permission requirements:</strong> Advanced commands require separate role assignment beyond basic Live Response access</li>
                            <li><strong>Platform differences:</strong> Some commands behave differently on Windows vs macOS vs Linux</li>
                        </ul>
                        <p>For large-scale evidence collection or complex remediation, I supplement Live Response with other tools like investigation packages or custom scripts deployed via Intune.</p>
                    </div>
                </div>
            </section>
        </article>
    </main>

    <script src="../assets/js/main.js"></script>
</body>
</html>
