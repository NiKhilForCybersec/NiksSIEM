<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Hunting | Microsoft Defender for Endpoint</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/main.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html" class="sidebar-brand">
                    <div class="brand-icon"><i class="fas fa-shield-halved"></i></div>
                    <div class="brand-text">
                        <span class="brand-title">Nik's SIEM</span>
                        <span class="brand-subtitle">Security Operations</span>
                    </div>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">MDE Platform</div>
                    <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Overview</a>
                    <a href="fundamentals.html" class="nav-link"><i class="fas fa-book"></i> Fundamentals</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Deployment</div>
                    <a href="onboarding-windows.html" class="nav-link"><i class="fab fa-windows"></i> Windows Onboarding</a>
                    <a href="onboarding-macos.html" class="nav-link"><i class="fab fa-apple"></i> macOS Onboarding</a>
                    <a href="onboarding-linux.html" class="nav-link"><i class="fab fa-linux"></i> Linux Onboarding</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Detection & Hunting</div>
                    <a href="kql-hunting.html" class="nav-link"><i class="fas fa-crosshairs"></i> KQL Hunting</a>
                    <a href="advanced-hunting.html" class="nav-link active"><i class="fas fa-code"></i> Advanced Hunting</a>
                    <a href="alert-tuning.html" class="nav-link"><i class="fas fa-sliders-h"></i> Alert Tuning</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Response</div>
                    <a href="response-actions.html" class="nav-link"><i class="fas fa-bolt"></i> Response Actions</a>
                    <a href="incident-management.html" class="nav-link"><i class="fas fa-clipboard-list"></i> Incident Management</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Administration</div>
                    <a href="troubleshooting.html" class="nav-link"><i class="fas fa-wrench"></i> Troubleshooting</a>
                </div>
            </nav>
        </aside>
        <div class="main-wrapper">
            <header class="top-bar">
                <div class="breadcrumb">
                    <a href="../index.html">Home</a><span class="separator">/</span>
                    <a href="index.html">MDE</a><span class="separator">/</span>
                    <span class="current">Advanced Hunting</span>
                </div>
            </header>
            <main class="main-content">
                <h1><i class="fas fa-search"></i> Advanced Hunting</h1>
                <p class="lead">Master advanced hunting in Microsoft Defender for Endpoint. Learn the hunting interface, key tables, hunting methodologies, and practical queries for threat detection.</p>

                <!-- Hunting Overview -->
                <h2><i class="fas fa-info-circle"></i> Advanced Hunting Overview</h2>
                <div class="config-section">
                    <p><span class="console-path">security.microsoft.com → Hunting → Advanced hunting</span></p>

                    <h4>Hunting Interface</h4>
                    <div class="code-block">Advanced Hunting Interface:

COMPONENTS:
├── Query Editor: Write and edit KQL queries
├── Schema Reference: Browse available tables/columns
├── Query Library: Saved and shared queries
├── Results Pane: Query results and visualization
└── Take Actions: Response actions from results

DATA RETENTION:
├── Default: 30 days
├── Extended: Up to 180 days (configurable)
├── Historical queries for investigation
└── Real-time data also available

QUERY LIMITS:
├── Max results: 10,000 rows
├── Query timeout: 10 minutes
├── Lookback: Up to 30 days (default)
└── Rate limits apply for large queries

FEATURES:
├── IntelliSense: Auto-complete
├── Schema browser: Explore tables
├── Query samples: Built-in examples
├── Custom functions: Reusable query blocks
└── Export: CSV, Power BI, API</div>

                    <h4>Key Tables</h4>
                    <table class="styled-table">
                        <thead>
                            <tr><th>Table</th><th>Contents</th><th>Use Case</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>DeviceProcessEvents</strong></td><td>Process creation/termination</td><td>Execution analysis</td></tr>
                            <tr><td><strong>DeviceNetworkEvents</strong></td><td>Network connections</td><td>C2, lateral movement</td></tr>
                            <tr><td><strong>DeviceFileEvents</strong></td><td>File operations</td><td>Malware, exfiltration</td></tr>
                            <tr><td><strong>DeviceRegistryEvents</strong></td><td>Registry changes</td><td>Persistence</td></tr>
                            <tr><td><strong>DeviceLogonEvents</strong></td><td>Authentication</td><td>Access, lateral movement</td></tr>
                            <tr><td><strong>DeviceImageLoadEvents</strong></td><td>DLL/module loads</td><td>DLL hijacking, injection</td></tr>
                            <tr><td><strong>DeviceEvents</strong></td><td>Miscellaneous events</td><td>Various security events</td></tr>
                            <tr><td><strong>AlertInfo</strong></td><td>Alert details</td><td>Alert investigation</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Essential Queries -->
                <h2><i class="fas fa-code"></i> Essential Hunting Queries</h2>
                <div class="config-section">
                    <h4>Process Execution</h4>
                    <div class="code-block">// Suspicious PowerShell execution
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName =~ "powershell.exe" or FileName =~ "pwsh.exe"
| where ProcessCommandLine has_any (
    "-enc", "-encodedcommand", 
    "downloadstring", "downloadfile",
    "invoke-webrequest", "iwr",
    "invoke-expression", "iex",
    "bypass", "hidden"
)
| project Timestamp, DeviceName, AccountName, 
          FileName, ProcessCommandLine, 
          InitiatingProcessFileName

// Living off the land binaries (LOLBins)
let LOLBins = dynamic([
    "certutil.exe", "mshta.exe", "regsvr32.exe",
    "rundll32.exe", "msiexec.exe", "wmic.exe",
    "cscript.exe", "wscript.exe", "bitsadmin.exe"
]);
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName in~ (LOLBins)
| where ProcessCommandLine has_any ("http", "ftp", "/c", "-e")
| project Timestamp, DeviceName, FileName, 
          ProcessCommandLine, AccountName

// Process execution from suspicious paths
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FolderPath has_any (
    "\\Users\\Public\\", "\\Temp\\", 
    "\\AppData\\Local\\Temp\\", "\\Downloads\\"
)
| where FileName endswith ".exe"
| summarize ExecutionCount = count(), 
            Devices = dcount(DeviceName) 
  by FileName, FolderPath
| where Devices < 5  // Rare across environment</div>

                    <h4>Network Activity</h4>
                    <div class="code-block">// Connections to rare external IPs
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemoteIPType == "Public"
| where ActionType == "ConnectionSuccess"
| summarize 
    ConnectionCount = count(),
    Devices = dcount(DeviceName),
    FirstSeen = min(Timestamp),
    LastSeen = max(Timestamp)
  by RemoteIP, RemotePort
| where Devices == 1 and ConnectionCount > 10
| order by ConnectionCount desc

// Beaconing detection
DeviceNetworkEvents
| where Timestamp > ago(24h)
| where RemoteIPType == "Public"
| summarize 
    Connections = count(),
    AvgInterval = avg(datetime_diff('second', Timestamp, prev(Timestamp)))
  by DeviceName, RemoteIP, bin(Timestamp, 1h)
| where Connections > 10
| where AvgInterval between (50 .. 70)  // ~1 min beacon

// Non-standard port usage
DeviceNetworkEvents
| where Timestamp > ago(7d)
| where RemotePort !in (80, 443, 53, 22, 25, 587)
| where RemoteIPType == "Public"
| summarize count() by DeviceName, RemoteIP, RemotePort
| order by count_ desc</div>

                    <h4>Persistence Hunting</h4>
                    <div class="code-block">// Registry run key modifications
DeviceRegistryEvents
| where Timestamp > ago(7d)
| where RegistryKey has_any (
    "\\CurrentVersion\\Run",
    "\\CurrentVersion\\RunOnce",
    "\\CurrentVersion\\RunServices"
)
| where ActionType in ("RegistryValueSet", "RegistryKeyCreated")
| project Timestamp, DeviceName, AccountName,
          RegistryKey, RegistryValueName, RegistryValueData

// Scheduled task creation
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "ScheduledTaskCreated"
| project Timestamp, DeviceName, AccountName,
          AdditionalFields

// Service installation
DeviceEvents
| where Timestamp > ago(7d)
| where ActionType == "ServiceInstalled"
| extend ServiceName = tostring(parse_json(AdditionalFields).ServiceName)
| extend ServicePath = tostring(parse_json(AdditionalFields).ServicePath)
| project Timestamp, DeviceName, ServiceName, ServicePath

// Startup folder additions
DeviceFileEvents
| where Timestamp > ago(7d)
| where FolderPath has "\\Start Menu\\Programs\\Startup\\"
| where ActionType == "FileCreated"
| project Timestamp, DeviceName, FileName, FolderPath, SHA256</div>

                    <h4>Credential Access</h4>
                    <div class="code-block">// LSASS access
DeviceProcessEvents
| where Timestamp > ago(7d)
| where FileName =~ "lsass.exe"
| join kind=inner (
    DeviceFileEvents
    | where ActionType == "FileCreated"
) on DeviceId, $left.ProcessId == $right.InitiatingProcessId
| project Timestamp, DeviceName, InitiatingProcessFileName,
          FileName, FolderPath

// Mimikatz indicators
DeviceProcessEvents
| where Timestamp > ago(7d)
| where ProcessCommandLine has_any (
    "sekurlsa", "kerberos::list", "lsadump",
    "privilege::debug", "token::elevate",
    "crypto::certificates", "vault::cred"
)
| project Timestamp, DeviceName, AccountName,
          FileName, ProcessCommandLine

// SAM database access
DeviceFileEvents
| where Timestamp > ago(7d)
| where FileName in~ ("sam", "system", "security")
| where FolderPath has "\\config\\"
| where ActionType in ("FileRead", "FileModified")
| project Timestamp, DeviceName, InitiatingProcessFileName,
          FileName, ActionType</div>
                </div>

                <!-- Hunting Methodology -->
                <h2><i class="fas fa-route"></i> Hunting Methodology</h2>
                <div class="config-section">
                    <h4>Hypothesis-Driven Hunting</h4>
                    <div class="code-block">Hypothesis-Driven Hunting Framework:

1. DEVELOP HYPOTHESIS
   ├── Based on: Threat intel, MITRE ATT&CK, incidents
   ├── Example: "Attackers may use encoded PowerShell
   │            to download malware"
   └── Technique: T1059.001 (PowerShell)

2. IDENTIFY DATA SOURCES
   ├── DeviceProcessEvents (process execution)
   ├── DeviceNetworkEvents (network connections)
   └── Required fields: ProcessCommandLine, FileName

3. BUILD QUERY
   DeviceProcessEvents
   | where FileName =~ "powershell.exe"
   | where ProcessCommandLine has "-enc"
   | where ProcessCommandLine has_any ("http", "ftp")

4. ANALYZE RESULTS
   ├── Review process command lines
   ├── Check parent processes
   ├── Correlate with network activity
   └── Identify true positives

5. ITERATE AND REFINE
   ├── Reduce false positives
   ├── Expand detection scope
   ├── Create detection rule if validated
   └── Document findings

6. OPERATIONALIZE
   ├── Create custom detection rule
   ├── Add to hunting playbook
   └── Share with team</div>

                    <h4>MITRE ATT&CK-Based Hunting</h4>
                    <div class="code-block">MITRE ATT&CK Hunting by Tactic:

INITIAL ACCESS:
├── T1566: Phishing
│   └── Look for: Office spawning suspicious processes
├── T1078: Valid Accounts
│   └── Look for: Anomalous logons, impossible travel

EXECUTION:
├── T1059: Command/Script Interpreter
│   └── Look for: PowerShell, cmd, wscript activity
├── T1204: User Execution
│   └── Look for: Office → child processes

PERSISTENCE:
├── T1547: Boot/Logon Autostart
│   └── Look for: Registry run keys, startup folder
├── T1053: Scheduled Task/Job
│   └── Look for: schtasks.exe, Task Scheduler events

PRIVILEGE ESCALATION:
├── T1134: Access Token Manipulation
│   └── Look for: Token impersonation events
├── T1055: Process Injection
│   └── Look for: Cross-process memory operations

DEFENSE EVASION:
├── T1070: Indicator Removal
│   └── Look for: Log clearing, file deletion
├── T1027: Obfuscated Files
│   └── Look for: Encoded commands, packed files

CREDENTIAL ACCESS:
├── T1003: OS Credential Dumping
│   └── Look for: LSASS access, SAM access
├── T1558: Kerberos Attacks
│   └── Look for: Kerberoasting activity

LATERAL MOVEMENT:
├── T1021: Remote Services
│   └── Look for: RDP, SMB, WinRM connections
├── T1550: Use Alternate Auth Material
│   └── Look for: Pass-the-hash, pass-the-ticket</div>
                </div>

                <!-- Custom Detection Rules -->
                <h2><i class="fas fa-bell"></i> Custom Detection Rules</h2>
                <div class="config-section">
                    <p><span class="console-path">Hunting → Custom detection rules → Create</span></p>

                    <div class="code-block">Creating Custom Detection Rules:

PROCESS:
1. Develop and test query in Advanced Hunting
2. Validate results (minimize false positives)
3. Click "Create detection rule"
4. Configure rule settings:
   ├── Name and description
   ├── Severity (Low/Medium/High/Informational)
   ├── Category (MITRE tactic)
   ├── MITRE technique
   ├── Impacted entities (map from query)
   ├── Frequency (hourly, daily, etc.)
   └── Actions (generate alert, take action)

EXAMPLE RULE:
// Encoded PowerShell with Network Activity
DeviceProcessEvents
| where Timestamp > ago(1h)
| where FileName =~ "powershell.exe"
| where ProcessCommandLine has "-enc"
| join kind=inner (
    DeviceNetworkEvents
    | where Timestamp > ago(1h)
    | where RemoteIPType == "Public"
) on DeviceId, ProcessId
| project Timestamp, DeviceName, AccountName,
          ProcessCommandLine, RemoteIP, RemotePort

RULE SETTINGS:
├── Name: Encoded PowerShell with External Connection
├── Severity: High
├── Category: Execution
├── Technique: T1059.001
├── Entity mapping:
│   ├── Device: DeviceName
│   └── User: AccountName
├── Frequency: Every hour
└── Actions: Create alert</div>
                </div>

                <!-- Interview Questions -->
                <h2><i class="fas fa-comments"></i> Interview Questions</h2>
                <div class="qa-section">
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: What are the key tables in MDE Advanced Hunting?</button>
                        <div class="qa-answer">
                            <ul>
                                <li><strong>DeviceProcessEvents:</strong> Process execution, command lines</li>
                                <li><strong>DeviceNetworkEvents:</strong> Network connections</li>
                                <li><strong>DeviceFileEvents:</strong> File operations</li>
                                <li><strong>DeviceRegistryEvents:</strong> Registry modifications</li>
                                <li><strong>DeviceLogonEvents:</strong> Authentication events</li>
                                <li><strong>DeviceImageLoadEvents:</strong> DLL/module loads</li>
                            </ul>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How would you hunt for credential dumping?</button>
                        <div class="qa-answer">
                            <p>Look for LSASS access, Mimikatz patterns, SAM access:</p>
                            <div class="code-block">DeviceProcessEvents
| where ProcessCommandLine has_any (
    "sekurlsa", "lsadump", "privilege::debug"
)
// Also check for LSASS memory access
// Check SAM/SYSTEM file access
// Look for procdump targeting lsass</div>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you turn a hunting query into a detection rule?</button>
                        <div class="qa-answer">
                            <ol>
                                <li>Test query, validate results, minimize false positives</li>
                                <li>Click "Create detection rule" from results</li>
                                <li>Configure: name, severity, MITRE mapping</li>
                                <li>Map entities (Device, User, IP)</li>
                                <li>Set frequency (hourly/daily)</li>
                                <li>Define actions (alert, response)</li>
                            </ol>
                        </div>
                    </div>
                    <div class="qa-item">
                        <button class="qa-question"><i class="fas fa-lightbulb"></i> Q: How do you detect beaconing behavior?</button>
                        <div class="qa-answer">
                            <p>Look for regular interval connections:</p>
                            <div class="code-block">DeviceNetworkEvents
| summarize Connections = count() by 
    DeviceName, RemoteIP, bin(Timestamp, 1h)
| where Connections > 10  // Regular pattern
// Calculate time intervals between connections
// Look for consistent ~60 second intervals</div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    <script>
        document.querySelectorAll('.qa-question').forEach(btn => {
            btn.addEventListener('click', () => {
                const answer = btn.nextElementSibling;
                const isOpen = answer.style.display === 'block';
                document.querySelectorAll('.qa-answer').forEach(a => a.style.display = 'none');
                document.querySelectorAll('.qa-question').forEach(b => b.classList.remove('active'));
                if (!isOpen) { answer.style.display = 'block'; btn.classList.add('active'); }
            });
        });
    </script>
</body>
</html>